<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Python-Standard Library, JackHCC">
    <meta name="description" content="Python标准库详解【3】">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Python-Standard Library | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Python-Standard Library</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Python/">
                                <span class="chip bg-color">Python</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Python/" class="post-category">
                                Python
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-11-09
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-11-18
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    44.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    173 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Python-标准库"><a href="#Python-标准库" class="headerlink" title="Python 标准库"></a>Python 标准库</h1><ul>
<li>并发执行<ul>
<li><code>threading</code> —- 基于线程的并行</li>
<li><code>multiprocessing</code> —- 基于进程的并行</li>
<li><code>multiprocessing.shared_memory</code> —- 可从进程直接访问的共享内存</li>
<li><code>concurrent</code> 包</li>
<li><code>concurrent.futures</code> —- 启动并行任务</li>
<li><code>subprocess</code> —- 子进程管理</li>
<li><code>sched</code> —- 事件调度器</li>
<li><code>queue</code> —- 一个同步的队列类</li>
<li><code>contextvars</code> —- 上下文变量</li>
<li><code>_thread</code> —- 底层多线程 API</li>
</ul>
</li>
<li>网络和进程间通信<ul>
<li><code>asyncio</code> —- 异步 I/O</li>
<li><code>socket</code> —- 底层网络接口</li>
<li><code>ssl</code> —- 套接字对象的 TLS/SSL 包装器</li>
<li><code>select</code> —- 等待 I/O 完成</li>
<li><code>selectors</code> —- 高级 I/O 复用库</li>
<li><code>asyncore</code> —- 异步套接字处理器</li>
<li><code>asynchat</code> —- 异步套接字指令/响应处理程序</li>
<li><code>signal</code> —- 设置异步事件处理程序</li>
<li><code>mmap</code> —- 内存映射文件支持</li>
</ul>
</li>
<li>互联网数据处理<ul>
<li><code>email</code> —- 电子邮件与 MIME 处理包</li>
<li><code>json</code> —- JSON 编码和解码器</li>
<li><code>mailcap</code> —- Mailcap 文件处理</li>
<li><code>mailbox</code> —- 操作多种格式的邮箱</li>
<li><code>mimetypes</code> —- 映射文件名到 MIME 类型</li>
<li><code>base64</code> —- Base16, Base32, Base64, Base85 数据编码</li>
<li><code>binhex</code> —- 对binhex4文件进行编码和解码</li>
<li><code>binascii</code> —- 二进制和 ASCII 码互转</li>
<li><code>quopri</code> —- 编码与解码经过 MIME 转码的可打印数据</li>
<li><code>uu</code> —- 对 uuencode 文件进行编码与解码</li>
</ul>
</li>
<li>结构化标记处理工具<ul>
<li><code>html</code> —- 超文本标记语言支持</li>
<li><code>html.parser</code> —- 简单的 HTML 和 XHTML 解析器</li>
<li><code>html.entities</code> —- HTML 一般实体的定义</li>
<li>XML处理模块</li>
<li><code>xml.etree.ElementTree</code> —- ElementTree XML API</li>
<li><code>xml.dom</code> —- 文档对象模型 API</li>
<li><code>xml.dom.minidom</code> —- 最小化的 DOM 实现</li>
<li><code>xml.dom.pulldom</code> —- 支持构建部分 DOM 树</li>
<li><code>xml.sax</code> —- 支持 SAX2 解析器</li>
<li><code>xml.sax.handler</code> —- SAX 处理句柄的基类</li>
<li><code>xml.sax.saxutils</code> —- SAX 工具集</li>
<li><code>xml.sax.xmlreader</code> —- 用于 XML 解析器的接口</li>
<li><code>xml.parsers.expat</code> —- 使用 Expat 的快速 XML 解析</li>
</ul>
</li>
<li>互联网协议和支持<ul>
<li><code>webbrowser</code> —- 方便的 Web 浏览器控制工具</li>
<li><code>cgi</code> —- 通用网关接口支持</li>
<li><code>cgitb</code> —- 用于 CGI 脚本的回溯管理器</li>
<li><code>wsgiref</code> —- WSGI 工具和参考实现</li>
<li><code>urllib</code> —- URL 处理模块</li>
<li><code>urllib.request</code> —- 用于打开 URL 的可扩展库</li>
<li><code>urllib.response</code> —- urllib 使用的 Response 类</li>
<li><code>urllib.parse</code> 用于解析 URL</li>
<li><code>urllib.error</code> —- urllib.request 引发的异常类</li>
<li><code>urllib.robotparser</code> —- robots.txt 语法分析程序</li>
<li><code>http</code> —- HTTP 模块</li>
<li><code>http.client</code> —- HTTP 协议客户端</li>
<li><code>ftplib</code> —- FTP 协议客户端</li>
<li><code>poplib</code> —- POP3 协议客户端</li>
<li><code>imaplib</code> —- IMAP4 协议客户端</li>
<li><code>nntplib</code> —- NNTP protocol client</li>
<li><code>smtplib</code> —-SMTP协议客户端</li>
<li><code>smtpd</code> —- SMTP 服务器</li>
<li><code>telnetlib</code> — Telnet 客户端</li>
<li><code>uuid</code> —- UUID objects according to <strong>RFC 4122</strong></li>
<li><code>socketserver</code> —- A framework for network servers</li>
<li><code>http.server</code> —- HTTP 服务器</li>
<li><code>http.cookies</code> —- HTTP状态管理</li>
<li><code>http.cookiejar</code> —— HTTP 客户端的 Cookie 处理</li>
<li><code>xmlrpc</code> —- XMLRPC 服务端与客户端模块</li>
<li><code>xmlrpc.client</code> —- XML-RPC 客户端访问</li>
<li><code>xmlrpc.server</code> —- 基本 XML-RPC 服务器</li>
<li><code>ipaddress</code> —- IPv4/IPv6 操作库</li>
</ul>
</li>
<li>多媒体服务<ul>
<li><code>audioop</code> —- 处理原始音频数据</li>
<li><code>aifc</code> —- 读写 AIFF 和 AIFC 文件</li>
<li><code>sunau</code> —- 读写 Sun AU 文件</li>
<li><code>wave</code> —- 读写WAV格式文件</li>
<li><code>chunk</code> —- 读取 IFF 分块数据</li>
<li><code>colorsys</code> —- 颜色系统间的转换</li>
<li><code>imghdr</code> —- 推测图像类型</li>
<li><code>sndhdr</code> —- 推测声音文件的类型</li>
<li><code>ossaudiodev</code> —- 访问兼容OSS的音频设备</li>
</ul>
</li>
<li>国际化<ul>
<li><code>gettext</code> —- 多语种国际化服务</li>
<li><code>locale</code> —- 国际化服务</li>
</ul>
</li>
<li>程序框架<ul>
<li><code>turtle</code> —- 海龟绘图</li>
<li><code>cmd</code> —- 支持面向行的命令解释器</li>
<li><code>shlex</code> —— 简单的词法分析</li>
</ul>
</li>
<li>Tk图形用户界面(GUI)<ul>
<li><code>tkinter</code> —- Tcl/Tk的Python接口</li>
<li><code>tkinter.colorchooser</code> —- 颜色选择对话框</li>
<li><code>tkinter.font</code> —- Tkinter 字体封装</li>
<li>Tkinter 对话框</li>
<li><code>tkinter.messagebox</code> —- Tkinter 消息提示</li>
<li><code>tkinter.scrolledtext</code> —- 滚动文字控件</li>
<li><code>tkinter.dnd</code> —- 拖放操作支持</li>
<li><code>tkinter.ttk</code> —- Tk主题部件</li>
<li><code>tkinter.tix</code> —- TK扩展包</li>
<li>IDLE</li>
</ul>
</li>
<li>开发工具<ul>
<li><code>typing</code> —- 类型提示支持</li>
<li><code>pydoc</code> —- 文档生成器和在线帮助系统</li>
<li>Python Development Mode</li>
<li>Effects of the Python Development Mode</li>
<li>ResourceWarning Example</li>
<li>Bad file descriptor error example</li>
<li><code>doctest</code> —- 测试交互性的Python示例</li>
<li><code>unittest</code> —- 单元测试框架</li>
<li><code>unittest.mock</code> —- 模拟对象库</li>
<li><code>unittest.mock</code> 上手指南</li>
<li>2to3 - 自动将 Python 2 代码转为 Python 3 代码</li>
<li><code>test</code> —- Python回归测试包</li>
<li><code>test.support</code> —- Utilities for the Python test suite</li>
<li><code>test.support.socket_helper</code> —- Utilities for socket tests</li>
<li><code>test.support.script_helper</code> —- Utilities for the Python execution tests</li>
<li><code>test.support.bytecode_helper</code> —- Support tools for testing correct bytecode generation</li>
<li><code>test.support.threading_helper</code> —- Utilities for threading tests</li>
<li><code>test.support.os_helper</code> —- Utilities for os tests</li>
<li><code>test.support.import_helper</code> —- Utilities for import tests</li>
<li><code>test.support.warnings_helper</code> —- Utilities for warnings tests</li>
</ul>
</li>
<li>调试和分析<ul>
<li>审计事件表</li>
<li><code>bdb</code> —- Debugger framework</li>
<li><code>faulthandler</code> —- Dump the Python traceback</li>
<li><code>pdb</code> —- Python 的调试器</li>
<li>Python Profilers 分析器</li>
<li><code>timeit</code> —- 测量小代码片段的执行时间</li>
<li><code>trace</code> —- 跟踪Python语句的执行</li>
<li><code>tracemalloc</code> —- 跟踪内存分配</li>
</ul>
</li>
<li>软件打包和分发<ul>
<li><code>distutils</code> —- 构建和安装 Python 模块</li>
<li><code>ensurepip</code> —- Bootstrapping the <code>pip</code> installer</li>
<li><code>venv</code> —- 创建虚拟环境</li>
<li><code>zipapp</code> —- Manage executable Python zip archives</li>
</ul>
</li>
<li>Python运行时服务<ul>
<li><code>sys</code> —- 系统相关的参数和函数</li>
<li><code>sysconfig</code> —- Provide access to Python’s configuration information</li>
<li><code>builtins</code> —- 内建对象</li>
<li><code>__main__</code> —- Top-level code environment</li>
<li><code>warnings</code> —— 警告信息的控制</li>
<li><code>dataclasses</code> —- 数据类</li>
<li><code>contextlib</code> —- 为 <code>with</code>语句上下文提供的工具</li>
<li><code>abc</code> —- 抽象基类</li>
<li><code>atexit</code> —- 退出处理器</li>
<li><code>traceback</code> —- 打印或检索堆栈回溯</li>
<li><code>__future__</code> —- Future 语句定义</li>
<li><code>gc</code> —- 垃圾回收器接口</li>
<li><code>inspect</code> —- 检查对象</li>
<li><code>site</code> —— 指定域的配置钩子</li>
</ul>
</li>
<li>自定义 Python 解释器<ul>
<li><code>code</code> —- 解释器基类</li>
<li><code>codeop</code> —- 编译Python代码</li>
</ul>
</li>
<li>导入模块<ul>
<li><code>zipimport</code> —- 从 Zip 存档中导入模块</li>
<li><code>pkgutil</code> —- 包扩展工具</li>
<li><code>modulefinder</code> —- 查找脚本使用的模块</li>
<li><code>runpy</code> ——查找并执行 Python 模块</li>
<li><code>importlib</code> —- <code>import</code> 的实现</li>
<li>Using <code>importlib.metadata</code></li>
</ul>
</li>
<li>Python 语言服务<ul>
<li><code>ast</code> —- 抽象语法树</li>
<li><code>symtable</code> —- Access to the compiler’s symbol tables</li>
<li><code>token</code> —- 与Python解析树一起使用的常量</li>
<li><code>keyword</code> —- 检验Python关键字</li>
<li><code>tokenize</code> —- 对 Python 代码使用的标记解析器</li>
<li><code>tabnanny</code> —- 模糊缩进检测</li>
<li><code>pyclbr</code> —- Python 模块浏览器支持</li>
<li><code>py_compile</code> —- 编译 Python 源文件</li>
<li><code>compileall</code> —- Byte-compile Python libraries</li>
<li><code>dis</code> —- Python 字节码反汇编器</li>
<li><code>pickletools</code> —- pickle 开发者工具集</li>
</ul>
</li>
<li>Windows系统相关模块<ul>
<li><code>msilib</code> —- Read and write Microsoft Installer files</li>
<li><code>msvcrt</code> —- 来自 MS VC++ 运行时的有用例程</li>
<li><code>winreg</code> —- 访问 Windows 注册表</li>
<li><code>winsound</code> —— Windows 系统的音频播放接口</li>
</ul>
</li>
<li>Unix 专有服务<ul>
<li><code>posix</code> —- 最常见的 POSIX 系统调用</li>
<li><code>pwd</code> —- 用户密码数据库</li>
<li><code>spwd</code> —- The shadow password database</li>
<li><code>grp</code> —- 组数据库</li>
<li><code>crypt</code> —— 验证 Unix 口令的函数</li>
<li><code>termios</code> —- POSIX 风格的 tty 控制</li>
<li><code>tty</code> —- 终端控制功能</li>
<li><code>pty</code> —- 伪终端工具</li>
<li><code>fcntl</code> —— 系统调用 <code>fcntl</code> 和 <code>ioctl</code></li>
<li><code>pipes</code> —- 终端管道接口</li>
<li><code>resource</code> —- Resource usage information</li>
<li><code>nis</code> —- Sun 的 NIS (黄页) 接口</li>
<li>Unix syslog 库例程</li>
</ul>
</li>
<li>被取代的模块<ul>
<li><code>optparse</code> —- 解析器的命令行选项</li>
<li><code>imp</code> —- Access the import internals</li>
</ul>
</li>
<li>未创建文档的模块<ul>
<li>平台特定模块</li>
</ul>
</li>
<li>Security Considerations</li>
</ul>
<h1 id="并发执行"><a href="#并发执行" class="headerlink" title="并发执行"></a>并发执行</h1><p>本章中描述的模块支持并发执行代码。 适当的工具选择取决于要执行的任务（CPU密集型或IO密集型）和偏好的开发风格（事件驱动的协作式多任务或抢占式多任务处理）。 这是一个概述：</p>
<ul>
<li><code>threading</code> —- 基于线程的并行<ul>
<li>线程本地数据</li>
<li>线程对象</li>
<li>锁对象</li>
<li>递归锁对象</li>
<li>条件对象</li>
<li>信号量对象<ul>
<li><code>Semaphore</code> 例子</li>
</ul>
</li>
<li>事件对象</li>
<li>定时器对象</li>
<li>栅栏对象</li>
<li>在 <code>with</code> 语句中使用锁、条件和信号量</li>
</ul>
</li>
<li><code>multiprocessing</code> —- 基于进程的并行<ul>
<li>概述<ul>
<li><code>Process</code> 类</li>
<li>上下文和启动方法</li>
<li>在进程之间交换对象</li>
<li>进程间同步</li>
<li>进程间共享状态</li>
<li>使用工作进程</li>
</ul>
</li>
<li>参考<ul>
<li><code>Process</code> 和异常</li>
<li>管道和队列</li>
<li>杂项</li>
<li>连接对象（Connection）</li>
<li>同步原语</li>
<li>共享 <code>ctypes</code> 对象<ul>
<li><code>multiprocessing.sharedctypes</code> 模块</li>
</ul>
</li>
<li>管理器<ul>
<li>自定义管理器</li>
<li>使用远程管理器</li>
</ul>
</li>
<li>代理对象<ul>
<li>清理</li>
</ul>
</li>
<li>进程池</li>
<li>监听器及客户端<ul>
<li>地址格式</li>
</ul>
</li>
<li>认证密码</li>
<li>日志记录</li>
<li><code>multiprocessing.dummy</code> 模块</li>
</ul>
</li>
<li>编程指导<ul>
<li>所有start方法</li>
<li><em>spawn</em> 和 <em>forkserver</em> 启动方式</li>
</ul>
</li>
<li>例子</li>
</ul>
</li>
<li><code>multiprocessing.shared_memory</code> —- 可从进程直接访问的共享内存</li>
<li><code>concurrent</code> 包</li>
<li><code>concurrent.futures</code> —- 启动并行任务<ul>
<li>Executor 对象</li>
<li>ThreadPoolExecutor<ul>
<li>ThreadPoolExecutor 例子</li>
</ul>
</li>
<li>ProcessPoolExecutor<ul>
<li>ProcessPoolExecutor 例子</li>
</ul>
</li>
<li>Future 对象</li>
<li>模块函数</li>
<li>Exception 类</li>
</ul>
</li>
<li><code>subprocess</code> —- 子进程管理<ul>
<li>使用 <code>subprocess</code> 模块<ul>
<li>常用参数</li>
<li>Popen 构造函数</li>
<li>异常</li>
</ul>
</li>
<li>安全考量</li>
<li>Popen 对象</li>
<li>Windows Popen 助手<ul>
<li>Windows 常数</li>
</ul>
</li>
<li>较旧的高阶 API</li>
<li>使用 <code>subprocess</code> 模块替换旧函数<ul>
<li>替代 <strong>/bin/sh</strong> shell 命令替换</li>
<li>替代 shell 管道</li>
<li>替代 <code>os.system()</code></li>
<li>替代 <code>os.spawn</code> 函数族</li>
<li>替代 <code>os.popen()</code>, <code>os.popen2()</code>, <code>os.popen3()</code></li>
<li>来自 <code>popen2</code> 模块的替代函数</li>
</ul>
</li>
<li>旧式的 Shell 发起函数</li>
<li>备注<ul>
<li>在 Windows 上将参数列表转换为一个字符串</li>
</ul>
</li>
</ul>
</li>
<li><code>sched</code> —- 事件调度器<ul>
<li>调度器对象</li>
</ul>
</li>
<li><code>queue</code> —- 一个同步的队列类<ul>
<li>Queue对象</li>
<li>SimpleQueue 对象</li>
</ul>
</li>
<li><code>contextvars</code> —- 上下文变量<ul>
<li>上下文变量</li>
<li>手动上下文管理</li>
<li>asyncio 支持</li>
</ul>
</li>
</ul>
<p>以下是上述某些服务的支持模块：</p>
<ul>
<li><code>_thread</code> —- 底层多线程 API</li>
</ul>
<h2 id="threading-—-基于线程的并行"><a href="#threading-—-基于线程的并行" class="headerlink" title="threading —- 基于线程的并行"></a><code>threading</code> —- 基于线程的并行</h2><p><strong>源代码:</strong><a href="https://github.com/python/cpython/tree/3.10/Lib/threading.py" target="_blank" rel="noopener">Lib/threading.py</a></p>
<hr>
<p>这个模块在较低级的模块 <code>_thread</code> 基础上建立较高级的线程接口。</p>
<p>在 3.7 版更改: 这个模块曾经为可选项，但现在总是可用。</p>
<p>注解</p>
<p>在 Python 2.x 系列中，此模块包含有某些方法和函数 <code>camelCase</code> 形式的名称。 它们在 Python 3.10 中已弃用，但为了与 Python 2.5 及更旧版本的兼容性而仍受到支持。</p>
<p><strong>CPython implementation detail:</strong> 在 CPython 中，由于存在 全局解释器锁，同一时刻只有一个线程可以执行 Python 代码（虽然某些性能导向的库可能会去除此限制）。 如果你想让你的应用更好地利用多核心计算机的计算资源，推荐你使用 <code>multiprocessing</code> 或 <code>concurrent.futures.ProcessPoolExecutor</code>。 但是，如果你想要同时运行多个 I/O 密集型任务，则多线程仍然是一个合适的模型。</p>
<p>这个模块定义了以下函数：</p>
<p><code>threading.active_count</code>()</p>
<p>返回当前存活的 <code>Thread</code> 对象的数量。 返回值与 <code>enumerate()</code> 所返回的列表长度一致。</p>
<p>函数 <code>activeCount</code> 是此函数的已弃用别名。</p>
<p><code>threading.current_thread</code>()</p>
<p>返回当前对应调用者的控制线程的 <code>Thread</code> 对象。如果调用者的控制线程不是利用 <code>threading</code> 创建，会返回一个功能受限的虚拟线程对象。</p>
<p>函数 <code>currentThread</code> 是此函数的已弃用别名。</p>
<p><code>threading.excepthook</code>(<em>args</em>, <em>/</em>)</p>
<p>处理由 <code>Thread.run()</code> 引发的未捕获异常。</p>
<p><em>args</em> 参数具有以下属性:</p>
<ul>
<li><em>exc_type</em>: 异常类型</li>
<li><em>exc_value</em>: 异常值，可以是 <code>None</code>.</li>
<li><em>exc_traceback</em>: 异常回溯，可以是 <code>None</code>.</li>
<li><em>thread</em>: 引发异常的线程，可以为 <code>None</code>。</li>
</ul>
<p>如果 <em>exc_type</em> 为 <code>SystemExit</code>，则异常会被静默地忽略。 在其他情况下，异常将被打印到 <code>sys.stderr</code>。</p>
<p>如果此函数引发了异常，则会调用 <code>sys.excepthook()</code> 来处理它。</p>
<p><code>threading.excepthook()</code> 可以被重载以控制由 <code>Thread.run()</code> 引发的未捕获异常的处理方式。</p>
<p>使用定制钩子存放 <em>exc_value</em> 可能会创建引用循环。 它应当在不再需要异常时被显式地清空以打破引用循环。</p>
<p>如果一个对象正在被销毁，那么使用自定义的钩子储存 <em>thread</em> 可能会将其复活。请在自定义钩子生效后避免储存 <em>thread</em>，以避免对象的复活。</p>
<p>参见</p>
<p><code>sys.excepthook()</code> 处理未捕获的异常。</p>
<p>3.8 新版功能.</p>
<pre><code>threading.__excepthook__</code></pre><p>保存 <code>threading.excepthook()</code> 的原始值。 它被保存以便在原始值碰巧被已损坏或替代对象所替换的情况下可被恢复。</p>
<p>3.10 新版功能.</p>
<p><code>threading.get_ident</code>()</p>
<p>返回当前线程的 “线程标识符”。它是一个非零的整数。它的值没有直接含义，主要是用作 magic cookie，比如作为含有线程相关数据的字典的索引。线程标识符可能会在线程退出，新线程创建时被复用。</p>
<p>3.3 新版功能.</p>
<p><code>threading.get_native_id</code>()</p>
<p>返回内核分配给当前线程的原生集成线程 ID。 这是一个非负整数。 它的值可被用来在整个系统中唯一地标识这个特定线程（直到线程终结，在那之后该值可能会被 OS 回收再利用）。</p>
<p>可用性: Windows, FreeBSD, Linux, macOS, OpenBSD, NetBSD, AIX。</p>
<p>3.8 新版功能.</p>
<p><code>threading.enumerate</code>()</p>
<p>返回当前所有存活的 <code>Thread</code> 对象的列表。 该列表包括守护线程以及 <code>current_thread()</code> 创建的空线程。 它不包括已终结的和尚未开始的线程。 但是，主线程将总是结果的一部分，即使是在已终结的时候。</p>
<p><code>threading.main_thread</code>()</p>
<p>返回主 <code>Thread</code> 对象。一般情况下，主线程是Python解释器开始时创建的线程。</p>
<p>3.4 新版功能.</p>
<p><code>threading.settrace</code>(<em>func</em>)</p>
<p>为所有 <code>threading</code> 模块开始的线程设置追踪函数。在每个线程的 <code>run()</code> 方法被调用前，<em>func</em> 会被传递给 <code>sys.settrace()</code> 。</p>
<p><code>threading.gettrace</code>()</p>
<p>返回由 <code>settrace()</code> 设置的跟踪函数。</p>
<p>3.10 新版功能.</p>
<p><code>threading.setprofile</code>(<em>func</em>)</p>
<p>为所有 <code>threading</code> 模块开始的线程设置性能测试函数。在每个线程的 <code>run()</code> 方法被调用前，<em>func</em> 会被传递给 <code>sys.setprofile()</code> 。</p>
<p><code>threading.getprofile</code>()</p>
<p>返回由 <code>setprofile()</code> 设置的性能分析函数。</p>
<p>3.10 新版功能.</p>
<p><code>threading.stack_size</code>([<em>size</em>])</p>
<p>返回创建线程时使用的堆栈大小。可选参数 <em>size</em> 指定之后新建的线程的堆栈大小，而且一定要是0（根据平台或者默认配置）或者最小是32,768(32KiB)的一个正整数。如果 <em>size</em> 没有指定，默认是0。如果不支持改变线程堆栈大小，会抛出 <code>RuntimeError</code> 错误。如果指定的堆栈大小不合法，会抛出 <code>ValueError</code> 错误并且不会修改堆栈大小。32KiB是当前最小的能保证解释器有足够堆栈空间的堆栈大小。需要注意的是部分平台对于堆栈大小会有特定的限制，例如要求大于32KiB的堆栈大小或者需要根据系统内存页面的整数倍进行分配 - 应当查阅平台文档有关详细信息（4KiB页面比较普遍，在没有更具体信息的情况下，建议的方法是使用4096的倍数作为堆栈大小）。</p>
<p>适用于: Windows，具有 POSIX 线程的系统。</p>
<p>这个模块同时定义了以下常量：</p>
<pre><code>threading.TIMEOUT_MAX</code></pre><p>阻塞函数（ <code>Lock.acquire()</code>, <code>RLock.acquire()</code>, <code>Condition.wait()</code>, …）中形参 <em>timeout</em> 允许的最大值。传入超过这个值的 timeout 会抛出 <code>OverflowError</code> 异常。</p>
<p>3.2 新版功能.</p>
<p>这个模块定义了许多类，详见以下部分。</p>
<p>该模块的设计基于 Java的线程模型。 但是，在Java里面，锁和条件变量是每个对象的基础特性，而在Python里面，这些被独立成了单独的对象。 Python 的 <code>Thread</code> 类只是 Java 的 Thread 类的一个子集；目前还没有优先级，没有线程组，线程还不能被销毁、停止、暂停、恢复或中断。 Java 的 Thread 类的静态方法在实现时会映射为模块级函数。</p>
<p>下述方法的执行都是原子性的。</p>
<h3 id="线程本地数据"><a href="#线程本地数据" class="headerlink" title="线程本地数据"></a>线程本地数据</h3><p>线程本地数据是特定线程的数据。管理线程本地数据，只需要创建一个 <code>local</code> （或者一个子类型）的实例并在实例中储存属性：</p>
<pre class="line-numbers language-python"><code class="language-python">mydata <span class="token operator">=</span> threading<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token punctuation">)</span>
mydata<span class="token punctuation">.</span>x <span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在不同的线程中，实例的值会不同。</p>
<p><em>class</em><code>threading.local</code></p>
<p>一个代表线程本地数据的类。</p>
<p>更多相关细节和大量示例，参见 <code>_threading_local</code> 模块的文档。</p>
<h3 id="线程对象"><a href="#线程对象" class="headerlink" title="线程对象"></a>线程对象</h3><p>The <code>Thread</code> class represents an activity that is run in a separate thread of control. There are two ways to specify the activity: by passing a callable object to the constructor, or by overriding the <code>run()</code> method in a subclass. No other methods (except for the constructor) should be overridden in a subclass. In other words, <em>only</em> override the <code>__init__()</code> and <code>run()</code> methods of this class.</p>
<p>当线程对象一但被创建，其活动一定会因调用线程的 <code>start()</code> 方法开始。这会在独立的控制线程调用 <code>run()</code> 方法。</p>
<p>一旦线程活动开始，该线程会被认为是 ‘存活的’ 。当它的 <code>run()</code> 方法终结了（不管是正常的还是抛出未被处理的异常），就不是’存活的’。 <code>is_alive()</code> 方法用于检查线程是否存活。</p>
<p>其他线程可以调用一个线程的 <code>join()</code> 方法。这会阻塞调用该方法的线程，直到被调用 <code>join()</code> 方法的线程终结。</p>
<p>线程有名字。名字可以传递给构造函数，也可以通过 <code>name</code> 属性读取或者修改。</p>
<p>如果 <code>run()</code> 方法引发了异常，则会调用 <code>threading.excepthook()</code> 来处理它。 在默认情况下，<code>threading.excepthook()</code> 会静默地忽略 <code>SystemExit</code>。</p>
<p>一个线程可以被标记成一个“守护线程”。 这个标识的意义是，当剩下的线程都是守护线程时，整个 Python 程序将会退出。 初始值继承于创建线程。 这个标识可以通过 <code>daemon</code> 特征属性或者 <em>daemon</em> 构造器参数来设置。</p>
<p>注解</p>
<p>守护线程在程序关闭时会突然关闭。他们的资源（例如已经打开的文档，数据库事务等等）可能没有被正确释放。如果你想你的线程正常停止，设置他们成为非守护模式并且使用合适的信号机制，例如： <code>Event</code>。</p>
<p>有个 “主线程” 对象；这对应Python程序里面初始的控制线程。它不是一个守护线程。</p>
<p>“虚拟线程对象” 是可以被创建的。这些是对应于“外部线程”的线程对象，它们是在线程模块外部启动的控制线程，例如直接来自C代码。虚拟线程对象功能受限；他们总是被认为是存活的和守护模式，不能被 <code>join()</code> 。因为无法检测外来线程的终结，它们永远不会被删除。</p>
<p><em>class<em><code>threading.Thread</code>(</em>group=None</em>, <em>target=None</em>, <em>name=None</em>, <em>args=()</em>, <em>kwargs={}</em>, <em>**,</em> daemon=None*)</p>
<p>调用这个构造函数时，必需带有关键字参数。参数如下：</p>
<p><em>group</em> 应该为 <code>None</code>；为了日后扩展 <code>ThreadGroup</code> 类实现而保留。</p>
<p><em>target</em> 是用于 <code>run()</code> 方法调用的可调用对象。默认是 <code>None</code>，表示不需要调用任何方法。</p>
<p><em>name</em> 是线程名称。 在默认情况下，会以 “Thread-<em>N</em>“ 的形式构造唯一名称，其中 <em>N</em> 为一个较小的十进制数值，或是 “Thread-<em>N</em> (target)” 的形式，其中 “target” 为 <code>target.__name__</code>，如果指定了 <em>target</em> 参数的话。</p>
<p><em>args</em> 是用于调用目标函数的参数元组。默认是 <code>()</code>。</p>
<p><em>kwargs</em> 是用于调用目标函数的关键字参数字典。默认是 <code>{}</code>。</p>
<p>如果不是 <code>None</code>，<em>daemon</em> 参数将显式地设置该线程是否为守护模式。 如果是 <code>None</code> (默认值)，线程将继承当前线程的守护模式属性。</p>
<p>如果子类型重载了构造函数，它一定要确保在做任何事前，先发起调用基类构造器(<code>Thread.__init__()</code>)。</p>
<p>在 3.10 版更改: 使用 <em>target</em> 名称，如果 <em>name</em> 参数被省略的话。</p>
<p>在 3.3 版更改: 加入 <em>daemon</em> 参数。</p>
<ul>
<li><p><code>start</code>()</p>
<p>开始线程活动。</p>
<p>它在一个线程里最多只能被调用一次。它安排对象的 <code>run()</code> 方法在一个独立的控制进程中调用。</p>
<p>如果同一个线程对象中调用这个方法的次数大于一次，会抛出 <code>RuntimeError</code> 。</p>
</li>
<li><p><code>run</code>()</p>
<p>代表线程活动的方法。</p>
<p>你可以在子类型里重载这个方法。 标准的 <code>run()</code> 方法会对作为 <em>target</em> 参数传递给该对象构造器的可调用对象（如果存在）发起调用，并附带从 <em>args</em> 和 <em>kwargs</em> 参数分别获取的位置和关键字参数。</p>
</li>
<li><p><code>join</code>(<em>timeout=None</em>)</p>
<p>等待，直到线程终结。这会阻塞调用这个方法的线程，直到被调用 <code>join()</code> 的线程终结 — 不管是正常终结还是抛出未处理异常 — 或者直到发生超时，超时选项是可选的。</p>
<p>当 <em>timeout</em> 参数存在而且不是 <code>None</code> 时，它应该是一个用于指定操作超时的以秒为单位的浮点数或者分数。因为 <code>join()</code> 总是返回 <code>None</code> ，所以你一定要在 <code>join()</code> 后调用 <code>is_alive()</code> 才能判断是否发生超时 — 如果线程仍然存活，则 <code>join()</code> 超时。</p>
<p>当 <em>timeout</em> 参数不存在或者是 <code>None</code> ，这个操作会阻塞直到线程终结。</p>
<p>一个线程可以被 <code>join()</code> 很多次。</p>
<p>如果尝试加入当前线程会导致死锁， <code>join()</code> 会引起 <code>RuntimeError</code> 异常。如果尝试 <code>join()</code> 一个尚未开始的线程，也会抛出相同的异常。</p>
</li>
<li><p><code>name</code></p>
<p>只用于识别的字符串。它没有语义。多个线程可以赋予相同的名称。 初始名称由构造函数设置。</p>
</li>
<li><p><code>getName</code>()</p>
<p><code>setName</code>()</p>
<p>已被弃用的 <code>name</code> 的取值/设值 API；请改为直接以特征属性方式使用它。</p>
<p>3.10 版后已移除.</p>
</li>
<li><p><code>ident</code></p>
<p>这个线程的 ‘线程标识符’，如果线程尚未开始则为 <code>None</code> 。这是个非零整数。当一个线程退出而另外一个线程被创建，线程标识符会被复用。即使线程退出后，仍可得到标识符。</p>
</li>
<li><p><code>native_id</code></p>
<p>此线程的线程 ID (<code>TID</code>)，由 OS (内核) 分配。 这是一个非负整数，或者如果线程还未启动则为 <code>None</code>。 这个值可被用来在全系统范围内唯一地标识这个特定线程 (直到线程终结，在那之后该值可能会被 OS 回收再利用)。</p>
<p>注解</p>
<p>类似于进程 ID，线程 ID 的有效期（全系统范围内保证唯一）将从线程被创建开始直到线程被终结。</p>
<p>可用性: 需要 <code>get_native_id()</code> 函数。</p>
<p>3.8 新版功能.</p>
</li>
<li><p><code>is_alive</code>()</p>
<p>返回线程是否存活。</p>
<p>当 <code>run()</code> 方法刚开始直到 <code>run()</code> 方法刚结束，这个方法返回 <code>True</code> 。模块函数 <code>enumerate()</code> 返回包含所有存活线程的列表。</p>
</li>
<li><p><code>daemon</code></p>
<p>一个表示这个线程是（True）否（False）守护线程的布尔值。一定要在调用 <code>start()</code> 前设置好，不然会抛出 <code>RuntimeError</code> 。初始值继承于创建线程；主线程不是守护线程，因此主线程创建的所有线程默认都是 <code>daemon</code> = <code>False</code>。</p>
<p>当没有存活的非守护线程时，整个Python程序才会退出。</p>
</li>
<li><p><code>isDaemon</code>()</p>
<p><code>setDaemon</code>()</p>
<p>已被弃用的 <code>daemon</code> 的取值/设值 API；请改为直接以特征属性方式使用它。</p>
<p>3.10 版后已移除.</p>
</li>
</ul>
<h3 id="锁对象"><a href="#锁对象" class="headerlink" title="锁对象"></a>锁对象</h3><p>原始锁是一个在锁定时不属于特定线程的同步基元组件。在Python中，它是能用的最低级的同步基元组件，由 <code>_thread</code> 扩展模块直接实现。</p>
<p>原始锁处于 “锁定” 或者 “非锁定” 两种状态之一。它被创建时为非锁定状态。它有两个基本方法， <code>acquire()</code> 和 <code>release()</code> 。当状态为非锁定时， <code>acquire()</code> 将状态改为 锁定 并立即返回。当状态是锁定时， <code>acquire()</code> 将阻塞至其他线程调用 <code>release()</code> 将其改为非锁定状态，然后 <code>acquire()</code> 调用重置其为锁定状态并返回。 <code>release()</code> 只在锁定状态下调用； 它将状态改为非锁定并立即返回。如果尝试释放一个非锁定的锁，则会引发 <code>RuntimeError</code> 异常。</p>
<p>锁同样支持 上下文管理协议。</p>
<p>当多个线程在 <code>acquire()</code> 等待状态转变为未锁定被阻塞，然后 <code>release()</code> 重置状态为未锁定时，只有一个线程能继续执行；至于哪个等待线程继续执行没有定义，并且会根据实现而不同。</p>
<p>所有方法的执行都是原子性的。</p>
<p><em>class</em><code>threading.Lock</code></p>
<p>实现原始锁对象的类。一旦一个线程获得一个锁，会阻塞随后尝试获得锁的线程，直到它被释放；任何线程都可以释放它。</p>
<p>需要注意的是 <code>Lock</code> 其实是一个工厂函数，返回平台支持的具体锁类中最有效的版本的实例。</p>
<ul>
<li><p><code>acquire</code>(<em>blocking=True</em>, <em>timeout=- 1</em>)</p>
<p>可以阻塞或非阻塞地获得锁。</p>
<p>当调用时参数 <em>blocking</em> 设置为 <code>True</code> （缺省值），阻塞直到锁被释放，然后将锁锁定并返回 <code>True</code> 。</p>
<p>在参数 <em>blocking</em> 被设置为 <code>False</code> 的情况下调用，将不会发生阻塞。如果调用时 <em>blocking</em> 设为 <code>True</code> 会阻塞，并立即返回 <code>False</code> ；否则，将锁锁定并返回 <code>True</code>。</p>
<p>当浮点型 <em>timeout</em> 参数被设置为正值调用时，只要无法获得锁，将最多阻塞 <em>timeout</em> 设定的秒数。<em>timeout</em> 参数被设置为 <code>-1</code> 时将无限等待。当 <em>blocking</em> 为 false 时，<em>timeout</em> 指定的值将被忽略。</p>
<p>如果成功获得锁，则返回 <code>True</code>，否则返回 <code>False</code> (例如发生 <em>超时</em> 的时候)。</p>
<p>在 3.2 版更改: 新的 <em>timeout</em> 形参。</p>
<p>在 3.2 版更改: 现在如果底层线程实现支持，则可以通过POSIX上的信号中断锁的获取。</p>
</li>
<li><p><code>release</code>()</p>
<p>释放一个锁。这个方法可以在任何线程中调用，不单指获得锁的线程。</p>
<p>当锁被锁定，将它重置为未锁定，并返回。如果其他线程正在等待这个锁解锁而被阻塞，只允许其中一个允许。</p>
<p>当在未锁定的锁上发起调用时，会引发 <code>RuntimeError</code>。</p>
<p>没有返回值。</p>
</li>
<li><p><code>locked</code>()</p>
<p>如果获得了锁则返回真值。</p>
</li>
</ul>
<h3 id="递归锁对象"><a href="#递归锁对象" class="headerlink" title="递归锁对象"></a>递归锁对象</h3><p>重入锁是一个可以被同一个线程多次获取的同步基元组件。在内部，它在基元锁的锁定/非锁定状态上附加了 “所属线程” 和 “递归等级” 的概念。在锁定状态下，某些线程拥有锁 ； 在非锁定状态下， 没有线程拥有它。</p>
<p>若要锁定锁，线程调用其 <code>acquire()</code> 方法；一旦线程拥有了锁，方法将返回。若要解锁，线程调用 <code>release()</code> 方法。 <code>acquire()</code>/<code>release()</code> 对可以嵌套；只有最终 <code>release()</code> (最外面一对的 <code>release()</code> ) 将锁解开，才能让其他线程继续处理 <code>acquire()</code> 阻塞。</p>
<p>递归锁也支持 上下文管理协议。</p>
<p><em>class</em><code>threading.RLock</code></p>
<p>此类实现了重入锁对象。重入锁必须由获取它的线程释放。一旦线程获得了重入锁，同一个线程再次获取它将不阻塞；线程必须在每次获取它时释放一次。</p>
<p>需要注意的是 <code>RLock</code> 其实是一个工厂函数，返回平台支持的具体递归锁类中最有效的版本的实例。</p>
<ul>
<li><p><code>acquire</code>(<em>blocking=True</em>, <em>timeout=- 1</em>)</p>
<p>可以阻塞或非阻塞地获得锁。</p>
<p>当无参数调用时： 如果这个线程已经拥有锁，递归级别增加一，并立即返回。否则，如果其他线程拥有该锁，则阻塞至该锁解锁。一旦锁被解锁(不属于任何线程)，则抢夺所有权，设置递归等级为一，并返回。如果多个线程被阻塞，等待锁被解锁，一次只有一个线程能抢到锁的所有权。在这种情况下，没有返回值。</p>
<p>当发起调用时将 <em>blocking</em> 参数设为真值，则执行与无参数调用时一样的操作，然后返回 <code>True</code>。</p>
<p>当发起调用时将 <em>blocking</em> 参数设为假值，则不进行阻塞。 如果一个无参数调用将要阻塞，则立即返回 <code>False</code>；在其他情况下，执行与无参数调用时一样的操作，然后返回 <code>True</code>。</p>
<p>当发起调用时将浮点数的 <em>timeout</em> 参数设为正值时，只要无法获得锁，将最多阻塞 <em>timeout</em> 所指定的秒数。 如果已经获得锁则返回 <code>True</code>，如果超时则返回假值。</p>
<p>在 3.2 版更改: 新的 <em>timeout</em> 形参。</p>
</li>
<li><p><code>release</code>()</p>
<p>释放锁，自减递归等级。如果减到零，则将锁重置为非锁定状态(不被任何线程拥有)，并且，如果其他线程正被阻塞着等待锁被解锁，则仅允许其中一个线程继续。如果自减后，递归等级仍然不是零，则锁保持锁定，仍由调用线程拥有。</p>
<p>只有当前线程拥有锁才能调用这个方法。如果锁被释放后调用这个方法，会引起 <code>RuntimeError</code> 异常。</p>
<p>没有返回值。</p>
</li>
</ul>
<h3 id="条件对象"><a href="#条件对象" class="headerlink" title="条件对象"></a>条件对象</h3><p>条件变量总是与某种类型的锁对象相关联，锁对象可以通过传入获得，或者在缺省的情况下自动创建。当多个条件变量需要共享同一个锁时，传入一个锁很有用。锁是条件对象的一部分，你不必单独地跟踪它。</p>
<p>条件变量遵循 上下文管理协议 ：使用 <code>with</code> 语句会在它包围的代码块内获取关联的锁。 <code>acquire()</code> 和 <code>release()</code> 方法也能调用关联锁的相关方法。</p>
<p>其它方法必须在持有关联的锁的情况下调用。 <code>wait()</code> 方法释放锁，然后阻塞直到其它线程调用 <code>notify()</code> 方法或 <code>notify_all()</code> 方法唤醒它。一旦被唤醒， <code>wait()</code> 方法重新获取锁并返回。它也可以指定超时时间。</p>
<p>The <code>notify()</code> method wakes up one of the threads waiting for the condition variable, if any are waiting. The <code>notify_all()</code> method wakes up all threads waiting for the condition variable.</p>
<p>注意： <code>notify()</code> 方法和 <code>notify_all()</code> 方法并不会释放锁，这意味着被唤醒的线程不会立即从它们的 <code>wait()</code> 方法调用中返回，而是会在调用了 <code>notify()</code> 方法或 <code>notify_all()</code> 方法的线程最终放弃了锁的所有权后返回。</p>
<p>使用条件变量的典型编程风格是将锁用于同步某些共享状态的权限，那些对状态的某些特定改变感兴趣的线程，它们重复调用 <code>wait()</code> 方法，直到看到所期望的改变发生；而对于修改状态的线程，它们将当前状态改变为可能是等待者所期待的新状态后，调用 <code>notify()</code> 方法或者 <code>notify_all()</code> 方法。例如，下面的代码是一个通用的无限缓冲区容量的生产者-消费者情形：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Consume one item</span>
<span class="token keyword">with</span> cv<span class="token punctuation">:</span>
whilenot an_item_is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cv<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    get_an_available_item<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Produce one item</span>
<span class="token keyword">with</span> cv<span class="token punctuation">:</span>
    make_an_item_available<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>while</code> 循环检查所要求的条件成立与否是有必要的，因为 <code>wait()</code> 方法可能要经过不确定长度的时间后才会返回，而此时导致 <code>notify()</code> 方法调用的那个条件可能已经不再成立。这是多线程编程所固有的问题。 <code>wait_for()</code> 方法可自动化条件检查，并简化超时计算。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Consume an item</span>
<span class="token keyword">with</span> cv<span class="token punctuation">:</span>
    cv<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>an_item_is_available<span class="token punctuation">)</span>
    get_an_available_item<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>选择 <code>notify()</code> 还是 <code>notify_all()</code> ，取决于一次状态改变是只能被一个还是能被多个等待线程所用。例如在一个典型的生产者-消费者情形中，添加一个项目到缓冲区只需唤醒一个消费者线程。</p>
<p><em>class<em><code>threading.Condition</code>(</em>lock=None</em>)</p>
<p>实现条件变量对象的类。一个条件变量对象允许一个或多个线程在被其它线程所通知之前进行等待。</p>
<p>如果给出了非 <code>None</code> 的 <em>lock</em> 参数，则它必须为 <code>Lock</code> 或者 <code>RLock</code> 对象，并且它将被用作底层锁。否则，将会创建新的 <code>RLock</code> 对象，并将其用作底层锁。</p>
<p>在 3.3 版更改: 从工厂函数变为类。</p>
<ul>
<li><p><code>acquire</code>(<em>\</em>args*)</p>
<p>请求底层锁。此方法调用底层锁的相应方法，返回值是底层锁相应方法的返回值。</p>
</li>
<li><p><code>release</code>()</p>
<p>释放底层锁。此方法调用底层锁的相应方法。没有返回值。</p>
</li>
<li><p><code>wait</code>(<em>timeout=None</em>)</p>
<p>等待直到被通知或发生超时。如果线程在调用此方法时没有获得锁，将会引发 <code>RuntimeError</code> 异常。</p>
<p>这个方法释放底层锁，然后阻塞，直到在另外一个线程中调用同一个条件变量的 <code>notify()</code> 或 <code>notify_all()</code> 唤醒它，或者直到可选的超时发生。一旦被唤醒或者超时，它重新获得锁并返回。</p>
<p>当提供了 <em>timeout</em> 参数且不是 <code>None</code> 时，它应该是一个浮点数，代表操作的超时时间，以秒为单位（可以为小数）。</p>
<p>当底层锁是个 <code>RLock</code> ，不会使用它的 <code>release()</code> 方法释放锁，因为当它被递归多次获取时，实际上可能无法解锁。相反，使用了 <code>RLock</code> 类的内部接口，即使多次递归获取它也能解锁它。 然后，在重新获取锁时，使用另一个内部接口来恢复递归级别。</p>
<p>返回 <code>True</code> ，除非提供的 <em>timeout</em> 过期，这种情况下返回 <code>False</code>。</p>
<p>在 3.2 版更改: 很明显，方法总是返回 <code>None</code>。</p>
</li>
<li><p><code>wait_for</code>(<em>predicate</em>, <em>timeout=None</em>)</p>
<p>等待，直到条件计算为真。 <em>predicate</em> 应该是一个可调用对象而且它的返回值可被解释为一个布尔值。可以提供 <em>timeout</em> 参数给出最大等待时间。</p>
<p>这个实用方法会重复地调用 <code>wait()</code> 直到满足判断式或者发生超时。返回值是判断式最后一个返回值，而且如果方法发生超时会返回 <code>False</code> 。</p>
<p>忽略超时功能，调用此方法大致相当于编写:</p>
<pre class="line-numbers language-python"><code class="language-python">whilenot predicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cv<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>因此，规则同样适用于 <code>wait()</code> ：锁必须在被调用时保持获取，并在返回时重新获取。 随着锁定执行判断式。</p>
<p>3.2 新版功能.</p>
</li>
<li><p><code>notify</code>(<em>n=1</em>)</p>
<p>默认唤醒一个等待这个条件的线程。如果调用线程在没有获得锁的情况下调用这个方法，会引发 <code>RuntimeError</code> 异常。</p>
<p>这个方法唤醒最多 <em>n</em> 个正在等待这个条件变量的线程；如果没有线程在等待，这是一个空操作。</p>
<p>当前实现中，如果至少有 <em>n</em> 个线程正在等待，准确唤醒 <em>n</em> 个线程。但是依赖这个行为并不安全。未来，优化的实现有时会唤醒超过 <em>n</em> 个线程。</p>
<p>注意：被唤醒的线程实际上不会返回它调用的 <code>wait()</code> ，直到它可以重新获得锁。因为 <code>notify()</code> 不会释放锁，只有它的调用者应该这样做。</p>
</li>
<li><p><code>notify_all</code>()</p>
<p>唤醒所有正在等待这个条件的线程。这个方法行为与 <code>notify()</code> 相似，但并不只唤醒单一线程，而是唤醒所有等待线程。如果调用线程在调用这个方法时没有获得锁，会引发 <code>RuntimeError</code> 异常。</p>
<p><code>notifyAll</code> 方法是此方法的已弃用别名。</p>
</li>
</ul>
<h3 id="信号量对象"><a href="#信号量对象" class="headerlink" title="信号量对象"></a>信号量对象</h3><p>这是计算机科学史上最古老的同步原语之一，早期的荷兰科学家 Edsger W. Dijkstra 发明了它。（他使用名称 <code>P()</code> 和 <code>V()</code> 而不是 <code>acquire()</code> 和 <code>release()</code> ）。</p>
<p>一个信号量管理一个内部计数器，该计数器因 <code>acquire()</code> 方法的调用而递减，因 <code>release()</code> 方法的调用而递增。 计数器的值永远不会小于零；当 <code>acquire()</code> 方法发现计数器为零时，将会阻塞，直到其它线程调用 <code>release()</code> 方法。</p>
<p>信号量对象也支持 上下文管理协议 。</p>
<p><em>class<em><code>threading.Semaphore</code>(</em>value=1</em>)</p>
<p>该类实现信号量对象。信号量对象管理一个原子性的计数器，代表 <code>release()</code> 方法的调用次数减去 <code>acquire()</code> 的调用次数再加上一个初始值。如果需要， <code>acquire()</code> 方法将会阻塞直到可以返回而不会使得计数器变成负数。在没有显式给出 <em>value</em> 的值时，默认为1。</p>
<p>可选参数 <em>value</em> 赋予内部计数器初始值，默认值为 <code>1</code> 。如果 <em>value</em> 被赋予小于0的值，将会引发 <code>ValueError</code> 异常。</p>
<p>在 3.3 版更改: 从工厂函数变为类。</p>
<ul>
<li><p><code>acquire</code>(<em>blocking=True</em>, <em>timeout=None</em>)</p>
<p>获取一个信号量。</p>
<p>在不带参数的情况下调用时：</p>
<ul>
<li>如果在进入时内部计数器的值大于零，则将其减一并立即返回 <code>True</code>。</li>
<li>如果在进入时内部计数器的值为零，则将会阻塞直到被对 <code>release()</code> 的调用唤醒。 一旦被唤醒（并且计数器的值大于 0），则将计数器减 1 并返回 <code>True</code>。 每次对 <code>release()</code> 的调用将只唤醒一个线程。 线程被唤醒的次序是不可确定的。</li>
</ul>
<p>当发起调用时将 <em>blocking</em> 设为假值，则不进行阻塞。 如果一个无参数调用将要阻塞，则立即返回 <code>False</code>；在其他情况下，执行与无参数调用时一样的操作，然后返回 <code>True</code>。</p>
<p>当发起调用时如果 <em>timeout</em> 不为 <code>None</code>，则它将阻塞最多 <em>timeout</em> 秒。 请求在此时段时未能成功完成获取则将返回 <code>False</code>。 在其他情况下返回 <code>True</code>。</p>
<p>在 3.2 版更改: 新的 <em>timeout</em> 形参。</p>
</li>
<li><p><code>release</code>(<em>n=1</em>)</p>
<p>释放一个信号量，将内部计数器的值增加 <em>n</em>。 当进入时值为零且有其他线程正在等待它再次变为大于零时，则唤醒那 <em>n</em> 个线程。</p>
<p>在 3.9 版更改: 增加了 <em>n</em> 形参以一次性释放多个等待线程。</p>
</li>
</ul>
<p><em>class<em><code>threading.BoundedSemaphore</code>(</em>value=1</em>)</p>
<p>该类实现有界信号量。有界信号量通过检查以确保它当前的值不会超过初始值。如果超过了初始值，将会引发 <code>ValueError</code> 异常。在大多情况下，信号量用于保护数量有限的资源。如果信号量被释放的次数过多，则表明出现了错误。没有指定时， <em>value</em> 的值默认为1。</p>
<p>在 3.3 版更改: 从工厂函数变为类。</p>
<h4 id="Semaphore-例子"><a href="#Semaphore-例子" class="headerlink" title="Semaphore 例子"></a><code>Semaphore</code> 例子</h4><p>信号量通常用于保护数量有限的资源，例如数据库服务器。在资源数量固定的任何情况下，都应该使用有界信号量。在生成任何工作线程前，应该在主线程中初始化信号量。</p>
<pre class="line-numbers language-python"><code class="language-python">maxconnections <span class="token operator">=</span><span class="token number">5</span>
<span class="token comment" spellcheck="true"># ...</span>
pool_sema <span class="token operator">=</span>BoundedSemaphore<span class="token punctuation">(</span>value<span class="token operator">=</span>maxconnections<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>工作线程生成后，当需要连接服务器时，这些线程将调用信号量的 acquire 和 release 方法：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">with</span> pool_sema<span class="token punctuation">:</span>
    conn <span class="token operator">=</span> connectdb<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true"># ... use connection ...</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用有界信号量能减少这种编程错误：信号量的释放次数多于其请求次数。</p>
<h3 id="事件对象"><a href="#事件对象" class="headerlink" title="事件对象"></a>事件对象</h3><p>这是线程之间通信的最简单机制之一：一个线程发出事件信号，而其他线程等待该信号。</p>
<p>一个事件对象管理一个内部标识，调用 <code>set()</code> 方法可将其设置为 true ，调用 <code>clear()</code> 方法可将其设置为 false ，调用 <code>wait()</code> 方法将进入阻塞直到标识为 true 。</p>
<p><em>class</em><code>threading.Event</code></p>
<p>实现事件对象的类。事件对象管理一个内部标识，调用 <code>set()</code> 方法可将其设置为true。调用 <code>clear()</code> 方法可将其设置为 false 。调用 <code>wait()</code> 方法将进入阻塞直到标识为true。这个标识初始时为 false 。</p>
<p>在 3.3 版更改: 从工厂函数变为类。</p>
<ul>
<li><p><code>is_set</code>()</p>
<p>当且仅当内部标识为 true 时返回 <code>True</code> 。</p>
<p><code>isSet</code> 方法是此方法的已弃用别名。</p>
</li>
<li><p><code>set</code>()</p>
<p>将内部标识设置为 true 。所有正在等待这个事件的线程将被唤醒。当标识为 true 时，调用 <code>wait()</code> 方法的线程不会被被阻塞。</p>
</li>
<li><p><code>clear</code>()</p>
<p>将内部标识设置为 false 。之后调用 <code>wait()</code> 方法的线程将会被阻塞，直到调用 <code>set()</code> 方法将内部标识再次设置为 true 。</p>
</li>
<li><p><code>wait</code>(<em>timeout=None</em>)</p>
<p>阻塞线程直到内部变量为 true 。如果调用时内部标识为 true，将立即返回。否则将阻塞线程，直到调用 <code>set()</code> 方法将标识设置为 true 或者发生可选的超时。</p>
<p>当提供了timeout参数且不是 <code>None</code> 时，它应该是一个浮点数，代表操作的超时时间，以秒为单位（可以为小数）。</p>
<p>当且仅当内部旗标在等待调用之前或者等待开始之后被设为真值时此方法将返回 <code>True</code>，也就是说，它将总是返回 <code>True</code> 除非设定了超时且操作发生了超时。</p>
<p>在 3.1 版更改: 很明显，方法总是返回 <code>None</code>。</p>
</li>
</ul>
<h3 id="定时器对象"><a href="#定时器对象" class="headerlink" title="定时器对象"></a>定时器对象</h3><p>此类表示一个操作应该在等待一定的时间之后运行 —- 相当于一个定时器。 <code>Timer</code> 类是 <code>Thread</code> 类的子类，因此可以像一个自定义线程一样工作。</p>
<p>与线程一样，通过调用 <code>start()</code> 方法启动定时器。而 <code>cancel()</code> 方法可以停止计时器（在计时结束前）， 定时器在执行其操作之前等待的时间间隔可能与用户指定的时间间隔不完全相同。</p>
<p>例如：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hello, world"</span><span class="token punctuation">)</span>
t <span class="token operator">=</span>Timer<span class="token punctuation">(</span><span class="token number">30.0</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># after 30 seconds, "hello, world" will be printed</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>class<em><code>threading.Timer</code>(</em>interval</em>, <em>function</em>, <em>args=None</em>, <em>kwargs=None</em>)</p>
<p>创建一个定时器，在经过 <em>interval</em> 秒的间隔事件后，将会用参数 <em>args</em> 和关键字参数 <em>kwargs</em> 调用 <em>function*。如果 *args</em> 为 <code>None</code> （默认值），则会使用一个空列表。如果 <em>kwargs</em> 为 <code>None</code> （默认值），则会使用一个空字典。</p>
<p>在 3.3 版更改: 从工厂函数变为类。</p>
<ul>
<li><p><code>cancel</code>()</p>
<p>停止定时器并取消执行计时器将要执行的操作。仅当计时器仍处于等待状态时有效。</p>
</li>
</ul>
<h3 id="栅栏对象"><a href="#栅栏对象" class="headerlink" title="栅栏对象"></a>栅栏对象</h3><p>3.2 新版功能.</p>
<p>栅栏类提供一个简单的同步原语，用于应对固定数量的线程需要彼此相互等待的情况。线程调用 <code>wait()</code> 方法后将阻塞，直到所有线程都调用了 <code>wait()</code> 方法。此时所有线程将被同时释放。</p>
<p>栅栏对象可以被多次使用，但进程的数量不能改变。</p>
<p>这是一个使用简便的方法实现客户端进程与服务端进程同步的例子：</p>
<pre class="line-numbers language-python"><code class="language-python">b <span class="token operator">=</span>Barrier<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
whileTrue<span class="token punctuation">:</span>
        connection <span class="token operator">=</span> accept_connection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        process_server_connection<span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    b<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
whileTrue<span class="token punctuation">:</span>
        connection <span class="token operator">=</span> make_connection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        process_client_connection<span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>class<em><code>threading.Barrier</code>(</em>parties</em>, <em>action=None</em>, <em>timeout=None</em>)</p>
<p>创建一个需要 <em>parties</em> 个线程的栅栏对象。如果提供了可调用的 <em>action</em> 参数，它会在所有线程被释放时在其中一个线程中自动调用。 <em>timeout</em> 是默认的超时时间，如果没有在 <code>wait()</code> 方法中指定超时时间的话。</p>
<ul>
<li><p><code>wait</code>(<em>timeout=None</em>)</p>
<p>冲出栅栏。当栅栏中所有线程都已经调用了这个函数，它们将同时被释放。如果提供了 <em>timeout</em> 参数，这里的 <em>timeout</em> 参数优先于创建栅栏对象时提供的 <em>timeout</em> 参数。</p>
<p>函数返回值是一个整数，取值范围在0到 <em>parties</em> — 1，在每个线程中的返回值不相同。可用于从所有线程中选择唯一的一个线程执行一些特别的工作。例如：</p>
<pre class="line-numbers language-python"><code class="language-python">i <span class="token operator">=</span> barrier<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> i <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true"># Only one thread needs to print this</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"passed the barrier"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果创建栅栏对象时在构造函数中提供了 <em>action</em> 参数，它将在其中一个线程释放前被调用。如果此调用引发了异常，栅栏对象将进入损坏态。</p>
<p>如果发生了超时，栅栏对象将进入破损态。</p>
<p>如果栅栏对象进入破损态，或重置栅栏时仍有线程等待释放，将会引发 <code>BrokenBarrierError</code> 异常。</p>
</li>
<li><p><code>reset</code>()</p>
<p>重置栅栏为默认的初始态。如果栅栏中仍有线程等待释放，这些线程将会收到 <code>BrokenBarrierError</code> 异常。</p>
<p>请注意使用此函数时，如果存在状态未知的其他线程，则可能需要执行外部同步。 如果栅栏已损坏则最好将其废弃并新建一个。</p>
</li>
<li><p><code>abort</code>()</p>
<p>使栅栏处于损坏状态。 这将导致任何现有和未来对 <code>wait()</code> 的调用失败并引发 <code>BrokenBarrierError</code>。 例如可以在需要中止某个线程时使用此方法，以避免应用程序的死锁。</p>
<p>更好的方式是：创建栅栏时提供一个合理的超时时间，来自动避免某个线程出错。</p>
</li>
<li><p><code>parties</code></p>
<p>冲出栅栏所需要的线程数量。</p>
</li>
<li><p><code>n_waiting</code></p>
<p>当前时刻正在栅栏中阻塞的线程数量。</p>
</li>
<li><p><code>broken</code></p>
<p>一个布尔值，值为 <code>True</code> 表明栅栏为破损态。</p>
</li>
</ul>
<p><em>exception</em><code>threading.BrokenBarrierError</code></p>
<p>异常类，是 <code>RuntimeError</code> 异常的子类，在 <code>Barrier</code> 对象重置时仍有线程阻塞时和对象进入破损态时被引发。</p>
<h3 id="在-with-语句中使用锁、条件和信号量"><a href="#在-with-语句中使用锁、条件和信号量" class="headerlink" title="在 with 语句中使用锁、条件和信号量"></a>在 <code>with</code> 语句中使用锁、条件和信号量</h3><p>这个模块提供的带有 <code>acquire()</code> 和 <code>release()</code> 方法的对象，可以被用作 <code>with</code> 语句的上下文管理器。当进入语句块时 <code>acquire()</code> 方法会被调用，退出语句块时 <code>release()</code> 会被调用。因此，以下片段:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">with</span> some_lock<span class="token punctuation">:</span>
<span class="token comment" spellcheck="true"># do something...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>相当于:</p>
<pre class="line-numbers language-python"><code class="language-python">some_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true"># do something...</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    some_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在 <code>Lock</code> 、 <code>RLock</code> 、 <code>Condition</code> 、 <code>Semaphore</code> 和 <code>BoundedSemaphore</code> 对象可以用作 <code>with</code> 语句的上下文管理器。</p>
<h2 id="multiprocessing-—-基于进程的并行"><a href="#multiprocessing-—-基于进程的并行" class="headerlink" title="multiprocessing —- 基于进程的并行"></a><code>multiprocessing</code> —- 基于进程的并行</h2><p><strong>源代码</strong> <a href="https://github.com/python/cpython/tree/3.10/Lib/multiprocessing/" target="_blank" rel="noopener">Lib/multiprocessing/</a></p>
<hr>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>multiprocessing</code> 是一个支持使用与 <code>threading</code> 模块类似的 API 来产生进程的包。 <code>multiprocessing</code> 包同时提供了本地和远程并发操作，通过使用子进程而非线程有效地绕过了 全局解释器锁。 因此，<code>multiprocessing</code> 模块允许程序员充分利用给定机器上的多个处理器。 它在 Unix 和 Windows 上均可运行。</p>
<p><code>multiprocessing</code> 模块还引入了在 <code>threading</code> 模块中没有的API。一个主要的例子就是 <code>Pool</code> 对象，它提供了一种快捷的方法，赋予函数并行化处理一系列输入值的能力，可以将输入数据分配给不同进程处理（数据并行）。下面的例子演示了在模块中定义此类函数的常见做法，以便子进程可以成功导入该模块。这个数据并行的基本例子使用了 <code>Pool</code> ，</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x<span class="token operator">*</span>x
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>map<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将在标准输出中打印</p>
<pre><code>[1, 4, 9]</code></pre><h4 id="Process-类"><a href="#Process-类" class="headerlink" title="Process 类"></a><code>Process</code> 类</h4><p>在 <code>multiprocessing</code> 中，通过创建一个 <code>Process</code> 对象然后调用它的 <code>start()</code> 方法来生成进程。 <code>Process</code> 和 <code>threading.Thread</code> API 相同。 一个简单的多进程程序示例是:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要显示所涉及的各个进程ID，这是一个扩展示例:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">info</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'module name:'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'parent process:'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'process id:'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    info<span class="token punctuation">(</span><span class="token string">'function f'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    info<span class="token punctuation">(</span><span class="token string">'main line'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于为什么 <code>if __name__ == '__main__'</code> 部分是必需的解释。</p>
<h4 id="上下文和启动方法"><a href="#上下文和启动方法" class="headerlink" title="上下文和启动方法"></a>上下文和启动方法</h4><p>根据不同的平台， <code>multiprocessing</code> 支持三种启动进程的方法。这些 <em>启动方法</em> 有</p>
<blockquote>
<p><em>spawn</em></p>
<p>父进程会启动一个全新的 python 解释器进程。 子进程将只继承那些运行进程对象的 <code>run()</code> 方法所必需的资源。 特别地，来自父进程的非必需文件描述符和句柄将不会被继承。 使用此方法启动进程相比使用 <em>fork</em> 或 <em>forkserver</em> 要慢上许多。</p>
<p>可在Unix和Windows上使用。 Windows上的默认设置。</p>
<p><em>fork</em></p>
<p>父进程使用 <code>os.fork()</code> 来产生 Python 解释器分叉。子进程在开始时实际上与父进程相同。父进程的所有资源都由子进程继承。请注意，安全分叉多线程进程是棘手的。</p>
<p>只存在于Unix。Unix中的默认值。</p>
<p><em>forkserver</em></p>
<p>程序启动并选择* forkserver * 启动方法时，将启动服务器进程。从那时起，每当需要一个新进程时，父进程就会连接到服务器并请求它分叉一个新进程。分叉服务器进程是单线程的，因此使用 <code>os.fork()</code> 是安全的。没有不必要的资源被继承。</p>
<p>可在Unix平台上使用，支持通过Unix管道传递文件描述符。</p>
</blockquote>
<p>在 3.8 版更改: 对于 macOS，<em>spawn</em> 启动方式是默认方式。 因为 <em>fork</em> 可能导致subprocess崩溃，被认为是不安全的，查看 <a href="https://bugs.python.org/issue33725" target="_blank" rel="noopener">bpo-33725</a> 。</p>
<p>在 3.4 版更改: 在所有unix平台上添加支持了 <em>spawn</em> ，并且为一些unix平台添加了 <em>forkserver</em> 。在Windows上子进程不再继承所有可继承的父进程句柄。</p>
<p>在 Unix 上通过 <em>spawn</em> 和 <em>forkserver</em> 方式启动多进程会同时启动一个 <em>资源追踪</em> 进程，负责追踪当前程序的进程产生的、并且不再被使用的命名系统资源(如命名信号量以及 <code>SharedMemory</code> 对象)。当所有进程退出后，资源追踪会负责释放这些仍被追踪的的对象。通常情况下是不会有这种对象的，但是假如一个子进程被某个信号杀死，就可能存在这一类资源的“泄露”情况。（泄露的信号量以及共享内存不会被释放，直到下一次系统重启，对于这两类资源来说，这是一个比较大的问题，因为操作系统允许的命名信号量的数量是有限的，而共享内存也会占据主内存的一片空间）</p>
<p>要选择一个启动方法，你应该在主模块的 <code>if __name__ == '__main__'</code> 子句中调用 <code>set_start_method()</code> 。例如：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> multiprocessing <span class="token keyword">as</span> mp
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    mp<span class="token punctuation">.</span>set_start_method<span class="token punctuation">(</span><span class="token string">'spawn'</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> mp<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> mp<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在程序中 <code>set_start_method()</code> 不应该被多次调用。</p>
<p>或者，你可以使用 <code>get_context()</code> 来获取上下文对象。上下文对象与 multiprocessing 模块具有相同的API，并允许在同一程序中使用多种启动方法。:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> multiprocessing <span class="token keyword">as</span> mp
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ctx <span class="token operator">=</span> mp<span class="token punctuation">.</span>get_context<span class="token punctuation">(</span><span class="token string">'spawn'</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，对象在不同上下文创建的进程间可能并不兼容。 特别是，使用 <em>fork</em> 上下文创建的锁不能传递给使用 <em>spawn</em> 或 <em>forkserver</em> 启动方法启动的进程。</p>
<p>想要使用特定启动方法的库应该使用 <code>get_context()</code> 以避免干扰库用户的选择。</p>
<p>警告</p>
<p><code>'spawn'</code> 和 <code>'forkserver'</code> 启动方法当前不能在Unix上和“冻结的”可执行内容一同使用（例如，有类似 <strong>PyInstaller</strong> 和 <strong>cx_Freeze</strong> 的包产生的二进制文件）。 <code>'fork'</code> 启动方法可以使用。</p>
<h4 id="在进程之间交换对象"><a href="#在进程之间交换对象" class="headerlink" title="在进程之间交换对象"></a>在进程之间交换对象</h4><p><code>multiprocessing</code> 支持进程之间的两种通信通道：</p>
<p><strong>队列</strong></p>
<blockquote>
<p><code>Queue</code> 类是一个近似 <code>queue.Queue</code> 的克隆。 例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># prints "[42, None, 'hello']"</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>队列是线程和进程安全的。</p>
</blockquote>
<p><strong>管道</strong></p>
<blockquote>
<p><code>Pipe()</code> 函数返回一个由管道连接的连接对象，默认情况下是双工（双向）。例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Pipe
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    parent_conn<span class="token punctuation">,</span> child_conn <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>child_conn<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>parent_conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># prints "[42, None, 'hello']"</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>返回的两个连接对象 <code>Pipe()</code> 表示管道的两端。每个连接对象都有 <code>send()</code> 和 <code>recv()</code> 方法（相互之间的）。请注意，如果两个进程（或线程）同时尝试读取或写入管道的 <em>同一</em> 端，则管道中的数据可能会损坏。当然，在不同进程中同时使用管道的不同端的情况下不存在损坏的风险。</p>
</blockquote>
<h4 id="进程间同步"><a href="#进程间同步" class="headerlink" title="进程间同步"></a>进程间同步</h4><p><code>multiprocessing</code> 包含来自 <code>threading</code> 的所有同步原语的等价物。例如，可以使用锁来确保一次只有一个进程打印到标准输出:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Lock
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        l<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不使用锁的情况下，来自于多进程的输出很容易产生混淆。</p>
<h4 id="进程间共享状态"><a href="#进程间共享状态" class="headerlink" title="进程间共享状态"></a>进程间共享状态</h4><p>如上所述，在进行并发编程时，通常最好尽量避免使用共享状态。使用多个进程时尤其如此。</p>
<p>但是，如果你真的需要使用一些共享数据，那么 <code>multiprocessing</code> 提供了两种方法。</p>
<p><strong>共享内存</strong></p>
<blockquote>
<p>可以使用 <code>Value</code> 或 <code>Array</code> 将数据存储在共享内存映射中。例如，以下代码:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Value<span class="token punctuation">,</span> Array
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">3.1415927</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    num <span class="token operator">=</span> Value<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
    arr <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将打印</p>
<pre><code>3.1415927
[0, -1, -2, -3, -4, -5, -6, -7, -8, -9]</code></pre><p>创建 <code>num</code> 和 <code>arr</code> 时使用的 <code>'d'</code> 和 <code>'i'</code> 参数是 <code>array</code> 模块使用的类型的 typecode ： <code>'d'</code> 表示双精度浮点数， <code>'i'</code> 表示有符号整数。这些共享对象将是进程和线程安全的。</p>
<p>为了更灵活地使用共享内存，可以使用 <code>multiprocessing.sharedctypes</code> 模块，该模块支持创建从共享内存分配的任意ctypes对象。</p>
</blockquote>
<p><strong>服务进程</strong></p>
<blockquote>
<p>由 <code>Manager()</code> 返回的管理器对象控制一个服务进程，该进程保存Python对象并允许其他进程使用代理操作它们。</p>
<p><code>Manager()</code> 返回的管理器支持类型： <code>list</code> 、 <code>dict</code> 、 <code>Namespace</code> 、 <code>Lock</code> 、 <code>RLock</code> 、 <code>Semaphore</code> 、 <code>BoundedSemaphore</code> 、 <code>Condition</code> 、 <code>Event</code> 、 <code>Barrier</code> 、 <code>Queue</code> 、 <code>Value</code> 和 <code>Array</code> 。例如</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Manager
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">:</span>
    d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span>
    d<span class="token punctuation">[</span><span class="token string">'2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
    d<span class="token punctuation">[</span><span class="token number">0.25</span><span class="token punctuation">]</span> <span class="token operator">=</span> None
    l<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> manager<span class="token punctuation">:</span>
        d <span class="token operator">=</span> manager<span class="token punctuation">.</span>dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将打印</p>
<pre><code>{0.25: None, 1: '1', '2': 2}
[9, 8, 7, 6, 5, 4, 3, 2, 1, 0]</code></pre><p>使用服务进程的管理器比使用共享内存对象更灵活，因为它们可以支持任意对象类型。此外，单个管理器可以通过网络由不同计算机上的进程共享。但是，它们比使用共享内存慢。</p>
</blockquote>
<h4 id="使用工作进程"><a href="#使用工作进程" class="headerlink" title="使用工作进程"></a>使用工作进程</h4><p><code>Pool</code> 类表示一个工作进程池。它具有允许以几种不同方式将任务分配到工作进程的方法。</p>
<p>例如：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool<span class="token punctuation">,</span> TimeoutError
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x<span class="token operator">*</span>x
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># start 4 worker processes</span>
    <span class="token keyword">with</span> Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># print "[0, 1, 4,..., 81]"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>map<span class="token punctuation">(</span>f<span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print same numbers in arbitrary order</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> pool<span class="token punctuation">.</span>imap_unordered<span class="token punctuation">(</span>f<span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># evaluate "f(20)" asynchronously</span>
        res <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># runs in *only* one process</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token comment" spellcheck="true"># prints "400"</span>
        <span class="token comment" spellcheck="true"># evaluate "os.getpid()" asynchronously</span>
        res <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># runs in *only* one process</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token comment" spellcheck="true"># prints the PID of that process</span>
        <span class="token comment" spellcheck="true"># launching multiple evaluations asynchronously *may* use more processes</span>
        multiple_results <span class="token operator">=</span> <span class="token punctuation">[</span>pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>res<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> res <span class="token keyword">in</span> multiple_results<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># make a single worker sleep for 10 secs</span>
        res <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> TimeoutError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"We lacked patience and got a multiprocessing.TimeoutError"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"For the moment, the pool remains available for more work"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># exiting the 'with'-block has stopped the pool</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Now the pool is closed and no longer available"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，进程池的方法只能由创建它的进程使用。</p>
<p>注解</p>
<p>这个包中的功能要求子进程可以导入 <code>__main__</code> 模块。虽然这在 编程指导 中有描述，但还是需要提前说明一下。这意味着一些示例在交互式解释器中不起作用，比如 <code>multiprocessing.pool.Pool</code> 示例。例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x<span class="token operator">*</span>x
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">with</span> p<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   p<span class="token punctuation">.</span>map<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Process PoolWorker<span class="token number">-1</span><span class="token punctuation">:</span>
Process PoolWorker<span class="token number">-2</span><span class="token punctuation">:</span>
Process PoolWorker<span class="token number">-3</span><span class="token punctuation">:</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'module'</span> object has no attribute <span class="token string">'f'</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'module'</span> object has no attribute <span class="token string">'f'</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'module'</span> object has no attribute <span class="token string">'f'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（如果尝试执行上面的代码，它会以一种半随机的方式将三个完整的堆栈内容交替输出，然后你只能以某种方式停止父进程。)</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><code>multiprocessing</code> 包主要复制了 <code>threading</code> 模块的API。</p>
<h4 id="Process-和异常"><a href="#Process-和异常" class="headerlink" title="Process 和异常"></a><code>Process</code> 和异常</h4><p><em>class</em> <code>multiprocessing.Process</code>(<em>group=None</em>, <em>target=None</em>, <em>name=None</em>, <em>args=()</em>, <em>kwargs={}</em>, <em>**,</em> daemon=None*)</p>
<p>进程对象表示在单独进程中运行的活动。 <code>Process</code> 类拥有和 <code>threading.Thread</code> 等价的大部分方法。</p>
<p>应始终使用关键字参数调用构造函数。 <em>group</em> 应该始终是 <code>None</code> ；它仅用于兼容 <code>threading.Thread</code> 。 <em>target</em> 是由 <code>run()</code> 方法调用的可调用对象。它默认为 <code>None</code> ，意味着什么都没有被调用。 <em>name</em> 是进程名称。 <em>args</em> 是目标调用的参数元组。 <em>kwargs</em> 是目标调用的关键字参数字典。如果提供，则键参数 <em>daemon</em> 将进程 <code>daemon</code> 标志设置为 <code>True</code> 或 <code>False</code> 。如果是 <code>None</code> （默认值），则该标志将从创建的进程继承。</p>
<p>默认情况下，不会将任何参数传递给 <em>target</em> 。</p>
<p>如果子类重写构造函数，它必须确保它在对进程执行任何其他操作之前调用基类构造函数（ <code>Process.__init__()</code> ）。</p>
<p>在 3.3 版更改: 加入 <em>daemon</em> 参数。</p>
<ul>
<li><p><code>run</code>()</p>
<p>表示进程活动的方法。</p>
<p>你可以在子类中重载此方法。标准 <code>run()</code> 方法调用传递给对象构造函数的可调用对象作为目标参数（如果有），分别从 <em>args</em> 和 <em>kwargs</em> 参数中获取顺序和关键字参数。</p>
</li>
<li><p><code>start</code>()</p>
<p>启动进程活动。</p>
<p>这个方法每个进程对象最多只能调用一次。它会将对象的 <code>run()</code> 方法安排在一个单独的进程中调用。</p>
</li>
<li><p><code>join</code>([<em>timeout</em>])</p>
<p>如果可选参数 <em>timeout</em> 是 <code>None</code> （默认值），则该方法将阻塞，直到调用 <code>join()</code> 方法的进程终止。如果 <em>timeout</em> 是一个正数，它最多会阻塞 <em>timeout</em> 秒。请注意，如果进程终止或方法超时，则该方法返回 <code>None</code> 。检查进程的 <code>exitcode</code> 以确定它是否终止。</p>
<p>一个进程可以被 join 多次。</p>
<p>进程无法join自身，因为这会导致死锁。尝试在启动进程之前join进程是错误的。</p>
</li>
<li><p><code>name</code></p>
<p>进程的名称。该名称是一个字符串，仅用于识别目的。它没有语义。可以为多个进程指定相同的名称。</p>
<p>初始名称由构造器设定。 如果没有为构造器提供显式名称，则会构造一个形式为 ‘Process-N1:N2:…:Nk’ 的名称，其中每个 Nk 是其父亲的第 N 个孩子。</p>
</li>
<li><p><code>is_alive</code>()</p>
<p>返回进程是否还活着。</p>
<p>粗略地说，从 <code>start()</code> 方法返回到子进程终止之前，进程对象仍处于活动状态。</p>
</li>
<li><p><code>daemon</code></p>
<p>进程的守护标志，一个布尔值。这必须在 <code>start()</code> 被调用之前设置。</p>
<p>初始值继承自创建进程。</p>
<p>当进程退出时，它会尝试终止其所有守护进程子进程。</p>
<p>请注意，不允许在守护进程中创建子进程。这是因为当守护进程由于父进程退出而中断时，其子进程会变成孤儿进程。 另外，这些 <strong>不是</strong> Unix 守护进程或服务，它们是正常进程，如果非守护进程已经退出，它们将被终止（并且不被合并）。</p>
</li>
</ul>
<p>除了 <code>threading.Thread</code> API ，<code>Process</code> 对象还支持以下属性和方法：</p>
<ul>
<li><p><code>pid</code></p>
<p>返回进程ID。在生成该进程之前，这将是 <code>None</code> 。</p>
</li>
<li><p><code>exitcode</code></p>
<p>子进程的退出代码。如果进程尚未终止，这将是 <code>None</code> 。负值 <em>-N</em> 表示子进程被信号 <em>N</em> 终止。</p>
</li>
<li><p><code>authkey</code></p>
<p>进程的身份验证密钥（字节字符串）。</p>
<p>当 <code>multiprocessing</code> 初始化时，主进程使用 <code>os.urandom()</code> 分配一个随机字符串。</p>
<p>当创建 <code>Process</code> 对象时，它将继承其父进程的身份验证密钥，尽管可以通过将 <code>authkey</code> 设置为另一个字节字符串来更改。</p>
</li>
<li><p><code>sentinel</code></p>
<p>系统对象的数字句柄，当进程结束时将变为 “ready” 。</p>
<p>如果要使用 <code>multiprocessing.connection.wait()</code> 一次等待多个事件，可以使用此值。否则调用 <code>join()</code> 更简单。</p>
<p>在Windows上，这是一个操作系统句柄，可以与 <code>WaitForSingleObject</code> 和 <code>WaitForMultipleObjects</code> 系列API调用一起使用。在Unix上，这是一个文件描述符，可以使用来自 <code>select</code> 模块的原语。</p>
<p>3.3 新版功能.</p>
</li>
<li><p><code>terminate</code>()</p>
<p>终止进程。 在Unix上，这是使用 <code>SIGTERM</code> 信号完成的；在Windows上使用 <code>TerminateProcess()</code> 。 请注意，不会执行退出处理程序和finally子句等。</p>
<p>请注意，进程的后代进程将不会被终止 —— 它们将简单地变成孤立的。</p>
<p>警告</p>
<p>如果在关联进程使用管道或队列时使用此方法，则管道或队列可能会损坏，并可能无法被其他进程使用。类似地，如果进程已获得锁或信号量等，则终止它可能导致其他进程死锁。</p>
</li>
<li><p><code>kill</code>()</p>
<p>与 <code>terminate()</code> 相同，但在Unix上使用 <code>SIGKILL</code> 信号。</p>
<p>3.7 新版功能.</p>
</li>
<li><p><code>close</code>()</p>
<p>关闭 <code>Process</code> 对象，释放与之关联的所有资源。如果底层进程仍在运行，则会引发 <code>ValueError</code> 。一旦 <code>close()</code> 成功返回， <code>Process</code> 对象的大多数其他方法和属性将引发 <code>ValueError</code> 。</p>
<p>3.7 新版功能.</p>
</li>
</ul>
<p>注意 <code>start()</code> 、 <code>join()</code> 、 <code>is_alive()</code> 、 <code>terminate()</code> 和 <code>exitcode</code> 方法只能由创建进程对象的进程调用。</p>
<p><code>Process</code> 一些方法的示例用法：</p>
<pre class="line-numbers language-python"><code class="language-python"> <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> multiprocessing<span class="token punctuation">,</span> time<span class="token punctuation">,</span> signal
 <span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token operator">&lt;</span>Process <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> initial<span class="token operator">></span> <span class="token boolean">False</span>
 <span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token operator">&lt;</span>Process <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> started<span class="token operator">></span> <span class="token boolean">True</span>
 <span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">>></span><span class="token operator">></span> time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
 <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token operator">&lt;</span>Process <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> stopped exitcode<span class="token operator">=</span><span class="token operator">-</span>SIGTERM<span class="token operator">></span> <span class="token boolean">False</span>
 <span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>exitcode <span class="token operator">==</span> <span class="token operator">-</span>signal<span class="token punctuation">.</span>SIGTERM
 <span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>exception</em> <code>multiprocessing.ProcessError</code></p>
<p>所有 <code>multiprocessing</code> 异常的基类。</p>
<p><em>exception</em> <code>multiprocessing.BufferTooShort</code></p>
<p>当提供的缓冲区对象太小而无法读取消息时， <code>Connection.recv_bytes_into()</code> 引发的异常。</p>
<p>如果 <code>e</code> 是一个 <code>BufferTooShort</code> 实例，那么 <code>e.args[0]</code> 将把消息作为字节字符串给出。</p>
<p><em>exception</em> <code>multiprocessing.AuthenticationError</code></p>
<p>出现身份验证错误时引发。</p>
<p><em>exception</em> <code>multiprocessing.TimeoutError</code></p>
<p>有超时的方法超时时引发。</p>
<h4 id="管道和队列"><a href="#管道和队列" class="headerlink" title="管道和队列"></a>管道和队列</h4><p>使用多进程时，一般使用消息机制实现进程间通信，尽可能避免使用同步原语，例如锁。</p>
<p>消息机制包含： <code>Pipe()</code> (可以用于在两个进程间传递消息)，以及队列(能够在多个生产者和消费者之间通信)。</p>
<p><code>Queue</code>, <code>SimpleQueue</code> 以及 <code>JoinableQueue</code> 都是多生产者，多消费者，并且实现了 FIFO 的队列类型，其表现与标准库中的 <code>queue.Queue</code> 类相似。 不同之处在于 <code>Queue</code> 缺少标准库的 <code>queue.Queue</code> 从 Python 2.5 开始引入的 <code>task_done()</code> 和 <code>join()</code> 方法。</p>
<p>如果你使用了 <code>JoinableQueue</code> ，那么你 <strong>必须</strong> 对每个已经移出队列的任务调用 <code>JoinableQueue.task_done()</code>。 不然的话用于统计未完成任务的信号量最终会溢出并抛出异常。</p>
<p>另外还可以通过使用一个管理器对象创建一个共享队列 。</p>
<p>注解</p>
<p><code>multiprocessing</code> 使用了普通的 <code>queue.Empty</code> 和 <code>queue.Full</code> 异常去表示超时。 你需要从 <code>queue</code> 中导入它们，因为它们并不在 <code>multiprocessing</code> 的命名空间中。</p>
<p>注解</p>
<p>当一个对象被放入一个队列中时，这个对象首先会被一个后台线程用 pickle 序列化，并将序列化后的数据通过一个底层管道的管道传递到队列中。 这种做法会有点让人惊讶，但一般不会出现什么问题。 如果它们确实妨碍了你，你可以使用一个由管理器 manager 创建的队列替换它。</p>
<ol>
<li>将一个对象放入一个空队列后，可能需要极小的延迟，队列的方法 <code>empty()</code> 才会返回 <code>False</code> 。而 <code>get_nowait()</code> 可以不抛出 <code>queue.Empty</code> 直接返回。</li>
<li>如果有多个进程同时将对象放入队列，那么在队列的另一端接受到的对象可能是无序的。但是由同一个进程放入的多个对象的顺序在另一端输出时总是一样的。</li>
</ol>
<p>警告</p>
<p>如果一个进程在尝试使用 <code>Queue</code> 期间被 <code>Process.terminate()</code> 或 <code>os.kill()</code> 调用终止了，那么队列中的数据很可能被破坏。 这可能导致其他进程在尝试使用该队列时发生异常。</p>
<p>警告</p>
<p>正如刚才提到的，如果一个子进程将一些对象放进队列中 (并且它没有用 <code>JoinableQueue.cancel_join_thread</code> 方法)，那么这个进程在所有缓冲区的对象被刷新进管道之前，是不会终止的。</p>
<p>这意味着，除非你确定所有放入队列中的对象都已经被消费了，否则如果你试图等待这个进程，你可能会陷入死锁中。相似地，如果该子进程不是后台进程，那么父进程可能在试图等待所有非后台进程退出时挂起。</p>
<p>注意用管理器创建的队列不存在这个问题。</p>
<p><code>multiprocessing.Pipe</code>([<em>duplex</em>])</p>
<p>返回一对 <code>Connection</code> 对象 <code>(conn1, conn2)</code> ， 分别表示管道的两端。</p>
<p>如果 <em>duplex</em> 被置为 <code>True</code> (默认值)，那么该管道是双向的。如果 <em>duplex</em> 被置为 <code>False</code> ，那么该管道是单向的，即 <code>conn1</code> 只能用于接收消息，而 <code>conn2</code> 仅能用于发送消息。</p>
<p><em>class</em> <code>multiprocessing.Queue</code>([<em>maxsize</em>])</p>
<p>返回一个使用一个管道和少量锁和信号量实现的共享队列实例。当一个进程将一个对象放进队列中时，一个写入线程会启动并将对象从缓冲区写入管道中。</p>
<p>一旦超时，将抛出标准库 <code>queue</code> 模块中常见的异常 <code>queue.Empty</code> 和 <code>queue.Full</code>。</p>
<p>除了 <code>task_done()</code> 和 <code>join()</code> 之外，<code>Queue</code> 实现了标准库类 <code>queue.Queue</code> 中所有的方法。</p>
<ul>
<li><p><code>qsize</code>()</p>
<p>返回队列的大致长度。由于多线程或者多进程的上下文，这个数字是不可靠的。</p>
<p>Note that this may raise <code>NotImplementedError</code> on Unix platforms like macOS where <code>sem_getvalue()</code> is not implemented.</p>
</li>
<li><p><code>empty</code>()</p>
<p>如果队列是空的，返回 <code>True</code> ，反之返回 <code>False</code> 。 由于多线程或多进程的环境，该状态是不可靠的。</p>
</li>
<li><p><code>full</code>()</p>
<p>如果队列是满的，返回 <code>True</code> ，反之返回 <code>False</code> 。 由于多线程或多进程的环境，该状态是不可靠的。</p>
</li>
<li><p><code>put</code>(<em>obj</em>[, <em>block</em>[, <em>timeout</em>]])</p>
<p>将 obj 放入队列。如果可选参数 <em>block</em> 是 <code>True</code> (默认值) 而且 <em>timeout</em> 是 <code>None</code> (默认值), 将会阻塞当前进程，直到有空的缓冲槽。如果 <em>timeout</em> 是正数，将会在阻塞了最多 <em>timeout</em> 秒之后还是没有可用的缓冲槽时抛出 <code>queue.Full</code> 异常。反之 (<em>block</em> 是 <code>False</code> 时)，仅当有可用缓冲槽时才放入对象，否则抛出 <code>queue.Full</code> 异常 (在这种情形下 <em>timeout</em> 参数会被忽略)。</p>
<p>在 3.8 版更改: 如果队列已经关闭，会抛出 <code>ValueError</code> 而不是 <code>AssertionError</code> 。</p>
</li>
<li><p><code>put_nowait</code>(<em>obj</em>)</p>
<p>相当于 <code>put(obj, False)</code>。</p>
</li>
<li><p><code>get</code>([<em>block</em>[, <em>timeout</em>]])</p>
<p>从队列中取出并返回对象。如果可选参数 <em>block</em> 是 <code>True</code> (默认值) 而且 <em>timeout</em> 是 <code>None</code> (默认值), 将会阻塞当前进程，直到队列中出现可用的对象。如果 <em>timeout</em> 是正数，将会在阻塞了最多 <em>timeout</em> 秒之后还是没有可用的对象时抛出 <code>queue.Empty</code> 异常。反之 (<em>block</em> 是 <code>False</code> 时)，仅当有可用对象能够取出时返回，否则抛出 <code>queue.Empty</code> 异常 (在这种情形下 <em>timeout</em> 参数会被忽略)。</p>
<p>在 3.8 版更改: 如果队列已经关闭，会抛出 <code>ValueError</code> 而不是 <code>OSError</code> 。</p>
</li>
<li><p><code>get_nowait</code>()</p>
<p>相当于 <code>get(False)</code> 。</p>
</li>
</ul>
<p><code>multiprocessing.Queue</code> 类有一些在 <code>queue.Queue</code> 类中没有出现的方法。这些方法在大多数情形下并不是必须的。</p>
<ul>
<li><p><code>close</code>()</p>
<p>指示当前进程将不会再往队列中放入对象。一旦所有缓冲区中的数据被写入管道之后，后台的线程会退出。这个方法在队列被gc回收时会自动调用。</p>
</li>
<li><p><code>join_thread</code>()</p>
<p>等待后台线程。这个方法仅在调用了 <code>close()</code> 方法之后可用。这会阻塞当前进程，直到后台线程退出，确保所有缓冲区中的数据都被写入管道中。</p>
<p>默认情况下，如果一个不是队列创建者的进程试图退出，它会尝试等待这个队列的后台线程。这个进程可以使用 <code>cancel_join_thread()</code> 让 <code>join_thread()</code> 方法什么都不做直接跳过。</p>
</li>
<li><p><code>cancel_join_thread</code>()</p>
<p>防止 <code>join_thread()</code> 方法阻塞当前进程。具体而言，这防止进程退出时自动等待后台线程退出。</p>
<p>这个方法更好的名字可能是 <code>allow_exit_without_flush()</code>。 这可能会导致已排入队列的数据丢失，几乎可以肯定你将不需要用到这个方法。 实际上它仅适用于当你需要当前进程立即退出而不必等待将已排入的队列更新到下层管道，并且你不担心丢失数据的时候。</p>
</li>
</ul>
<p>注解</p>
<p>该类的功能依赖于宿主操作系统具有可用的共享信号量实现。否则该类将被禁用，任何试图实例化一个 <code>Queue</code> 对象的操作都会抛出 <code>ImportError</code> 异常 。后续说明的任何专用队列对象亦如此。</p>
<p><em>class</em> <code>multiprocessing.SimpleQueue</code></p>
<p>这是一个简化的 <code>Queue</code> 类的实现，很像带锁的 <code>Pipe</code> 。</p>
<ul>
<li><p><code>close</code>()</p>
<p>关闭队列：释放内部资源。</p>
<p>队列在被关闭后就不可再被使用。 例如不可再调用 <code>get()</code>, <code>put()</code> 和 <code>empty()</code> 等方法。</p>
<p>3.9 新版功能.</p>
</li>
<li><p><code>empty</code>()</p>
<p>如果队列为空返回 <code>True</code> ，否则返回 <code>False</code> 。</p>
</li>
<li><p><code>get</code>()</p>
<p>从队列中移出并返回一个对象。</p>
</li>
<li><p><code>put</code>(<em>item</em>)</p>
<p>将 <em>item</em> 放入队列。</p>
</li>
</ul>
<p><em>class</em> <code>multiprocessing.JoinableQueue</code>([<em>maxsize</em>])</p>
<p><code>JoinableQueue</code> 类是 <code>Queue</code> 的子类，额外添加了 <code>task_done()</code> 和 <code>join()</code> 方法。</p>
<ul>
<li><p><code>task_done</code>()</p>
<p>指出之前进入队列的任务已经完成。由队列的消费者进程使用。对于每次调用 <code>get()</code> 获取的任务，执行完成后调用 <code>task_done()</code> 告诉队列该任务已经处理完成。</p>
<p>如果 <code>join()</code> 方法正在阻塞之中，该方法会在所有对象都被处理完的时候返回 (即对之前使用 <code>put()</code> 放进队列中的所有对象都已经返回了对应的 <code>task_done()</code> ) 。</p>
<p>如果被调用的次数多于放入队列中的项目数量，将引发 <code>ValueError</code> 异常 。</p>
</li>
<li><p><code>join</code>()</p>
<p>阻塞至队列中所有的元素都被接收和处理完毕。</p>
<p>当条目添加到队列的时候，未完成任务的计数就会增加。每当消费者进程调用 <code>task_done()</code> 表示这个条目已经被回收，该条目所有工作已经完成，未完成计数就会减少。当未完成计数降到零的时候， <code>join()</code> 阻塞被解除。</p>
</li>
</ul>
<h4 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h4><p><code>multiprocessing.active_children</code>()</p>
<p>返回当前进程存活的子进程的列表。</p>
<p>调用该方法有“等待”已经结束的进程的副作用。</p>
<p><code>multiprocessing.cpu_count</code>()</p>
<p>返回系统的CPU数量。</p>
<p>该数量不同于当前进程可以使用的CPU数量。可用的CPU数量可以由 <code>len(os.sched_getaffinity(0))</code> 方法获得。</p>
<p>When the number of CPUs cannot be determined a <code>NotImplementedError</code> is raised.</p>
<p>参见</p>
<p><code>os.cpu_count()</code></p>
<p><code>multiprocessing.current_process</code>()</p>
<p>返回与当前进程相对应的 <code>Process</code> 对象。</p>
<p>和 <code>threading.current_thread()</code> 相同。</p>
<p><code>multiprocessing.parent_process</code>()</p>
<p>返回父进程 <code>Process</code> 对象，和父进程调用 <code>current_process()</code> 返回的对象一样。如果一个进程已经是主进程， <code>parent_process</code> 会返回 <code>None</code>.</p>
<p>3.8 新版功能.</p>
<p><code>multiprocessing.freeze_support</code>()</p>
<p>为使用了 <code>multiprocessing</code> 的程序，提供冻结以产生 Windows 可执行文件的支持。(在 <strong>py2exe</strong>, <strong>PyInstaller</strong> 和 <strong>cx_Freeze</strong> 上测试通过)</p>
<p>需要在 main 模块的 <code>if __name__ == '__main__'</code> 该行之后马上调用该函数。例如：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> freeze_support
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有调用 <code>freeze_support()</code> 在尝试运行被冻结的可执行文件时会抛出 <code>RuntimeError</code> 异常。</p>
<p>对 <code>freeze_support()</code> 的调用在非 Windows 平台上是无效的。如果该模块在 Windows 平台的 Python 解释器中正常运行 (该程序没有被冻结)， 调用<code>freeze_support()</code> 也是无效的。</p>
<p><code>multiprocessing.get_all_start_methods</code>()</p>
<p>返回支持的启动方法的列表，该列表的首项即为默认选项。可能的启动方法有 <code>'fork'</code> ， <code>'spawn'</code> 和<code>‘forkserver’</code> 。在 Windows 中，只有 <code>'spawn'</code> 是可用的。 Unix 平台总是支持 <code>'fork'</code> 和 <code>'spawn'</code> ，且 <code>'fork'</code> 是默认值。</p>
<p>3.4 新版功能.</p>
<p><code>multiprocessing.get_context</code>(<em>method=None</em>)</p>
<p>返回一个 Context 对象。该对象具有和 <code>multiprocessing</code> 模块相同的API。</p>
<p>如果 <em>method</em> 设置成 <code>None</code> 那么将返回默认上下文对象。否则 <em>method</em> 应该是 <code>'fork'</code>, <code>'spawn'</code>, <code>'forkserver'</code> 。 如果指定的启动方法不存在，将抛出 <code>ValueError</code> 异常。</p>
<p>3.4 新版功能.</p>
<p><code>multiprocessing.get_start_method</code>(<em>allow_none=False</em>)</p>
<p>返回启动进程时使用的启动方法名。</p>
<p>如果启动方法已经固定，并且 <em>allow_none</em> 被设置成 False ，那么启动方法将被固定为默认的启动方法，并且返回其方法名。如果启动方法没有设定，并且 <em>allow_none</em> 被设置成 True ，那么将返回 <code>None</code> 。</p>
<p>The return value can be <code>'fork'</code>, <code>'spawn'</code>, <code>'forkserver'</code> or <code>None</code>. <code>'fork'</code> is the default on Unix, while <code>'spawn'</code> is the default on Windows and macOS.</p>
<p>在 3.8 版更改: 对于 macOS，<em>spawn</em> 启动方式是默认方式。 因为 <em>fork</em> 可能导致subprocess崩溃，被认为是不安全的，查看 <a href="https://bugs.python.org/issue33725" target="_blank" rel="noopener">bpo-33725</a> 。</p>
<p>3.4 新版功能.</p>
<p><code>multiprocessing.set_executable</code>()</p>
<p>设置在启动子进程时使用的 Python 解释器路径。 ( 默认使用 <code>sys.executable</code> ) 嵌入式编程人员可能需要这样做：</p>
<pre><code>set_executable(os.path.join(sys.exec_prefix, 'pythonw.exe'))</code></pre><p>以使他们可以创建子进程。</p>
<p>在 3.4 版更改: 现在在 Unix 平台上使用 <code>'spawn'</code> 启动方法时支持调用该方法。</p>
<p><code>multiprocessing.set_start_method</code>(<em>method</em>)</p>
<p>设置启动子进程的方法。 <em>method</em> 可以是 <code>'fork'</code> , <code>'spawn'</code> 或者 <code>'forkserver'</code> 。</p>
<p>注意这最多只能调用一次，并且需要藏在 main 模块中，由 <code>if __name__ == '__main__'</code> 保护着。</p>
<p>3.4 新版功能.</p>
<p>注解</p>
<p><code>multiprocessing</code> 并没有包含类似 <code>threading.active_count()</code> , <code>threading.enumerate()</code> , <code>threading.settrace()</code> , <code>threading.setprofile()</code>, <code>threading.Timer</code> , 或者 <code>threading.local</code> 的方法和类。</p>
<h4 id="连接对象（Connection）"><a href="#连接对象（Connection）" class="headerlink" title="连接对象（Connection）"></a>连接对象（Connection）</h4><p>Connection 对象允许收发可以序列化的对象或字符串。它们可以看作面向消息的连接套接字。</p>
<p>通常使用 <code>Pipe</code> 创建 Connection 对象。</p>
<p><em>class</em> <code>multiprocessing.connection.Connection</code></p>
<ul>
<li><p><code>send</code>(<em>obj</em>)</p>
<p>将一个对象发送到连接的另一端，可以用 <code>recv()</code> 读取。</p>
<p>发送的对象必须是可以序列化的，过大的对象 ( 接近 32MiB+ ，这个值取决于操作系统 ) 有可能引发 <code>ValueError</code> 异常。</p>
</li>
<li><p><code>recv</code>()</p>
<p>返回一个由另一端使用 <code>send()</code> 发送的对象。该方法会一直阻塞直到接收到对象。 如果对端关闭了连接或者没有东西可接收，将抛出 <code>EOFError</code> 异常。</p>
</li>
<li><p><code>fileno</code>()</p>
<p>返回由连接对象使用的描述符或者句柄。</p>
</li>
<li><p><code>close</code>()</p>
<p>关闭连接对象。</p>
<p>当连接对象被垃圾回收时会自动调用。</p>
</li>
<li><p><code>poll</code>([<em>timeout</em>])</p>
<p>返回连接对象中是否有可以读取的数据。</p>
<p>如果未指定 <em>timeout</em> ，此方法会马上返回。如果 <em>timeout</em> 是一个数字，则指定了最大阻塞的秒数。如果 <em>timeout</em> 是 <code>None</code>，那么将一直等待，不会超时。</p>
<p>注意通过使用 <code>multiprocessing.connection.wait()</code> 可以一次轮询多个连接对象。</p>
</li>
<li><p><code>send_bytes</code>(<em>buffer</em>[, <em>offset</em>[, <em>size</em>]])</p>
<p>从一个 bytes-like object 对象中取出字节数组并作为一条完整消息发送。</p>
<p>如果由 <em>offset</em> 给定了在 <em>buffer</em> 中读取数据的位置。 如果给定了 <em>size</em> ，那么将会从缓冲区中读取多个字节。 过大的缓冲区 ( 接近 32MiB+ ，此值依赖于操作系统 ) 有可能引发 <code>ValueError</code> 异常。</p>
</li>
<li><p><code>recv_bytes</code>([<em>maxlength</em>])</p>
<p>以字符串形式返回一条从连接对象另一端发送过来的字节数据。此方法在接收到数据前将一直阻塞。 如果连接对象被对端关闭或者没有数据可读取，将抛出 <code>EOFError</code> 异常。</p>
<p>如果给定了 <em>maxlength</em> 并且消息长于 <em>maxlength</em> 那么将抛出 <code>OSError</code> 并且该连接对象将不再可读。</p>
<p>在 3.3 版更改: 曾经该函数抛出 <code>IOError</code> ，现在这是 <code>OSError</code> 的别名。</p>
</li>
<li><p><code>recv_bytes_into</code>(<em>buffer</em>[, <em>offset</em>])</p>
<p>将一条完整的字节数据消息读入 <em>buffer</em> 中并返回消息的字节数。 此方法在接收到数据前将一直阻塞。 如果连接对象被对端关闭或者没有数据可读取，将抛出 <code>EOFError</code> 异常。</p>
<p><em>buffer</em> must be a writable bytes-like object. If <em>offset</em> is given then the message will be written into the buffer from that position. Offset must be a non-negative integer less than the length of <em>buffer</em> (in bytes).</p>
<p>如果缓冲区太小，则将引发 <code>BufferTooShort</code> 异常，并且完整的消息将会存放在异常实例 <code>e</code> 的 <code>e.args[0]</code> 中。</p>
</li>
</ul>
<p>在 3.3 版更改: 现在连接对象自身可以通过 <code>Connection.send()</code> 和 <code>Connection.recv()</code> 在进程之间传递。</p>
<p>3.3 新版功能: 连接对象现已支持上下文管理协议 。 <code>__enter__()</code> 返回连接对象， <code>__exit__()</code> 会调用 <code>close()</code> 。</p>
<p>例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pipe
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">,</span> None<span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>send_bytes<span class="token punctuation">(</span>b<span class="token string">'thank you'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>recv_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
b<span class="token string">'thank you'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> array
<span class="token operator">>></span><span class="token operator">></span> arr1 <span class="token operator">=</span> array<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> arr2 <span class="token operator">=</span> array<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>send_bytes<span class="token punctuation">(</span>arr1<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> count <span class="token operator">=</span> b<span class="token punctuation">.</span>recv_bytes_into<span class="token punctuation">(</span>arr2<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">assert</span> count <span class="token operator">==</span> len<span class="token punctuation">(</span>arr1<span class="token punctuation">)</span> <span class="token operator">*</span> arr1<span class="token punctuation">.</span>itemsize
<span class="token operator">>></span><span class="token operator">></span> arr2
array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>警告</p>
<p><code>Connection.recv()</code> 方法会自动解封它收到的数据，除非你能够信任发送消息的进程，否则此处可能有安全风险。</p>
<p>因此， 除非连接对象是由 <code>Pipe()</code> 产生的，否则你应该仅在使用了某种认证手段之后才使用 <code>recv()</code> 和 <code>send()</code> 方法。 </p>
<p>警告</p>
<p>如果一个进程在试图读写管道时被终止了，那么管道中的数据很可能是不完整的，因为此时可能无法确定消息的边界。</p>
<h4 id="同步原语"><a href="#同步原语" class="headerlink" title="同步原语"></a>同步原语</h4><p>通常来说同步原语在多进程环境中并不像它们在多线程环境中那么必要。</p>
<p>注意可以使用管理器对象创建同步原语。</p>
<p><em>class</em> <code>multiprocessing.Barrier</code>(<em>parties</em>[, <em>action</em>[, <em>timeout</em>]])</p>
<p>类似 <code>threading.Barrier</code> 的栅栏对象。</p>
<p>3.3 新版功能.</p>
<p><em>class</em> <code>multiprocessing.BoundedSemaphore</code>([<em>value</em>])</p>
<p>非常类似 <code>threading.BoundedSemaphore</code> 的有界信号量对象。</p>
<p>一个小小的不同在于，它的 <code>acquire</code> 方法的第一个参数名是和 <code>Lock.acquire()</code> 一样的 <em>block</em> 。</p>
<p>注解</p>
<p>On macOS, this is indistinguishable from <code>Semaphore</code> because <code>sem_getvalue()</code> is not implemented on that platform.</p>
<p><em>class</em> <code>multiprocessing.Condition</code>([<em>lock</em>])</p>
<p>条件变量： <code>threading.Condition</code> 的别名。</p>
<p>指定的 <em>lock</em> 参数应该是 <code>multiprocessing</code> 模块中的 <code>Lock</code> 或者 <code>RLock</code> 对象。</p>
<p>在 3.3 版更改: 新增了 <code>wait_for()</code> 方法。</p>
<p><em>class</em> <code>multiprocessing.Event</code></p>
<p>A clone of <code>threading.Event</code>.</p>
<p><em>class</em> <code>multiprocessing.Lock</code></p>
<p>原始锁（非递归锁）对象，类似于 <code>threading.Lock</code> 。一旦一个进程或者线程拿到了锁，后续的任何其他进程或线程的其他请求都会被阻塞直到锁被释放。任何进程或线程都可以释放锁。除非另有说明，否则 <code>multiprocessing.Lock</code> 用于进程或者线程的概念和行为都和 <code>threading.Lock</code> 一致。</p>
<p>注意 <code>Lock</code> 实际上是一个工厂函数。它返回由默认上下文初始化的 <code>multiprocessing.synchronize.Lock</code> 对象。</p>
<p><code>Lock</code> supports the context manager protocol and thus may be used in <code>with</code> statements.</p>
<ul>
<li><p><code>acquire</code>(<em>block=True</em>, <em>timeout=None</em>)</p>
<p>可以阻塞或非阻塞地获得锁。</p>
<p>如果 <em>block</em> 参数被设为 <code>True</code> ( 默认值 ) ， 对该方法的调用在锁处于释放状态之前都会阻塞，然后将锁设置为锁住状态并返回 <code>True</code> 。需要注意的是第一个参数名与 <code>threading.Lock.acquire()</code> 的不同。</p>
<p>如果 <em>block</em> 参数被设置成 <code>False</code> ，方法的调用将不会阻塞。 如果锁当前处于锁住状态，将返回 <code>False</code> ； 否则将锁设置成锁住状态，并返回 <code>True</code> 。</p>
<p>当 <em>timeout</em> 是一个正浮点数时，会在等待锁的过程中最多阻塞等待 <em>timeout</em> 秒，当 <em>timeout</em> 是负数时，效果和 <em>timeout</em> 为0时一样，当 <em>timeout</em> 是 <code>None</code> （默认值）时，等待时间是无限长。需要注意的是，对于 <em>timeout</em> 参数是负数和 <code>None</code> 的情况, 其行为与 <code>threading.Lock.acquire()</code> 是不一样的。当 <em>block</em> 参数 为 <code>False</code> 时， <em>timeout</em> 并没有实际用处，会直接忽略。否则，函数会在拿到锁后返回 <code>True</code> 或者 超时没拿到锁后返回 <code>False</code> 。</p>
</li>
<li><p><code>release</code>()</p>
<p>释放锁，可以在任何进程、线程使用，并不限于锁的拥有者。</p>
<p>当尝试释放一个没有被持有的锁时，会抛出 <code>ValueError</code> 异常，除此之外其行为与 <code>threading.Lock.release()</code> 一样。</p>
</li>
</ul>
<p><em>class</em> <code>multiprocessing.RLock</code></p>
<p>递归锁对象: 类似于 <code>threading.RLock</code> 。递归锁必须由持有线程、进程亲自释放。如果某个进程或者线程拿到了递归锁，这个进程或者线程可以再次拿到这个锁而不需要等待。但是这个进程或者线程的拿锁操作和释放锁操作的次数必须相同。</p>
<p>注意 <code>RLock</code> 是一个工厂函数，调用后返回一个使用默认 context 初始化的 <code>multiprocessing.synchronize.RLock</code> 实例。</p>
<p><code>RLock</code> 支持 context manager 协议，因此可在 <code>with</code> 语句内使用。</p>
<ul>
<li><p><code>acquire</code>(<em>block=True</em>, <em>timeout=None</em>)</p>
<p>可以阻塞或非阻塞地获得锁。</p>
<p>当 <em>block</em> 参数设置为 <code>True</code> 时，会一直阻塞直到锁处于空闲状态（没有被任何进程、线程拥有），除非当前进程或线程已经拥有了这把锁。然后当前进程/线程会持有这把锁（在锁没有其他持有者的情况下），锁内的递归等级加一，并返回 <code>True</code> . 注意， 这个函数第一个参数的行为和 <code>threading.RLock.acquire()</code> 的实现有几个不同点，包括参数名本身。</p>
<p>当 <em>block</em> 参数是 <code>False</code> , 将不会阻塞，如果此时锁被其他进程或者线程持有，当前进程、线程获取锁操作失败，锁的递归等级也不会改变，函数返回 <code>False</code> , 如果当前锁已经处于释放状态，则当前进程、线程则会拿到锁，并且锁内的递归等级加一，函数返回 <code>True</code> 。</p>
<p><em>timeout</em> 参数的使用方法及行为与 <code>Lock.acquire()</code> 一样。但是要注意 <em>timeout</em> 的其中一些行为和 <code>threading.RLock.acquire()</code> 中实现的行为是不同的。</p>
</li>
<li><p><code>release</code>()</p>
<p>释放锁，使锁内的递归等级减一。如果释放后锁内的递归等级降低为0，则会重置锁的状态为释放状态（即没有被任何进程、线程持有），重置后如果有有其他进程和线程在等待这把锁，他们中的一个会获得这个锁而继续运行。如果释放后锁内的递归等级还没到达0，则这个锁仍将保持未释放状态且当前进程和线程仍然是持有者。</p>
<p>只有当前进程或线程是锁的持有者时，才允许调用这个方法。如果当前进程或线程不是这个锁的拥有者，或者这个锁处于已释放的状态(即没有任何拥有者)，调用这个方法会抛出 <code>AssertionError</code> 异常。注意这里抛出的异常类型和 <code>threading.RLock.release()</code> 中实现的行为不一样。</p>
</li>
</ul>
<p><em>class</em> <code>multiprocessing.Semaphore</code>([<em>value</em>])</p>
<p>一种信号量对象: 类似于 <code>threading.Semaphore</code>.</p>
<p>一个小小的不同在于，它的 <code>acquire</code> 方法的第一个参数名是和 <code>Lock.acquire()</code> 一样的 <em>block</em> 。</p>
<p>注解</p>
<p>On macOS, <code>sem_timedwait</code> is unsupported, so calling <code>acquire()</code> with a timeout will emulate that function’s behavior using a sleeping loop.</p>
<p>注解</p>
<p>假如信号 SIGINT 是来自于 Ctrl-C ，并且主线程被 <code>BoundedSemaphore.acquire()</code>, <code>Lock.acquire()</code>, <code>RLock.acquire()</code>, <code>Semaphore.acquire()</code>, <code>Condition.acquire()</code> 或 <code>Condition.wait()</code> 阻塞，则调用会立即中断同时抛出 <code>KeyboardInterrupt</code> 异常。</p>
<p>这和 <code>threading</code> 的行为不同，此模块中当执行对应的阻塞式调用时，SIGINT 会被忽略。</p>
<p>注解</p>
<p>这个包的某些功能依赖于宿主机系统的共享信号量的实现，如果系统没有这个特性， <code>multiprocessing.synchronize</code> 会被禁用，尝试导入这个模块会引发 <code>ImportError</code> 异常，详细信息请查看 <a href="https://bugs.python.org/issue3770" target="_blank" rel="noopener">bpo-3770</a> 。</p>
<h4 id="共享-ctypes-对象"><a href="#共享-ctypes-对象" class="headerlink" title="共享 ctypes 对象"></a>共享 <code>ctypes</code> 对象</h4><p>在共享内存上创建可被子进程继承的共享对象时是可行的。</p>
<p><code>multiprocessing.Value</code>(<em>typecode_or_type</em>, <em>\</em>args<em>,</em> lock=True*)</p>
<p>返回一个从共享内存上创建的 <code>ctypes</code> 对象。默认情况下返回的对象实际上是经过了同步器包装过的。可以通过 <code>Value</code> 的 <em>value</em> 属性访问这个对象本身。</p>
<p><em>typecode_or_type</em> 指明了返回的对象类型: 它可能是一个 ctypes 类型或者 <code>array</code> 模块中每个类型对应的单字符长度的字符串。 <em>\</em>args* 会透传给这个类的构造函数。</p>
<p>如果 <em>lock</em> 参数是 <code>True</code> （默认值）, 将会新建一个递归锁用于同步对于此值的访问操作。 如果 <em>lock</em> 是 <code>Lock</code> 或者 <code>RLock</code> 对象，那么这个传入的锁将会用于同步对这个值的访问操作，如果 <em>lock</em> 是 <code>False</code> , 那么对这个对象的访问将没有锁保护，也就是说这个变量不是进程安全的。</p>
<p>诸如 <code>+=</code> 这类的操作会引发独立的读操作和写操作，也就是说这类操作符并不具有原子性。所以，如果你想让递增共享变量的操作具有原子性，仅仅以这样的方式并不能达到要求:</p>
<pre><code>counter.value += 1</code></pre><p>共享对象内部关联的锁是递归锁(默认情况下就是)的情况下， 你可以采用这种方式</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">with</span> counter<span class="token punctuation">.</span>get_lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    
    counter<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意 <em>lock</em> 只能是命名参数。</p>
<p><code>multiprocessing.Array</code>(<em>typecode_or_type</em>, <em>size_or_initializer</em>, <em>**,</em> lock=True*)</p>
<p>从共享内存中申请并返回一个具有ctypes类型的数组对象。默认情况下返回值实际上是被同步器包装过的数组对象。</p>
<p><em>typecode_or_type</em> 指明了返回的数组中的元素类型: 它可能是一个 ctypes 类型或者 <code>array</code> 模块中每个类型对应的单字符长度的字符串。 如果 <em>size_or_initializer</em> 是一个整数，那就会当做数组的长度，并且整个数组的内存会初始化为0。否则，如果 <em>size_or_initializer</em> 会被当成一个序列用于初始化数组中的每一个元素，并且会根据元素个数自动判断数组的长度。</p>
<p>如果 <em>lock</em> 为 <code>True</code> (默认值) 则将创建一个新的锁对象用于同步对值的访问。 如果 <em>lock</em> 为一个 <code>Lock</code> 或 <code>RLock</code> 对象则该对象将被用于同步对值的访问。 如果 <em>lock</em> 为 <code>False</code> 则对返回对象的访问将不会自动得到锁的保护，也就是说它不是“进程安全的”。</p>
<p>请注意 <em>lock</em> 是一个仅限关键字参数。</p>
<p>请注意 <code>ctypes.c_char</code> 的数组具有 <em>value</em> 和 <em>raw</em> 属性，允许被用来保存和提取字符串。</p>
<h5 id="multiprocessing-sharedctypes-模块"><a href="#multiprocessing-sharedctypes-模块" class="headerlink" title="multiprocessing.sharedctypes 模块"></a><code>multiprocessing.sharedctypes</code> 模块</h5><p><code>multiprocessing.sharedctypes</code> 模块提供了一些函数，用于分配来自共享内存的、可被子进程继承的 <code>ctypes</code> 对象。</p>
<p>注解</p>
<p>虽然可以将指针存储在共享内存中，但请记住它所引用的是特定进程地址空间中的位置。 而且，指针很可能在第二个进程的上下文中无效，尝试从第二个进程对指针进行解引用可能会导致崩溃。</p>
<p><code>multiprocessing.sharedctypes.RawArray</code>(<em>typecode_or_type</em>, <em>size_or_initializer</em>)</p>
<p>从共享内存中申请并返回一个 ctypes 数组。</p>
<p><em>typecode_or_type</em> 指明了返回的数组中的元素类型: 它可能是一个 ctypes 类型或者 <code>array</code> 模块中使用的类型字符。 如果 <em>size_or_initializer</em> 是一个整数，那就会当做数组的长度，并且整个数组的内存会初始化为0。否则，如果 <em>size_or_initializer</em> 会被当成一个序列用于初始化数组中的每一个元素，并且会根据元素个数自动判断数组的长度。</p>
<p>注意对元素的访问、赋值操作可能是非原子操作 - 使用 <code>Array()</code> , 从而借助其中的锁保证操作的原子性。</p>
<p><code>multiprocessing.sharedctypes.RawValue</code>(<em>typecode_or_type</em>, <em>\</em>args*)</p>
<p>从共享内存中申请并返回一个 ctypes 对象。</p>
<p><em>typecode_or_type</em> 指明了返回的对象类型: 它可能是一个 ctypes 类型或者 <code>array</code> 模块中每个类型对应的单字符长度的字符串。 <em>\</em>args* 会透传给这个类的构造函数。</p>
<p>注意对 value 的访问、赋值操作可能是非原子操作 - 使用 <code>Value()</code> ，从而借助其中的锁保证操作的原子性。</p>
<p>请注意 <code>ctypes.c_char</code> 的数组具有 <em>value</em> 和 <em>raw</em> 属性，允许被用来保存和提取字符串 。</p>
<p><code>multiprocessing.sharedctypes.Array</code>(<em>typecode_or_type</em>, <em>size_or_initializer</em>, <em>**,</em> lock=True*)</p>
<p>返回一个纯 ctypes 数组, 或者在此之上经过同步器包装过的进程安全的对象，这取决于 <em>lock</em> 参数的值，除此之外，和 <code>RawArray()</code> 一样。</p>
<p>如果 <em>lock</em> 为 <code>True</code> (默认值) 则将创建一个新的锁对象用于同步对值的访问。 如果 <em>lock</em> 为一个 <code>Lock</code> 或 <code>RLock</code> 对象则该对象将被用于同步对值的访问。 如果 <em>lock</em> 为 <code>False</code> 则对所返回对象的访问将不会自动得到锁的保护，也就是说它将不是“进程安全的”。</p>
<p>注意 <em>lock</em> 只能是命名参数。</p>
<p><code>multiprocessing.sharedctypes.Value</code>(<em>typecode_or_type</em>, <em>\</em>args<em>,</em> lock=True*)</p>
<p>返回一个纯 ctypes 数组, 或者在此之上经过同步器包装过的进程安全的对象，这取决于 <em>lock</em> 参数的值，除此之外，和 <code>RawArray()</code> 一样。</p>
<p>如果 <em>lock</em> 为 <code>True</code> (默认值) 则将创建一个新的锁对象用于同步对值的访问。 如果 <em>lock</em> 为一个 <code>Lock</code> 或 <code>RLock</code> 对象则该对象将被用于同步对值的访问。 如果 <em>lock</em> 为 <code>False</code> 则对所返回对象的访问将不会自动得到锁的保护，也就是说它将不是“进程安全的”。</p>
<p>注意 <em>lock</em> 只能是命名参数。</p>
<p><code>multiprocessing.sharedctypes.copy</code>(<em>obj</em>)</p>
<p>从共享内存中申请一片空间将 ctypes 对象 <em>obj</em> 过来，然后返回一个新的 ctypes 对象。</p>
<p><code>multiprocessing.sharedctypes.synchronized</code>(<em>obj</em>[, <em>lock</em>])</p>
<p>将一个 ctypes 对象包装为进程安全的对象并返回，使用 <em>lock</em> 同步对于它的操作。如果 <em>lock</em> 是 <code>None</code> (默认值) ，则会自动创建一个 <code>multiprocessing.RLock</code> 对象。</p>
<p>同步器包装后的对象会在原有对象基础上额外增加两个方法: <code>get_obj()</code> 返回被包装的对象， <code>get_lock()</code> 返回内部用于同步的锁。</p>
<p>需要注意的是，访问包装后的ctypes对象会比直接访问原来的纯 ctypes 对象慢得多。</p>
<p>在 3.5 版更改: 同步器包装后的对象支持 context manager 协议。</p>
<p>下面的表格对比了创建普通ctypes对象和基于共享内存上创建共享ctypes对象的语法。（表格中的 <code>MyStruct</code> 是 <code>ctypes.Structure</code> 的子类）</p>
<table>
<thead>
<tr>
<th align="left">ctypes</th>
<th align="left">使用类型的共享ctypes</th>
<th align="left">使用 typecode 的共享 ctypes</th>
</tr>
</thead>
<tbody><tr>
<td align="left">c_double(2.4)</td>
<td align="left">RawValue(c_double, 2.4)</td>
<td align="left">RawValue(‘d’, 2.4)</td>
</tr>
<tr>
<td align="left">MyStruct(4, 6)</td>
<td align="left">RawValue(MyStruct, 4, 6)</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">(c_short <em>7)()</em></td>
<td align="left">RawArray(c_short, 7)</td>
<td align="left">RawArray(‘h’, 7)</td>
</tr>
<tr>
<td align="left">(c_int 3)(9, 2, 8)</td>
<td align="left">RawArray(c_int, (9, 2, 8))</td>
<td align="left">RawArray(‘i’, (9, 2, 8))</td>
</tr>
</tbody></table>
<p>下面是一个在子进程中修改多个ctypes对象的例子。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Lock
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>sharedctypes <span class="token keyword">import</span> Value<span class="token punctuation">,</span> Array
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> Structure<span class="token punctuation">,</span> c_double
<span class="token keyword">class</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> c_double<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">,</span> c_double<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">modify</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> x<span class="token punctuation">,</span> s<span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n<span class="token punctuation">.</span>value <span class="token operator">**=</span> <span class="token number">2</span>
    x<span class="token punctuation">.</span>value <span class="token operator">**=</span> <span class="token number">2</span>
    s<span class="token punctuation">.</span>value <span class="token operator">=</span> s<span class="token punctuation">.</span>value<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> A<span class="token punctuation">:</span>
        a<span class="token punctuation">.</span>x <span class="token operator">**=</span> <span class="token number">2</span>
        a<span class="token punctuation">.</span>y <span class="token operator">**=</span> <span class="token number">2</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> Value<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> Value<span class="token punctuation">(</span>c_double<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">3.0</span><span class="token punctuation">,</span> lock<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">,</span> b<span class="token string">'hello world'</span><span class="token punctuation">,</span> lock<span class="token operator">=</span>lock<span class="token punctuation">)</span>
    A <span class="token operator">=</span> Array<span class="token punctuation">(</span>Point<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1.875</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.75</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2.375</span><span class="token punctuation">,</span><span class="token number">9.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lock<span class="token operator">=</span>lock<span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>modify<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> x<span class="token punctuation">,</span> s<span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> a<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> A<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出如下</p>
<pre><code>49
0.1111111111111111
HELLO WORLD
[(3.515625, 39.0625), (33.0625, 4.0), (5.640625, 90.25)]</code></pre><h4 id="管理器"><a href="#管理器" class="headerlink" title="管理器"></a>管理器</h4><p>管理器提供了一种创建共享数据的方法，从而可以在不同进程中共享，甚至可以通过网络跨机器共享数据。管理器维护一个用于管理 <em>共享对象</em> 的服务。其他进程可以通过代理访问这些共享对象。</p>
<p><code>multiprocessing.Manager</code>()</p>
<p>返回一个已启动的 <code>SyncManager</code> 管理器对象，这个对象可以用于在不同进程中共享数据。返回的管理器对象对应了一个已经启动的子进程，并且拥有一系列方法可以用于创建共享对象、返回对应的代理。</p>
<p>当管理器被垃圾回收或者父进程退出时，管理器进程会立即退出。管理器类定义在 <code>multiprocessing.managers</code> 模块:</p>
<p><em>class</em> <code>multiprocessing.managers.BaseManager</code>([<em>address</em>[, <em>authkey</em>]])</p>
<p>创建一个 BaseManager 对象。</p>
<p>一旦创建，应该及时调用 <code>start()</code> 或者 <code>get_server().serve_forever()</code> 以确保管理器对象对应的管理进程已经启动。</p>
<p><em>address</em> 是管理器服务进程监听的地址。如果 <em>address</em> 是 <code>None</code> ,则允许和任意主机的请求建立连接。</p>
<p><em>authkey</em> 是认证标识，用于检查连接服务进程的请求合法性。如果 <em>authkey</em> 是 <code>None</code>, 则会使用 <code>current_process().authkey</code> , 否则，就使用 <em>authkey</em> , 需要保证它必须是 byte 类型的字符串。</p>
<ul>
<li><p><code>start</code>([<em>initializer</em>[, <em>initargs</em>]])</p>
<p>为管理器开启一个子进程，如果 <em>initializer</em> 不是 <code>None</code> , 子进程在启动时将会调用 <code>initializer(*initargs)</code> 。</p>
</li>
<li><p><code>get_server</code>()</p>
<p>返回一个 <code>Server</code> 对象，它是管理器在后台控制的真实的服务。 <code>Server</code> 对象拥有 <code>serve_forever()</code> 方法。</p>
<pre><code>&gt;&gt;&gt; from multiprocessing.managers import BaseManager
&gt;&gt;&gt; manager = BaseManager(address=('', 50000), authkey=b'abc')
&gt;&gt;&gt; server = manager.get_server()
&gt;&gt;&gt; server.serve_forever()</code></pre><p><code>Server</code> 额外拥有一个 <code>address</code> 属性。</p>
</li>
<li><p><code>connect</code>()</p>
<p>将本地管理器对象连接到一个远程管理器进程:</p>
<pre><code>&gt;&gt;&gt; from multiprocessing.managers import BaseManager
&gt;&gt;&gt; m = BaseManager(address=('127.0.0.1', 50000), authkey=b'abc')
&gt;&gt;&gt; m.connect()</code></pre></li>
<li><p><code>shutdown</code>()</p>
<p>停止管理器的进程。这个方法只能用于已经使用 <code>start()</code> 启动的服务进程。</p>
<p>它可以被多次调用。</p>
</li>
<li><p><code>register</code>(<em>typeid</em>[, <em>callable</em>[, <em>proxytype</em>[, <em>exposed</em>[, <em>method_to_typeid</em>[, <em>create_method</em>]]]]])</p>
<p>一个 classmethod，可以将一个类型或者可调用对象注册到管理器类。</p>
<p><em>typeid</em> 是一种 “类型标识符”，用于唯一表示某种共享对象类型，必须是一个字符串。</p>
<p><em>callable</em> 是一个用来为此类型标识符创建对象的可调用对象。如果一个管理器实例将使用 <code>connect()</code> 方法连接到服务器，或者 <em>create_method</em> 参数为 <code>False</code>，那么这里可留下 <code>None</code>。</p>
<p><em>proxytype</em> 是 <code>BaseProxy</code> 的子类，可以根据 <em>typeid</em> 为共享对象创建一个代理，如果是 <code>None</code> , 则会自动创建一个代理类。</p>
<p><em>exposed</em> 是一个函数名组成的序列，用来指明只有这些方法可以使用 <code>BaseProxy._callmethod()</code> 代理。(如果 <em>exposed</em> 是 <code>None</code>, 则会在 <code>proxytype._exposed_</code> 存在的情况下转而使用它) 当暴露的方法列表没有指定的时候，共享对象的所有 “公共方法” 都会被代理。（这里的“公共方法”是指所有拥有 <code>__call__()</code> 方法并且不是以 <code>'_'</code> 开头的属性）</p>
<p><em>method_to_typeid</em> 是一个映射，用来指定那些应该返回代理对象的暴露方法所返回的类型。（如果 <em>method_to_typeid</em> 是 <code>None</code>, 则 <code>proxytype._method_to_typeid_</code> 会在存在的情况下被使用）如果方法名称不在这个映射中或者映射是 <code>None</code> ,则方法返回的对象会是一个值拷贝。</p>
<p><em>create_method</em> 指明，是否要创建一个以 <em>typeid</em> 命名并返回一个代理对象的方法，这个函数会被服务进程用于创建共享对象，默认为 <code>True</code> 。</p>
</li>
</ul>
<p><code>BaseManager</code> 实例也有一个只读属性。</p>
<ul>
<li><p><code>address</code></p>
<p>管理器所用的地址。</p>
</li>
</ul>
<p>在 3.3 版更改: 管理器对象支持上下文管理协议 。<code>__enter__()</code> 启动服务进程（如果它还没有启动）并且返回管理器对象， <code>__exit__()</code> 会调用 <code>shutdown()</code> 。</p>
<p>在之前的版本中，如果管理器服务进程没有启动， <code>__enter__()</code> 不会负责启动它。</p>
<p><em>class</em> <code>multiprocessing.managers.SyncManager</code></p>
<p><code>BaseManager</code> 的子类，可用于进程的同步。这个类型的对象使用 <code>multiprocessing.Manager()</code> 创建。</p>
<p>它拥有一系列方法，可以为大部分常用数据类型创建并返回 代理对象 代理，用于进程间同步。甚至包括共享列表和字典。</p>
<ul>
<li><p><code>Barrier</code>(<em>parties</em>[, <em>action</em>[, <em>timeout</em>]])</p>
<p>创建一个共享的 <code>threading.Barrier</code> 对象并返回它的代理。</p>
<p>3.3 新版功能.</p>
</li>
<li><p><code>BoundedSemaphore</code>([<em>value</em>])</p>
<p>创建一个共享的 <code>threading.BoundedSemaphore</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Condition</code>([<em>lock</em>])</p>
<p>创建一个共享的 <code>threading.Condition</code> 对象并返回它的代理。</p>
<p>如果提供了 <em>lock</em> 参数，那它必须是 <code>threading.Lock</code> 或 <code>threading.RLock</code> 的代理对象。</p>
<p>在 3.3 版更改: 新增了 <code>wait_for()</code> 方法。</p>
</li>
<li><p><code>Event</code>()</p>
<p>创建一个共享的 <code>threading.Event</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Lock</code>()</p>
<p>创建一个共享的 <code>threading.Lock</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Namespace</code>()</p>
<p>创建一个共享的 <code>Namespace</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Queue</code>([<em>maxsize</em>])</p>
<p>创建一个共享的 <code>queue.Queue</code> 对象并返回它的代理。</p>
</li>
<li><p><code>RLock</code>()</p>
<p>创建一个共享的 <code>threading.RLock</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Semaphore</code>([<em>value</em>])</p>
<p>创建一个共享的 <code>threading.Semaphore</code> 对象并返回它的代理。</p>
</li>
<li><p><code>Array</code>(<em>typecode</em>, <em>sequence</em>)</p>
<p>创建一个数组并返回它的代理。</p>
</li>
<li><p><code>Value</code>(<em>typecode</em>, <em>value</em>)</p>
<p>创建一个具有可写 <code>value</code> 属性的对象并返回它的代理。</p>
</li>
<li><p><code>dict</code>()</p>
<p><code>dict</code>(<em>mapping</em>)</p>
<p><code>dict</code>(<em>sequence</em>)</p>
<p>创建一个共享的 <code>dict</code> 对象并返回它的代理。</p>
</li>
<li><p><code>list</code>()</p>
<p><code>list</code>(<em>sequence</em>)</p>
<p>创建一个共享的 <code>list</code> 对象并返回它的代理。</p>
</li>
</ul>
<p>在 3.6 版更改: 共享对象能够嵌套。例如, 共享的容器对象如共享列表，可以包含另一个共享对象，他们全都会在 <code>SyncManager</code> 中进行管理和同步。</p>
<p><em>class</em> <code>multiprocessing.managers.Namespace</code></p>
<p>一个可以注册到 <code>SyncManager</code> 的类型。</p>
<p>命名空间对象没有公共方法，但是拥有可写的属性。直接print会显示所有属性的值。</p>
<p>值得一提的是，当对命名空间对象使用代理的时候，访问所有名称以 <code>'_'</code> 开头的属性都只是代理器上的属性，而不是命名空间对象的属性。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> manager <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> Global <span class="token operator">=</span> manager<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> Global<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">10</span>
<span class="token operator">>></span><span class="token operator">></span> Global<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token operator">>></span><span class="token operator">></span> Global<span class="token punctuation">.</span>_z <span class="token operator">=</span> <span class="token number">12.3</span>    <span class="token comment" spellcheck="true"># this is an attribute of the proxy</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Global<span class="token punctuation">)</span>
Namespace<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="自定义管理器"><a href="#自定义管理器" class="headerlink" title="自定义管理器"></a>自定义管理器</h5><p>要创建一个自定义的管理器，需要新建一个 <code>BaseManager</code> 的子类，然后使用这个管理器类上的 <code>register()</code> 类方法将新类型或者可调用方法注册上去。例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager
<span class="token keyword">class</span> <span class="token class-name">MathsClass</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> y
    <span class="token keyword">def</span> <span class="token function">mul</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
<span class="token keyword">class</span> <span class="token class-name">MyManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
MyManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'Maths'</span><span class="token punctuation">,</span> MathsClass<span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> MyManager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> manager<span class="token punctuation">:</span>
        maths <span class="token operator">=</span> manager<span class="token punctuation">.</span>Maths<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>maths<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># prints 7</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>maths<span class="token punctuation">.</span>mul<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># prints 56</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="使用远程管理器"><a href="#使用远程管理器" class="headerlink" title="使用远程管理器"></a>使用远程管理器</h5><p>可以将管理器服务运行在一台机器上，然后使用客户端从其他机器上访问。(假设它们的防火墙允许)</p>
<p>运行下面的代码可以启动一个服务，此付包含了一个共享队列，允许远程客户端访问:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> queue <span class="token keyword">import</span> Queue
<span class="token operator">>></span><span class="token operator">></span> queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
<span class="token operator">>></span><span class="token operator">></span> QueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'get_queue'</span><span class="token punctuation">,</span> callable<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span>queue<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'abracadabra'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> m<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>远程客户端可以通过下面的方式访问服务:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
<span class="token operator">>></span><span class="token operator">></span> QueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'get_queue'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'foo.bar.org'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'abracadabra'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> queue <span class="token operator">=</span> m<span class="token punctuation">.</span>get_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也可以通过下面的方式:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
<span class="token operator">>></span><span class="token operator">></span> QueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'get_queue'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'foo.bar.org'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'abracadabra'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> queue <span class="token operator">=</span> m<span class="token punctuation">.</span>get_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'hello'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本地进程也可以访问这个队列，利用上面的客户端代码通过远程方式访问:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>q <span class="token operator">=</span> q
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'local hello'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> w <span class="token operator">=</span> Worker<span class="token punctuation">(</span>queue<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> w<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> QueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'get_queue'</span><span class="token punctuation">,</span> callable<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> queue<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'abracadabra'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> m<span class="token punctuation">.</span>get_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="代理对象"><a href="#代理对象" class="headerlink" title="代理对象"></a>代理对象</h4><p>代理是一个 <em>指向</em> 其他共享对象的对象，这个对象(很可能)在另外一个进程中。共享对象也可以说是代理 <em>指涉</em> 的对象。多个代理对象可能指向同一个指涉对象。</p>
<p>代理对象代理了指涉对象的一系列方法调用(虽然并不是指涉对象的每个方法都有必要被代理)。通过这种方式，代理的使用方法可以和它的指涉对象一样:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Manager
<span class="token operator">>></span><span class="token operator">></span> manager <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>ListProxy object<span class="token punctuation">,</span> typeid <span class="token string">'list'</span> at 0x<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token number">16</span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，对代理使用 <code>str()</code> 函数会返回指涉对象的字符串表示，但是 <code>repr()</code> 却会返回代理本身的内部字符串表示。</p>
<p>被代理的对象很重要的一点是必须可以被序列化，这样才能允许他们在进程间传递。因此，指涉对象可以包含 代理对象 。这允许管理器中列表、字典或者其他 代理对象 对象之间的嵌套。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># referent of a now contains referent of b</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>ListProxy object<span class="token punctuation">,</span> typeid <span class="token string">'list'</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>类似地，字典和列表代理也可以相互嵌套:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> l_outer <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">[</span> manager<span class="token punctuation">.</span>dict<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d_first_inner <span class="token operator">=</span> l_outer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> d_first_inner<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> d_first_inner<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> l_outer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> l_outer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">26</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>l_outer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>l_outer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果指涉对象包含了普通 <code>list</code> 或 <code>dict</code> 对象，对这些内部可变对象的修改不会通过管理器传播，因为代理无法得知被包含的值什么时候被修改了。但是把存放在容器代理中的值本身是会通过管理器传播的（会触发代理对象中的 <code>__setitem__</code> ）从而有效修改这些对象，所以可以把修改过的值重新赋值给容器代理:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a list proxy and append a mutable object (a dictionary)</span>
lproxy <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">)</span>
lproxy<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># now mutate the dictionary</span>
d <span class="token operator">=</span> lproxy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
d<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
d<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment" spellcheck="true"># at this point, the changes to d are not yet synced, but by</span>
<span class="token comment" spellcheck="true"># updating the dictionary, the proxy is notified of the change</span>
lproxy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在大多是使用情形下，这种实现方式并不比嵌套 代理对象 方便，但是依然演示了对于同步的一种控制级别。</p>
<p>注解</p>
<p><code>multiprocessing</code> 中的代理类并没有提供任何对于代理值比较的支持。所以，我们会得到如下结果:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>当需要比较值的时候，应该替换为使用指涉对象的拷贝。</p>
<p><em>class</em> <code>multiprocessing.managers.BaseProxy</code></p>
<p>代理对象是 <code>BaseProxy</code> 派生类的实例。</p>
<ul>
<li><p><code>_callmethod</code>(<em>methodname</em>[, <em>args</em>[, <em>kwds</em>]])</p>
<p>调用指涉对象的方法并返回结果。</p>
<p>如果 <code>proxy</code> 是一个代理且其指涉的是 <code>obj</code> , 那么下面的表达式:</p>
<pre><code>proxy._callmethod(methodname, args, kwds)</code></pre><p>相当于求取以下表达式的值:</p>
<pre><code>getattr(obj, methodname)(*args, **kwds)</code></pre><p>于管理器进程。</p>
<p>返回结果会是一个值拷贝或者一个新的共享对象的代理 - 见函数 <code>BaseManager.register()</code> 中关于参数 <em>method_to_typeid</em> 的文档。</p>
<p>如果这个调用熬出了异常，则这个异常会被 <code>_callmethod()</code> 透传出来。如果是管理器进程本身抛出的一些其他异常，则会被 <code>_callmethod()</code> 转换为 <code>RemoteError</code> 异常重新抛出。</p>
<p>特别注意，如果 <em>methodname</em> 没有 <em>暴露</em> 出来，将会引发一个异常。</p>
<p><code>_callmethod()</code> 的一个使用示例:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> manager<span class="token punctuation">.</span>list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">.</span>_callmethod<span class="token punctuation">(</span><span class="token string">'__len__'</span><span class="token punctuation">)</span>
<span class="token number">10</span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">.</span>_callmethod<span class="token punctuation">(</span><span class="token string">'__getitem__'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>slice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># equivalent to l[2:7]</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">.</span>_callmethod<span class="token punctuation">(</span><span class="token string">'__getitem__'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true"># equivalent to l[20]</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
IndexError<span class="token punctuation">:</span> list index out of range<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>_getvalue</code>()</p>
<p>返回指涉对象的一份拷贝。</p>
<p>如果指涉对象无法序列化，则会抛出一个异常。</p>
</li>
<li><p><code>__repr__</code>()</p>
<p>返回代理对象的内部字符串表示。</p>
</li>
<li><p><code>__str__</code>()</p>
<p>返回指涉对象的内部字符串表示。</p>
</li>
</ul>
<h5 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h5><p>代理对象使用了一个弱引用回调函数，当它被垃圾回收时，会将自己从拥有此指涉对象的管理器上反注册，</p>
<p>当共享对象没有被任何代理器引用时，会被管理器进程删除。</p>
<h4 id="进程池"><a href="#进程池" class="headerlink" title="进程池"></a>进程池</h4><p>可以创建一个进程池，它将使用 <code>Pool</code> 类执行提交给它的任务。</p>
<p><em>class</em> <code>multiprocessing.pool.Pool</code>([<em>processes</em>[, <em>initializer</em>[, <em>initargs</em>[, <em>maxtasksperchild</em>[, <em>context</em>]]]]])</p>
<p>一个进程池对象，它控制可以提交作业的工作进程池。它支持带有超时和回调的异步结果，以及一个并行的 map 实现。</p>
<p><em>processes</em> 是要使用的工作进程数目。如果 <em>processes</em> 为 <code>None</code>，则使用 <code>os.cpu_count()</code> 返回的值。</p>
<p>如果 <em>initializer</em> 不为 <code>None</code>，则每个工作进程将会在启动时调用 <code>initializer(*initargs)</code>。</p>
<p><em>maxtasksperchild</em> 是一个工作进程在它退出或被一个新的工作进程代替之前能完成的任务数量，为了释放未使用的资源。默认的 <em>maxtasksperchild</em> 是 <code>None</code>，意味着工作进程寿与池齐。</p>
<p><em>context</em> 可被用于指定启动的工作进程的上下文。通常一个进程池是使用函数 <code>multiprocessing.Pool()</code> 或者一个上下文对象的 <code>Pool()</code> 方法创建的。在这两种情况下， <em>context</em> 都是适当设置的。</p>
<p>注意，进程池对象的方法只有创建它的进程能够调用。</p>
<p>警告</p>
<p><code>multiprocessing.pool</code> 对象具有需要正确管理的内部资源 （像任何其他资源一样），具体方式是将进程池用作上下文管理器，或者手动调用 <code>close()</code> 和 <code>terminate()</code>。 未做此类操作将导致进程在终结阶段挂起。</p>
<p>请注意依赖垃圾回收器来销毁进程池是 <strong>不正确的</strong> 做法，因为 CPython 并不保证进程池终结器会被调用</p>
<p>3.2 新版功能: <em>maxtasksperchild</em></p>
<p>3.4 新版功能: <em>context</em></p>
<p>注解</p>
<p>通常来说，<code>Pool</code> 中的 Worker 进程的生命周期和进程池的工作队列一样长。一些其他系统中（如 Apache, mod_wsgi 等）也可以发现另一种模式，他们会让工作进程在完成一些任务后退出，清理、释放资源，然后启动一个新的进程代替旧的工作进程。 <code>Pool</code> 的 <em>maxtasksperchild</em> 参数给用户提供了这种能力。</p>
<ul>
<li><p><code>apply</code>(<em>func</em>[, <em>args</em>[, <em>kwds</em>]])</p>
<p>使用 <em>args</em> 参数以及 <em>kwds</em> 命名参数调用 <em>func</em> , 它会返回结果前阻塞。这种情况下，<code>apply_async()</code> 更适合并行化工作。另外 <em>func</em> 只会在一个进程池中的一个工作进程中执行。</p>
</li>
<li><p><code>apply_async</code>(<em>func</em>[, <em>args</em>[, <em>kwds</em>[, <em>callback</em>[, <em>error_callback</em>]]]])</p>
<p><code>apply()</code> 方法的一个变种，返回一个 <code>AsyncResult</code> 对象。</p>
<p>如果指定了 <em>callback</em> , 它必须是一个接受单个参数的可调用对象。当执行成功时， <em>callback</em> 会被用于处理执行后的返回结果，否则，调用 <em>error_callback</em> 。</p>
<p>如果指定了 <em>error_callback</em> , 它必须是一个接受单个参数的可调用对象。当目标函数执行失败时， 会将抛出的异常对象作为参数传递给 <em>error_callback</em> 执行。</p>
<p>回调函数应该立即执行完成，否则会阻塞负责处理结果的线程。</p>
</li>
<li><p><code>map</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>])</p>
<p>内置 <code>map()</code> 函数的并行版本 (但它只支持一个 <em>iterable</em> 参数，对于多个可迭代对象请参阅 <code>starmap()</code>)。 它会保持阻塞直到获得结果。</p>
<p>这个方法会将可迭代对象分割为许多块，然后提交给进程池。可以将 <em>chunksize</em> 设置为一个正整数从而（近似）指定每个块的大小可以。</p>
<p>注意对于很长的迭代对象，可能消耗很多内存。可以考虑使用 <code>imap()</code> 或 <code>imap_unordered()</code> 并且显示指定 <em>chunksize</em> 以提升效率。</p>
</li>
<li><p><code>map_async</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>[, <em>callback</em>[, <em>error_callback</em>]]])</p>
<p><code>map()</code> 方法的一个变种，返回一个 <code>AsyncResult</code> 对象。</p>
<p>如果指定了 <em>callback</em> , 它必须是一个接受单个参数的可调用对象。当执行成功时， <em>callback</em> 会被用于处理执行后的返回结果，否则，调用 <em>error_callback</em> 。</p>
<p>如果指定了 <em>error_callback</em> , 它必须是一个接受单个参数的可调用对象。当目标函数执行失败时， 会将抛出的异常对象作为参数传递给 <em>error_callback</em> 执行。</p>
<p>回调函数应该立即执行完成，否则会阻塞负责处理结果的线程。</p>
</li>
<li><p><code>imap</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>])</p>
<p><code>map()</code> 的延迟执行版本。</p>
<p><em>chunksize</em> 参数的作用和 <code>map()</code> 方法的一样。对于很长的迭代器，给 <em>chunksize</em> 设置一个很大的值会比默认值 <code>1</code> <strong>极大</strong> 地加快执行速度。</p>
<p>同样，如果 <em>chunksize</em> 是 <code>1</code> , 那么 <code>imap()</code> 方法所返回的迭代器的 <code>next()</code> 方法拥有一个可选的 <em>timeout</em> 参数： 如果无法在 <em>timeout</em> 秒内执行得到结果，则<code>next(timeout)</code> 会抛出 <code>multiprocessing.TimeoutError</code> 异常。</p>
</li>
<li><p><code>imap_unordered</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>])</p>
<p>和 <code>imap()</code> 相同，只不过通过迭代器返回的结果是任意的。（当进程池中只有一个工作进程的时候，返回结果的顺序才能认为是”有序”的）</p>
</li>
<li><p><code>starmap</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>])</p>
<p>和 <code>map()</code> 类似，不过 <em>iterable</em> 中的每一项会被解包再作为函数参数。</p>
<p>比如可迭代对象 <code>[(1,2), (3, 4)]</code> 会转化为等价于 <code>[func(1,2), func(3,4)]</code> 的调用。</p>
<p>3.3 新版功能.</p>
</li>
<li><p><code>starmap_async</code>(<em>func</em>, <em>iterable</em>[, <em>chunksize</em>[, <em>callback</em>[, <em>error_callback</em>]]])</p>
<p>相当于 <code>starmap()</code> 与 <code>map_async()</code> 的结合，迭代 <em>iterable</em> 的每一项，解包作为 <em>func</em> 的参数并执行，返回用于获取结果的对象。</p>
<p>3.3 新版功能.</p>
</li>
<li><p><code>close</code>()</p>
<p>阻止后续任务提交到进程池，当所有任务执行完成后，工作进程会退出。</p>
</li>
<li><p><code>terminate</code>()</p>
<p>不必等待未完成的任务，立即停止工作进程。当进程池对象被垃圾回收时，会立即调用 <code>terminate()</code>。</p>
</li>
<li><p><code>join</code>()</p>
<p>等待工作进程结束。调用 <code>join()</code> 前必须先调用 <code>close()</code> 或者 <code>terminate()</code> 。</p>
</li>
</ul>
<p>3.3 新版功能: 进程池对象现在支持上下文管理器协议。<code>__enter__()</code> 返回进程池对象, <code>__exit__()</code> 会调用 <code>terminate()</code> 。</p>
<p><em>class</em> <code>multiprocessing.pool.AsyncResult</code></p>
<p><code>Pool.apply_async()</code> 和 <code>Pool.map_async()</code> 返回对象所属的类。</p>
<ul>
<li><p><code>get</code>([<em>timeout</em>])</p>
<p>用于获取执行结果。如果 <em>timeout</em> 不是 <code>None</code> 并且在 <em>timeout</em> 秒内仍然没有执行完得到结果，则抛出 <code>multiprocessing.TimeoutError</code> 异常。如果远程调用发生异常，这个异常会通过 <code>get()</code> 重新抛出。</p>
</li>
<li><p><code>wait</code>([<em>timeout</em>])</p>
<p>阻塞，直到返回结果，或者 <em>timeout</em> 秒后超时。</p>
</li>
<li><p><code>ready</code>()</p>
<p>返回执行状态，是否已经完成。</p>
</li>
<li><p><code>successful</code>()</p>
<p>判断调用是否已经完成并且未引发异常。 如果还未获得结果则将引发 <code>ValueError</code>。</p>
<p>在 3.7 版更改: 如果没有执行完，会抛出 <code>ValueError</code> 异常而不是 <code>AssertionError</code> 。</p>
</li>
</ul>
<p>下面的例子演示了进程池的用法:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x<span class="token operator">*</span>x
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>         <span class="token comment" spellcheck="true"># start 4 worker processes</span>
        result <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># evaluate "f(10)" asynchronously in a single process</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># prints "100" unless your computer is *very* slow</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>map<span class="token punctuation">(</span>f<span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># prints "[0, 1, 4,..., 81]"</span>
        it <span class="token operator">=</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>f<span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>next<span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># prints "0"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>next<span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># prints "1"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>next<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment" spellcheck="true"># prints "4" unless your computer is *very* slow</span>
        result <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># raises multiprocessing.TimeoutError</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="监听器及客户端"><a href="#监听器及客户端" class="headerlink" title="监听器及客户端"></a>监听器及客户端</h4><p>通常情况下，进程间通过队列或者 <code>Pipe()</code> 返回的 <code>Connection</code> 传递消息。</p>
<p>不过，<code>multiprocessing.connection</code> 模块其实提供了一些更灵活的特性。最基础的用法是通过它抽象出来的高级API来操作socket或者Windows命名管道。也提供一些高级用法，如通过 <code>hmac</code> 模块来支持 <em>摘要认证</em>，以及同时监听多个管道连接。</p>
<p><code>multiprocessing.connection.deliver_challenge</code>(<em>connection</em>, <em>authkey</em>)</p>
<p>发送一个随机生成的消息到另一端，并等待回复。</p>
<p>如果收到的回复与使用 <em>authkey</em> 作为键生成的信息摘要匹配成功，就会发送一个欢迎信息给管道另一端。否则抛出 <code>AuthenticationError</code> 异常。</p>
<p><code>multiprocessing.connection.answer_challenge</code>(<em>connection</em>, <em>authkey</em>)</p>
<p>接收一条信息，使用 <em>authkey</em> 作为键计算信息摘要，然后将摘要发送回去。</p>
<p>如果没有收到欢迎消息，就抛出 <code>AuthenticationError</code> 异常。</p>
<p><code>multiprocessing.connection.Client</code>(<em>address</em>[, <em>family</em>[, <em>authkey</em>]])</p>
<p>尝试使用 <em>address</em> 地址上的监听器建立一个连接，返回 <code>Connection</code> 。</p>
<p>连接的类型取决于 <em>family</em> 参数，但是通常可以省略，因为可以通过 <em>address</em> 的格式推导出来。</p>
<p>如果提供了 <em>authkey</em> 参数并且不是 None，那它必须是一个字符串并且会被当做基于 HMAC 认证的密钥。如果 <em>authkey</em> 是None 则不会有认证行为。认证失败抛出 <code>AuthenticationError</code> 异常，请查看 See 认证密码 。</p>
<p><em>class</em> <code>multiprocessing.connection.Listener</code>([<em>address</em>[, <em>family</em>[, <em>backlog</em>[, <em>authkey</em>]]]])</p>
<p>可以监听连接请求，是对于绑定套接字或者 Windows 命名管道的封装。</p>
<p><em>address</em> 是监听器对象中的绑定套接字或命名管道使用的地址。</p>
<p>注解</p>
<p>如果使用 ‘0.0.0.0’ 作为监听地址，那么在Windows上这个地址无法建立连接。想要建立一个可连接的端点，应该使用 ‘127.0.0.1’ 。</p>
<p><em>family</em> 是套接字(或者命名管道)使用的类型。它可以是以下一种: <code>'AF_INET'</code> ( TCP 套接字类型), <code>'AF_UNIX'</code> ( Unix 域套接字) 或者 <code>'AF_PIPE'</code> ( Windows 命名管道)。其中只有第一个保证各平台可用。如果 <em>family</em> 是 <code>None</code> ,那么 family 会根据 <em>address</em> 的格式自动推导出来。如果 <em>address</em> 也是 <code>None</code> , 则取默认值。默认值为可用类型中速度最快的。注意，如果 <em>family</em> 是 <code>'AF_UNIX'</code> 而address是<code>None</code> ,套接字会在一个 <code>tempfile.mkstemp()</code> 创建的私有临时目录中创建。</p>
<p>如果监听器对象使用了套接字，<em>backlog</em> (默认值为1) 会在套接字绑定后传递给它的 <code>listen()</code> 方法。</p>
<p>如果提供了 <em>authkey</em> 参数并且不是 None，那它必须是一个字符串并且会被当做基于 HMAC 认证的密钥。如果 <em>authkey</em> 是None 则不会有认证行为。认证失败抛出 <code>AuthenticationError</code> 异常。</p>
<ul>
<li><p><code>accept</code>()</p>
<p>接受一个连接并返回一个 <code>Connection</code> 对象，其连接到的监听器对象已绑定套接字或者命名管道。如果已经尝试过认证并且失败了，则会抛出 <code>AuthenticationError</code> 异常。</p>
</li>
<li><p><code>close</code>()</p>
<p>关闭监听器对象上的绑定套接字或者命名管道。此函数会在监听器被垃圾回收后自动调用。不过仍然建议显式调用函数关闭。</p>
</li>
</ul>
<p>监听器对象拥有下列只读属性:</p>
<ul>
<li><p><code>address</code></p>
<p>监听器对象使用的地址。</p>
</li>
<li><p><code>last_accepted</code></p>
<p>最后一个连接所使用的地址。如果没有的话就是 <code>None</code> 。</p>
</li>
</ul>
<p>3.3 新版功能: 监听器对象现在支持了上下文管理协议 。 <code>__enter__()</code> 返回一个监听器对象, <code>__exit__()</code> 会调用 <code>close()</code> 。</p>
<p><code>multiprocessing.connection.wait</code>(<em>object_list</em>, <em>timeout=None</em>)</p>
<p>一直等待直到 <em>object_list</em> 中某个对象处于就绪状态。返回 <em>object_list</em> 中处于就绪状态的对象。如果 <em>timeout</em> 是一个浮点型，该方法会最多阻塞这么多秒。如果 <em>timeout</em> 是 <code>None</code> ，则会允许阻塞的事件没有限制。timeout为负数的情况下和为0的情况相同。</p>
<p>对于 Unix 和 Windows ，满足下列条件的对象可以出现在 <em>object_list</em> 中</p>
<ul>
<li>可读的 <code>Connection</code> 对象；</li>
<li>一个已连接并且可读的 <code>socket.socket</code> 对象；或者</li>
<li><code>Process</code> 对象中的 <code>sentinel</code> 属性。</li>
</ul>
<p>当一个连接或者套接字对象拥有有效的数据可被读取的时候，或者另一端关闭后，这个对象就处于就绪状态。</p>
<p><strong>Unix</strong>: <code>wait(object_list, timeout)</code> 和 <code>select.select(object_list, [], [], timeout)</code> 几乎相同。差别在于，如果 <code>select.select()</code> 被信号中断，它会抛出一个附带错误号为 <code>EINTR</code> 的 <code>OSError</code> 异常，而 <code>wait()</code> 不会。</p>
<p><strong>Windows</strong>: <em>object_list</em> 中的元素必须是一个表示为整数的可等待的句柄(按照 Win32 函数 <code>WaitForMultipleObjects()</code> 的文档中所定义) 或者一个拥有 <code>fileno()</code> 方法的对象，这个对象返回一个套接字句柄或者管道句柄。（注意管道和套接字两种句柄 <strong>不是</strong> 可等待的句柄）</p>
<p>3.3 新版功能.</p>
<p><strong>示例</strong></p>
<p>下面的服务代码创建了一个使用 <code>'secret password'</code> 作为认证密码的监听器。它会等待连接然后发送一些数据给客户端:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>connection <span class="token keyword">import</span> Listener
<span class="token keyword">from</span> array <span class="token keyword">import</span> array
address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># family is deduced to be 'AF_INET'</span>
<span class="token keyword">with</span> Listener<span class="token punctuation">(</span>address<span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'secret password'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> listener<span class="token punctuation">:</span>
    <span class="token keyword">with</span> listener<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'connection accepted from'</span><span class="token punctuation">,</span> listener<span class="token punctuation">.</span>last_accepted<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2.25</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> <span class="token string">'junk'</span><span class="token punctuation">,</span> float<span class="token punctuation">]</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send_bytes<span class="token punctuation">(</span>b<span class="token string">'hello'</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send_bytes<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">1729</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面的代码连接到服务然后从服务器上j接收一些数据:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>connection <span class="token keyword">import</span> Client
<span class="token keyword">from</span> array <span class="token keyword">import</span> array
address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> Client<span class="token punctuation">(</span>address<span class="token punctuation">,</span> authkey<span class="token operator">=</span>b<span class="token string">'secret password'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true"># => [2.25, None, 'junk', float]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># => 'hello'</span>
    arr <span class="token operator">=</span> array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv_bytes_into<span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># => 8</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>                          <span class="token comment" spellcheck="true"># => array('i', [42, 1729, 0, 0, 0])</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面的代码使用了 <code>wait()</code> ，以便在同时等待多个进程发来消息。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> time<span class="token punctuation">,</span> random
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Pipe<span class="token punctuation">,</span> current_process
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>connection <span class="token keyword">import</span> wait
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        w<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> current_process<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    w<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    readers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> w <span class="token operator">=</span> Pipe<span class="token punctuation">(</span>duplex<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        readers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># We close the writable end of the pipe now to be sure that</span>
        <span class="token comment" spellcheck="true"># p is the only process which owns a handle for it.  This</span>
        <span class="token comment" spellcheck="true"># ensures that when p closes its handle for the writable end,</span>
        <span class="token comment" spellcheck="true"># wait() will promptly report the readable end as being ready.</span>
        w<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> readers<span class="token punctuation">:</span>
        <span class="token keyword">for</span> r <span class="token keyword">in</span> wait<span class="token punctuation">(</span>readers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                msg <span class="token operator">=</span> r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
                readers<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="地址格式"><a href="#地址格式" class="headerlink" title="地址格式"></a>地址格式</h5><ul>
<li><code>'AF_INET'</code> 地址是 <code>(hostname, port)</code> 形式的元组类型，其中 <em>hostname</em> 是一个字符串，<em>port</em> 是整数。</li>
<li><code>'AF_UNIX'</code> 地址是文件系统上文件名的字符串。</li>
<li><code>'AF_PIPE'</code> 地址是一个 <code>r'\.\pipe{PipeName}'</code> 形式的字符串。 要使用 <code>Client()</code> 来连接到远程计算机上一个名为 <em>ServerName</em> 的命名管道，则应当改用 <code>r'\*ServerName*\pipe{PipeName}'</code> 形式的地址。</li>
</ul>
<p>注意，使用两个反斜线开头的字符串默认被当做 <code>'AF_PIPE'</code> 地址而不是 <code>'AF_UNIX'</code> 。</p>
<h4 id="认证密码"><a href="#认证密码" class="headerlink" title="认证密码"></a>认证密码</h4><p>当使用 <code>Connection.recv</code> 接收数据时，数据会自动被反序列化。不幸的是，对于一个不可信的数据源发来的数据，反序列化是存在安全风险的。所以 <code>Listener</code> 和 <code>Client()</code> 之间使用 <code>hmac</code> 模块进行摘要认证。</p>
<p>认证密钥是一个 byte 类型的字符串，可以认为是和密码一样的东西，连接建立好后，双方都会要求另一方证明知道认证密钥。（这个证明过程不会通过连接发送密钥）</p>
<p>如果要求认证但是没有指定认证密钥，则会使用 <code>current_process().authkey</code> 的返回值。 这个值将被当前进程所创建的任何 <code>Process</code> 对象自动继承。 这意味着 (在默认情况下) 一个包含多进程的程序中的所有进程会在相互间建立连接的时候共享单个认证密钥。</p>
<p><code>os.urandom()</code> 也可以用来生成合适的认证密钥。</p>
<h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>当前模块也提供了一些对 logging 的支持。注意， <code>logging</code> 模块本身并没有使用进程间共享的锁，所以来自于多个进程的日志可能（具体取决于使用的日志 handler 类型）相互覆盖或者混杂。</p>
<p><code>multiprocessing.get_logger</code>()</p>
<p>返回 <code>multiprocessing</code> 使用的 logger，必要的话会创建一个新的。</p>
<p>如果创建的首个 logger 日志级别为 <code>logging.NOTSET</code> 并且没有默认 handler。通过这个 logger 打印的消息不会传递到根 logger。</p>
<p>注意在 Windows 上，子进程只会继承父进程 logger 的日志级别 - 对于logger的其他自定义项不会继承。</p>
<p><code>multiprocessing.log_to_stderr</code>()</p>
<p>此函数会调用 <code>get_logger()</code> 但是会在返回的 logger 上增加一个 handler，将所有输出都使用 <code>'[%(levelname)s/%(processName)s] %(message)s'</code> 的格式发送到 <code>sys.stderr</code> 。</p>
<p>下面是一个在交互式解释器中打开日志功能的例子:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> multiprocessing<span class="token punctuation">,</span> logging
<span class="token operator">>></span><span class="token operator">></span> logger <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>log_to_stderr<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'doomed'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>WARNING<span class="token operator">/</span>MainProcess<span class="token punctuation">]</span> doomed
<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>INFO<span class="token operator">/</span>SyncManager<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> child process calling self<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>INFO<span class="token operator">/</span>SyncManager<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> created temp directory <span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>pymp<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>INFO<span class="token operator">/</span>SyncManager<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> manager serving at <span class="token string">'/.../listener-...'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> m
<span class="token punctuation">[</span>INFO<span class="token operator">/</span>MainProcess<span class="token punctuation">]</span> sending shutdown message to manager
<span class="token punctuation">[</span>INFO<span class="token operator">/</span>SyncManager<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> manager exiting <span class="token keyword">with</span> exitcode <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="multiprocessing-dummy-模块"><a href="#multiprocessing-dummy-模块" class="headerlink" title="multiprocessing.dummy 模块"></a><code>multiprocessing.dummy</code> 模块</h4><p><code>multiprocessing.dummy</code> 复制了 <code>multiprocessing</code> 的 API，不过是在 <code>threading</code> 模块之上包装了一层。</p>
<p>特别地，<code>multiprocessing.dummy</code> 所提供的 <code>Pool</code> 函数会返回一个 <code>ThreadPool</code> 的实例，该类是 <code>Pool</code> 的子类，它支持所有相同的方法调用但会使用一个工作线程池而非工作进程池。</p>
<p><em>class</em> <code>multiprocessing.pool.ThreadPool</code>([<em>processes</em>[, <em>initializer</em>[, <em>initargs</em>]]])</p>
<p>一个线程池对象，用来控制可向其提交任务的工作线程池。 <code>ThreadPool</code> 实例与 <code>Pool</code> 实例是完全接口兼容的，并且它们的资源也必须被正确地管理，或者是将线程池作为上下文管理器来使用，或者是通过手动调用 <code>close()</code> 和 <code>terminate()</code>。</p>
<p><em>processes</em> 是要使用的工作线程数目。 如果 <em>processes</em> 为 <code>None</code>，则使用 <code>os.cpu_count()</code> 返回的值。</p>
<p>如果 <em>initializer</em> 不为 <code>None</code>，则每个工作进程将会在启动时调用 <code>initializer(*initargs)</code>。</p>
<p>不同于 <code>Pool</code>，<em>maxtasksperchild</em> 和 <em>context</em> 不可被提供。</p>
<blockquote>
<p>注解</p>
<p><code>ThreadPool</code> 具有与 <code>Pool</code> 相同的接口，它围绕一个进程池进行设计并且先于 <code>concurrent.futures</code> 模块的引入。 因此，它继承了一些对于基于线程的池来说没有意义的操作，并且它具有自己的用于表示异步任务状态的类型 <code>AsyncResult</code>，该类型不为任何其他库所知。</p>
<p>用户通常应该倾向于使用 <code>concurrent.futures.ThreadPoolExecutor</code>，它拥有从一开始就围绕线程进行设计的更简单接口，并且返回与许多其他库相兼容的 <code>concurrent.futures.Future</code> 实例，包括 <code>asyncio</code> 库。</p>
</blockquote>
<h3 id="编程指导"><a href="#编程指导" class="headerlink" title="编程指导"></a>编程指导</h3><p>使用 <code>multiprocessing</code> 时，应遵循一些指导原则和习惯用法。</p>
<h4 id="所有start方法"><a href="#所有start方法" class="headerlink" title="所有start方法"></a>所有start方法</h4><p>下面这些适用于所有start方法。</p>
<p>避免共享状态</p>
<blockquote>
<p>应该尽可能避免在进程间传递大量数据，越少越好。</p>
<p>最好坚持使用队列或者管道进行进程间通信，而不是底层的同步原语。</p>
</blockquote>
<p>可序列化</p>
<blockquote>
<p>保证所代理的方法的参数是可以序列化的。</p>
</blockquote>
<p>代理的线程安全性</p>
<blockquote>
<p>不要在多线程中同时使用一个代理对象，除非你用锁保护它。</p>
<p>（而在不同进程中使用 <em>相同</em> 的代理对象却没有问题。）</p>
</blockquote>
<p>使用 Join 避免僵尸进程</p>
<blockquote>
<p>在 Unix 上，如果一个进程执行完成但是没有被 join，就会变成僵尸进程。一般来说，僵尸进程不会很多，因为每次新启动进程（或者 <code>active_children()</code> 被调用）时，所有已执行完成且没有被 join 的进程都会自动被 join，而且对一个执行完的进程调用 <code>Process.is_alive</code> 也会 join 这个进程。尽管如此，对自己启动的进程显式调用 join 依然是最佳实践。</p>
</blockquote>
<p>继承优于序列化、反序列化</p>
<blockquote>
<p>当使用 <em>spawn</em> 或者 <em>forkserver</em> 的启动方式时，<code>multiprocessing</code> 中的许多类型都必须是可序列化的，这样子进程才能使用它们。但是通常我们都应该避免使用管道和队列发送共享对象到另外一个进程，而是重新组织代码，对于其他进程创建出来的共享对象，让那些需要访问这些对象的子进程可以直接将这些对象从父进程继承过来。</p>
</blockquote>
<p>避免杀死进程</p>
<blockquote>
<p>听过 <code>Process.terminate</code> 停止一个进程很容易导致这个进程正在使用的共享资源（如锁、信号量、管道和队列）损坏或者变得不可用，无法在其他进程中继续使用。</p>
<p>所以，最好只对那些从来不使用共享资源的进程调用 <code>Process.terminate</code> 。</p>
</blockquote>
<p>Join 使用队列的进程</p>
<blockquote>
<p>记住，往队列放入数据的进程会一直等待直到队列中所有项被”feeder” 线程传给底层管道。（子进程可以调用队列的 <code>Queue.cancel_join_thread</code> 方法禁止这种行为）</p>
<p>这意味着，任何使用队列的时候，你都要确保在进程join之前，所有存放到队列中的项将会被其他进程、线程完全消费。否则不能保证这个写过队列的进程可以正常终止。记住非精灵进程会自动 join 。</p>
<p>下面是一个会导致死锁的例子:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'X'</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true"># this deadlocks</span>
    obj <span class="token operator">=</span> queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>交换最后两行可以修复这个问题（或者直接删掉 <code>p.join()</code>）。</p>
</blockquote>
<p>显式传递资源给子进程</p>
<blockquote>
<p>在Unix上，使用 <em>fork</em> 方式启动的子进程可以使用父进程中全局创建的共享资源。不过，最好是显式将资源对象通过参数的形式传递给子进程。</p>
<p>除了（部分原因）让代码兼容 Windows 以及其他的进程启动方式外，这种形式还保证了在子进程生命期这个对象是不会被父进程垃圾回收的。如果父进程中的某些对象被垃圾回收会导致资源释放，这就变得很重要。</p>
<p>所以对于实例：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Lock
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> do something using <span class="token string">"lock"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应当重写成这样：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Lock
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> do something using <span class="token string">"l"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        Process<span class="token punctuation">(</span>target<span class="token operator">=</span>f<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>谨防将 <code>sys.stdin</code> 数据替换为 “类似文件的对象”</p>
<blockquote>
<p><code>multiprocessing</code> 原本会无条件地这样调用:</p>
<pre class="line-numbers language-python"><code class="language-python">os<span class="token punctuation">.</span>close<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 <code>multiprocessing.Process._bootstrap()</code> 方法中 —— 这会导致与”进程中的进程”相关的一些问题。这已经被修改成了:</p>
<pre class="line-numbers language-python"><code class="language-python">sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>stdin <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>devnull<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">,</span> closefd<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>它解决了进程相互冲突导致文件描述符错误的根本问题，但是对使用带缓冲的“文件类对象”替换 <code>sys.stdin()</code> 作为输出的应用程序造成了潜在的危险。如果多个进程调用了此文件类对象的 <code>close()</code> 方法，会导致相同的数据多次刷写到此对象，损坏数据。</p>
<p>如果你写入文件类对象并实现了自己的缓存，可以在每次追加缓存数据时记录当前进程id，从而将其变成 fork 安全的，当发现进程id变化后舍弃之前的缓存，例如:</p>
<pre class="line-numbers language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">cache</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pid <span class="token operator">!=</span> self<span class="token punctuation">.</span>_pid<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_pid <span class="token operator">=</span> pid
        self<span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_cache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要更多信息，请查看 <a href="https://bugs.python.org/issue5155" target="_blank" rel="noopener">bpo-5155</a>, <a href="https://bugs.python.org/issue5313" target="_blank" rel="noopener">bpo-5313</a> 以及 <a href="https://bugs.python.org/issue5331" target="_blank" rel="noopener">bpo-5331</a></p>
</blockquote>
<h4 id="spawn-和-forkserver-启动方式"><a href="#spawn-和-forkserver-启动方式" class="headerlink" title="spawn 和 forkserver 启动方式"></a><em>spawn</em> 和 <em>forkserver</em> 启动方式</h4><p>相对于 <em>fork</em> 启动方式，有一些额外的限制。</p>
<p>更依赖序列化</p>
<blockquote>
<p><code>Process.__init__()</code> 的所有参数都必须可序列化。同样的，当你继承 <code>Process</code> 时，需要保证当调用 <code>Process.start</code> 方法时，实例可以被序列化。</p>
</blockquote>
<p>全局变量</p>
<blockquote>
<p>记住，如果子进程中的代码尝试访问一个全局变量，它所看到的值（如果有）可能和父进程中执行 <code>Process.start</code> 那一刻的值不一样。</p>
<p>当全局变量知识模块级别的常量时，是不会有问题的。</p>
</blockquote>
<p>安全导入主模块</p>
<blockquote>
<p>确保主模块可以被新启动的Python解释器安全导入而不会引发什么副作用（比如又启动了一个子进程）</p>
<p>例如，使用 <em>spawn</em> 或 <em>forkserver</em> 启动方式执行下面的模块，会引发 <code>RuntimeError</code> 异常而失败。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应该通过下面的方法使用 <code>if __name__ == '__main__':</code> ，从而保护程序”入口点”:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> freeze_support<span class="token punctuation">,</span> set_start_method
<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    set_start_method<span class="token punctuation">(</span><span class="token string">'spawn'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（如果程序将正常运行而不是冻结，则可以省略 <code>freeze_support()</code> 行）</p>
<p>这允许新启动的 Python 解释器安全导入模块然后运行模块中的 <code>foo()</code> 函数。</p>
<p>如果主模块中创建了进程池或者管理器，这个规则也适用。</p>
</blockquote>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>创建和使用自定义管理器、代理的示例:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> freeze_support
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager<span class="token punctuation">,</span> BaseProxy
<span class="token keyword">import</span> operator
<span class="token comment" spellcheck="true">##</span>
<span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'you called Foo.f()'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'you called Foo.g()'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_h</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'you called Foo._h()'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># A simple generator function</span>
<span class="token keyword">def</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> i<span class="token operator">*</span>i
<span class="token comment" spellcheck="true"># Proxy type for generator objects</span>
<span class="token keyword">class</span> <span class="token class-name">GeneratorProxy</span><span class="token punctuation">(</span>BaseProxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _exposed_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__next__'</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self
    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_callmethod<span class="token punctuation">(</span><span class="token string">'__next__'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Function to return the operator module</span>
<span class="token keyword">def</span> <span class="token function">get_operator_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> operator
<span class="token comment" spellcheck="true">##</span>
<span class="token keyword">class</span> <span class="token class-name">MyManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token comment" spellcheck="true"># register the Foo class; make `f()` and `g()` accessible via proxy</span>
MyManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'Foo1'</span><span class="token punctuation">,</span> Foo<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># register the Foo class; make `g()` and `_h()` accessible via proxy</span>
MyManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'Foo2'</span><span class="token punctuation">,</span> Foo<span class="token punctuation">,</span> exposed<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'_h'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># register the generator function baz; use `GeneratorProxy` to make proxies</span>
MyManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">,</span> baz<span class="token punctuation">,</span> proxytype<span class="token operator">=</span>GeneratorProxy<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># register get_operator_module(); make public functions accessible via proxy</span>
MyManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">'operator'</span><span class="token punctuation">,</span> get_operator_module<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    manager <span class="token operator">=</span> MyManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    manager<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span>
    f1 <span class="token operator">=</span> manager<span class="token punctuation">.</span>Foo1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f1<span class="token punctuation">.</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f1<span class="token punctuation">.</span>g<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token operator">not</span> hasattr<span class="token punctuation">(</span>f1<span class="token punctuation">,</span> <span class="token string">'_h'</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> sorted<span class="token punctuation">(</span>f1<span class="token punctuation">.</span>_exposed_<span class="token punctuation">)</span> <span class="token operator">==</span> sorted<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span>
    f2 <span class="token operator">=</span> manager<span class="token punctuation">.</span>Foo2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f2<span class="token punctuation">.</span>g<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f2<span class="token punctuation">.</span>_h<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token operator">not</span> hasattr<span class="token punctuation">(</span>f2<span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> sorted<span class="token punctuation">(</span>f2<span class="token punctuation">.</span>_exposed_<span class="token punctuation">)</span> <span class="token operator">==</span> sorted<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'_h'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span>
    it <span class="token operator">=</span> manager<span class="token punctuation">.</span>baz<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> it<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'&lt;%d>'</span> <span class="token operator">%</span> i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span>
    op <span class="token operator">=</span> manager<span class="token punctuation">.</span>operator<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'op.add(23, 45) ='</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'op.pow(2, 94) ='</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'op._exposed_ ='</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>_exposed_<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>Pool</code>:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Functions used by test code</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'%s says that %s%s = %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
        multiprocessing<span class="token punctuation">.</span>current_process<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        func<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> args<span class="token punctuation">,</span> result
        <span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">calculatestar</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> calculate<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mul</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b
<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">5.0</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pow3</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">**</span> <span class="token number">3</span>
<span class="token keyword">def</span> <span class="token function">noop</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Test code</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    PROCESSES <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Creating pool with %d processes\n'</span> <span class="token operator">%</span> PROCESSES<span class="token punctuation">)</span>
    <span class="token keyword">with</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span>PROCESSES<span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true"># Tests</span>
        <span class="token comment" spellcheck="true">#</span>
        TASKS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>mul<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> \
                <span class="token punctuation">[</span><span class="token punctuation">(</span>plus<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        results <span class="token operator">=</span> <span class="token punctuation">[</span>pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>calculate<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> TASKS<span class="token punctuation">]</span>
        imap_it <span class="token operator">=</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>calculatestar<span class="token punctuation">,</span> TASKS<span class="token punctuation">)</span>
        imap_unordered_it <span class="token operator">=</span> pool<span class="token punctuation">.</span>imap_unordered<span class="token punctuation">(</span>calculatestar<span class="token punctuation">,</span> TASKS<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Ordered results using pool.apply_async():'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> r <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Ordered results using pool.imap():'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> imap_it<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unordered results using pool.imap_unordered():'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> imap_unordered_it<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Ordered results using pool.map() --- will block till complete:'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> pool<span class="token punctuation">.</span>map<span class="token punctuation">(</span>calculatestar<span class="token punctuation">,</span> TASKS<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true"># Test error handling</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Testing error handling:'</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>apply<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\tGot ZeroDivisionError as expected from pool.apply()'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span><span class="token string">'expected ZeroDivisionError'</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>map<span class="token punctuation">(</span>f<span class="token punctuation">,</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\tGot ZeroDivisionError as expected from pool.map()'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span><span class="token string">'expected ZeroDivisionError'</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">(</span>pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>f<span class="token punctuation">,</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\tGot ZeroDivisionError as expected from list(pool.imap())'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span><span class="token string">'expected ZeroDivisionError'</span><span class="token punctuation">)</span>
        it <span class="token operator">=</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>f<span class="token punctuation">,</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> next<span class="token punctuation">(</span>it<span class="token punctuation">)</span>
            <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>
                <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
            <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span><span class="token string">'expected ZeroDivisionError'</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> i <span class="token operator">==</span> <span class="token number">9</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\tGot ZeroDivisionError as expected from IMapIterator.next()'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true"># Testing timeouts</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Testing ApplyResult.get() with timeout:'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>calculate<span class="token punctuation">,</span> TASKS<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n\t%s'</span> <span class="token operator">%</span> res<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span> multiprocessing<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Testing IMapIterator.next() with timeout:'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
        it <span class="token operator">=</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>calculatestar<span class="token punctuation">,</span> TASKS<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n\t%s'</span> <span class="token operator">%</span> it<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span> multiprocessing<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    multiprocessing<span class="token punctuation">.</span>freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一个演示如何使用队列来向一组工作进程提供任务并收集结果的例子：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue<span class="token punctuation">,</span> current_process<span class="token punctuation">,</span> freeze_support
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Function run by worker processes</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> func<span class="token punctuation">,</span> args <span class="token keyword">in</span> iter<span class="token punctuation">(</span>input<span class="token punctuation">.</span>get<span class="token punctuation">,</span> <span class="token string">'STOP'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> calculate<span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        output<span class="token punctuation">.</span>put<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Function used to calculate result</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'%s says that %s%s = %s'</span> <span class="token operator">%</span> \
        <span class="token punctuation">(</span>current_process<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> args<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Functions referenced by tasks</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">mul</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b
<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    NUMBER_OF_PROCESSES <span class="token operator">=</span> <span class="token number">4</span>
    TASKS1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>mul<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    TASKS2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>plus<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># Create queues</span>
    task_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    done_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Submit tasks</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> TASKS1<span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Start worker processes</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>NUMBER_OF_PROCESSES<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Process<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>task_queue<span class="token punctuation">,</span> done_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Get and print results</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unordered results:'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>TASKS1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> done_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Add more tasks using `put()`</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> TASKS2<span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Get and print some more results</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>TASKS2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">,</span> done_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Tell child processes to stop</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>NUMBER_OF_PROCESSES<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'STOP'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="multiprocessing-shared-memory-—-可从进程直接访问的共享内存"><a href="#multiprocessing-shared-memory-—-可从进程直接访问的共享内存" class="headerlink" title="multiprocessing.shared_memory —- 可从进程直接访问的共享内存"></a><code>multiprocessing.shared_memory</code> —- 可从进程直接访问的共享内存</h2><p><strong>源代码:</strong> <a href="https://github.com/python/cpython/tree/3.10/Lib/multiprocessing/shared_memory.py" target="_blank" rel="noopener">Lib/multiprocessing/shared_memory.py</a></p>
<p>3.8 新版功能.</p>
<hr>
<p>该模块提供了一个 <code>SharedMemory</code> 类，用于分配和管理多核或对称多处理器（SMP）机器上进程间的共享内存。为了协助管理不同进程间的共享内存生命周期，<code>multiprocessing.managers</code> 模块也提供了一个 <code>BaseManager</code> 的子类： <code>SharedMemoryManager</code>。</p>
<p>本模块中，共享内存是指 “System V 类型” 的共享内存块（虽然可能和它实现方式不完全一致）而不是 “分布式共享内存”。这种类型的的共享内存允许不同进程读写一片公共（或者共享）的易失性存储区域。一般来说，进程被限制只能访问属于自己进程空间的内存，但是共享内存允许跨进程共享数据，从而避免通过进程间发送消息的形式传递数据。相比通过磁盘、套接字或者其他要求序列化、反序列化和复制数据的共享形式，直接通过内存共享数据拥有更出色性能。</p>
<p><em>class</em> <code>multiprocessing.shared_memory.SharedMemory</code>(<em>name=None</em>, <em>create=False</em>, <em>size=0</em>)</p>
<p>创建一个新的共享内存块或者连接到一片已经存在的共享内存块。每个共享内存块都被指定了一个全局唯一的名称。通过这种方式，进程可以使用一个特定的名字创建共享内存区块，然后其他进程使用同样的名字连接到这个共享内存块。</p>
<p>作为一种跨进程共享数据的方式，共享内存块的寿命可能超过创建它的原始进程。一个共享内存块可能同时被多个进程使用，当一个进程不再需要访问这个共享内存块的时候，应该调用 <code>close()</code> 方法。当一个共享内存块不被任何进程使用的时候，应该调用 <code>unlink()</code> 方法以执行必要的清理。</p>
<p><em>name</em> 是共享内存的唯一名称，字符串类型。如果创建一个新共享内存块的时候，名称指定为 <code>None</code> (默认值)，将会随机产生一个新名称。</p>
<p><em>create</em> 指定创建一个新的共享内存块 (<code>True</code>) 还是连接到已存在的共享内存块 (<code>False</code>) 。</p>
<p>如果是新创建共享内存块则 <em>size</em> 用于指定块的大小为多少字节。由于某些平台是以内存页大小为最小单位来分配内存的，最终得到的内存块大小可能大于或等于要求的大小。如果是连接到已经存在的共享内存块， <code>size</code> 参数会被忽略。</p>
<ul>
<li><p><code>close</code>()</p>
<p>关闭实例对于共享内存的访问连接。所有实例确认自己不再需要使用共享内存的时候都应该调用 <code>close()</code> ，以保证必要的资源清理。调用 <code>close()</code> 并不会销毁共享内存区域。</p>
</li>
<li><p><code>unlink</code>()</p>
<p>请求销毁底层的共享内存块。为了执行必要的资源清理， 在所有使用这个共享内存块的进程中， <code>unlink()</code> 应该调用一次(且只能调用一次) 。发出此销毁请求后，共享内存块可能会、也可能不会立即销毁，且此行为在不同操作系统之间可能不同。调用 <code>unlink()</code> 后再尝试方位其中的数据可能导致内存错误。注意: 最后一个关闭共享内存访问权限的进程可以以任意顺序调用 <code>unlink()</code> 和 <code>close()</code> 。</p>
</li>
<li><p><code>buf</code></p>
<p>共享内存块内容的 memoryview 。</p>
</li>
<li><p><code>name</code></p>
<p>共享内存块的唯一标识，只读属性。</p>
</li>
<li><p><code>size</code></p>
<p>共享内存块的字节大小，只读属性。</p>
</li>
</ul>
<p>以下示例展示了 <code>SharedMemory</code> 底层的用法:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> shared_memory
<span class="token operator">>></span><span class="token operator">></span> shm_a <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>SharedMemory<span class="token punctuation">(</span>create<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>shm_a<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'memoryview'</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> buffer <span class="token operator">=</span> shm_a<span class="token punctuation">.</span>buf
<span class="token operator">>></span><span class="token operator">></span> len<span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
<span class="token number">10</span>
<span class="token operator">>></span><span class="token operator">></span> buffer<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> bytearray<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Modify multiple at once</span>
<span class="token operator">>></span><span class="token operator">></span> buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>                           <span class="token comment" spellcheck="true"># Modify single byte at a time</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Attach to an existing shared memory block</span>
<span class="token operator">>></span><span class="token operator">></span> shm_b <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>SharedMemory<span class="token punctuation">(</span>shm_a<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> array
<span class="token operator">>></span><span class="token operator">></span> array<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> shm_b<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Copy the data into a new array.array</span>
array<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> shm_b<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token string">'howdy'</span>  <span class="token comment" spellcheck="true"># Modify via shm_b using bytes</span>
<span class="token operator">>></span><span class="token operator">></span> bytes<span class="token punctuation">(</span>shm_a<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># Access via shm_a</span>
b<span class="token string">'howdy'</span>
<span class="token operator">>></span><span class="token operator">></span> shm_b<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># Close each SharedMemory instance</span>
<span class="token operator">>></span><span class="token operator">></span> shm_a<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> shm_a<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Call unlink only once to release the shared memory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下示例展示了一个现实中的例子，使用 <code>SharedMemory</code> 类和 NumPy arrays 结合, 从两个 Python shell 中访问同一个 <code>numpy.ndarray</code> :</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># In the first Python interactive shell</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Start with an existing NumPy array</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> shared_memory
<span class="token operator">>></span><span class="token operator">></span> shm <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>SharedMemory<span class="token punctuation">(</span>create<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> size<span class="token operator">=</span>a<span class="token punctuation">.</span>nbytes<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Now create a NumPy array backed by shared memory</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">(</span>a<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>a<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> buffer<span class="token operator">=</span>shm<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># Copy the original data into shared memory</span>
<span class="token operator">>></span><span class="token operator">></span> b
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'numpy.ndarray'</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'numpy.ndarray'</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> shm<span class="token punctuation">.</span>name  <span class="token comment" spellcheck="true"># We did not specify a name so one was chosen for us</span>
<span class="token string">'psm_21467_46075'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># In either the same shell or a new Python shell on the same machine</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> shared_memory
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Attach to the existing shared memory block</span>
<span class="token operator">>></span><span class="token operator">></span> existing_shm <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>SharedMemory<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'psm_21467_46075'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Note that a.shape is (6,) and a.dtype is np.int64 in this example</span>
<span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> buffer<span class="token operator">=</span>existing_shm<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">888</span>
<span class="token operator">>></span><span class="token operator">></span> c
array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">,</span>   <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">888</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Back in the first Python interactive shell, b reflects this change</span>
<span class="token operator">>></span><span class="token operator">></span> b
array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">,</span>   <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">888</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Clean up from within the second Python shell</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> c  <span class="token comment" spellcheck="true"># Unnecessary; merely emphasizing the array is no longer used</span>
<span class="token operator">>></span><span class="token operator">></span> existing_shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Clean up from within the first Python shell</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> b  <span class="token comment" spellcheck="true"># Unnecessary; merely emphasizing the array is no longer used</span>
<span class="token operator">>></span><span class="token operator">></span> shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> shm<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Free and release the shared memory block at the very end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>class</em> <code>multiprocessing.managers.SharedMemoryManager</code>([<em>address</em>[, <em>authkey</em>]])</p>
<p><code>BaseManager</code> 的子类，可用于管理跨进程的共享内存块。</p>
<p>调用 <code>SharedMemoryManager</code> 实例上的 <code>start()</code> 方法会启动一个新进程。这个新进程的唯一目的就是管理所有由它创建的共享内存块的生命周期。想要释放此进程管理的所有共享内存块，可以调用实例的 <code>shutdown()</code> 方法。这会触发执行它管理的所有 <code>SharedMemory</code> 对象的 <code>SharedMemory.unlink()</code> 方法，然后停止这个进程。通过 <code>SharedMemoryManager</code> 创建 <code>SharedMemory</code> 实例，我们可以避免手动跟踪和释放共享内存资源。</p>
<p>这个类提供了创建和返回 <code>SharedMemory</code> 实例的方法，以及以共享内存为基础创建一个列表类对象 (<code>ShareableList</code>) 的方法。</p>
<p>有关继承的可选输入参数 <em>address</em> 和 <em>authkey</em> 以及他们如何用于从进程连接已经存在的 <code>SharedMemoryManager</code> 服务，参见 <code>multiprocessing.managers.BaseManager</code> 。</p>
<ul>
<li><p><code>SharedMemory</code>(<em>size</em>)</p>
<p>使用 <code>size</code> 参数，创建一个新的指定字节大小的 <code>SharedMemory</code> 对象并返回。</p>
</li>
<li><p><code>ShareableList</code>(<em>sequence</em>)</p>
<p>创建并返回一个新的 <code>ShareableList</code> 对象，通过输入参数 <code>sequence</code> 初始化。</p>
</li>
</ul>
<p>下面的案例展示了 <code>SharedMemoryManager</code> 的基本机制:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> SharedMemoryManager
<span class="token operator">>></span><span class="token operator">></span> smm <span class="token operator">=</span> SharedMemoryManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> smm<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Start the process that manages the shared memory blocks</span>
<span class="token operator">>></span><span class="token operator">></span> sl <span class="token operator">=</span> smm<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sl
ShareableList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'psm_6572_7512'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> raw_shm <span class="token operator">=</span> smm<span class="token punctuation">.</span>SharedMemory<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> another_sl <span class="token operator">=</span> smm<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span><span class="token string">'alpha'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> another_sl
ShareableList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'psm_6572_12221'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> smm<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Calls unlink() on sl, raw_shm, and another_sl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下案例展示了 <code>SharedMemoryManager</code> 对象的一种可能更方便的使用方式，通过 <code>with</code> 语句来保证所有共享内存块在使用完后被释放。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">with</span> SharedMemoryManager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> smm<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     sl <span class="token operator">=</span> smm<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token comment" spellcheck="true"># Divide the work among two processes, storing partial results in sl</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>do_work<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>do_work<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># A multiprocessing.Pool might be more efficient</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     p2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># Wait for all work to complete in both processes</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     total_result <span class="token operator">=</span> sum<span class="token punctuation">(</span>sl<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Consolidate the partial results now in sl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 <code>with</code> 语句中使用 <code>SharedMemoryManager</code> 对象的时候，使用这个管理器创建的共享内存块会在 <code>with</code> 语句代码块结束后被释放。</p>
<p><em>class</em> <code>multiprocessing.shared_memory.ShareableList</code>(<em>sequence=None</em>, <em>**,</em> name=None*)</p>
<p>提供一个可修改的类 list 对象，其中所有值都存放在共享内存块中。这限制了可被存储在其中的值只能是 <code>int</code>, <code>float</code>, <code>bool</code>, <code>str</code> （每条数据小于10M）, <code>bytes</code> （每条数据小于10M）以及 <code>None</code> 这些内置类型。它另一个显著区别于内置 <code>list</code> 类型的地方在于它的长度无法修改（比如，没有 append, insert 等操作）且不支持通过切片操作动态创建新的 <code>ShareableList</code> 实例。</p>
<p><em>sequence</em> 会被用来为一个新的 <code>ShareableList</code> 填充值。 设为 <code>None</code> 则会基于唯一的共享内存名称关联到已经存在的 <code>ShareableList</code>。</p>
<p><em>name</em> 是所请求的共享内存的唯一名称，与 <code>SharedMemory</code> 的定义中所描述的一致。 当关联到现有的 <code>ShareableList</code> 时，则指明其共享内存块的唯一名称并将 <code>sequence</code> 设为 <code>None</code>。</p>
<ul>
<li><p><code>count</code>(<em>value</em>)</p>
<p>返回 <code>value</code> 出现的次数。</p>
</li>
<li><p><code>index</code>(<em>value</em>)</p>
<p>返回 <code>value</code> 首次出现的位置，如果 <code>value</code> 不存在, 则抛出 <code>ValueError</code> 异常。</p>
</li>
<li><p><code>format</code></p>
<p>包含由所有当前存储值所使用的 <code>struct</code> 打包格式的只读属性。</p>
</li>
<li><p><code>shm</code></p>
<p>存储了值的 <code>SharedMemory</code> 实例。</p>
</li>
</ul>
<p>下面的例子演示了 <code>ShareableList</code> 实例的基本用法:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> shared_memory
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'howdy'</span><span class="token punctuation">,</span> b<span class="token string">'HoWdY'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">273.154</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span> type<span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token keyword">for</span> entry <span class="token keyword">in</span> a <span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'str'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'bytes'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'float'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'NoneType'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'bool'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">></span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token number">273.154</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">78.5</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token number">78.5</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'dry ice'</span>  <span class="token comment" spellcheck="true"># Changing data types is supported as well</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token string">'dry ice'</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'larger than previously allocated storage space'</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ValueError<span class="token punctuation">:</span> exceeds available storage <span class="token keyword">for</span> existing str
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token string">'dry ice'</span>
<span class="token operator">>></span><span class="token operator">></span> len<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">7</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token number">6</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>count<span class="token punctuation">(</span>b<span class="token string">'howdy'</span><span class="token punctuation">)</span>
<span class="token number">0</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>count<span class="token punctuation">(</span>b<span class="token string">'HoWdY'</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> a  <span class="token comment" spellcheck="true"># Use of a ShareableList after call to unlink() is unsupported</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面的例子演示了一个、两个或多个进程如何通过提供下层的共享内存块名称来访问同一个 <code>ShareableList</code>:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># In a first process</span>
<span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span>name<span class="token operator">=</span>b<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># In a second process</span>
<span class="token operator">>></span><span class="token operator">></span> c
ShareableList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">999</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token number">999</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The following examples demonstrates that <code>ShareableList</code> (and underlying <code>SharedMemory</code>) objects can be pickled and unpickled if needed. Note, that it will still be the same shared object. This happens, because the deserialized object has the same unique name and is just attached to an existing object with the same name (if the object is still alive):</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> pickle
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> shared_memory
<span class="token operator">>></span><span class="token operator">></span> sl <span class="token operator">=</span> shared_memory<span class="token punctuation">.</span>ShareableList<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> list<span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>

<span class="token operator">>></span><span class="token operator">></span> deserialized_sl <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sl<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> list<span class="token punctuation">(</span>deserialized_sl<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>

<span class="token operator">>></span><span class="token operator">></span> sl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> deserialized_sl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> list<span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> list<span class="token punctuation">(</span>deserialized_sl<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>

<span class="token operator">>></span><span class="token operator">></span> sl<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sl<span class="token punctuation">.</span>shm<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="concurrent-包"><a href="#concurrent-包" class="headerlink" title="concurrent 包"></a><code>concurrent</code> 包</h2><p>目前，此包中只有一个模块：</p>
<ul>
<li><code>concurrent.futures</code> —— 启动并行任务</li>
</ul>
<h2 id="concurrent-futures-—-启动并行任务"><a href="#concurrent-futures-—-启动并行任务" class="headerlink" title="concurrent.futures —- 启动并行任务"></a><code>concurrent.futures</code> —- 启动并行任务</h2><p>3.2 新版功能.</p>
<p><strong>源码:</strong> <a href="https://github.com/python/cpython/tree/3.10/Lib/concurrent/futures/thread.py" target="_blank" rel="noopener">Lib/concurrent/futures/thread.py</a> 和 <a href="https://github.com/python/cpython/tree/3.10/Lib/concurrent/futures/process.py" target="_blank" rel="noopener">Lib/concurrent/futures/process.py</a></p>
<hr>
<p><code>concurrent.futures</code> 模块提供异步执行可调用对象高层接口。</p>
<p>异步执行可以由 <code>ThreadPoolExecutor</code> 使用线程或由 <code>ProcessPoolExecutor</code> 使用单独的进程来实现。 两者都是实现抽像类 <code>Executor</code> 定义的接口。</p>
<h3 id="Executor-对象"><a href="#Executor-对象" class="headerlink" title="Executor 对象"></a>Executor 对象</h3><p><em>class</em> <code>concurrent.futures.Executor</code></p>
<p>抽象类提供异步执行调用方法。要通过它的子类调用，而不是直接调用。</p>
<blockquote>
<ul>
<li><p><code>submit</code>(<em>fn</em>, <em>/</em>, <em>\</em>args<em>,</em> <em>*kwargs</em>)</p>
<p>调度可调用对象 <em>fn</em>，以 <code>fn(*args **kwargs)</code> 方式执行并返回 <code>Future</code> 对象代表可调用对象的执行。:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    future <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>pow<span class="token punctuation">,</span> <span class="token number">323</span><span class="token punctuation">,</span> <span class="token number">1235</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>map</code>(<em>func</em>, <em>\</em>iterables<em>,</em> timeout=None<em>,</em> chunksize=1*)</p>
<p>类似于 <code>map(func, *iterables)</code> 函数，除了以下两点：</p>
<ul>
<li><p><em>iterables</em> 是立即执行而不是延迟执行的；</p>
</li>
<li><p><em>func</em> 是异步执行的，对 <em>func</em> 的多个调用可以并发执行。</p>
<p>如果从原始调用到 <code>Executor.map()</code> 经过 <em>timeout</em> 秒后， <code>__next__()</code> 已被调用且返回的结果还不可用，那么已返回的迭代器将触发 <code>concurrent.futures.TimeoutError</code> 。 <em>timeout</em> 可以是整数或浮点数。如果 <em>timeout</em> 没有指定或为 <code>None</code> ，则没有超时限制。<br>如果 <em>func</em> 调用引发一个异常，当从迭代器中取回它的值时这个异常将被引发。<br>使用 <code>ProcessPoolExecutor</code> 时，这个方法会将 <em>iterables</em> 分割任务块并作为独立的任务并提交到执行池中。这些块的大概数量可以由 <em>chunksize</em> 指定正整数设置。 对很长的迭代器来说，使用大的 <em>chunksize</em> 值比默认值 1 能显著地提高性能。 <em>chunksize</em> 对 <code>ThreadPoolExecutor</code> 没有效果。<br>在 3.5 版更改: 加入 <em>chunksize</em> 参数。</p>
</li>
</ul>
</li>
<li><p><code>shutdown</code>(<em>wait=True</em>, <em>**,</em> cancel_futures=False*)</p>
<p>当待执行的 future 对象完成执行后向执行者发送信号，它就会释放正在使用的任何资源。 在关闭后调用 <code>Executor.submit()</code> 和 <code>Executor.map()</code> 将会引发 <code>RuntimeError</code>。</p>
<p>如果 <em>wait</em> 为 <code>True</code> 则此方法只有在所有待执行的 future 对象完成执行且释放已分配的资源后才会返回。 如果 <em>wait</em> 为 <code>False</code>，方法立即返回，所有待执行的 future 对象完成执行后会释放已分配的资源。 不管 <em>wait</em> 的值是什么，整个 Python 程序将等到所有待执行的 future 对象完成执行后才退出。</p>
<p>如果 <em>cancel_futures</em> 为 <code>True</code>，此方法将取消所有执行器还未开始运行的挂起的 Future。 任何已完成或正在运行的 Future 将不会被取消，无论 <em>cancel_futures</em> 的值是什么？</p>
<p>如果 <em>cancel_futures</em> 和 <em>wait</em> 均为 <code>True</code>，则执行器已开始运行的所有 Future 将在此方法返回之前完成。 其余的 Future 会被取消。</p>
<p>如果使用 <code>with</code> 语句，你就可以避免显式调用这个方法，它将会停止 <code>Executor</code> (就好像 <code>Executor.shutdown()</code> 调用时 <em>wait</em> 设为 <code>True</code> 一样等待):</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> shutil
<span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    e<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span> <span class="token string">'src1.txt'</span><span class="token punctuation">,</span> <span class="token string">'dest1.txt'</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span> <span class="token string">'src2.txt'</span><span class="token punctuation">,</span> <span class="token string">'dest2.txt'</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span> <span class="token string">'src3.txt'</span><span class="token punctuation">,</span> <span class="token string">'dest3.txt'</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span> <span class="token string">'src4.txt'</span><span class="token punctuation">,</span> <span class="token string">'dest4.txt'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 3.9 版更改: 增加了 <em>cancel_futures</em>。</p>
</li>
</ul>
</blockquote>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p><code>ThreadPoolExecutor</code> 是 <code>Executor</code> 的子类，它使用线程池来异步执行调用。</p>
<p>当回调已关联了一个 <code>Future</code> 然后再等待另一个 <code>Future</code> 的结果时就会发产死锁情况。例如:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">wait_on_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># b will never complete because it is waiting on a.</span>
    <span class="token keyword">return</span> <span class="token number">5</span>
<span class="token keyword">def</span> <span class="token function">wait_on_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># a will never complete because it is waiting on b.</span>
    <span class="token keyword">return</span> <span class="token number">6</span>
executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>wait_on_b<span class="token punctuation">)</span>
b <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>wait_on_a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">wait_on_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>pow<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># This will never complete because there is only one worker thread and</span>
    <span class="token comment" spellcheck="true"># it is executing this function.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>wait_on_future<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>class</em> <code>concurrent.futures.ThreadPoolExecutor</code>(<em>max_workers=None</em>, <em>thread_name_prefix=’’</em>, <em>initializer=None</em>, <em>initargs=()</em>)</p>
<p><code>Executor</code> 子类使用最多 <em>max_workers</em> 个线程的线程池来异步执行调用。</p>
<p><em>initializer</em> 是在每个工作者线程开始处调用的一个可选可调用对象。 <em>initargs</em> 是传递给初始化器的元组参数。任何向池提交更多工作的尝试， <em>initializer</em> 都将引发一个异常，当前所有等待的工作都会引发一个 <code>BrokenThreadPool</code>。</p>
<p>在 3.5 版更改: 如果 <em>max_workers</em> 为 <code>None</code> 或没有指定，将默认为机器处理器的个数，假如 <code>ThreadPoolExecutor</code> 则重于I/O操作而不是CPU运算，那么可以乘以 <code>5</code> ，同时工作线程的数量可以比 <code>ProcessPoolExecutor</code> 的数量高。</p>
<p>3.6 新版功能: 添加 <em>thread_name_prefix</em> 参数允许用户控制由线程池创建的 <code>threading.Thread</code> 工作线程名称以方便调试。</p>
<p>在 3.7 版更改: 加入 <em>initializer</em> 和<em>initargs</em> 参数。</p>
<p>在 3.8 版更改: <em>max_workers</em> 的默认值已改为 <code>min(32, os.cpu_count() + 4)</code>。 这个默认值会保留至少 5 个工作线程用于 I/O 密集型任务。 对于那些释放了 GIL 的 CPU 密集型任务，它最多会使用 32 个 CPU 核心。这样能够避免在多核机器上不知不觉地使用大量资源。</p>
<p>现在 ThreadPoolExecutor 在启动 <em>max_workers</em> 个工作线程之前也会重用空闲的工作线程。</p>
<h4 id="ThreadPoolExecutor-例子"><a href="#ThreadPoolExecutor-例子" class="headerlink" title="ThreadPoolExecutor 例子"></a>ThreadPoolExecutor 例子</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request
URLS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://www.foxnews.com/'</span><span class="token punctuation">,</span>
        <span class="token string">'http://www.cnn.com/'</span><span class="token punctuation">,</span>
        <span class="token string">'http://europe.wsj.com/'</span><span class="token punctuation">,</span>
        <span class="token string">'http://www.bbc.co.uk/'</span><span class="token punctuation">,</span>
        <span class="token string">'http://some-made-up-domain.com/'</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># Retrieve a single page and report the URL and contents</span>
<span class="token keyword">def</span> <span class="token function">load_url</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token operator">=</span>timeout<span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># We can use a with statement to ensure threads are cleaned up promptly</span>
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Start the load operations and mark each future with its URL</span>
    future_to_url <span class="token operator">=</span> <span class="token punctuation">{</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>load_url<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span> url <span class="token keyword">for</span> url <span class="token keyword">in</span> URLS<span class="token punctuation">}</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>future_to_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> future_to_url<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%r generated an exception: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> exc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%r page is %d bytes'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ProcessPoolExecutor"><a href="#ProcessPoolExecutor" class="headerlink" title="ProcessPoolExecutor"></a>ProcessPoolExecutor</h3><p><code>ProcessPoolExecutor</code> 类是 <code>Executor</code> 的子类，它使用进程池来异步地执行调用。 <code>ProcessPoolExecutor</code> 会使用 <code>multiprocessing</code> 模块，这允许它绕过 全局解释器锁 但也意味着只可以处理和返回可封存的对象。</p>
<p><code>__main__</code> 模块必须可以被工作者子进程导入。这意味着 <code>ProcessPoolExecutor</code> 不可以工作在交互式解释器中。</p>
<p>从可调用对象中调用 <code>Executor</code> 或 <code>Future</code> 的方法提交给 <code>ProcessPoolExecutor</code> 会导致死锁。</p>
<p><em>class</em> <code>concurrent.futures.ProcessPoolExecutor</code>(<em>max_workers=None</em>, <em>mp_context=None</em>, <em>initializer=None</em>, <em>initargs=()</em>)</p>
<p>异步地执行调用的 <code>Executor</code> 子类使用最多具有 <em>max_workers</em> 个进程的进程池。 如果 <em>max_workers</em> 为 <code>None</code> 或未给出，它将默认为机器的处理器个数。 如果 <em>max_workers</em> 小于等于 <code>0</code>，则将引发 <code>ValueError</code>。 在 Windows 上，<em>max_workers</em> 必须小于等于 <code>61</code>，否则将引发 <code>ValueError</code>。 如果 <em>max_workers</em> 为 <code>None</code>，则所选择的默认值最多为 <code>61</code>，即使存在更多的处理器。 <em>mp_context</em> 可以是一个多进程上下文或是 None。 它将被用来启动工作进程。 如果 <em>mp_context</em> 为 <code>None</code> 或未给出，则将使用默认的多进程上下文。</p>
<p><em>initializer</em> 是一个可选的可调用对象，它会在每个工作进程启动时被调用；<em>initargs</em> 是传给 initializer 的参数元组。 如果 <em>initializer</em> 引发了异常，则所有当前在等待的任务以及任何向进程池提交更多任务的尝试都将引发 <code>BrokenProcessPool</code>。</p>
<p>在 3.3 版更改: 如果其中一个工作进程被突然终止，<code>BrokenProcessPool</code> 就会马上触发。 可预计的行为没有定义，但执行器上的操作或它的 future 对象会被冻结或死锁。</p>
<p>在 3.7 版更改: 添加 <em>mp_context</em> 参数允许用户控制由进程池创建给工作者进程的开始方法 。</p>
<p>加入 <em>initializer</em> 和<em>initargs</em> 参数。</p>
<h4 id="ProcessPoolExecutor-例子"><a href="#ProcessPoolExecutor-例子" class="headerlink" title="ProcessPoolExecutor 例子"></a>ProcessPoolExecutor 例子</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> math
PRIMES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">112272535095293</span><span class="token punctuation">,</span>
    <span class="token number">112582705942171</span><span class="token punctuation">,</span>
    <span class="token number">112272535095293</span><span class="token punctuation">,</span>
    <span class="token number">115280095190773</span><span class="token punctuation">,</span>
    <span class="token number">115797848077099</span><span class="token punctuation">,</span>
    <span class="token number">1099726899285419</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">is_prime</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    sqrt_n <span class="token operator">=</span> int<span class="token punctuation">(</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> sqrt_n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> n <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ProcessPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
        <span class="token keyword">for</span> number<span class="token punctuation">,</span> prime <span class="token keyword">in</span> zip<span class="token punctuation">(</span>PRIMES<span class="token punctuation">,</span> executor<span class="token punctuation">.</span>map<span class="token punctuation">(</span>is_prime<span class="token punctuation">,</span> PRIMES<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d is prime: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>number<span class="token punctuation">,</span> prime<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Future-对象"><a href="#Future-对象" class="headerlink" title="Future 对象"></a>Future 对象</h3><p><code>Future</code> 类将可调用对象封装为异步执行。<code>Future</code> 实例由 <code>Executor.submit()</code> 创建。</p>
<p><em>class</em> <code>concurrent.futures.Future</code></p>
<p>将可调用对象封装为异步执行。<code>Future</code> 实例由 <code>Executor.submit()</code> 创建，除非测试，不应直接创建。</p>
<blockquote>
<ul>
<li><p><code>cancel</code>()</p>
<p>尝试取消调用。 如果调用正在执行或已结束运行不能被取消则该方法将返回 <code>False</code>，否则调用会被取消并且该方法将返回 <code>True</code>。</p>
</li>
<li><p><code>cancelled</code>()</p>
<p>如果调用成功取消返回 <code>True</code>。</p>
</li>
<li><p><code>running</code>()</p>
<p>如果调用正在执行而且不能被取消那么返回 <code>True</code> 。</p>
</li>
<li><p><code>done</code>()</p>
<p>如果调用已被取消或正常结束那么返回 <code>True</code>。</p>
</li>
<li><p><code>result</code>(<em>timeout=None</em>)</p>
<p>返回调用返回的值。如果调用还没完成那么这个方法将等待 <em>timeout</em> 秒。如果在 <em>timeout</em> 秒内没有执行完成，<code>concurrent.futures.TimeoutError</code> 将会被触发。<em>timeout</em> 可以是整数或浮点数。如果 <em>timeout</em> 没有指定或为 <code>None</code>，那么等待时间就没有限制。</p>
<p>如果 futrue 在完成前被取消则 <code>CancelledError</code> 将被触发。</p>
<p>如果调用引发了一个异常，这个方法也会引发同样的异常。</p>
</li>
<li><p><code>exception</code>(<em>timeout=None</em>)</p>
<p>返回由调用引发的异常。如果调用还没完成那么这个方法将等待 <em>timeout</em> 秒。如果在 <em>timeout</em> 秒内没有执行完成，<code>concurrent.futures.TimeoutError</code> 将会被触发。<em>timeout</em> 可以是整数或浮点数。如果 <em>timeout</em> 没有指定或为 <code>None</code>，那么等待时间就没有限制。</p>
<p>如果 futrue 在完成前被取消则 <code>CancelledError</code> 将被触发。</p>
<p>如果调用正常完成那么返回 <code>None</code>。</p>
</li>
<li><p><code>add_done_callback</code>(<em>fn</em>)</p>
<p>附加可调用 <em>fn</em> 到 future 对象。当 future 对象被取消或完成运行时，将会调用 <em>fn</em>，而这个 future 对象将作为它唯一的参数。</p>
<p>加入的可调用对象总被属于添加它们的进程中的线程按加入的顺序调用。如果可调用对象引发一个 <code>Exception</code> 子类，它会被记录下来并被忽略掉。如果可调用对象引发一个 <code>BaseException</code> 子类，这个行为没有定义。</p>
<p>如果 future 对象已经完成或已取消，<em>fn</em> 会被立即调用。</p>
</li>
</ul>
</blockquote>
<p>下面这些 <code>Future</code> 方法用于单元测试和 <code>Executor</code> 实现。</p>
<blockquote>
<ul>
<li><p><code>set_running_or_notify_cancel</code>()</p>
<p>这个方法只可以在执行关联 <code>Future</code> 工作之前由 <code>Executor</code> 实现调用或由单测试调用。</p>
<p>如果这个方法返回 <code>False</code> 那么 <code>Future</code> 已被取消，即 <code>Future.cancel()</code> 已被调用并返回 <code>True</code> 。等待 <code>Future</code> 完成 (即通过 <code>as_completed()</code> 或 <code>wait()</code>) 的线程将被唤醒。</p>
<p>如果这个方法返回 <code>True</code> 那么 <code>Future</code> 不会被取消并已将它变为正在运行状态，也就是说调用 <code>Future.running()</code> 时将返回 True。</p>
<p>这个方法只可以被调用一次并且不能在调用 <code>Future.set_result()</code> 或 <code>Future.set_exception()</code> 之后再调用。</p>
</li>
<li><p><code>set_result</code>(<em>result</em>)</p>
<p>设置将 <code>Future</code> 关联工作的结果给 <em>result</em> 。</p>
<p>这个方法只可以由 <code>Executor</code> 实现和单元测试使用。</p>
<p>在 3.8 版更改: 如果 <code>Future</code> 已经完成则此方法会引发 <code>concurrent.futures.InvalidStateError</code>。</p>
</li>
<li><p><code>set_exception</code>(<em>exception</em>)</p>
<p>设置 <code>Future</code> 关联工作的结果给 <code>Exception</code> <em>exception</em> 。</p>
<p>这个方法只可以由 <code>Executor</code> 实现和单元测试使用。</p>
<p>在 3.8 版更改: 如果 <code>Future</code> 已经完成则此方法会引发 <code>concurrent.futures.InvalidStateError</code>。</p>
</li>
</ul>
</blockquote>
<h3 id="模块函数"><a href="#模块函数" class="headerlink" title="模块函数"></a>模块函数</h3><p><code>concurrent.futures.wait</code>(<em>fs</em>, <em>timeout=None</em>, <em>return_when=ALL_COMPLETED</em>)</p>
<p>等待 <em>fs</em> 指定的 <code>Future</code> 实例（可能由不同的 <code>Executor</code> 实例创建）完成。 返回一个由集合构成的具名 2 元组。 第一个集合名称为 <code>done</code>，包含在等待完成之前已完成的期程（包括正常结束或被取消的 future 对象）。 第二个集合名称为 <code>not_done</code>，包含未完成的 future 对象（包括挂起的或正在运行的 future 对象）。</p>
<p><em>timeout</em> 可以用来控制返回前最大的等待秒数。 <em>timeout</em> 可以为 int 或 float 类型。 如果 <em>timeout</em> 未指定或为 <code>None</code> ，则不限制等待时间。</p>
<p><em>return_when</em> 指定此函数应在何时返回。它必须为以下常数之一:</p>
<table>
<thead>
<tr>
<th align="left">常量</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>FIRST_COMPLETED</code></td>
<td align="left">函数将在任意可等待对象结束或取消时返回。</td>
</tr>
<tr>
<td align="left"><code>FIRST_EXCEPTION</code></td>
<td align="left">函数将在任意可等待对象因引发异常而结束时返回。当没有引发任何异常时它就相当于 <code>ALL_COMPLETED</code>。</td>
</tr>
<tr>
<td align="left"><code>ALL_COMPLETED</code></td>
<td align="left">函数将在所有可等待对象结束或取消时返回。</td>
</tr>
</tbody></table>
<p><code>concurrent.futures.as_completed</code>(<em>fs</em>, <em>timeout=None</em>)</p>
<p>返回一个包含 <em>fs</em> 所指定的 <code>Future</code> 实例（可能由不同的 <code>Executor</code> 实例创建）的迭代器，这些实例会在完成时生成 future 对象（包括正常结束或被取消的 future 对象）。 任何由 <em>fs</em> 所指定的重复 future 对象将只被返回一次。 任何在 <code>as_completed()</code> 被调用之前完成的 future 对象将优先被生成。 如果 <code>__next__()</code> 被调用并且在对 <code>as_completed()</code> 的原始调用 <em>timeout</em> 秒之后结果仍不可用，则返回的迭代器将引发 <code>concurrent.futures.TimeoutError</code>。 <em>timeout</em> 可以为整数或浮点数。 如果 <em>timeout</em> 未指定或为 <code>None</code>，则不限制等待时间。</p>
<p>参见</p>
<p><a href="https://www.python.org/dev/peps/pep-3148" target="_blank" rel="noopener"><strong>PEP 3148</strong></a> — future 对象 - 异步执行指令。</p>
<p>该提案描述了Python标准库中包含的这个特性。</p>
<h3 id="Exception-类"><a href="#Exception-类" class="headerlink" title="Exception 类"></a>Exception 类</h3><p><em>exception</em> <code>concurrent.futures.CancelledError</code></p>
<p>future 对象被取消时会触发。</p>
<p><em>exception</em> <code>concurrent.futures.TimeoutError</code></p>
<p>future 对象执行超出给定的超时数值时引发。</p>
<p><em>exception</em> <code>concurrent.futures.BrokenExecutor</code></p>
<p>当执行器被某些原因中断而且不能用来提交或执行新任务时就会被引发派生于 <code>RuntimeError</code> 的异常类。</p>
<p>3.7 新版功能.</p>
<p><em>exception</em> <code>concurrent.futures.InvalidStateError</code></p>
<p>当某个操作在一个当前状态所不允许的 future 上执行时将被引发。</p>
<p>3.8 新版功能.</p>
<p><em>exception</em> <code>concurrent.futures.thread.BrokenThreadPool</code></p>
<p>当 <code>ThreadPoolExecutor</code> 中的其中一个工作者初始化失败时会引发派生于 <code>BrokenExecutor</code> 的异常类。</p>
<p>3.7 新版功能.</p>
<p><em>exception</em> <code>concurrent.futures.process.BrokenProcessPool</code></p>
<p>当 <code>ThreadPoolExecutor</code> 中的其中一个工作者不完整终止时(比如，被外部杀死)会引发派生于 <code>BrokenExecutor</code> ( 原名 <code>RuntimeError</code> ) 的异常类。</p>
<p>3.3 新版功能.</p>
<h2 id="sched-—-事件调度器"><a href="#sched-—-事件调度器" class="headerlink" title="sched —- 事件调度器"></a><code>sched</code> —- 事件调度器</h2><p><strong>源码：</strong> <a href="https://github.com/python/cpython/tree/3.10/Lib/sched.py" target="_blank" rel="noopener">Lib/sched.py</a></p>
<hr>
<p><code>sched</code> 模块定义了一个实现通用事件调度程序的类：</p>
<p><em>class</em> <code>sched.scheduler</code>(<em>timefunc=time.monotonic</em>, <em>delayfunc=time.sleep</em>)</p>
<p><code>scheduler</code> 类定义了一个调度事件的通用接口。 它需要两个函数来实际处理“外部世界” —— <em>timefunc</em> 应当不带参数地调用，并返回一个数字（“时间”，可以为任意单位）。 <em>delayfunc</em> 函数应当带一个参数调用，与 <em>timefunc</em> 的输出相兼容，并且应当延迟其所指定的时间单位。 每个事件运行后还将调用 <em>delayfunc</em> 并传入参数 <code>0</code> 以允许其他线程有机会在多线程应用中运行。</p>
<p>在 3.3 版更改: <em>timefunc</em> 和 <em>delayfunc</em> 参数是可选的。</p>
<p>在 3.3 版更改: <code>scheduler</code> 类可以安全的在多线程环境中使用。</p>
<p>示例:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sched<span class="token punctuation">,</span> time
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> sched<span class="token punctuation">.</span>scheduler<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">,</span> time<span class="token punctuation">.</span>sleep<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">print_time</span><span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"From print_time"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">print_some_times</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s<span class="token punctuation">.</span>enter<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> print_time<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s<span class="token punctuation">.</span>enter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> print_time<span class="token punctuation">,</span> argument<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'positional'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s<span class="token punctuation">.</span>enter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> print_time<span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token string">'keyword'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> print_some_times<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">930343690.257</span>
From print_time <span class="token number">930343695.274</span> positional
From print_time <span class="token number">930343695.275</span> keyword
From print_time <span class="token number">930343700.273</span> default
<span class="token number">930343700.276</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="调度器对象"><a href="#调度器对象" class="headerlink" title="调度器对象"></a>调度器对象</h3><p><code>scheduler</code> 实例拥有以下方法和属性：</p>
<p><code>scheduler.enterabs</code>(<em>time</em>, <em>priority</em>, <em>action</em>, <em>argument=()</em>, <em>kwargs={}</em>)</p>
<p>安排一个新事件。 <em>time</em> 参数应该有一个数字类型兼容的返回值，与传递给构造函数的 <em>timefunc</em> 函数的返回值兼容。 计划在相同 <em>time</em> 的事件将按其 <em>priority</em> 的顺序执行。 数字越小表示优先级越高。</p>
<p>执行事件意为执行 <code>action(*argument, **kwargs)</code>。 <em>argument</em> 是包含有 <em>action</em> 的位置参数的序列。 <em>kwargs</em> 是包含 <em>action</em> 的关键字参数的字典。</p>
<p>返回值是一个事件，可用于以后取消事件。</p>
<p>在 3.3 版更改: <em>argument</em> 参数是可选的。</p>
<p>在 3.3 版更改: 添加了 <em>kwargs</em> 形参。</p>
<p><code>scheduler.enter</code>(<em>delay</em>, <em>priority</em>, <em>action</em>, <em>argument=()</em>, <em>kwargs={}</em>)</p>
<p>安排延后 <em>delay</em> 时间单位的事件。 除了相对时间，其他参数、效果和返回值与 <code>enterabs()</code> 的相同。</p>
<p>在 3.3 版更改: <em>argument</em> 参数是可选的。</p>
<p>在 3.3 版更改: 添加了 <em>kwargs</em> 形参。</p>
<p><code>scheduler.cancel</code>(<em>event</em>)</p>
<p>从队列中删除事件。 如果 <em>event</em> 不是当前队列中的事件，则此方法将引发 <code>ValueError</code>。</p>
<p><code>scheduler.empty</code>()</p>
<p>如果事件队列为空则返回 <code>True</code>。</p>
<p><code>scheduler.run</code>(<em>blocking=True</em>)</p>
<p>运行所有预定事件。 此方法将等待（使用传递给构造函数的 <code>delayfunc()</code> 函数）进行下一个事件，然后执行它，依此类推，直到没有更多的计划事件。</p>
<p>如果 <em>blocking</em> 为false，则执行由于最快到期（如果有）的预定事件，然后在调度程序中返回下一个预定调用的截止时间（如果有）。</p>
<p><em>action</em> 或 <em>delayfunc</em> 都可以引发异常。 在任何一种情况下，调度程序都将保持一致状态并传播异常。 如果 <em>action</em> 引发异常，则在将来调用 <code>run()</code> 时不会尝试该事件。</p>
<p>如果一系列事件的运行时间比下一个事件之前的可用时间长，那么调度程序将完全落后。 不会发生任何事件；调用代码负责取消不再相关的事件。</p>
<p>在 3.3 版更改: 添加了 <em>blocking</em> 形参。</p>
<pre><code>scheduler.queue</code></pre><p>只读属性按照将要运行的顺序返回即将发生的事件列表。 每个事件都显示为 named tuple ，包含以下字段：time、priority、action、argument、kwargs。</p>
<h2 id="queue-—-一个同步的队列类"><a href="#queue-—-一个同步的队列类" class="headerlink" title="queue —- 一个同步的队列类"></a><code>queue</code> —- 一个同步的队列类</h2><p><strong>源代码:</strong> <a href="https://github.com/python/cpython/tree/3.10/Lib/queue.py" target="_blank" rel="noopener">Lib/queue.py</a></p>
<hr>
<p><code>queue</code> 模块实现了多生产者、多消费者队列。这特别适用于消息必须安全地在多线程间交换的线程编程。模块中的 <code>Queue</code> 类实现了所有所需的锁定语义。</p>
<p>模块实现了三种类型的队列，它们的区别仅仅是条目取回的顺序。在 FIFO 队列中，先添加的任务先取回。在 LIFO 队列中，最近被添加的条目先取回(操作类似一个堆栈)。优先级队列中，条目将保持排序( 使用 <code>heapq</code> 模块 ) 并且最小值的条目第一个返回。</p>
<p>在内部，这三个类型的队列使用锁来临时阻塞竞争线程；然而，它们并未被设计用于线程的重入性处理。</p>
<p>此外，模块实现了一个 “简单的” FIFO 队列类型， <code>SimpleQueue</code> ，这个特殊实现为小功能在交换中提供额外的保障。</p>
<p><code>queue</code> 模块定义了下列类和异常：</p>
<p><em>class</em> <code>queue.Queue</code>(<em>maxsize=0</em>)</p>
<p>Constructor for a FIFO queue. <em>maxsize</em> is an integer that sets the upperbound limit on the number of items that can be placed in the queue. Insertion will block once this size has been reached, until queue items are consumed. If <em>maxsize</em> is less than or equal to zero, the queue size is infinite.</p>
<p><em>class</em> <code>queue.LifoQueue</code>(<em>maxsize=0</em>)</p>
<p>LIFO 队列构造函数。 <em>maxsize</em> 是个整数，用于设置可以放入队列中的项目数的上限。当达到这个大小的时候，插入操作将阻塞至队列中的项目被消费掉。如果 <em>maxsize</em> 小于等于零，队列尺寸为无限大。</p>
<p><em>class</em> <code>queue.PriorityQueue</code>(<em>maxsize=0</em>)</p>
<p>优先级队列构造函数。 <em>maxsize</em> 是个整数，用于设置可以放入队列中的项目数的上限。当达到这个大小的时候，插入操作将阻塞至队列中的项目被消费掉。如果 <em>maxsize</em> 小于等于零，队列尺寸为无限大。</p>
<p>最小值先被取出( 最小值条目是由 <code>sorted(list(entries))[0]</code> 返回的条目)。条目的典型模式是一个以下形式的元组： <code>(priority_number, data)</code> 。</p>
<p>如果 <em>data</em> 元素没有可比性，数据将被包装在一个类中，忽略数据值，仅仅比较优先级数字 ：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass<span class="token punctuation">,</span> field
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any
@dataclass<span class="token punctuation">(</span>order<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">PrioritizedItem</span><span class="token punctuation">:</span>
    priority<span class="token punctuation">:</span> int
    item<span class="token punctuation">:</span> Any<span class="token operator">=</span>field<span class="token punctuation">(</span>compare<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>class</em> <code>queue.SimpleQueue</code></p>
<p>无界的 FIFO 队列构造函数。简单的队列，缺少任务跟踪等高级功能。</p>
<p>3.7 新版功能.</p>
<p><em>exception</em> <code>queue.Empty</code></p>
<p>对空的 <code>Queue</code> 对象，调用非阻塞的 <code>get()</code> (or <code>get_nowait()</code>) 时，引发的异常。</p>
<p><em>exception</em> <code>queue.Full</code></p>
<p>对满的 <code>Queue</code> 对象，调用非阻塞的 <code>put()</code> (or <code>put_nowait()</code>) 时，引发的异常。</p>
<h3 id="Queue对象"><a href="#Queue对象" class="headerlink" title="Queue对象"></a>Queue对象</h3><p>队列对象 (<code>Queue</code>, <code>LifoQueue</code>, 或者 <code>PriorityQueue</code>) 提供下列描述的公共方法。</p>
<p><code>Queue.qsize</code>()</p>
<p>返回队列的大致大小。注意，qsize() &gt; 0 不保证后续的 get() 不被阻塞，qsize() &lt; maxsize 也不保证 put() 不被阻塞。</p>
<p><code>Queue.empty</code>()</p>
<p>如果队列为空，返回 <code>True</code> ，否则返回 <code>False</code> 。如果 empty() 返回 <code>True</code> ，不保证后续调用的 put() 不被阻塞。类似的，如果 empty() 返回 <code>False</code> ，也不保证后续调用的 get() 不被阻塞。</p>
<p><code>Queue.full</code>()</p>
<p>如果队列是满的返回 <code>True</code> ，否则返回 <code>False</code> 。如果 full() 返回 <code>True</code> 不保证后续调用的 get() 不被阻塞。类似的，如果 full() 返回 <code>False</code> 也不保证后续调用的 put() 不被阻塞。</p>
<p><code>Queue.put</code>(<em>item</em>, <em>block=True</em>, <em>timeout=None</em>)</p>
<p>将 <em>item</em> 放入队列。如果可选参数 <em>block</em> 是 true 并且 <em>timeout</em> 是 <code>None</code> (默认)，则在必要时阻塞至有空闲插槽可用。如果 <em>timeout</em> 是个正数，将最多阻塞 <em>timeout</em> 秒，如果在这段时间没有可用的空闲插槽，将引发 <code>Full</code> 异常。反之 (<em>block</em> 是 false)，如果空闲插槽立即可用，则把 <em>item</em> 放入队列，否则引发 <code>Full</code> 异常 ( 在这种情况下，<em>timeout</em> 将被忽略)。</p>
<p><code>Queue.put_nowait</code>(<em>item</em>)</p>
<p>相当于 <code>put(item, False)</code> 。</p>
<p><code>Queue.get</code>(<em>block=True</em>, <em>timeout=None</em>)</p>
<p>从队列中移除并返回一个项目。如果可选参数 <em>block</em> 是 true 并且 <em>timeout</em> 是 <code>None</code> (默认值)，则在必要时阻塞至项目可得到。如果 <em>timeout</em> 是个正数，将最多阻塞 <em>timeout</em> 秒，如果在这段时间内项目不能得到，将引发 <code>Empty</code> 异常。反之 (<em>block</em> 是 false) , 如果一个项目立即可得到，则返回一个项目，否则引发 <code>Empty</code> 异常 (这种情况下，<em>timeout</em> 将被忽略)。</p>
<p>POSIX系统3.0之前，以及所有版本的Windows系统中，如果 <em>block</em> 是 true 并且 <em>timeout</em> 是 <code>None</code> ， 这个操作将进入基础锁的不间断等待。这意味着，没有异常能发生，尤其是 SIGINT 将不会触发 <code>KeyboardInterrupt</code> 异常。</p>
<p><code>Queue.get_nowait</code>()</p>
<p>相当于 <code>get(False)</code> 。</p>
<p>提供了两个方法，用于支持跟踪 排队的任务 是否 被守护的消费者线程 完整的处理。</p>
<p><code>Queue.task_done</code>()</p>
<p>表示前面排队的任务已经被完成。被队列的消费者线程使用。每个 <code>get()</code> 被用于获取一个任务， 后续调用 <code>task_done()</code> 告诉队列，该任务的处理已经完成。</p>
<p>如果 <code>join()</code> 当前正在阻塞，在所有条目都被处理后，将解除阻塞(意味着每个 <code>put()</code> 进队列的条目的 <code>task_done()</code> 都被收到)。</p>
<p>如果被调用的次数多于放入队列中的项目数量，将引发 <code>ValueError</code> 异常 。</p>
<p><code>Queue.join</code>()</p>
<p>阻塞至队列中所有的元素都被接收和处理完毕。</p>
<p>当条目添加到队列的时候，未完成任务的计数就会增加。每当消费者线程调用 <code>task_done()</code> 表示这个条目已经被回收，该条目所有工作已经完成，未完成计数就会减少。当未完成计数降到零的时候， <code>join()</code> 阻塞被解除。</p>
<p>如何等待排队的任务被完成的示例：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token punctuation">,</span> queue
q <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Working on {item}'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Finished {item}'</span><span class="token punctuation">)</span>
        q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># turn-on the worker thread</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send thirty task requests to the worker</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'All task requests sent\n'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># block until all tasks are done</span>
q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'All work completed'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="SimpleQueue-对象"><a href="#SimpleQueue-对象" class="headerlink" title="SimpleQueue 对象"></a>SimpleQueue 对象</h3><p><code>SimpleQueue</code> 对象提供下列描述的公共方法。</p>
<p><code>SimpleQueue.qsize</code>()</p>
<p>返回队列的大致大小。注意，qsize() &gt; 0 不保证后续的 get() 不被阻塞。</p>
<p><code>SimpleQueue.empty</code>()</p>
<p>如果队列为空，返回 <code>True</code> ，否则返回 <code>False</code> 。如果 empty() 返回 <code>False</code> ，不保证后续调用的 get() 不被阻塞。</p>
<p><code>SimpleQueue.put</code>(<em>item</em>, <em>block=True</em>, <em>timeout=None</em>)</p>
<p>将 <em>item</em> 放入队列。此方法永不阻塞，始终成功（除了潜在的低级错误，例如内存分配失败）。可选参数 <em>block</em> 和 <em>timeout</em> 仅仅是为了保持 <code>Queue.put()</code> 的兼容性而提供，其值被忽略。</p>
<p><strong>CPython implementation detail:</strong> This method has a C implementation which is reentrant. That is, a <code>put()</code> or <code>get()</code> call can be interrupted by another <code>put()</code> call in the same thread without deadlocking or corrupting internal state inside the queue. This makes it appropriate for use in destructors such as <code>__del__</code> methods or <code>weakref</code> callbacks.</p>
<p><code>SimpleQueue.put_nowait</code>(<em>item</em>)</p>
<p>相当于 <code>put(item)</code> ，仅为保持 <code>Queue.put_nowait()</code> 兼容性而提供。</p>
<p><code>SimpleQueue.get</code>(<em>block=True</em>, <em>timeout=None</em>)</p>
<p>从队列中移除并返回一个项目。如果可选参数 <em>block</em> 是 true 并且 <em>timeout</em> 是 <code>None</code> (默认值)，则在必要时阻塞至项目可得到。如果 <em>timeout</em> 是个正数，将最多阻塞 <em>timeout</em> 秒，如果在这段时间内项目不能得到，将引发 <code>Empty</code> 异常。反之 (<em>block</em> 是 false) , 如果一个项目立即可得到，则返回一个项目，否则引发 <code>Empty</code> 异常 (这种情况下，<em>timeout</em> 将被忽略)。</p>
<p><code>SimpleQueue.get_nowait</code>()</p>
<p>相当于 <code>get(False)</code> 。</p>
<h2 id="contextvars-—-上下文变量"><a href="#contextvars-—-上下文变量" class="headerlink" title="contextvars —- 上下文变量"></a><code>contextvars</code> —- 上下文变量</h2><p>本模块提供了相关API用于管理、存储和访问上下文相关的状态。 <code>ContextVar</code> 类用于声明 <em>上下文变量</em> 并与其一起使用。函数 <code>copy_context()</code> 和类 <code>Context</code> 用于管理当前上下文和异步框架中。</p>
<p>在多并发环境中，有状态上下文管理器应该使用上下文变量，而不是 <code>threading.local()</code> 来防止他们的状态意外泄露到其他代码。</p>
<p>更多信息参见 <a href="https://www.python.org/dev/peps/pep-0567" target="_blank" rel="noopener"><strong>PEP 567</strong></a> 。</p>
<p>3.7 新版功能.</p>
<h3 id="上下文变量"><a href="#上下文变量" class="headerlink" title="上下文变量"></a>上下文变量</h3><p><em>class</em> <code>contextvars.ContextVar</code>(<em>name</em>[, <em>**,</em> default*])</p>
<p>此类用于声明一个新的上下文变量，如:</p>
<pre class="line-numbers language-python"><code class="language-python">var<span class="token punctuation">:</span> ContextVar<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">'var'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>name</em> 参数用于内省和调试，必需。</p>
<p>调用 <code>ContextVar.get()</code> 时，如果上下文中没有找到此变量的值，则返回可选的仅命名参数 <em>default</em> 。</p>
<p><strong>重要：</strong> 上下文变量应该在顶级模块中创建，且永远不要在闭包中创建。 <code>Context</code> 对象拥有对上下文变量的强引用，这可以让上下文变量被垃圾收集器正确回收。</p>
<ul>
<li><p><code>name</code></p>
<p>上下文变量的名称，只读属性。</p>
<p>3.7.1 新版功能.</p>
</li>
<li><p><code>get</code>([<em>default</em>])</p>
<p>返回当前上下文中此上下文变量的值。</p>
<p>如果当前上下文中此变量没有值，则此方法会:</p>
<ul>
<li>如果提供了得 话，返回传入的 <em>default</em> 值；或者</li>
<li>返回上下文变量本身的默认值， 如果创建此上下文变量时提供了默认值；或者</li>
<li>抛出 <code>LookupError</code> 异常。</li>
</ul>
</li>
<li><p><code>set</code>(<em>value</em>)</p>
<p>调用此方法设置上下文变量在当前上下文中的值。</p>
<p>必选参数 <em>value</em> 是上下文变量的新值。</p>
<p>返回一个 <code>Token</code> 对象，可通过 <code>ContextVar.reset()</code> 方法将上下文变量还原为之前某个状态。</p>
</li>
<li><p><code>reset</code>(<em>token</em>)</p>
<p>将上下文变量重置为调用 <code>ContextVar.set()</code> 之前、创建 <em>token</em> 时候的状态。</p>
<p>例如：</p>
<pre class="line-numbers language-python"><code class="language-python">var <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">'var'</span><span class="token punctuation">)</span>
token <span class="token operator">=</span> var<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># code that uses 'var'; var.get() returns 'new value'.</span>
var<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># After the reset call the var has no value again, so</span>
<span class="token comment" spellcheck="true"># var.get() would raise a LookupError.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p><em>class</em> <code>contextvars.Token</code></p>
<p><code>ContextVar.set()</code> 方法返回 <em>Token</em> 对象。此对象可以传递给 <code>ContextVar.reset()</code> 方法用于将上下文变量还原为调用 <em>set</em> 前的状态。</p>
<ul>
<li><p><code>Token.var</code></p>
<p>只读属性。指向创建此 token 的 <code>ContextVar</code> 对象。</p>
</li>
<li><p><code>Token.old_value</code></p>
<p>一个只读属性。 会被设为在创建此令牌的 <code>ContextVar.set()</code> 方法调用之前该变量所具有的值。 如果调用之前变量没有设置值，则它指向 <code>Token.MISSING</code> 。</p>
</li>
<li><p><code>Token.MISSING</code></p>
<p><code>Token.old_value</code> 会用到的一个标记对象。</p>
</li>
</ul>
<h3 id="手动上下文管理"><a href="#手动上下文管理" class="headerlink" title="手动上下文管理"></a>手动上下文管理</h3><p><code>contextvars.copy_context</code>()</p>
<p>返回当前上下文中 <code>Context</code> 对象的拷贝。</p>
<p>以下代码片段会获取当前上下文的拷贝并打印设置到其中的所有变量及其值:</p>
<pre class="line-numbers language-python"><code class="language-python">ctx<span class="token punctuation">:</span> Context <span class="token operator">=</span> copy_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此函数复杂度为 O(1) ，也就是说对于只包含几个上下文变量和很多上下文变量的情况，他们是一样快的。</p>
<p><em>class</em> <code>contextvars.Context</code></p>
<p><code>ContextVars</code> 中所有值的映射。</p>
<p><code>Context()</code> 创建一个不包含任何值的空上下文。如果要获取当前上下文的拷贝，使用 <code>copy_context()</code> 函数。</p>
<p>Context 实现了 <code>collections.abc.Mapping</code> 接口。</p>
<ul>
<li><p><code>run</code>(<em>callable</em>, <em>\</em>args<em>,</em> <em>*kwargs</em>)</p>
<p>按照 <em>run</em> 方法中的参数在上下文对象中执行 <code>callable(*args, **kwargs)</code> 代码。返回执行结果，如果发生异常，则将异常透传出来。</p>
<p><em>callable</em> 中队上下文变量做出的任何修改会保留在上下文对象中:</p>
<pre class="line-numbers language-python"><code class="language-python">var <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">'var'</span><span class="token punctuation">)</span>
var<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">'spam'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># 'var' was set to 'spam' before</span>
    <span class="token comment" spellcheck="true"># calling 'copy_context()' and 'ctx.run(main)', so:</span>
    <span class="token comment" spellcheck="true"># var.get() == ctx[var] == 'spam'</span>
    var<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">'ham'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Now, after setting 'var' to 'ham':</span>
    <span class="token comment" spellcheck="true"># var.get() == ctx[var] == 'ham'</span>
ctx <span class="token operator">=</span> copy_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Any changes that the 'main' function makes to 'var'</span>
<span class="token comment" spellcheck="true"># will be contained in 'ctx'.</span>
ctx<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># The 'main()' function was run in the 'ctx' context,</span>
<span class="token comment" spellcheck="true"># so changes to 'var' are contained in it:</span>
<span class="token comment" spellcheck="true"># ctx[var] == 'ham'</span>
<span class="token comment" spellcheck="true"># However, outside of 'ctx', 'var' is still set to 'spam':</span>
<span class="token comment" spellcheck="true"># var.get() == 'spam'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当在多个系统线程或者递归调用同一个上下文对象的此方法，抛出 <code>RuntimeError</code> 异常。</p>
</li>
<li><p><code>copy</code>()</p>
<p>返回此上下文对象的浅拷贝。</p>
</li>
<li><p><code>var in context</code></p>
<p>如果<em>context</em> 中含有名称为 <em>var</em> 的变量，返回 <code>True</code> ， 否则返回 <code>False</code> 。</p>
</li>
<li><p><code>context[var]</code></p>
<p>返回名称为 <em>var</em> 的 <code>ContextVar</code> 变量。如果上下文对象中不包含这个变量，则抛出 <code>KeyError</code> 异常。</p>
</li>
<li><p><code>get</code>(<em>var</em>[, <em>default</em>])</p>
<p>如果 <em>var</em> 在上下文对象中具有值则返回 <em>var</em> 的值。 在其他情况下返回 <em>default*。 如果未给出 *default</em> 则返回 <code>None</code>。</p>
</li>
<li><p><code>iter(context)</code></p>
<p>返回一个存储在上下文对象中的变量的迭代器。</p>
</li>
<li><p><code>len(proxy)</code></p>
<p>返回上下文对象中所设的变量的数量。</p>
</li>
<li><p><code>keys</code>()</p>
<p>返回上下文对象中的所有变量的列表。</p>
</li>
<li><p><code>values</code>()</p>
<p>返回上下文对象中所有变量值的列表。</p>
</li>
<li><p><code>items</code>()</p>
<p>返回包含上下文对象中所有变量及其值的 2 元组的列表。</p>
</li>
</ul>
<h3 id="asyncio-支持"><a href="#asyncio-支持" class="headerlink" title="asyncio 支持"></a>asyncio 支持</h3><p>上下文变量在 <code>asyncio</code> 中有原生的支持并且无需任何额外配置即可被使用。 例如，以下是一个简单的回显服务器，它使用上下文变量来让远程客户端的地址在处理该客户端的 Task 中可用:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> contextvars
client_addr_var <span class="token operator">=</span> contextvars<span class="token punctuation">.</span>ContextVar<span class="token punctuation">(</span><span class="token string">'client_addr'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">render_goodbye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># The address of the currently handled client can be accessed</span>
    <span class="token comment" spellcheck="true"># without passing it explicitly to this function.</span>
    client_addr <span class="token operator">=</span> client_addr_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> f<span class="token string">'Good bye, client @ {client_addr}\n'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    addr <span class="token operator">=</span> writer<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>get_extra_info<span class="token punctuation">(</span><span class="token string">'socket'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span>
    client_addr_var<span class="token punctuation">.</span>set<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># In any code that we call is now possible to get</span>
    <span class="token comment" spellcheck="true"># client's address by calling 'client_addr_var.get()'.</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>render_goodbye<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    srv <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span>
        handle_request<span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8081</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> srv<span class="token punctuation">:</span>
        <span class="token keyword">await</span> srv<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># To test it you can use telnet:</span>
<span class="token comment" spellcheck="true">#     telnet 127.0.0.1 8081</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="thread-—-底层多线程-API"><a href="#thread-—-底层多线程-API" class="headerlink" title="_thread —- 底层多线程 API"></a><code>_thread</code> —- 底层多线程 API</h2><p>该模块提供了操作多个线程（也被称为 <em>轻量级进程</em> 或 <em>任务*）的底层原语 —— 多个控制线程共享全局数据空间。为了处理同步问题，也提供了简单的锁机制（也称为 *互斥锁</em> 或 <em>二进制信号</em>）。<code>threading</code> 模块基于该模块提供了更易用的高级多线程 API。</p>
<p>在 3.7 版更改: 这个模块曾经为可选项，但现在总是可用。</p>
<p>这个模块定义了以下常量和函数：</p>
<p><em>exception</em> <code>_thread.error</code></p>
<p>发生线程相关错误时抛出。</p>
<p>在 3.3 版更改: 现在是内建异常 <code>RuntimeError</code> 的别名。</p>
<pre><code>_thread.LockType</code></pre><p>锁对象的类型。</p>
<p><code>_thread.start_new_thread</code>(<em>function</em>, <em>args</em>[, <em>kwargs</em>])</p>
<p>开启一个新线程并返回其标识。 线程执行函数 <em>function</em> 并附带参数列表 <em>args</em> (必须是元组)。 可选的 <em>kwargs</em> 参数指定一个关键字参数字典。</p>
<p>当函数返回时，线程会静默地退出。</p>
<p>当函数因某个未处理异常而终结时，<code>sys.unraisablehook()</code> 会被调用以处理异常。 钩子参数的 <em>object</em> 属性为 <em>function</em>。 在默认情况下，会打印堆栈回溯然后该线程将退出（但其他线程会继续运行）。</p>
<p>当函数引发 <code>SystemExit</code> 异常时，它会被静默地忽略。</p>
<p>在 3.8 版更改: 现在会使用 <code>sys.unraisablehook()</code> 来处理未处理的异常。</p>
<p><code>_thread.interrupt_main</code>(<em>signum=signal.SIGINT</em>, <em>/</em>)</p>
<p>模拟一个信号到达主线程的效果。 线程可使用此函数来打断主线程，虽然并不保证打断将立即发生。</p>
<p>如果给出 <em>signum</em>，则表示要模拟的信号的编号。 如果未给出 <em>signum</em>，则将模拟 <code>signal.SIGINT</code>。</p>
<p>如果 Python 没有处理给定的信号 (它被设为 <code>signal.SIG_DFL</code> 或 <code>signal.SIG_IGN</code>)，此函数将不做任何操作。</p>
<p>在 3.10 版更改: 添加了 <em>signum</em> 参数来定制信号的编号。</p>
<p>注解</p>
<p>这并不会发出对应的信号而是将一个调用排入关联处理句柄的计划任务（如果句柄存在的话）。 如果你想要真的发出信号，请使用 <code>signal.raise_signal()</code>。</p>
<p><code>_thread.exit</code>()</p>
<p>抛出 <code>SystemExit</code> 异常。如果没有捕获的话，这个异常会使线程退出。</p>
<p><code>_thread.allocate_lock</code>()</p>
<p>返回一个新的锁对象。锁中的方法在后面描述。初始情况下锁处于解锁状态。</p>
<p><code>_thread.get_ident</code>()</p>
<p>返回当前线程的 “线程标识符”。它是一个非零的整数。它的值没有直接含义，主要是用作 magic cookie，比如作为含有线程相关数据的字典的索引。线程标识符可能会在线程退出，新线程创建时被复用。</p>
<p><code>_thread.get_native_id</code>()</p>
<p>返回内核分配给当前线程的原生集成线程 ID。 这是一个非负整数。 它的值可被用来在整个系统中唯一地标识这个特定线程（直到线程终结，在那之后该值可能会被 OS 回收再利用）。</p>
<p>可用性: Windows, FreeBSD, Linux, macOS, OpenBSD, NetBSD, AIX。</p>
<p>3.8 新版功能.</p>
<p><code>_thread.stack_size</code>([<em>size</em>])</p>
<p>返回创建线程时使用的堆栈大小。可选参数 <em>size</em> 指定之后新建的线程的堆栈大小，而且一定要是0（根据平台或者默认配置）或者最小是32,768(32KiB)的一个正整数。如果 <em>size</em> 没有指定，默认是0。如果不支持改变线程堆栈大小，会抛出 <code>RuntimeError</code> 错误。如果指定的堆栈大小不合法，会抛出 <code>ValueError</code> 错误并且不会修改堆栈大小。32KiB是当前最小的能保证解释器有足够堆栈空间的堆栈大小。需要注意的是部分平台对于堆栈大小会有特定的限制，例如要求大于32KiB的堆栈大小或者需要根据系统内存页面的整数倍进行分配 - 应当查阅平台文档有关详细信息（4KiB页面比较普遍，在没有更具体信息的情况下，建议的方法是使用4096的倍数作为堆栈大小）。</p>
<p>适用于: Windows，具有 POSIX 线程的系统。</p>
<pre><code>_thread.TIMEOUT_MAX</code></pre><p><code>Lock.acquire()</code> 方法中 <em>timeout</em> 参数允许的最大值。传入超过这个值的 timeout 会抛出 <code>OverflowError</code> 异常。</p>
<p>3.2 新版功能.</p>
<p>锁对象有以下方法：</p>
<p><code>lock.acquire</code>(<em>waitflag=1</em>, <em>timeout=- 1</em>)</p>
<p>没有任何可选参数时，该方法无条件申请获得锁，有必要的话会等待其他线程释放锁（同时只有一个线程能获得锁 —— 这正是锁存在的原因）。</p>
<p>如果传入了整型参数 <em>waitflag</em>，具体的行为取决于传入的值：如果是 0 的话，只会在能够立刻获取到锁时才获取，不会等待，如果是非零的话，会像之前提到的一样，无条件获取锁。</p>
<p>如果传入正浮点数参数 <em>timeout<em>，相当于指定了返回之前等待得最大秒数。如果传入负的 *timeout</em>，相当于无限期等待。如果 *waitflag</em> 是 0 的话，不能指定 <em>timeout</em>。</p>
<p>如果成功获取到所会返回 <code>True</code>，否则返回 <code>False</code>。</p>
<p>在 3.2 版更改: 新的 <em>timeout</em> 形参。</p>
<p>在 3.2 版更改: 现在获取锁的操作可以被 POSIX 信号中断。</p>
<p><code>lock.release</code>()</p>
<p>释放锁。锁必须已经被获取过，但不一定是同一个线程获取的。</p>
<p><code>lock.locked</code>()</p>
<p>返回锁的状态：如果已被某个线程获取，返回 <code>True</code>，否则返回 <code>False</code>。</p>
<p>除了这些方法之外，锁对象也可以通过 <code>with</code> 语句使用，例如：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> _thread
a_lock <span class="token operator">=</span> _thread<span class="token punctuation">.</span>allocate_lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> a_lock<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"a_lock is locked while this executes"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意事项：</strong></p>
<ul>
<li>线程与中断奇怪地交互：<code>KeyboardInterrupt</code> 异常可能会被任意一个线程捕获。（如果 <code>signal</code> 模块可用的话，中断总是会进入主线程。）</li>
<li>调用 <code>sys.exit()</code> 或是抛出 <code>SystemExit</code> 异常等效于调用 <code>_thread.exit()</code>。</li>
<li>不可能中断锁的 <code>acquire()</code> 方法 —— <code>KeyboardInterrupt</code> 一场会在锁获取到之后发生。</li>
<li>当主线程退出时，由系统决定其他线程是否存活。在大多数系统中，这些线程会直接被杀掉，不会执行 <code>try</code> … <code>finally</code> 语句，也不会执行对象析构函数。</li>
<li>当主线程退出时，不会进行正常的清理工作（除非使用了 <code>try</code> … <code>finally</code> 语句），标准 I/O 文件也不会刷新。</li>
</ul>
<h2 id="subprocess-—-子进程管理"><a href="#subprocess-—-子进程管理" class="headerlink" title="subprocess —- 子进程管理"></a><code>subprocess</code> —- 子进程管理</h2><h1 id="网络和进程间通信"><a href="#网络和进程间通信" class="headerlink" title="网络和进程间通信"></a>网络和进程间通信</h1><p>本章介绍的模块提供了网络和进程间通信的机制。</p>
<p>某些模块仅适用于同一台机器上的两个进程，例如 <code>signal</code> 和 <code>mmap</code> 。 其他模块支持两个或多个进程可用于跨机器通信的网络协议。</p>
<p>本章中描述的模块列表是：</p>
<ul>
<li><code>asyncio</code> —- 异步 I/O</li>
<li><code>socket</code> —- 底层网络接口</li>
<li><code>ssl</code> —- 套接字对象的 TLS/SSL 包装器</li>
<li><code>select</code> —- 等待 I/O 完成</li>
<li><code>selectors</code> —- 高级 I/O 复用库</li>
<li><code>asyncore</code> —- 异步套接字处理器</li>
<li><code>asynchat</code> —- 异步套接字指令/响应处理程序</li>
<li><code>signal</code> —- 设置异步事件处理程序</li>
<li><code>mmap</code> —- 内存映射文件支持</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/Language-Python-Lib3.html">https://jackhcc.github.io/posts/Language-Python-Lib3.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Python/">
                                    <span class="chip bg-color">Python</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-11-09T11-58-47',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/dl-series18.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/5.jpg" class="responsive-img" alt="DL专栏18-Normalization">
                        
                        <span class="card-title">DL专栏18-Normalization</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Normalization方法
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-11-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Normalization/">
                        <span class="chip bg-color">Normalization</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/Algorithm.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/3.jpg" class="responsive-img" alt="Algorithm Summary">
                        
                        <span class="card-title">Algorithm Summary</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            经典算法实现汇总
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-11-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Algorithm/" class="post-category">
                                    Algorithm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Algorithm/">
                        <span class="chip bg-color">Algorithm</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">2840.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script>
        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script></body>

</html>

