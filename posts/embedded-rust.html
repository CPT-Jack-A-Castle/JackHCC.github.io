<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Embedded Rust详解, JackHCC">
    <meta name="description" content="Rust嵌入式编程">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Embedded Rust详解 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Embedded Rust详解</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Rust/">
                                <span class="chip bg-color">Rust</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Embedded/" class="post-category">
                                Embedded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-09-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-11
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    38.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    155 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="✔Learning-Resource"><a href="#✔Learning-Resource" class="headerlink" title="✔Learning Resource"></a>✔Learning Resource</h1><ul>
<li><a href="https://rust-embedded.github.io/book/" target="_blank" rel="noopener">The Embedded Rust Book</a> - An introductory book about using the Rust Programming Language on “Bare Metal” embedded systems, such as Microcontrollers.</li>
<li><a href="https://rust-embedded.github.io/discovery" target="_blank" rel="noopener">Discovery</a> by @rust-embedded — this book is an introductory course on microcontroller-based embedded systems that uses Rust as the teaching language. Original author: @japaric</li>
<li><a href="https://docs.rs/cortex-m-quickstart/0.3.1/cortex_m_quickstart/" target="_blank" rel="noopener">Cortex-M Quickstart</a> by @japaric – a template and introduction to embedded Rust, suitable for developers familiar to embedded development but new to embedded Rust.</li>
<li><a href="https://os.phil-opp.com/" target="_blank" rel="noopener">Writing an OS in rust</a> A blog series creating a small operating system in Rust</li>
<li><a href="https://droogmic.github.io/microrust/" target="_blank" rel="noopener">MicroRust</a> Introductory book for embedded development in Rust on the micro:bit.</li>
<li><a href="https://rahul-thakoor.github.io/physical-computing-rust/" target="_blank" rel="noopener">Physical Computing With Rust</a> A (WIP) guide to physical computing with Rust on the Raspberry Pi.</li>
<li><a href="https://github.com/rust-embedded/rust-raspi3-OS-tutorials" target="_blank" rel="noopener">Writing an embedded OS in Rust on the Raspberry Pi</a> A set of tutorials that give a guided, step-by-step tour of how to write a monolithic Operating System kernel for an embedded system from scratch. Runs on the Raspberry Pi 3 and the Raspberry Pi 4.</li>
<li><a href="https://hboeving.dev/blog/rust-2c-driver-p1/" target="_blank" rel="noopener">Writing embedded drivers in Rust isn’t that hard</a> A guide to building an embedded-hal driver. <a href="https://hboeving.dev/blog/rust-i2c-driver-p2/" target="_blank" rel="noopener">Part 2</a></li>
<li><a href="https://github.com/ferrous-systems/embedded-trainings-2020" target="_blank" rel="noopener">Ferrous Systems’ Embedded Training Courses: 2020-current edition</a> A hands-on training course for beginner and advanced learners of Embedded Rust, based on Nordic Semiconductor’s nRF52840 harware. This training was given at Oxidize Conferences and by <a href="https://ferrous-systems.com/" target="_blank" rel="noopener">Ferrous Systems</a> to corporate customers.</li>
<li><a href="https://knurling.ferrous-systems.com/sessions/" target="_blank" rel="noopener">Ferrous Systems’ Knurling Sessions</a> are hands-on embedded projects that explore specific concepts using generally available hardware, building full systems and components using microcontrollers, sensors, and actuators.</li>
<li><a href="https://github.com/jacobrosenthal/dsp-discoveryf4-rust/" target="_blank" rel="noopener">DSP on STM32F407G-DISC1</a> Unofficial oxidization of the <a href="https://www.amazon.com/Digital-Signal-Processing-Cortex-M-Microcontrollers/dp/1911531166" target="_blank" rel="noopener">Digital Signal Processing using Arm Cortex-M based Microcontrollers: Theory and Practice</a> book. The book isn’t necessary to enjoy the examples and learn a functional DSP Rust coding style.</li>
</ul>
<hr>
<h1 id="😀《The-Embedded-Rust-Book》"><a href="#😀《The-Embedded-Rust-Book》" class="headerlink" title="😀《The Embedded Rust Book》"></a>😀《The Embedded Rust Book》</h1><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="认识硬件"><a href="#认识硬件" class="headerlink" title="认识硬件"></a>认识硬件</h2><p>让我们熟悉一下我们将要使用的硬件。</p>
<h3 id="STM32F3DISCOVERY（“F3”）"><a href="#STM32F3DISCOVERY（“F3”）" class="headerlink" title="STM32F3DISCOVERY（“F3”）"></a>STM32F3DISCOVERY（“F3”）</h3><p><img src="/images/loading.gif" data-original="../images/language/f3-16313292317231.jpg" alt=""></p>
<p>这个板子包含什么？</p>
<ul>
<li>一个<a href="https://www.st.com/en/microcontrollers/stm32f303vc.html" target="_blank" rel="noopener">STM32F303VCT6</a>微控制器。这个微控制器有<ul>
<li>单核 ARM Cortex-M4F 处理器，硬件支持单精度浮点运算，最大时钟频率为 72 MHz。</li>
<li>256 KiB 的“闪存”内存。（1 KiB = 10 <strong>24</strong>字节）</li>
<li>48 KiB 内存。</li>
<li>多种集成外设，如定时器、I2C、SPI 和 USART。</li>
<li>通用输入输出 (GPIO) 和其他类型的引脚可通过板旁边的两排接头访问。</li>
<li>可通过标有“USB USER”的 USB 端口访问的 USB 接口。</li>
</ul>
</li>
<li>一个<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">加速计</a>作为的一部分<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>芯片。</li>
<li>甲<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">磁力</a>作为一部分<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>芯片。</li>
<li>甲<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">陀螺仪</a>作为一部分<a href="https://www.pololu.com/file/0J563/L3GD20.pdf" target="_blank" rel="noopener">L3GD20</a>芯片。</li>
<li>8 个用户 LED 排列成指南针形状。</li>
<li>第二个微控制器：<a href="https://www.st.com/en/microcontrollers/stm32f103cb.html" target="_blank" rel="noopener">STM32F103</a>。该微控制器实际上是板载编程器/调试器的一部分，并连接到名为“USB ST-LINK”的 USB 端口。</li>
</ul>
<p>如需更详细的功能列表和电路板的进一步规格，请访问<a href="https://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STMicroelectronics</a>网站。</p>
<p>警告：如果您想将外部信号应用于电路板，请务必小心。微控制器 STM32F303VCT6 引脚的标称电压为 3.3 伏。如需更多信息，请参阅手册中的<a href="https://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">6.2 绝对最大额定值部分</a></p>
<h2 id="一个no-std-rust环境"><a href="#一个no-std-rust环境" class="headerlink" title="一个no_std rust环境"></a>一个<code>no_std</code> rust环境</h2><p>术语嵌入式编程用于广泛的不同类别的编程。从编程只有几 KB RAM 和 ROM 的8 位 MCU（如<a href="https://www.st.com/resource/en/datasheet/st72325j6.pdf" target="_blank" rel="noopener">ST72325xx</a>），到具有 32/64 位 4 核 Cortex-A53 @的 Raspberry Pi（<a href="https://en.wikipedia.org/wiki/Raspberry_Pi#Specifications" target="_blank" rel="noopener">B 型 3+</a>）等系统1.4 GHz 和 1GB 内存。编写代码时将应用不同的限制/限制，具体取决于您拥有的目标和用例类型。</p>
<p>有两种通用的嵌入式编程分类：</p>
<h3 id="托管环境"><a href="#托管环境" class="headerlink" title="托管环境"></a>托管环境</h3><p>这些类型的环境接近于正常的 PC 环境。这意味着您提供了一个系统接口<a href="https://en.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener">EG POSIX</a> ，它为您提供了与各种系统交互的原语，例如文件系统、网络、内存管理、线程等。标准库通常又依赖于这些原语来实现他们的功能。您可能还有某种 sysroot 和 RAM/ROM 使用限制，也许还有一些特殊的硬件或 I/O。总体而言，感觉就像在专用 PC 环境中编码。</p>
<h3 id="裸机环境"><a href="#裸机环境" class="headerlink" title="裸机环境"></a>裸机环境</h3><p>在裸机环境中，在您的程序之前没有加载任何代码。如果没有操作系统提供的软件，我们将无法加载标准库。相反，程序及其使用的板条箱只能使用硬件（裸机）来运行。为了防止 Rust 加载标准库，请使用<code>no_std</code>. 标准库的平台无关部分可通过<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore 获得</a>。libcore 还排除了在嵌入式环境中并不总是需要的东西。其中之一是用于动态内存分配的内存分配器。如果您需要此功能或任何其他功能，通常有提供这些功能的板条箱。</p>
<p>libstd 运行时</p>
<p>如前所述，使用<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>需要某种系统集成，但这不仅是因为 <a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>只是提供一种访问操作系统抽象的通用方法，它还提供了一个运行时。该运行时负责设置堆栈溢出保护、处理命令行参数以及在调用程序的主函数之前生成主线程。此运行时在<code>no_std</code>环境中也不可用。</p>
<h3 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h3><p><code>#![no_std]</code>是一个 crate 级别的属性，表示 crate 将链接到 core-crate 而不是 std-crate。反过来，<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a> crate 是 std crate 与平台无关的子集，它不对程序将在其上运行的系统做任何假设。因此，它为浮点数、字符串和切片等语言原语提供 API，以及公开原子操作和 SIMD 指令等处理器功能的 API。然而，它缺少任何涉及平台集成的 API。由于这些属性，no_std 和<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a>代码可用于任何类型的引导（阶段 0）代码，如引导加载程序、固件或内核。</p>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><table>
<thead>
<tr>
<th>特征</th>
<th>no_std</th>
<th>标准</th>
</tr>
</thead>
<tbody><tr>
<td>堆（动态内存）</td>
<td>*</td>
<td>✓</td>
</tr>
<tr>
<td>集合（Vec、HashMap 等）</td>
<td>**</td>
<td>✓</td>
</tr>
<tr>
<td>堆栈溢出保护</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>在 main 之前运行初始化代码</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>libstd 可用</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>libcore 可用</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>编写固件、内核或引导加载程序代码</td>
<td>✓</td>
<td>✘</td>
</tr>
</tbody></table>
<p>* 仅当您使用<code>alloc</code>crate 并使用合适的分配器（如<a href="https://github.com/rust-embedded/alloc-cortex-m" target="_blank" rel="noopener">alloc-cortex-m ）时</a>。</p>
<p>** 仅当您使用<code>collections</code>crate 并配置全局默认分配器时。</p>
<h3 id="也可以看看"><a href="#也可以看看" class="headerlink" title="也可以看看"></a>也可以看看</h3><ul>
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1184-stabilize-no_std.md" target="_blank" rel="noopener">RFC-1184</a></li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>处理微控制器涉及使用几种不同的工具，因为我们将处理与笔记本电脑不同的架构，我们必须在<em>远程</em>设备上运行和调试程序。</p>
<p>我们将使用下面列出的所有工具。当未指定最低版本时，任何最新版本都应该可以工作，但我们已经列出了我们测试过的版本。</p>
<ul>
<li>Rust 1.31、1.31-beta 或更新的工具链加上 ARM Cortex-M 编译支持。</li>
<li><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a> ~0.1.4</li>
<li><a href="https://www.qemu.org/" target="_blank" rel="noopener"><code>qemu-system-arm</code></a>. 测试版本：3.0.0</li>
<li>OpenOCD &gt;=0.8。测试版本：v0.9.0 和 v0.10.0</li>
<li>具有 ARM 支持的 GDB。强烈建议使用 7.12 或更高版本。测试版本：7.10、7.11、7.12 和 8.1</li>
<li><a href="https://github.com/ashleygwilliams/cargo-generate" target="_blank" rel="noopener"><code>cargo-generate</code></a>或<code>git</code>。这些工具是可选的，但可以更轻松地跟随本书进行学习。</li>
</ul>
<p>下面的文字解释了我们使用这些工具的原因。安装说明可以在下一页找到。</p>
<h3 id="cargo-generate-或者-git"><a href="#cargo-generate-或者-git" class="headerlink" title="cargo-generate 或者 git"></a><code>cargo-generate</code> 或者 <code>git</code></h3><p>裸机程序是非标准的 ( <code>no_std</code>) Rust 程序，需要对链接过程进行一些调整才能使程序的内存布局正确。这需要一些额外的文件（如链接器脚本）和设置（如链接器标志）。我们为您打包了一个模板，您只需填写缺少的信息（例如项目名称和目标硬件的特性）。</p>
<p>我们的模板兼容<code>cargo-generate</code>：用于从模板创建新 Cargo 项目的 Cargo 子命令。您还可以使用下载模板<code>git</code>，<code>curl</code>，<code>wget</code>，或Web浏览器。</p>
<h3 id="cargo-binutils"><a href="#cargo-binutils" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><p><code>cargo-binutils</code>是 Cargo 子命令的集合，可以轻松使用 Rust 工具链附带的 LLVM 工具。这些工具包括<code>objdump</code>、<code>nm</code>和的 LLVM 版本，<code>size</code>用于检查二进制文件。</p>
<p>与 GNU binutils 相比，使用这些工具的优势在于 (a) 安装 LLVM 工具是相同的单命令安装 ( <code>rustup component add llvm-tools-preview</code>)，无论您的操作系统如何，以及 (b)<code>objdump</code>支持所有<code>rustc</code>支持架构的工具——从 ARM 到 x86_64—— - 因为它们共享相同的 LLVM 后端。</p>
<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu-system-arm"></a><code>qemu-system-arm</code></h3><p>QEMU 是一个模拟器。在这种情况下，我们使用可以完全模拟 ARM 系统的变体。我们使用 QEMU 在主机上运行嵌入式程序。多亏了这一点，即使您没有任何硬件，您也可以遵循本书的某些部分！</p>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><p>调试器是嵌入式开发的一个非常重要的组件，因为您可能并不总是能够将内容记录到主机控制台。在某些情况下，您的硬件甚至可能没有 LED 指示灯闪烁！</p>
<p>总的来说，LLDB 在调试方面的效果与 GDB 一样好，但我们还没有找到 GDB 的<code>load</code>命令的 LLDB 对应项，它将程序上传到目标硬件，因此目前我们建议您使用 GDB。</p>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>GDB 无法直接与 STM32F3DISCOVERY 开发板上的 ST-Link 调试硬件通信。它需要一个转换器，而开放式片上调试器 OpenOCD 就是那个转换器。OpenOCD 是一个在您的笔记本电脑/PC 上运行的程序，可在 GDB 的基于 TCP/IP 的远程调试协议和 ST-Link 的基于 USB 的协议之间进行转换。</p>
<p>OpenOCD 还执行其他重要工作，作为其在 STM32F3DISCOVERY 开发板上调试基于 ARM Cortex-M 的微控制器的翻译的一部分：</p>
<ul>
<li>它知道如何与 ARM CoreSight 调试外设使用的内存映射寄存器进行交互。正是这些 CoreSight 寄存器允许：<ul>
<li>断点/观察点操作</li>
<li>读取和写入 CPU 寄存器</li>
<li>检测 CPU 何时因调试事件而停止</li>
<li>遇到调试事件后继续执行 CPU</li>
<li>等等。</li>
</ul>
</li>
<li>它还知道如何擦除和写入微控制器的 FLASH</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>此页面包含一些工具的与操作系统无关的安装说明：</p>
<h3 id="Rust-工具链"><a href="#Rust-工具链" class="headerlink" title="Rust 工具链"></a>Rust 工具链</h3><p>按照<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs </a>上的说明安装 rustup 。</p>
<p><strong>注意</strong>确保您的编译器版本等于或高于<code>1.31</code>. <code>rustc -V</code>应该返回一个比下面显示的日期新的日期。</p>
<pre class="line-numbers language-text"><code class="language-text">$ rustc -V
rustc 1.31.1 (b6c32da9b 2018-12-18)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于带宽和磁盘使用问题，默认安装仅支持本机编译。要为 ARM Cortex-M 架构添加交叉编译支持，请选择以下编译目标之一。对于本书示例中使用的 STM32F3DISCOVERY 板，请使用<code>thumbv7em-none-eabihf</code>目标。</p>
<p>Cortex-M0、M0+ 和 M1（ARMv6-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M3（ARMv7-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>无硬件浮点的 Cortex-M4 和 M7（ARMv7E-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>带有硬件浮点的 Cortex-M4F 和 M7F（ARMv7E-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M23（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.base-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33 和 M35P（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33F 和 M35PF 带硬件浮点（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="cargo-binutils-1"><a href="#cargo-binutils-1" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><pre class="line-numbers language-text"><code class="language-text">cargo install cargo-binutils

rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-generate"><a href="#cargo-generate" class="headerlink" title="cargo-generate"></a><code>cargo-generate</code></h3><p>稍后我们将使用它从模板生成项目。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>以下是一些 Linux 发行版的安装命令。</p>
<h4 id="套餐"><a href="#套餐" class="headerlink" title="套餐"></a>套餐</h4><ul>
<li>Ubuntu 18.04 或更高版本/Debian 延伸版或更高版本</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>gdb-multiarch</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-multiarch openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Ubuntu 14.04 和 16.04</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-arm-none-eabi openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Fedora 27 或更新版本</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo dnf install arm-none-eabi-gdb openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>拱形Linux</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S arm-none-eabi-gdb qemu-arch-extra openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="udev-规则"><a href="#udev-规则" class="headerlink" title="udev 规则"></a>udev 规则</h4><p>此规则允许您在没有 root 权限的情况下将 OpenOCD 与 Discovery 板一起使用。</p>
<p><code>/etc/udev/rules.d/70-st-link.rules</code>使用如下所示的内容创建文件。</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY rev A/B - ST-LINK/V2
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="3748", TAG+="uaccess"

# STM32F3DISCOVERY rev C+ - ST-LINK/V2-1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", TAG+="uaccess"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后使用以下命令重新加载所有 udev 规则：</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果您将电路板插入笔记本电脑，请将其拔下，然后再重新插入。</p>
<p>您可以通过运行以下命令来检查权限：</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>哪个应该显示类似</p>
<pre class="line-numbers language-text"><code class="language-text">(..)
Bus 001 Device 018: ID 0483:374b STMicroelectronics ST-LINK/V2.1
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>记下总线和设备编号。使用这些数字创建一个类似 <code>/dev/bus/usb/&lt;bus&gt;/&lt;device&gt;</code>. 然后像这样使用这个路径：</p>
<pre class="line-numbers language-console"><code class="language-console">ls -l /dev/bus/usb/001/018
crw-------+ 1 root root 189, 17 Sep 13 12:34 /dev/bus/usb/001/018
getfacl /dev/bus/usb/001/018 | grep user
user::rw-
user:you:rw-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>+</code>附加到权限指示扩展的许可的存在。该<code>getfacl</code>命令告诉用户<code>you</code>可以使用该设备。</p>
<h3 id="苹果系统"><a href="#苹果系统" class="headerlink" title="苹果系统"></a>苹果系统</h3><p>所有工具都可以使用<a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>安装：</p>
<pre class="line-numbers language-text"><code class="language-text">$ # GDB
$ brew install armmbed/formulae/arm-none-eabi-gcc

$ # OpenOCD
$ brew install openocd

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="arm-none-eabi-gdb"><a href="#arm-none-eabi-gdb" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h4><p>ARM<code>.exe</code>为 Windows提供安装程序。从<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">这里</a>拿一个，然后按照说明操作。就在安装过程完成之前，勾选/选择“添加环境变量路径”选项。然后验证工具是否在您的<code>%PATH%</code>：</p>
<pre class="line-numbers language-text"><code class="language-text">$ arm-none-eabi-gdb -v
GNU gdb (GNU Tools for Arm Embedded Processors 7-2018-q2-update) 8.1.0.20180315-git
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="开放式强迫症"><a href="#开放式强迫症" class="headerlink" title="开放式强迫症"></a>开放式强迫症</h4><p>没有用于 Windows 的 OpenOCD 的官方二进制版本，但如果您不想自己编译它，xPack 项目提供了一个二进制发行版，请<a href="https://xpack.github.io/openocd/" target="_blank" rel="noopener">点击此处</a>。按照提供的安装说明进行操作。然后更新您的<code>%PATH%</code>环境变量以包含安装二进制文件的路径。( <code>C:\Users\USERNAME\AppData\Roaming\xPacks\@xpack-dev-tools\openocd\0.10.0-13.1\.content\bin\</code>, 如果您一直在使用简易安装)</p>
<p>验证 OpenOCD 是否在您的目录<code>%PATH%</code>中：</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="动车组"><a href="#动车组" class="headerlink" title="动车组"></a>动车组</h4><p>从<a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">官方网站获取</a>QEMU 。</p>
<h4 id="ST-LINK-USB-驱动"><a href="#ST-LINK-USB-驱动" class="headerlink" title="ST-LINK USB 驱动"></a>ST-LINK USB 驱动</h4><p>您还需要安装<a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">此 USB 驱动程序</a>，否则 OpenOCD 将无法工作。按照安装程序说明进行操作，并确保安装正确版本（32 位或 64 位）的驱动程序。</p>
<h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><p>在本节中，我们检查一些必需的工具/驱动程序是否已正确安装和配置。</p>
<p>使用微型 USB 电缆将您的笔记本电脑/PC 连接到发现板。发现板有两个 USB 连接器；使用位于电路板边缘中心的标有“USB ST-LINK”的那个。</p>
<p>还要检查是否填充了 ST-LINK 标头。见下图；ST-LINK 标头以红色圈出。</p>
<p><img src="/images/loading.gif" data-original="../images/language/verify.jpeg" alt=""></p>
<p>现在运行以下命令：</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：旧版本的 openocd，包括 2017 年的 0.10.0 版本，不包含新的（和更可取的）<code>interface/stlink.cfg</code>文件；相反，您可能需要使用<code>interface/stlink-v2.cfg</code>或<code>interface/stlink-v2-1.cfg</code>。</p>
</blockquote>
<p>您应该得到以下输出，并且程序应该阻止控制台：</p>
<pre class="line-numbers language-text"><code class="language-text">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.919881
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>内容可能不完全匹配，但您应该得到关于断点和观察点的最后一行。如果您得到它，则终止 OpenOCD 进程并转到<a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">下一部分</a>。</p>
<p>如果您没有得到“断点”行，请尝试以下命令之一。</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2.cfg -f target/stm32f3x.cfg
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果其中一个命令有效，则意味着您获得了发现板的旧硬件版本。这不会成为问题，但请将此事实记入内存，因为您稍后需要以不同的方式配置内容。您可以转到 <a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">下一部分</a>。</p>
<p>如果没有任何命令以普通用户身份运行，则尝试以 root 权限（例如<code>sudo openocd ..</code>）运行它们。如果命令确实在 root 权限下工作，则检查<a href="https://docs.rust-embedded.org/book/intro/install/linux.html#udev-rules" target="_blank" rel="noopener">udev 规则</a>是否已正确设置。</p>
<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><h2 id="QUEM"><a href="#QUEM" class="headerlink" title="QUEM"></a>QUEM</h2><p>我们将开始为Cortex-M3 微控制器<a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>编写程序。我们选择它作为我们的初始目标，因为它<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">可以</a>使用 QEMU<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">进行模拟</a>，因此您无需在本节中摆弄硬件，我们可以专注于工具和开发过程。</p>
<p><strong>重要信息</strong> 在本教程中，我们将使用名称“app”作为项目名称。每当您看到“app”一词时，您都应该将其替换为您为项目选择的名称。或者，您也可以将您的项目命名为“app”并避免替换。</p>
<h3 id="创建一个非标准的-Rust-程序"><a href="#创建一个非标准的-Rust-程序" class="headerlink" title="创建一个非标准的 Rust 程序"></a>创建一个非标准的 Rust 程序</h3><p>我们将使用<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>项目模板从中生成一个新项目。创建的项目将包含一个准系统应用程序：一个新的嵌入式 Rust 应用程序的良好起点。此外，该项目将包含一个<code>examples</code>目录，其中包含几个单独的应用程序，突出显示了一些关键的嵌入式 Rust 功能。</p>
<h4 id="使用-cargo-generate"><a href="#使用-cargo-generate" class="headerlink" title="使用 cargo-generate"></a>使用 <code>cargo-generate</code></h4><p>首先安装货物生成</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后生成一个新项目</p>
<pre class="line-numbers language-console"><code class="language-console">cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用-git"><a href="#使用-git" class="headerlink" title="使用 git"></a>使用 <code>git</code></h4><p>克隆存储库</p>
<pre class="line-numbers language-console"><code class="language-console">git clone https://github.com/rust-embedded/cortex-m-quickstart app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后填写<code>Cargo.toml</code>文件中的占位符</p>
<pre class="line-numbers language-toml"><code class="language-toml">[package]
authors = ["{{authors}}"] # "{{authors}}" -> "John Smith"
edition = "2018"
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
version = "0.1.0"

# ..

[[bin]]
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
test = false
bench = false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用neither"><a href="#使用neither" class="headerlink" title="使用neither"></a>使用<code>neither</code></h4><p>获取<code>cortex-m-quickstart</code>模板的最新快照并提取它。</p>
<pre class="line-numbers language-console"><code class="language-console">curl -LO https://github.com/rust-embedded/cortex-m-quickstart/archive/master.zip
unzip master.zip
mv cortex-m-quickstart-master app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者您可以浏览到<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>，单击绿色的“克隆或下载”按钮，然后单击“下载 ZIP”。</p>
<p>然后<code>Cargo.toml</code>按照“使用<code>git</code>”版本的第二部分中的方法填写文件中的占位符。</p>
<h3 id="程序概览"><a href="#程序概览" class="headerlink" title="程序概览"></a>程序概览</h3><p>为方便起见，这里是源代码中最重要的部分<code>src/main.rs</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// your code goes here</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个程序与标准的 Rust 程序有点不同，所以让我们仔细看看。</p>
<p><code>#![no_std]</code>表示这个程序<em>不会</em>链接到标准包， <code>std</code>. 相反，它将链接到它的子集：<code>core</code>板条箱。</p>
<p><code>#![no_main]</code>表示这个程序不会使用<code>main</code> 大多数 Rust 程序使用的标准接口。主要（没有双关语）的原因<code>no_main</code>是<code>main</code>在<code>no_std</code>上下文中使用界面需要每晚。</p>
<p><code>use panic_halt as _;</code>. 这个 crate 提供了一个<code>panic_handler</code>定义程序的恐慌行为。</p>
<p><a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.entry.html" target="_blank" rel="noopener"><code>#[entry]</code></a>是<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>crate提供的一个属性，用于标记程序的入口点。由于我们没有使用标准<code>main</code> 接口，我们需要另一种方式来指示程序的入口点，那就是<code>#[entry]</code>.</p>
<p><code>fn main() -&gt; !</code>. 我们的程序将是目标硬件上运行的<em>唯一</em>进程，所以我们不希望它结束！我们使用<a href="https://doc.rust-lang.org/rust-by-example/fn/diverging.html" target="_blank" rel="noopener">发散函数</a>（<code>-&gt; !</code> 函数签名中的位）来确保在编译时就是这种情况。</p>
<h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>下一步是<em>交叉</em>编译 Cortex-M3 架构的程序。<code>cargo build --target $TRIPLE</code>如果您知道编译目标 ( <code>$TRIPLE</code>) 应该是什么，那么这就像运行一样简单。幸运的是，<code>.cargo/config.toml</code>模板中有答案：</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n6 .cargo/config.toml
[build]
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
# target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要交叉编译 Cortex-M3 架构，我们必须使用 <code>thumbv7m-none-eabi</code>. 安装 Rust 工具链时不会自动安装该目标，现在是将该目标添加到工具链的好时机，如果您还没有这样做：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>由于<code>thumbv7m-none-eabi</code>编译目标已在您的<code>.cargo/config.toml</code>文件中设置为默认值，因此下面的两个命令执行相同的操作：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7m-none-eabi
cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><p>现在我们在<code>target/thumbv7m-none-eabi/debug/app</code>. 我们可以使用<code>cargo-binutils</code>.</p>
<p>随着<code>cargo-readobj</code>我们可以打印ELF头，以确认这是一个ARM二进制文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --bin app -- -file-headers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：</p>
<ul>
<li><code>--bin app</code> 是用于检查二进制文件的糖 <code>target/$TRIPLE/debug/app</code></li>
<li><code>--bin app</code> 如有必要，还将（重新）编译二进制文件</li>
</ul>
<pre class="line-numbers language-text"><code class="language-text">ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0x0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x405
  Start of program headers:          52 (bytes into file)
  Start of section headers:          153204 (bytes into file)
  Flags:                             0x5000200
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         19
  Section header string table index: 18<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>cargo-size</code> 可以打印二进制文件的链接器部分的大小。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo size --bin app --release -- -A<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们<code>--release</code>用来检查优化版本</p>
<pre class="line-numbers language-text"><code class="language-text">app  :
section             size        addr
.vector_table       1024         0x0
.text                 92       0x400
.rodata                0       0x45c
.data                  0  0x20000000
.bss                   0  0x20000000
.debug_str          2958         0x0
.debug_loc            19         0x0
.debug_abbrev        567         0x0
.debug_info         4929         0x0
.debug_ranges         40         0x0
.debug_macinfo         1         0x0
.debug_pubnames     2035         0x0
.debug_pubtypes     1892         0x0
.ARM.attributes       46         0x0
.debug_frame         100         0x0
.debug_line          867         0x0
Total              14570<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ELF 链接器部分的复习</p>
<ul>
<li><code>.text</code> 包含程序指令</li>
<li><code>.rodata</code> 包含常量值，如字符串</li>
<li><code>.data</code>包含初始值<em>不</em>为零的静态分配变量</li>
<li><code>.bss</code>也包含静态分配的变量，其初始值 <em>是</em>零</li>
<li><code>.vector_table</code>是我们用来存储向量（中断）表的<em>非标准</em>部分</li>
<li><code>.ARM.attributes</code>并且这些<code>.debug_*</code>部分包含元数据，并且 在闪烁二进制文件时<em>不会</em>加载到目标上。</li>
</ul>
</blockquote>
<p><strong>重要提示</strong>：ELF 文件包含诸如调试信息之类的元数据，因此它们<em>在磁盘</em>上的<em>大小*</em>不能<em>准确反映程序在设备上闪烁时将占用的空间。</em>始终*使用<code>cargo-size</code>来检查二进制真的有多大。</p>
<p><code>cargo-objdump</code> 可用于反汇编二进制文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin app --release -- --disassemble --no-show-raw-insn --print-imm-hex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果上面的命令抱怨<code>Unknown command line argument</code>看到以下错误报告：<a href="https://github.com/rust-embedded/book/issues/269" target="_blank" rel="noopener">https://github.com/rust-embedded/book/issues/269</a></p>
</blockquote>
<blockquote>
<p><strong>注意</strong>此输出在您的系统上可能会有所不同。新版本的 rustc、LLVM 和库可以生成不同的程序集。我们截断了一些指令以保持代码片段较小。</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">app:  file format ELF32-arm-little

Disassembly of section .text:
main:
     400: bl  #0x256
     404: b #-0x4 <main+0x4>

Reset:
     406: bl  #0x24e
     40a: movw  r0, #0x0
     < .. truncated any more instructions .. >

DefaultHandler_:
     656: b #-0x4 <DefaultHandler_>

UsageFault:
     657: strb  r7, [r4, #0x3]

DefaultPreInit:
     658: bx  lr

__pre_init:
     659: strb  r7, [r0, #0x1]

__nop:
     65a: bx  lr

HardFaultTrampoline:
     65c: mrs r0, msp
     660: b #-0x2 <HardFault_>

HardFault_:
     662: b #-0x4 <HardFault_>

HardFault:
     663: <unknown><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>接下来，让我们看看如何在 QEMU 上运行嵌入式程序！这次我们将使用<code>hello</code>实际执行某些操作的 示例。</p>
<p>为方便起见，这里的源代码<code>examples/hello.rs</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! Prints "Hello, world!" on the host console using semihosting</span>

<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该程序使用称为半主机的东西将文本打印到<em>主机</em> 控制台。当使用真正的硬件时，这需要一个调试会话，但当使用 QEMU 时，它就可以工作。</p>
<p>让我们从编译示例开始：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输出二进制文件将位于 <code>target/thumbv7m-none-eabi/debug/examples/hello</code>.</p>
<p>要在 QEMU 上运行此二进制文件，请运行以下命令：</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打印文本后，该命令应成功退出（退出代码 = 0）。在 *nix 上，您可以使用以下命令进行检查：</p>
<pre class="line-numbers language-console"><code class="language-console">echo $?
0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>让我们分解一下 QEMU 命令：</p>
<ul>
<li><code>qemu-system-arm</code>. 这是 QEMU 模拟器。这些 QEMU 二进制文件有几个变体；这个对<em>ARM</em>机器进行完整的<em>系统</em>仿真，因此得名。</li>
<li><code>-cpu cortex-m3</code>. 这告诉 QEMU 模拟 Cortex-M3 CPU。指定 CPU 型号可以让我们捕获一些错误编译错误：例如，运行为 Cortex-M4F 编译的程序，它具有硬件 FPU，在执行过程中会导致 QEMU 错误。</li>
<li><code>-machine lm3s6965evb</code>. 这告诉 QEMU 模拟 LM3S6965EVB，这是一个包含 LM3S6965 微控制器的评估板。</li>
<li><code>-nographic</code>. 这告诉 QEMU 不要启动它的 GUI。</li>
<li><code>-semihosting-config (..)</code>. 这告诉 QEMU 启用半主机。半主机允许模拟设备使用主机 stdout、stderr 和 stdin 并在主机上创建文件。</li>
<li><code>-kernel $file</code>. 这会告诉 QEMU 在模拟机器上加载和运行哪个二进制文件。</li>
</ul>
<p>输入这么长的 QEMU 命令太费力了！我们可以设置自定义运行器来简化流程。<code>.cargo/config.toml</code>有一个被注释掉的调用 QEMU 的运行程序；让我们取消注释：</p>
<pre class="line-numbers language-console"><code class="language-console">head -n3 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此运行程序仅适用于<code>thumbv7m-none-eabi</code>目标，这是我们的默认编译目标。现在<code>cargo run</code>将编译程序并在 QEMU 上运行它：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run --example hello --release
   Compiling app v0.1.0 (file:///tmp/app)
    Finished release [optimized + debuginfo] target(s) in 0.26s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/examples/hello`
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>调试对于嵌入式开发至关重要。让我们看看它是如何完成的。</p>
<p>调试嵌入式设备涉及<em>远程</em>调试，因为我们要调试的程序不会在运行调试器程序（GDB 或 LLDB）的机器上运行。</p>
<p>远程调试涉及客户端和服务器。在 QEMU 设置中，客户端将是一个 GDB（或 LLDB）进程，而服务器将是运行嵌入式程序的 QEMU 进程。</p>
<p>在本节中，我们将使用<code>hello</code>我们已经编译的示例。</p>
<p>调试的第一步是在调试模式下启动 QEMU：</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -gdb tcp::3333 \
  -S \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此命令不会向控制台打印任何内容并将阻止终端。这次我们传递了两个额外的标志：</p>
<ul>
<li><code>-gdb tcp::3333</code>. 这告诉 QEMU 等待 TCP 端口 3333 上的 GDB 连接。</li>
<li><code>-S</code>. 这告诉 QEMU 在启动时冻结机器。如果没有这个，程序将在我们有机会启动调试器之前到达 main 的末尾！</li>
</ul>
<p>接下来我们在另一个终端中启动 GDB 并告诉它加载示例的调试符号：</p>
<pre class="line-numbers language-console"><code class="language-console">gdb-multiarch -q target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>注意</strong>：您可能需要另一个版本的 gdb 而不是<code>gdb-multiarch</code>取决于您在安装章节中安装的那个版本。这也可以是 <code>arm-none-eabi-gdb</code>或只是<code>gdb</code>.</p>
<p>然后在 GDB shell 中我们连接到 QEMU，它正在等待 TCP 端口 3333 上的连接。</p>
<pre class="line-numbers language-console"><code class="language-console">target remote :3333
Remote debugging using :3333
Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473
473     pub unsafe extern "C" fn Reset() -> ! {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>您将看到该进程已停止，并且程序计数器指向名为<code>Reset</code>. 这就是重置处理程序：Cortex-M 内核在启动时执行的操作。</p>
<blockquote>
<p>请注意，在某些设置<code>Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473</code>中，gdb 可能会打印一些警告，而不是显示如上所示的行：</p>
<pre><code>core::num::bignum::Big32x40::mul_small () at src/libcore/num/bignum.rs:254` `src/libcore/num/bignum.rs: No such file or directory.</code></pre><p>这是一个众所周知的故障。您可以放心地忽略这些警告，您很可能在 Reset() 处。</p>
</blockquote>
<p>这个重置处理程序最终会调用我们的主函数。让我们使用断点和<code>continue</code>命令一路跳过。要设置断点，让我们首先看看我们想要在代码中中断的位置，使用<code>list</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">list main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这将显示来自文件 examples/hello.rs 的源代码。</p>
<pre class="line-numbers language-text"><code class="language-text">6       use panic_halt as _;
7
8       use cortex_m_rt::entry;
9       use cortex_m_semihosting::{debug, hprintln};
10
11      #[entry]
12      fn main() -> ! {
13          hprintln!("Hello, world!").unwrap();
14
15          // exit QEMU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们想在第 13 行的“Hello, world!”之前添加一个断点。我们使用以下<code>break</code>命令：</p>
<pre class="line-numbers language-console"><code class="language-console">break 13<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们现在可以使用以下<code>continue</code>命令指示 gdb 运行到我们的 main 函数：</p>
<pre class="line-numbers language-console"><code class="language-console">continue
Continuing.

Breakpoint 1, hello::__cortex_m_rt_main () at examples\hello.rs:13
13          hprintln!("Hello, world!").unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们现在接近打印“Hello, world!”的代码。让我们继续使用<code>next</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">next
16          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时您应该看到“Hello, world!” 打印在正在运行的终端上<code>qemu-system-arm</code>。</p>
<pre class="line-numbers language-text"><code class="language-text">$ qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>next</code>再次调用将终止 QEMU 进程。</p>
<pre class="line-numbers language-console"><code class="language-console">next
[Inferior 1 (Remote target) exited normally]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>您现在可以退出 GDB 会话。</p>
<pre class="line-numbers language-console"><code class="language-console">quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Hardware（硬件）"><a href="#Hardware（硬件）" class="headerlink" title="Hardware（硬件）"></a>Hardware（硬件）</h2><h3 id="了解硬件"><a href="#了解硬件" class="headerlink" title="了解硬件"></a>了解硬件</h3><p>在我们开始之前，您需要确定目标设备的一些特征，因为这些特征将用于配置项目：</p>
<ul>
<li>ARM 核心。例如皮质-M3。</li>
<li>ARM 内核是否包含 FPU？Cortex-M4 <strong>F</strong>和 Cortex-M7 <strong>F</strong>内核可以。</li>
<li>目标设备有多少闪存和 RAM？例如 256 KiB 的闪存和 32 KiB 的 RAM。</li>
<li>闪存和 RAM 在地址空间中映射到哪里？例如，RAM 通常位于 address <code>0x2000_0000</code>。</li>
</ul>
<p>您可以在数据表或设备的参考手册中找到此信息。</p>
<p>在本节中，我们将使用我们的参考硬件 STM32F3DISCOVERY。该板包含一个 STM32F303VCT6 微控制器。该微控制器具有：</p>
<ul>
<li>包含单精度 FPU 的 Cortex-M4F 内核</li>
<li>位于地址 0x0800_0000 的 256 KiB 闪存。</li>
<li>位于地址 0x2000_0000 的 40 KiB RAM。（还有另一个 RAM 区域，但为简单起见，我们将忽略它）。</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>我们将从一个新的模板实例开始。请参阅 QEMU关于如何做到这一点没有复习 <code>cargo-generate</code>。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app

$ cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步是在<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n5 .cargo/config.toml
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
# target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将使用<code>thumbv7em-none-eabihf</code>它覆盖 Cortex-M4F 内核。</p>
<p>第二步是将内存区域信息输入到<code>memory.x</code> 文件中。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cat memory.x
/* Linker script for the STM32F303VCT6 */
MEMORY
{
  /* NOTE 1 K = 1 KiBi = 1024 bytes */
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：如果您<code>memory.x</code>在完成特定构建目标的第一次构建后出于某种原因更改了文件，请<code>cargo clean</code>在之前执行 <code>cargo build</code>，因为<code>cargo build</code>可能无法跟踪<code>memory.x</code>.</p>
</blockquote>
<p>我们将再次从 hello 示例开始，但首先我们必须进行一些小的更改。</p>
<p>在 中<code>examples/hello.rs</code>，确保<code>debug::exit()</code>已注释掉或删除该调用。它仅用于在 QEMU 中运行。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    <span class="token comment" spellcheck="true">// debug::exit(debug::EXIT_SUCCESS);</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您现在可以像以前一样使用交叉编译程序<code>cargo build</code> 和检查二进制文件<code>cargo-binutils</code>。该 <code>cortex-m-rt</code>箱处理所有的魔法需要得到你的芯片上运行，如有益，几乎所有的Cortex-M CPU的启动以同样的方式。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>调试看起来有点不同。事实上，根据目标设备的不同，第一步看起来可能会有所不同。在本节中，我们将展示调试在 STM32F3DISCOVERY 上运行的程序所需的步骤。这是为了作为参考；有关调试的设备特定信息，请查看<a href="https://github.com/rust-embedded/debugonomicon" target="_blank" rel="noopener">Debugonomicon</a>。</p>
<p>和以前一样，我们将进行远程调试，客户端将是一个 GDB 进程。然而，这一次，服务器将是 OpenOCD。</p>
<p>正如在安装验证部分所做的那样，将发现板连接到您的笔记本电脑/PC 并检查 ST-LINK 标头是否已填充。</p>
<p>在终端上运行<code>openocd</code>以连接到发现板上的 ST-LINK。从模板的根目录运行此命令；<code>openocd</code>将拾取 <code>openocd.cfg</code>指示使用哪个接口文件和目标文件的文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.cfg
# Sample OpenOCD configuration for the STM32F3DISCOVERY development board

# Depending on the hardware revision you got you'll have to pick ONE of these
# interfaces. At any time only one interface should be commented out.

# Revision C (newer revision)
source [find interface/stlink.cfg]

# Revision A and B (older revisions)
# source [find interface/stlink-v2.cfg]

source [find target/stm32f3x.cfg]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果您在验证部分发现发现板的版本较旧，则此时应修改<code>openocd.cfg</code> 文件以使用<code>interface/stlink-v2.cfg</code>.</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.913879
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在另一个终端上运行 GDB，也是从模板的根目录。</p>
<pre class="line-numbers language-text"><code class="language-text">$ <gdb> -q target/thumbv7em-none-eabihf/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来将 GDB 连接到 OpenOCD，它正在等待端口 3333 上的 TCP 连接。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>现在继续使用命令将程序<em>闪存</em>（加载）到微控制器上 <code>load</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) load
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序现在已加载。该程序使用半主机，因此在我们进行任何半主机调用之前，我们必须告诉 OpenOCD 启用半主机。您可以使用命令向 OpenOCD 发送命令<code>monitor</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>您可以通过调用<code>monitor help</code>命令查看所有 OpenOCD 命令。</p>
</blockquote>
<p>像以前一样，我们可以一直跳过<code>main</code>使用断点和 <code>continue</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main
Breakpoint 1 at 0x8000d18: file examples/hello.rs, line 15.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, main () at examples/hello.rs:15
15          let mut stdout = hio::hstdout().unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果在您发出上述<code>continue</code>命令后 GDB 阻塞终端而不是点击断点，您可能需要仔细检查文件中的内存区域信息<code>memory.x</code>是否为您的设备正确设置（开始<em>和</em>长度）。</p>
</blockquote>
<p>推进程序<code>next</code>应该产生与以前相同的结果。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next
16          writeln!(stdout, "Hello, world!").unwrap();

(gdb) next
19          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时您应该看到“Hello, world!” 打印在 OpenOCD 控制台上，等等。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08000e6c
Hello, world!
Info : halted: PC: 0x08000d62
Info : halted: PC: 0x08000d64
Info : halted: PC: 0x08000d66
Info : halted: PC: 0x08000d6a
Info : halted: PC: 0x08000a0c
Info : halted: PC: 0x08000d70
Info : halted: PC: 0x08000d72<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发出另一个<code>next</code>将使处理器执行<code>debug::exit</code>。这充当断点并停止进程：</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next

Program received signal SIGTRAP, Trace/breakpoint trap.
0x0800141a in __syscall ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>它还会导致将其打印到 OpenOCD 控制台：</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08001188
semihosting: *** application exited ***
Warn : target not halted
Warn : target not halted
target halted due to breakpoint, current mode: Thread
xPSR: 0x21000000 pc: 0x08000d76 msp: 0x20009fc0, semihosting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，在微控制器上运行的进程尚未终止，您可以使用<code>continue</code>或类似命令恢复它。</p>
<p>您现在可以使用该<code>quit</code>命令退出 GDB 。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调试现在需要更多的步骤，因此我们将所有这些步骤打包到一个名为<code>openocd.gdb</code>. 该文件是在该<code>cargo generate</code>步骤中创建的，应该无需任何修改即可工作。让我们有一个高峰：</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.gdb
target extended-remote :3333

# print demangled symbols
set print asm-demangle on

# detect unhandled exceptions, hard faults and panics
break DefaultHandler
break HardFault
break rust_begin_unwind

monitor arm semihosting enable

load

# start the process but immediately halt the processor
stepi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在运行<code>&lt;gdb&gt; -x openocd.gdb target/thumbv7em-none-eabihf/debug/examples/hello</code>将立即将 GDB 连接到 OpenOCD，启用半主机，加载程序并启动进程。</p>
<p>或者，您可以变成<code>&lt;gdb&gt; -x openocd.gdb</code>自定义运行<code>cargo run</code>程序来 构建程序<em>并</em>启动 GDB 会话。此运行程序包含在<code>.cargo/config.toml</code>但已注释掉。</p>
<pre class="line-numbers language-console"><code class="language-console">head -n10 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
# runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"

[target.'cfg(all(target_arch = "arm", target_os = "none"))']
# uncomment ONE of these three option to make `cargo run` start a GDB session
# which option to pick depends on your system
runner = "arm-none-eabi-gdb -x openocd.gdb"
# runner = "gdb-multiarch -x openocd.gdb"
# runner = "gdb -x openocd.gdb"
$ cargo run --example hello
(..)
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Memory-Mapped-Registers"><a href="#Memory-Mapped-Registers" class="headerlink" title="Memory Mapped Registers"></a>Memory Mapped Registers</h2><p>嵌入式系统只能通过执行普通的 Rust 代码并在 RAM 中移动数据来实现。如果我们想将任何信息输入或输出我们的系统（例如闪烁 LED、检测按钮按下或与某种总线上的片外外围设备通信），我们将不得不深入了解外设及其“内存映射寄存器”。</p>
<p>您可能会发现访问微控制器中的外围设备所需的代码已经编写好了，位于以下级别之一：</p>
<p><img src="/images/loading.gif" data-original="../images/language/crates.png" alt=""></p>
<ul>
<li>Micro-architecture Crate - 此类 crate 处理您的微控制器使用的处理器内核通用的任何有用例程，以及使用该特定类型处理器内核的所有微控制器通用的任何外围设备。例如，<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate 为您提供了启用和禁用中断的功能，这些功能对于所有基于 Cortex-M 的微控制器都是相同的。它还允许您访问所有基于 Cortex-M 的微控制器中包含的“SysTick”外设。</li>
<li>外设访问板条箱 (PAC) - 这种板条箱是为您正在使用的微控制器的特定部件号定义的各种内存包装器寄存器的薄包装器。例如，<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>适用于 Texas Instruments Tiva-C TM4C123 系列，或<a href="https://crates.io/crates/stm32f30x" target="_blank" rel="noopener">stm32f30x</a>适用于 ST-Micro STM32F30x 系列。在这里，您将按照微控制器技术参考手册中给出的每个外围设备的操作说明直接与寄存器交互。</li>
<li>HAL Crate - 这些 crate 为您的特定处理器提供更加用户友好的 API，通常通过实现一些在<a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener">Embedded-hal </a>中定义的常见特征。例如，这个 crate 可能提供一个<code>Serial</code>结构体，带有一个构造函数，该构造函数采用一组适当的 GPIO 引脚和波特率，并提供某种<code>write_byte</code>发送数据的功能。</li>
<li>Board Crate - 这些 crate 比 HAL Crate 更进一步，通过预配置各种外设和 GPIO 引脚以适合您正在使用的特定开发人员套件或板，例如<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>用于 STM32F3DISCOVERY 板。</li>
</ul>
<h3 id="板条箱"><a href="#板条箱" class="headerlink" title="板条箱"></a>板条箱</h3><p>如果您不熟悉嵌入式 Rust，板条箱是完美的起点。他们很好地抽象了开始学习这个主题时可能会让人不知所措的硬件细节，并使标准任务变得简单，比如打开或关闭 LED。它们公开的功能因板而异。由于本书旨在保持与硬件无关，因此本书不会涵盖板条箱。</p>
<p>如果您想试用 STM32F3DISCOVERY 板，强烈建议查看<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>板箱，它提供使板 LED 闪烁、访问指南针、蓝牙等功能。<a href="https://rust-embedded.github.io/discovery/" target="_blank" rel="noopener">discovery</a>提供了一个很好的介绍使用板箱的。</p>
<p>但是，如果您正在使用一个还没有专用板条箱的系统，或者您需要现有板条箱未提供的功能，请继续阅读我们从底部开始的微架构板条箱。</p>
<h3 id="微架构箱"><a href="#微架构箱" class="headerlink" title="微架构箱"></a>微架构箱</h3><p>让我们看看所有基于 Cortex-M 的微控制器通用的 SysTick 外设。我们可以在<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate 中找到一个非常低级的 API ，我们可以这样使用它：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>syst<span class="token punctuation">,</span> Peripherals<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> systick <span class="token operator">=</span> peripherals<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>systick<span class="token punctuation">.</span><span class="token function">has_wrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Loop</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在功能<code>SYST</code>结构非常紧密映射到由ARM技术参考手册此外设定义的功能。这个 API 中没有关于“延迟 X 毫秒”的内容——我们必须自己使用<code>while</code>循环粗略地实现它。请注意，<code>SYST</code>在调用之前我们无法访问我们的结构<code>Peripherals::take()</code>- 这是一个特殊的例程，可保证<code>SYST</code>我们整个程序中只有一个结构。</p>
<h3 id="使用外设访问箱-PAC"><a href="#使用外设访问箱-PAC" class="headerlink" title="使用外设访问箱 (PAC)"></a>使用外设访问箱 (PAC)</h3><p>如果我们将自己限制在每个 Cortex-M 附带的基本外围设备上，我们的嵌入式软件开发就不会走得太远。在某些时候，我们将需要编写一些特定于我们正在使用的特定微控制器的代码。在这个例子中，我们假设我们有一个 Texas Instruments TM4C123——一个中等的 80MHz Cortex-M4，具有 256 KiB 的闪存。我们将拉入<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>板条箱以使用该芯片。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> Leds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> tm4c123x<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> pwm <span class="token operator">=</span> p<span class="token punctuation">.</span>PWM0<span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Mode = 1 => Count up/down mode</span>
    pwm<span class="token punctuation">.</span>_2_ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_gena<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">actcmpau</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actcmpad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 528 cycles (264 up and down) = 4 loops per video line (2112 cycles)</span>
    pwm<span class="token punctuation">.</span>_2_load<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">263</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_cmpa<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">compa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">pwm4en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们访问的<code>PWM0</code>外设完全相同的方式，因为我们访问的<code>SYST</code>外围较早，但我们叫<code>tm4c123x::Peripherals::take()</code>。由于这个 crate 是使用<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>自动生成的，我们寄存器字段的访问函数采用闭包，而不是数字参数。虽然这看起来像很多代码，但 Rust 编译器可以使用它为我们执行一堆检查，然后生成非常接近手写汇编器的机器代码！自动生成的代码无法确定特定访问器函数的所有可能参数都有效（例如，如果 SVD 将寄存器定义为 32 位，但没有说明这些 32 位值中的某些值是否有效）有特殊意义），则该函数被标记为<code>unsafe</code>. 在使用该函数设置<code>load</code>和<code>compa</code>子字段时，我们可以在上面的示例中看到这一点<code>bits()</code>。</p>
<h4 id="读"><a href="#读" class="headerlink" title="读"></a>读</h4><p>该<code>read()</code>函数返回一个对象，该对象提供对该寄存器中各个子字段的只读访问，如该芯片制造商的 SVD 文件所定义。您可以<code>R</code>在<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.R.html" target="_blank" rel="noopener">tm4c123x 文档中</a>找到此特定寄存器的特殊返回类型、此特定外设、此特定芯片上的所有可用函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">if</span> pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Do a thing</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="写"><a href="#写" class="headerlink" title="写"></a>写</h4><p>该<code>write()</code>函数采用带有单个参数的闭包。通常我们称之为<code>w</code>. 然后，此参数提供对该寄存器内的各种子字段的读写访问，如该芯片制造商的 SVD 文件所定义的那样。同样，您可以在<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.W.html" target="_blank" rel="noopener">tm4c123x 文档中</a>找到此特定寄存器、此特定外设、此特定芯片上的“w”上可用的所有功能。请注意，我们未设置的所有子字段将为我们设置为默认值 - 寄存器中的任何现有内容都将丢失。</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><p>如果我们只想改变这个寄存器中的一个特定子字段而其他子字段保持不变，我们可以使用该<code>modify</code>函数。这个函数接受一个带有两个参数的闭包——一个用于读取，一个用于写入。通常我们分别称它们为<code>r</code>和<code>w</code>。该<code>r</code>参数可以用来检查所述寄存器的当前内容，并且<code>w</code>参数可以用来修改寄存器的内容。</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该<code>modify</code>函数在这里真正展示了闭包的威力。在 C 中，我们必须读入一些临时值，修改正确的位，然后将值写回。这意味着存在相当大的错误范围：</p>
<pre class="line-numbers language-C"><code class="language-C">uint32_t temp = pwm0.ctl.read();
temp |= PWM0_CTL_GLOBALSYNC0;
pwm0.ctl.write(temp);
uint32_t temp2 = pwm0.enable.read();
temp2 |= PWM0_ENABLE_PWM4EN;
pwm0.enable.write(temp); // Uh oh! Wrong variable!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用-HAL-板条箱"><a href="#使用-HAL-板条箱" class="headerlink" title="使用 HAL 板条箱"></a>使用 HAL 板条箱</h3><p>芯片的 HAL crate 通常通过为 PAC 公开的原始结构实现自定义 Trait 来工作。通常，此特征会定义一个函数，调用<code>constrain()</code>单个外设或<code>split()</code>具有多个引脚的 GPIO 端口之类的东西。此函数将消耗底层原始外围结构并返回具有更高级别 API 的新对象。这个 API 也可以做一些事情，比如让串口<code>new</code>功能需要借用一些<code>Clock</code>结构，只能通过调用配置 PLL 和设置所有时钟频率的函数来生成。通过这种方式，静态地不可能在没有首先配置时钟速率的情况下创建串行端口对象，或者串行端口对象将波特率错误地转换为时钟滴答。一些 crate 甚至为每个 GPIO 引脚可以处于的状态定义特殊特征，要求用户在将引脚传递到外设之前将引脚置于正确的状态（例如，通过选择适当的备用功能模式）。一切都没有运行时成本！</p>
<p>让我们看一个例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal <span class="token keyword">as</span> hal<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>NewlineMode<span class="token punctuation">,</span> Serial<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>sysctl<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>CorePeripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the SYSCTL struct into an object with a higher-layer API</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sc <span class="token operator">=</span> p<span class="token punctuation">.</span>SYSCTL<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Pick our oscillation settings</span>
    sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span>oscillator <span class="token operator">=</span> sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>Oscillator<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Main</span><span class="token punctuation">(</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>CrystalFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_16mhz<span class="token punctuation">,</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>SystemClock<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UsePll</span><span class="token punctuation">(</span>sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>PllOutputFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_80_00mhz<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Configure the PLL with those settings</span>
    <span class="token keyword">let</span> clocks <span class="token operator">=</span> sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the GPIO_PORTA struct into an object with a higher-layer API.</span>
    <span class="token comment" spellcheck="true">// Note it needs to borrow `sc.power_control` so it can power up the GPIO</span>
    <span class="token comment" spellcheck="true">// peripheral automatically.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> porta <span class="token operator">=</span> p<span class="token punctuation">.</span>GPIO_PORTA<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Activate the UART.</span>
    <span class="token keyword">let</span> uart <span class="token operator">=</span> Serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">uart0</span><span class="token punctuation">(</span>
        p<span class="token punctuation">.</span>UART0<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The transmit pin</span>
        porta
            <span class="token punctuation">.</span>pa1
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The receive pin</span>
        porta
            <span class="token punctuation">.</span>pa0
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// No RTS or CTS required</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The baud rate</span>
        <span class="token number">115200_u32</span><span class="token punctuation">.</span><span class="token function">bps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// Output handling</span>
        NewlineMode<span class="token punctuation">:</span><span class="token punctuation">:</span>SwapLFtoCRLF<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need the clock rates to calculate the baud rate divisors</span>
        <span class="token operator">&amp;</span>clocks<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need this to power up the UART peripheral</span>
        <span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>uart<span class="token punctuation">,</span> <span class="token string">"Hello, World!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Semihosting（半主机）"><a href="#Semihosting（半主机）" class="headerlink" title="Semihosting（半主机）"></a>Semihosting（半主机）</h2><p>半主机是一种让嵌入式设备在主机上进行 I/O 的机制，主要用于将消息记录到主机控制台。半主机需要一个调试会话，几乎不需要其他任何东西（没有额外的电线！）所以它使用起来非常方便。缺点是它非常慢：根据您使用的硬件调试器（例如 ST-Link），每个写入操作可能需要几毫秒。</p>
<p>该<a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>箱提供了一个API做的Cortex-M的设备半主机操作。下面的程序是“Hello, world!”的半主机版本：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hprintln<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你在硬件上运行这个程序，你会看到“Hello, world!” OpenOCD 日志中的消息。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Hello, world!
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>您确实需要先从 GDB 在 OpenOCD 中启用半主机：</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>QEMU 理解半主机操作，因此上述程序也可以运行而 <code>qemu-system-arm</code>无需启动调试会话。请注意，您需要将<code>-semihosting-config</code>标志传递给 QEMU 以启用半主机支持；这些标志已经包含在<code>.cargo/config.toml</code>模板文件中。</p>
<pre class="line-numbers language-text"><code class="language-text">$ # this program will block the terminal
$ cargo run
     Running `qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有一个<code>exit</code>半主机操作可用于终止 QEMU 进程。重要提示：千万<strong>不能</strong>使用<code>debug::exit</code>硬件; 此功能可能会损坏您的 OpenOCD 会话，并且在您重新启动它之前您将无法调试更多程序。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> roses <span class="token operator">==</span> <span class="token string">"red"</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一个提示：您可以将恐慌行为设置为<code>exit(EXIT_FAILURE)</code>. 这将让您编写<code>no_std</code>可以在 QEMU 上运行的运行通过测试。</p>
<p>为方便起见，<code>panic-semihosting</code>板条箱具有“退出”功能，启用<code>exit(EXIT_FAILURE)</code>后会在将紧急消息记录到主机 stderr 后调用。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// features = ["exit"]</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>roses<span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
panicked at 'assertion failed<span class="token punctuation">:</span> `<span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span>`
  left<span class="token punctuation">:</span> `<span class="token string">"blue"</span>`<span class="token punctuation">,</span>
 right<span class="token punctuation">:</span> `<span class="token string">"red"</span>`'<span class="token punctuation">,</span> examples<span class="token operator">/</span>hello<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">5</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意</strong>：要在 上启用此功能<code>panic-semihosting</code>，请编辑您的 <code>Cargo.toml</code>依赖项部分，其中<code>panic-semihosting</code>指定为：</p>
<pre class="line-numbers language-toml"><code class="language-toml">panic-semihosting = { version = "VERSION", features = ["exit"] }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>VERSION</code>想要的版本在哪里。有关依赖项功能的更多信息，请查看<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html" target="_blank" rel="noopener"><code>specifying dependencies</code></a>Cargo 书的部分。</p>
<h2 id="Panicking（恐慌）"><a href="#Panicking（恐慌）" class="headerlink" title="Panicking（恐慌）"></a>Panicking（恐慌）</h2><p>恐慌是 Rust 语言的核心部分。索引等内置操作会在运行时检查内存安全。当尝试越界索引时，这会导致恐慌。</p>
<p>在标准库中，恐慌有一个定义的行为：它展开恐慌线程的堆栈，除非用户选择在恐慌时中止程序。</p>
<p>然而，在没有标准库的程序中，恐慌行为是未定义的。可以通过声明<code>#[panic_handler]</code>函数来选择行为。该函数必须在程序的依赖图中只出现<em>一次</em>，并且必须具有以下签名：<code>fn(&amp;PanicInfo) -&gt; !</code>，其中<a href="https://doc.rust-lang.org/core/panic/struct.PanicInfo.html" target="_blank" rel="noopener"><code>PanicInfo</code></a> 是一个包含有关恐慌位置信息的结构。</p>
<p>鉴于嵌入式系统的范围从面向用户到安全关键（不能崩溃），没有一种适合所有恐慌行为的尺寸，但有很多常用行为。这些常见的行为已经被打包到定义<code>#[panic_handler]</code>函数的crate 中。一些例子包括：</p>
<ul>
<li><a href="https://crates.io/crates/panic-abort" target="_blank" rel="noopener"><code>panic-abort</code></a>. 恐慌导致中止指令被执行。</li>
<li><a href="https://crates.io/crates/panic-halt" target="_blank" rel="noopener"><code>panic-halt</code></a>. 恐慌导致程序或当前线程通过进入无限循环而停止。</li>
<li><a href="https://crates.io/crates/panic-itm" target="_blank" rel="noopener"><code>panic-itm</code></a>. 使用 ITM（一种 ARM Cortex-M 特定外设）记录紧急消息。</li>
<li><a href="https://crates.io/crates/panic-semihosting" target="_blank" rel="noopener"><code>panic-semihosting</code></a>. 使用半主机技术将恐慌消息记录到主机。</li>
</ul>
<p>您可以<a href="https://crates.io/keywords/panic-handler" target="_blank" rel="noopener"><code>panic-handler</code></a> 在 crates.io 上找到更多搜索关键字的 crate。</p>
<p>程序可以通过链接到相应的 crate 来选择这些行为之一。在应用程序的源代码中将恐慌行为表示为一行代码这一事实不仅可用作文档，而且还可用于根据编译配置文件更改恐慌行为。例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// dev profile: easier to debug panics; can put a breakpoint on `rust_begin_unwind`</span>
<span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// release profile: minimize the binary size of the application</span>
<span class="token attribute attr-name">#[cfg(not(debug_assertions))]</span>
<span class="token keyword">use</span> panic_abort <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此示例中，<code>panic-halt</code>使用 dev 配置文件 ( <code>cargo build</code>)构建时crate 链接到crate ，但<code>panic-abort</code>使用 release 配置文件 ( <code>cargo build --release</code>)构建时链接到crate 。</p>
<blockquote>
<p>语句的<code>use panic_abort as _;</code>形式<code>use</code>用于确保<code>panic_abort</code>恐慌处理程序包含在我们的最终可执行文件中，同时向编译器明确我们不会显式使用 crate 中的任何内容。如果没有<code>as _</code>重命名，编译器会警告我们有一个未使用的导入。有时候，你可能会看到<code>extern crate panic_abort</code>，而不是，这是2018年版的锈之前使用的旧风格，现在应该仅用于“SYSROOT”箱子（那些散发着铁锈本身），例如<code>proc_macro</code>，<code>alloc</code>，<code>std</code>，和<code>test</code>。</p>
</blockquote>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>这是一个尝试对超出其长度的数组进行索引的示例。操作导致恐慌。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> xs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// out of bounds access</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此示例选择了<code>panic-semihosting</code>使用半主机将紧急消息打印到主机控制台的行为。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo run
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb (..)
panicked at 'index out of bounds: the len is 3 but the index is 4', src/main.rs:12:13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>您可以尝试将行为更改为<code>panic-halt</code>并确认在这种情况下不会打印任何消息。</p>
<h2 id="Exceptions（异常）"><a href="#Exceptions（异常）" class="headerlink" title="Exceptions（异常）"></a>Exceptions（异常）</h2><p>异常和中断是处理器处理异步事件和致命错误（例如执行无效指令）的硬件机制。异常意味着抢占并涉及异常处理程序、响应触发事件的信号而执行的子程序。</p>
<p>该<code>cortex-m-rt</code>箱提供了一个<a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.exception.html" target="_blank" rel="noopener"><code>exception</code></a>声明异常处理程序属性。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Exception handler for the SysTick (System Timer) exception</span>
<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了<code>exception</code>属性异常处理程序看起来像普通函数之外，还有一个区别：<code>exception</code>处理程序<em>不能</em>被软件调用。按照前面的示例，该语句<code>SysTick();</code> 将导致编译错误。</p>
<p>这种行为几乎是有意为之，它需要提供一个特性： <em>在</em>处理程序中<code>static mut</code>声明的变量可以<em>安全</em>使用。 <code>exception</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has transformed to type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可能知道，<code>static mut</code>在函数中使用变量会使其 <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)" target="_blank" rel="noopener"><em>不可重入</em></a>。从多个异常/中断处理程序或从<code>main</code>一个或多个异常/中断处理程序直接或间接调用不可重入函数是未定义的行为 。</p>
<p>安全 Rust 绝不能导致未定义的行为，因此不可重入函数必须标记为<code>unsafe</code>. 然而我只是告诉<code>exception</code>处理程序可以安全地使用<code>static mut</code>变量。这怎么可能？这是可能的，因为 <code>exception</code>处理程序<em>不能</em>被软件调用，因此重入是不可能的。</p>
<blockquote>
<p>请注意，该<code>exception</code>属性通过将静态变量包装到<code>unsafe</code>块中并为我们提供新的适当类型<code>&amp;mut</code>的同名变量来转换函数内静态变量的定义。因此，我们可以通过<code>*</code>访问变量的值来取消引用引用，而无需将它们包装在一个<code>unsafe</code>块中。</p>
</blockquote>
<h3 id="一个完整的例子"><a href="#一个完整的例子" class="headerlink" title="一个完整的例子"></a>一个完整的例子</h3><p>这是一个使用系统计时器<code>SysTick</code>大约每秒引发一次异常的示例。在<code>SysTick</code>异常处理程序跟踪它已经多少次被称为在<code>COUNT</code>变量，然后打印出的值 <code>COUNT</code>使用半主机主机控制台。</p>
<blockquote>
<p><strong>注意</strong>：您可以在任何 Cortex-M 设备上运行此示例；你也可以在 QEMU 上运行它</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    debug<span class="token punctuation">,</span>
    hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> HStdout<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> syst <span class="token operator">=</span> p<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configures the system timer to trigger a SysTick exception every second</span>
    syst<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// this is configured for the LM3S6965 which has a default CPU clock of 12 MHz</span>
    syst<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">12_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> STDOUT<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>HStdout<span class="token operator">></span> <span class="token operator">=</span> None<span class="token punctuation">;</span>

    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Lazy initialization</span>
    <span class="token keyword">if</span> STDOUT<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>STDOUT <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> STDOUT<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// IMPORTANT omit this `if` block if running on real hardware or your</span>
    <span class="token comment" spellcheck="true">// debugger will end in an inconsistent state</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>COUNT <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This will terminate the QEMU process</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
tail <span class="token operator">-</span>n5 Cargo<span class="token punctuation">.</span>toml
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
cortex<span class="token operator">-</span>m <span class="token operator">=</span> <span class="token string">"0.5.7"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">"0.6.3"</span>
panic<span class="token operator">-</span>halt <span class="token operator">=</span> <span class="token string">"0.2.0"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>semihosting <span class="token operator">=</span> <span class="token string">"0.3.1"</span>
$ cargo run <span class="token operator">-</span><span class="token operator">-</span>release
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span>arm <span class="token operator">-</span>cpu cortex<span class="token operator">-</span>m3 <span class="token operator">-</span>machine <span class="token function">lm3s6965evb</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
<span class="token number">123456789</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您在 Discovery 板上运行它，您将在 OpenOCD 控制台上看到输出。此外，当计数达到 9 时，程序<em>不会</em>停止。</p>
<h3 id="默认异常处理程序"><a href="#默认异常处理程序" class="headerlink" title="默认异常处理程序"></a>默认异常处理程序</h3><p>该<code>exception</code>属性的实际作用是<em>覆盖</em>特定异常的默认异常处理程序。如果您不覆盖特定异常的处理程序，它将由<code>DefaultHandler</code>函数处理，该函数默认为：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此函数由<code>cortex-m-rt</code>crate提供并标记为， <code>#[no_mangle]</code>以便您可以在“DefaultHandler”上放置断点并捕获 <em>未处理的</em>异常。</p>
<p>可以<code>DefaultHandler</code>使用<code>exception</code>属性覆盖它：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span>irqn<span class="token punctuation">:</span> i16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// custom default handler</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>irqn</code>参数指示正在处理哪个异常。负值表示正在处理 Cortex-M 异常；零或正值表示正在处理设备特定异常（AKA 中断）。</p>
<h3 id="硬故障处理程序"><a href="#硬故障处理程序" class="headerlink" title="硬故障处理程序"></a>硬故障处理程序</h3><p>在<code>HardFault</code>例外的情况比较特殊。当程序进入无效状态时会触发此异常，因此其处理程序<em>无法</em>返回，因为这可能导致未定义的行为。此外，运行时 crate 在<code>HardFault</code>调用用户定义的处理程序之前会做一些工作，以提高可调试性。</p>
<p>结果是<code>HardFault</code>处理程序必须具有以下签名： <code>fn(&amp;ExceptionFrame) -&gt; !</code>. 处理程序的参数是一个指向由异常压入堆栈的寄存器的指针。这些寄存器是触发异常时处理器状态的快照，可用于诊断硬故障。</p>
<p>这是一个执行非法操作的示例：读取不存在的内存位置。</p>
<blockquote>
<p><strong>注意</strong>：这个程序在 QEMU<code>qemu-system-arm -machine lm3s6965evb</code>上无法运行，即它不会崩溃，因为 它不检查内存负载，并且会很高兴地<code>0</code>在读取无效内存时返回。</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> ExceptionFrame<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hio<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// read a nonexistent memory location</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x3FFF_FFFE</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>ef<span class="token punctuation">:</span> <span class="token operator">&amp;</span>ExceptionFrame<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">mut</span> hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#?}"</span><span class="token punctuation">,</span> ef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>HardFault</code>处理器打印<code>ExceptionFrame</code>值。如果您运行它，您将在 OpenOCD 控制台上看到类似的内容。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
ExceptionFrame {
    r0: 0x3ffffffe,
    r1: 0x00f00000,
    r2: 0x20000000,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x080008f7,
    pc: 0x0800094a,
    xpsr: 0x61000000
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>pc</code>值是异常发生时程序计数器的值，它指向触发异常的指令。</p>
<p>如果你看一下程序的反汇编：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
(..)
ResetTrampoline:
 8000942:       movw    r0, #0xfffe
 8000946:       movt    r0, #0x3fff
 800094a:       ldr     r0, [r0]
 800094c:       b       #-0x4 <ResetTrampoline+0xa><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可以在反<code>0x0800094a</code>汇编中查找程序计数器的值。您将看到加载操作 ( <code>ldr r0, [r0]</code>) 导致了异常。本<code>r0</code>场<code>ExceptionFrame</code>会告诉你寄存器的值<code>r0</code> 是<code>0x3fff_fffe</code>在那个时候。</p>
<h2 id="Interrupts（中断）"><a href="#Interrupts（中断）" class="headerlink" title="Interrupts（中断）"></a>Interrupts（中断）</h2><p>中断在很多方面与异常不同，但它们的操作和使用大体相似，并且它们也由相同的中断控制器处理。尽管异常由 Cortex-M 架构定义，但中断始终是供应商（通常甚至是芯片）在命名和功能方面的特定实现。</p>
<p>中断确实提供了很大的灵活性，在尝试以高级方式使用它们时需要考虑到这一点。我们不会在本书中介绍这些用途，但记住以下几点是个好主意：</p>
<ul>
<li>中断具有可编程的优先级，这些优先级决定了它们的处理程序的执行顺序</li>
<li>中断可以嵌套和抢占，即中断处理程序的执行可能会被另一个更高优先级的中断中断</li>
<li>一般需要清除导致中断触发的原因，防止无休止地重新进入中断处理程序</li>
</ul>
<p>运行时的一般初始化步骤始终相同：</p>
<ul>
<li>设置外设以在所需场合生成中断请求</li>
<li>在中断控制器中设置中断处理程序所需的优先级</li>
<li>在中断控制器中启用中断处理程序</li>
</ul>
<p>与异常类似，<code>cortex-m-rt</code>crate 提供了一个<a href="https://docs.rs/cortex-m-rt-macros/0.1.5/cortex_m_rt_macros/attr.interrupt.html" target="_blank" rel="noopener"><code>interrupt</code></a> 属性来声明中断处理程序。可用的中断（以及它们在中断处理程序表中的位置）通常是通过<code>svd2rust</code>SVD 描述自动生成的。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Interrupt handler for the Timer2 interrupt</span>
<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
    <span class="token comment" spellcheck="true">// Clear reason for the generated interrupt request</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>中断处理程序看起来像普通函数（除了缺少参数）类似于异常处理程序。然而，由于特殊的调用约定，它们不能被固件的其他部分直接调用。然而，可以在软件中生成中断请求以触发对中断处理程序的转移。</p>
<p>与异常处理程序类似，也可以<code>static mut</code> 在中断处理程序中声明变量以保持<em>安全</em>状态。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p><strong>TODO</strong> Cover memory mapped I/O using registers.</p>
<h1 id="Peripherals（外设）"><a href="#Peripherals（外设）" class="headerlink" title="Peripherals（外设）"></a>Peripherals（外设）</h1><h3 id="什么是外设？"><a href="#什么是外设？" class="headerlink" title="什么是外设？"></a>什么是外设？</h3><p>大多数微控制器不仅仅是一个 CPU、RAM 或闪存——它们包含硅片部分，用于与微控制器之外的系统进行交互，以及通过传感器、电机控制器直接或间接地与周围环境进行交互，或人机界面，如显示器或键盘。这些组件统称为外围设备。</p>
<p>这些外设很有用，因为它们允许开发人员将处理工作卸载给它们，从而避免必须在软件中处理所有事情。类似于桌面开发人员将图形处理卸载到视频卡的方式，嵌入式开发人员可以将一些任务卸载到外围设备，从而让 CPU 将时间花在做其他重要的事情上，或者什么都不做以节省电量。</p>
<p>如果您查看 1970 年代或 1980 年代的老式家用计算机的主电路板（实际上，昨天的台式 PC 与今天的嵌入式系统相距甚远），您会期望看到：</p>
<ul>
<li>处理器</li>
<li>一个内存芯片</li>
<li>一个ROM芯片</li>
<li>一个 I/O 控制器</li>
</ul>
<p>RAM 芯片、ROM 芯片和 I/O 控制器（该系统中的外围设备）将通过一系列称为“总线”的并行迹线连接到处理器。该总线承载地址信息，它选择处理器希望与总线上的哪个设备进行通信，以及承载实际数据的数据总线。在我们的嵌入式微控制器中，同样的原则适用 - 只是所有东西都封装在一块硅上。</p>
<p>但是，与通常具有 Vulkan、Metal 或 OpenGL 等软件 API 的图形卡不同，外围设备通过硬件接口暴露给我们的微控制器，该接口映射到一块内存。</p>
<h3 id="线性和实内存空间"><a href="#线性和实内存空间" class="headerlink" title="线性和实内存空间"></a>线性和实内存空间</h3><p>在微控制器上，将一些数据写入其他任意地址（例如<code>0x4000_0000</code>或<code>0x0000_0000</code>）也可能是完全有效的操作。</p>
<p>在桌面系统上，对内存的访问由 MMU 或内存管理单元严格控制。该组件有两个主要职责：强制执行对内存部分的访问权限（防止一个进程读取或修改另一个进程的内存）；并将物理内存的段重新映射到软件中使用的虚拟内存范围。微控制器通常没有 MMU，而是仅在软件中使用真实的物理地址。</p>
<p>尽管 32 位微控制器具有来自<code>0x0000_0000</code>, 和的真实线性地址空间<code>0xFFFF_FFFF</code>，但它们通常只使用该范围的几百 KB 用于实际内存。这留下了大量的地址空间。在前面的章节中，我们讨论了 RAM 位于 address <code>0x2000_0000</code>。如果我们的RAM为64昆明植物研究所长（即0xFFFF的最大地址），然后地址<code>0x2000_0000</code>，以<code>0x2000_FFFF</code>将对应于我们的RAM。当我们写入一个位于 address 的变量<code>0x2000_1234</code>时，内部发生的事情是一些逻辑检测地址的高位部分（在本例中为 0x2000），然后激活 RAM 以便它可以对地址的低位部分（0x1234在这种情况下）。在 Cortex-M 上，我们也将闪存 ROM 映射到地址<code>0x0000_0000</code>直到地址<code>0x0007_FFFF</code>（如果我们有 512 KiB 闪存 ROM）。微控制器设计者并没有忽略这两个区域之间的所有剩余空间，而是将外围设备的接口映射到某些存储器位置。这最终看起来像这样：</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-memory-map.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 数据表 (pdf)</a></p>
<h3 id="内存映射外设"><a href="#内存映射外设" class="headerlink" title="内存映射外设"></a>内存映射外设</h3><p>乍一看，与这些外设的交互很简单——将正确的数据写入正确的地址。例如，通过串行端口发送 32 位字可能与将该 32 位字写入某个内存地址一样直接。然后串行端口外围设备将接管并自动发送数据。</p>
<p>这些外设的配置工作类似。不是调用函数来配置外设，而是公开了一块内存，用作硬件 API。写入<code>0x8000_0000</code>SPI 频率配置寄存器，SPI 端口将以每秒 8 兆位的速度发送数据。写入<code>0x0200_0000</code>相同的地址，SPI 端口将以每秒 125 千位的速度发送数据。这些配置寄存器看起来有点像这样：</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-spi-frequency-register.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 数据表 (pdf)</a></p>
<p>无论使用何种语言，无论该语言是汇编、C 还是 Rust，此接口都是与硬件进行交互的方式。</p>
<h2 id="A-First-Attempt"><a href="#A-First-Attempt" class="headerlink" title="A First Attempt"></a>A First Attempt</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>让我们看看“SysTick”外设 - 每个 Cortex-M 处理器内核都附带一个简单的计时器。通常，您会在芯片制造商的数据表或<em>技术参考手册中</em>查找这些内容，但此示例适用于所有 ARM Cortex-M 内核，让我们查看<a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0553a/Babieigh.html" target="_blank" rel="noopener">ARM 参考手册</a>。我们看到有四个寄存器：</p>
<table>
<thead>
<tr>
<th>抵消</th>
<th>姓名</th>
<th>描述</th>
<th>宽度</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>SYST_CSR</td>
<td>控制和状态寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x04</td>
<td>SYST_RVR</td>
<td>重载值寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x08</td>
<td>SYST_CVR</td>
<td>当前值寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x0C</td>
<td>SYST_CALIB</td>
<td>校准值寄存器</td>
<td>32位</td>
</tr>
</tbody></table>
<h3 id="C-方法"><a href="#C-方法" class="headerlink" title="C 方法"></a>C 方法</h3><p>在 Rust 中，我们可以用与在 C 中完全相同的方式来表示一组寄存器 - 使用<code>struct</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>限定符<code>#[repr(C)]</code>告诉 Rust 编译器像 C 编译器那样布置这个结构。这非常重要，因为 Rust 允许重新排序结构字段，而 C 则不允许。您可以想象如果这些字段被编译器默默地重新排列，我们将不得不进行调试！有了这个限定符，我们就有了与上表相对应的四个 32 位字段。但是当然，这<code>struct</code>本身是没有用的——我们需要一个变量。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token operator">*</span>systick<span class="token punctuation">)</span><span class="token punctuation">.</span>cvr <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Volatile-Accesses"><a href="#Volatile-Accesses" class="headerlink" title="Volatile Accesses"></a>Volatile Accesses</h3><p>现在，上述方法存在一些问题。</p>
<ol>
<li>每次我们想访问我们的外设时，我们都必须使用 unsafe。</li>
<li>我们无法指定哪些寄存器是只读的或读写的。</li>
<li>程序中任何位置的任何代码都可以通过此结构访问硬件。</li>
<li>最重要的是，它实际上不起作用……</li>
</ol>
<p>现在，问题是编译器很聪明。如果您对同一块 RAM 进行两次写入，一个接一个，编译器会注意到这一点，并且完全跳过第一次写入。在 C 中，我们可以将变量标记为<code>volatile</code>确保每次读取或写入都按预期进行。在 Rust 中，我们将<em>访问</em>标记为 volatile，而不是变量。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> systick<span class="token punctuation">.</span>cvr<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以，我们已经解决了四个问题之一，但现在我们有更多的<code>unsafe</code>代码！幸运的是，有一个第三方板条箱可以提供帮助 - <a href="https://crates.io/crates/volatile_register" target="_blank" rel="noopener"><code>volatile_register</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
    <span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，易失性访问是通过<code>read</code>和<code>write</code>方法自动执行的。它仍然<code>unsafe</code>是执行写入，但公平地说，硬件是一堆可变状态，编译器无法知道这些写入是否真正安全，因此这是一个很好的默认位置。</p>
<h3 id="The-Rusty-Wrapper"><a href="#The-Rusty-Wrapper" class="headerlink" title="The Rusty Wrapper"></a>The Rusty Wrapper</h3><p>我们需要将其封装<code>struct</code>到一个更高层的 API 中，以便我们的用户可以安全地调用。作为驱动程序作者，我们手动验证不安全代码是否正确，然后为我们的用户提供一个安全的 API，这样他们就不必担心（前提是他们相信我们会做对！）。</p>
<p>一个例子可能是：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> SystemTimer <span class="token punctuation">{</span>
    p<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> RegisterBlock
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> RegisterBlock <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> SystemTimer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SystemTimer <span class="token punctuation">{</span>
        SystemTimer <span class="token punctuation">{</span>
            p<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> RegisterBlock<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> reload_value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>rvr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reload_value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">example_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">0x00FF_FFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"Time is now 0x{:08x}"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，这种方法的问题是编译器完全可以接受以下代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们<code>&amp;mut self</code>对该<code>set_reload</code>函数的参数检查是否没有<em>对该</em>特定<code>SystemTimer</code>结构的其他引用，但它们不会阻止用户创建第二个<code>SystemTimer</code>指向完全相同的外围设备！如果作者足够勤奋地发现所有这些“重复”的驱动程序实例，以这种方式编写的代码将起作用，但是一旦代码分布在多个模块、驱动程序、开发人员和数天中，编写这些代码会变得越来越容易各种错误。</p>
<h2 id="The-Borrow-Checker"><a href="#The-Borrow-Checker" class="headerlink" title="The Borrow Checker"></a>The Borrow Checker</h2><h3 id="可变全局状态"><a href="#可变全局状态" class="headerlink" title="可变全局状态"></a>可变全局状态</h3><p>不幸的是，硬件基本上只是可变的全局状态，这对于 Rust 开发人员来说可能会感到非常可怕。硬件独立于我们编写的代码结构而存在，并且可以随时被现实世界修改。</p>
<h3 id="我们的规则应该是什么？"><a href="#我们的规则应该是什么？" class="headerlink" title="我们的规则应该是什么？"></a>我们的规则应该是什么？</h3><p>我们如何才能可靠地与这些外围设备交互？</p>
<ol>
<li>始终使用<code>volatile</code>读取或写入外围存储器的方法，因为它可以随时更改</li>
<li>在软件中，我们应该能够共享对这些外设的任意数量的只读访问</li>
<li>如果某些软件应该具有对外围设备的读写访问权限，则它应该持有对该外围设备的唯一引用</li>
</ol>
<h3 id="借用检查器"><a href="#借用检查器" class="headerlink" title="借用检查器"></a>借用检查器</h3><p>这些规则中的最后两条听起来与 Borrow Checker 已经做的很相似！</p>
<p>想象一下，我们是否可以传递这些外围设备的所有权，或者为它们提供不可变或可变的引用？</p>
<p>嗯，我们可以，但是对于 Borrow Checker，我们需要每个外设正好有一个实例，这样 Rust 才能正确处理这个问题。好吧，幸运的是在硬件中，任何给定的外围设备只有一个实例，但是我们如何在代码结构中公开它？</p>
<h2 id="Singletons"><a href="#Singletons" class="headerlink" title="Singletons"></a>Singletons</h2><blockquote>
<p>在软件工程中，单例模式是一种软件设计模式，它将类的实例化限制为一个对象。</p>
<p><em>维基百科：<a href="https://en.wikipedia.org/wiki/Singleton_pattern" target="_blank" rel="noopener">单例模式</a></em></p>
</blockquote>
<h3 id="但是为什么我们不能只使用全局变量呢？"><a href="#但是为什么我们不能只使用全局变量呢？" class="headerlink" title="但是为什么我们不能只使用全局变量呢？"></a>但是为什么我们不能只使用全局变量呢？</h3><p>我们可以让一切都变成公共静态，就像这样</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> THE_SERIAL_PORT<span class="token punctuation">:</span> SerialPort <span class="token operator">=</span> SerialPort<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        THE_SERIAL_PORT<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但这有几个问题。它是一个可变的全局变量，在 Rust 中，与这些变量交互总是不安全的。这些变量在整个程序中也是可见的，这意味着借用检查器无法帮助您跟踪这些变量的引用和所有权。</p>
<h3 id="我们如何在-Rust-中做到这一点？"><a href="#我们如何在-Rust-中做到这一点？" class="headerlink" title="我们如何在 Rust 中做到这一点？"></a>我们如何在 Rust 中做到这一点？</h3><p>我们不只是让我们的外设成为一个全局变量，而是决定创建一个全局变量，在这种情况下称为<code>PERIPHERALS</code>，它包含<code>Option&lt;T&gt;</code>我们每个外设的 。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>SerialPort<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Peripherals <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SerialPort <span class="token punctuation">{</span>
        <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> PERIPHERALS<span class="token punctuation">:</span> Peripherals <span class="token operator">=</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>SerialPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种结构使我们能够获得外围设备的单个实例。如果我们尝试<code>take_serial()</code>多次调用，我们的代码就会崩溃！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// This panics!</span>
    <span class="token comment" spellcheck="true">// let serial_2 = unsafe { PERIPHERALS.take_serial() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>尽管与这个结构交互是<code>unsafe</code>，但是一旦我们包含了<code>SerialPort</code>它，我们就不再需要使用<code>unsafe</code>，或者根本不需要使用该<code>PERIPHERALS</code>结构。</p>
<p>这有一个小的运行时开销，因为我们必须将<code>SerialPort</code>结构包装在一个选项中，我们需要调用<code>take_serial()</code>一次，但是这个小的前期成本允许我们在我们程序的其余部分中利用借用检查器。</p>
<h3 id="现有库支持"><a href="#现有库支持" class="headerlink" title="现有库支持"></a>现有库支持</h3><p>尽管我们在<code>Peripherals</code>上面创建了自己的结构，但没有必要为您的代码执行此操作。在<code>cortex_m</code>箱子中含有一种叫宏<code>singleton!()</code>，会为你执行此操作。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_use(singleton)]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// OK if `main` is executed only once</span>
    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> bool <span class="token operator">=</span>
        <span class="token function">singleton!</span><span class="token punctuation">(</span><span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://docs.rs/cortex-m/latest/cortex_m/macro.singleton.html" target="_blank" rel="noopener">cortex_m 文档</a></p>
<p>此外，如果您使用<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener"><code>cortex-m-rtic</code></a>，则定义和获取这些外设的整个过程都会为您抽象化，您将获得一个<code>Peripherals</code>结构，其中包含<code>Option&lt;T&gt;</code>您定义的所有项目的非版本。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// cortex-m-rtic v0.5.x</span>
#<span class="token punctuation">[</span>rtic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">app</span><span class="token punctuation">(</span>device <span class="token operator">=</span> lm3s6965<span class="token punctuation">,</span> peripherals <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> APP<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[init]</span>
    <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>cx<span class="token punctuation">:</span> init<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">mut</span> X<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Cortex-M peripherals</span>
        <span class="token keyword">let</span> core<span class="token punctuation">:</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>core<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Device specific peripherals</span>
        <span class="token keyword">let</span> device<span class="token punctuation">:</span> lm3s6965<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="但为什么？"><a href="#但为什么？" class="headerlink" title="但为什么？"></a>但为什么？</h3><p>但是这些单例如何对我们的 Rust 代码的工作方式产生显着的影响？</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SER_PORT_SPEED_REG<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32 <span class="token operator">=</span> <span class="token number">0x4000_1000</span> <span class="token keyword">as</span> _<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">read_speed</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token comment" spellcheck="true">// &lt;------ This is really, really important</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>SER_PORT_SPEED_REG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有两个重要因素在起作用：</p>
<ul>
<li>因为我们使用的是单例，所以只有一种方法或地方可以获取<code>SerialPort</code>结构</li>
<li>要调用该<code>read_speed()</code>方法，我们必须拥有所有权或对<code>SerialPort</code>结构的引用</li>
</ul>
<p>这两个因素放在一起意味着只有在我们适当满足借用检查器的情况下才能访问硬件，这意味着我们在任何时候都不会对同一硬件有多个可变引用！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// missing reference to `self`! Won't work.</span>
    <span class="token comment" spellcheck="true">// SerialPort::read_speed();</span>

    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// you can only read what you have access to</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> serial_1<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="像对待数据一样对待硬件"><a href="#像对待数据一样对待硬件" class="headerlink" title="像对待数据一样对待硬件"></a>像对待数据一样对待硬件</h3><p>此外，由于一些引用是可变的，而一些引用是不可变的，因此可以查看函数或方法是否有可能修改硬件的状态。例如，</p>
<p>允许更改硬件设置：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">setup_spi_port</span><span class="token punctuation">(</span>
    spi<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> SpiPort<span class="token punctuation">,</span>
    cs_pin<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> GpioPin
<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这不是：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read_button</span><span class="token punctuation">(</span>gpio<span class="token punctuation">:</span> <span class="token operator">&amp;</span>GpioPin<span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这允许我们强制代码是否应该或不应该在<strong>编译时而</strong>不是在运行时对硬件进行更改。请注意，这通常仅适用于一个应用程序，但对于裸机系统，我们的软件将被编译为单个应用程序，因此这通常不是限制。</p>
<h1 id="Static-Guarantees"><a href="#Static-Guarantees" class="headerlink" title="Static Guarantees"></a>Static Guarantees</h1><p>Rust 的类型系统在编译时防止数据竞争（请参阅<a href="https://doc.rust-lang.org/core/marker/trait.Send.html" target="_blank" rel="noopener"><code>Send</code></a>和 <a href="https://doc.rust-lang.org/core/marker/trait.Sync.html" target="_blank" rel="noopener"><code>Sync</code></a>特征）。类型系统还可用于在编译时检查其他属性；在某些情况下减少运行时检查的需要。</p>
<p>例如，当应用于嵌入式程序时，可以使用这些<em>静态检查</em>来强制正确完成 I/O 接口的配置。例如，可以设计一个 API，其中只能通过首先配置接口将使用的引脚来初始化串行接口。</p>
<p>还可以静态检查操作，例如将引脚设置为低电平，只能在正确配置的外设上执行。例如，尝试更改配置为浮动输入模式的引脚的输出状态会引发编译错误。</p>
<p>并且，如前一章所见，所有权的概念可以应用于外设，以确保只有程序的某些部分可以修改外设。与将外围设备视为全局可变状态的替代方案相比，这种<em>访问控制</em>使软件更容易推理。</p>
<h2 id="Typestate-Programming"><a href="#Typestate-Programming" class="headerlink" title="Typestate Programming"></a>Typestate Programming</h2><p><a href="https://en.wikipedia.org/wiki/Typestate_analysis" target="_blank" rel="noopener">typestates</a>的概念描述了将有关对象当前状态的信息编码为该对象的类型。虽然这听起来有点神秘，但如果您在 Rust 中使用过<a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html" target="_blank" rel="noopener">构建器模式</a>，那么您已经开始使用 Typestate Programming！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">mod</span> foo_module <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[derive(Debug)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
        inner<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">struct</span> FooBuilder <span class="token punctuation">{</span>
        a<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> FooBuilder <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>starter<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">double_a</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Foo <span class="token punctuation">{</span>
            Foo <span class="token punctuation">{</span>
                inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> foo_module<span class="token punctuation">:</span><span class="token punctuation">:</span>FooBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">double_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个例子中，没有直接的方法来创建一个<code>Foo</code>对象。我们必须创建一个<code>FooBuilder</code>，并正确初始化它，然后才能获得<code>Foo</code>我们想要的对象。</p>
<p>这个最小的例子编码了两个状态：</p>
<ul>
<li><code>FooBuilder</code>，表示“未配置”或“配置进行中”状态</li>
<li><code>Foo</code>，表示“已配置”或“准备使用”状态。</li>
</ul>
<h3 id="强类型"><a href="#强类型" class="headerlink" title="强类型"></a>强类型</h3><p>因为 Rust 有一个<a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing" target="_blank" rel="noopener">强类型系统</a>，没有简单的方法可以神奇地创建 的实例<code>Foo</code>，或者在不调用方法<code>FooBuilder</code>的<code>Foo</code>情况下将 a变成 a <code>into_foo()</code>。此外，调用该<code>into_foo()</code>方法会消耗原始<code>FooBuilder</code>结构，这意味着如果不创建新实例就无法重用它。</p>
<p>这允许我们将系统的状态表示为类型，并将状态转换的必要操作包含到将一种类型交换为另一种类型的方法中。通过创建一个<code>FooBuilder</code>并将其交换为一个<code>Foo</code>对象，我们已经完成了基本状态机的步骤。</p>
<h2 id="Peripherals-as-State-Machines"><a href="#Peripherals-as-State-Machines" class="headerlink" title="Peripherals as State Machines"></a>Peripherals as State Machines</h2><p>微控制器的外围设备可以被认为是一组状态机。例如，简化<a href="https://en.wikipedia.org/wiki/General-purpose_input/output" target="_blank" rel="noopener">GPIO 引脚</a>的配置可以表示为以下状态树：</p>
<ul>
<li>已禁用</li>
<li>启用<ul>
<li>配置为输出<ul>
<li>输出：高</li>
<li>输出：低</li>
</ul>
</li>
<li>配置为输入<ul>
<li>输入：高阻</li>
<li>输入：拉低</li>
<li>输入：拉高</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>如果外设在<code>Disabled</code>模式下启动，要移动到<code>Input: High Resistance</code>模式，我们必须执行以下步骤：</p>
<ol>
<li>已禁用</li>
<li>启用</li>
<li>配置为输入</li>
<li>输入：高阻</li>
</ol>
<p>如果我们想从 移动<code>Input: High Resistance</code>到<code>Input: Pulled Low</code>，我们必须执行以下步骤：</p>
<ol>
<li>输入：高阻</li>
<li>输入：拉低</li>
</ol>
<p>同样，如果我们要将 GPIO 引脚从配置为 移动<code>Input: Pulled Low</code>到<code>Output: High</code>，我们必须执行以下步骤：</p>
<ol>
<li>输入：拉低</li>
<li>配置为输入</li>
<li>配置为输出</li>
<li>输出：高</li>
</ol>
<h3 id="硬件表示"><a href="#硬件表示" class="headerlink" title="硬件表示"></a>硬件表示</h3><p>通常，上面列出的状态是通过将值写入映射到 GPIO 外设的给定寄存器来设置的。让我们定义一个虚构的 GPIO 配置寄存器来说明这一点：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>位数</th>
<th>价值</th>
<th>意义</th>
<th>笔记</th>
</tr>
</thead>
<tbody><tr>
<td>使能够</td>
<td>0</td>
<td>0</td>
<td>残疾</td>
<td>禁用 GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>启用</td>
<td>启用 GPIO</td>
</tr>
<tr>
<td>方向</td>
<td>1</td>
<td>0</td>
<td>输入</td>
<td>将方向设置为输入</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>输出</td>
<td>将方向设置为输出</td>
</tr>
<tr>
<td>输入模式</td>
<td>2..3</td>
<td>00</td>
<td>高阻抗</td>
<td>将输入设置为高电阻</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>下拉</td>
<td>输入引脚被拉低</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>拉高</td>
<td>输入引脚被拉高</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>不适用</td>
<td>无效状态。不要设置</td>
</tr>
<tr>
<td>输出模式</td>
<td>4</td>
<td>0</td>
<td>设置低</td>
<td>输出引脚被驱动为低电平</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>设置高</td>
<td>输出引脚被驱动为高电平</td>
</tr>
<tr>
<td>输入状态</td>
<td>5</td>
<td>X</td>
<td>有效值</td>
<td>0 如果输入 &lt; 1.5v，1 如果输入 &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>我们<em>可以</em>在 Rust 中暴露以下结构来控制这个 GPIO：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，这将允许我们修改某些没有意义的寄存器。例如，如果我们<code>output_mode</code>在 GPIO 配置为输入时设置该字段会发生什么？</p>
<p>一般来说，使用这种结构将允许我们达到上面状态机未定义的状态：例如，输出被拉低，或输入被设置为高。对于某些硬件，这可能无关紧要。在其他硬件上，它可能会导致意外或未定义的行为！</p>
<p>虽然这个接口编写起来很方便，但它并没有强制执行我们的硬件实现所规定的设计契约。</p>
<h2 id="Design-Contracts"><a href="#Design-Contracts" class="headerlink" title="Design Contracts"></a>Design Contracts</h2><p>在上一章中，我们编写了一个<em>不</em>强制执行设计契约的接口。让我们再看看我们想象中的 GPIO 配置寄存器：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>位数</th>
<th>价值</th>
<th>意义</th>
<th>笔记</th>
</tr>
</thead>
<tbody><tr>
<td>使能够</td>
<td>0</td>
<td>0</td>
<td>残疾</td>
<td>禁用 GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>启用</td>
<td>启用 GPIO</td>
</tr>
<tr>
<td>方向</td>
<td>1</td>
<td>0</td>
<td>输入</td>
<td>将方向设置为输入</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>输出</td>
<td>将方向设置为输出</td>
</tr>
<tr>
<td>输入模式</td>
<td>2..3</td>
<td>00</td>
<td>高阻抗</td>
<td>将输入设置为高电阻</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>下拉</td>
<td>输入引脚被拉低</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>拉高</td>
<td>输入引脚被拉高</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>不适用</td>
<td>无效状态。不要设置</td>
</tr>
<tr>
<td>输出模式</td>
<td>4</td>
<td>0</td>
<td>设置低</td>
<td>输出引脚被驱动为低电平</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>设置高</td>
<td>输出引脚被驱动为高电平</td>
</tr>
<tr>
<td>输入状态</td>
<td>5</td>
<td>X</td>
<td>有效值</td>
<td>0 如果输入 &lt; 1.5v，1 如果输入 &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>如果我们在使用底层硬件之前检查状态，在运行时执行我们的设计契约，我们可能会编写如下代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set direction</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set input mode</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set output status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be output</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>bool<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to get status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为我们需要对硬件实施限制，所以我们最终会进行大量的运行时检查，这会浪费时间和资源，而且这些代码对于开发人员来说使用起来会很不愉快。</p>
<h3 id="类型状态"><a href="#类型状态" class="headerlink" title="类型状态"></a>类型状态</h3><p>但是，如果我们使用 Rust 的类型系统来强制执行状态转换规则呢？拿这个例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig<span class="token operator">&lt;</span>ENABLED<span class="token punctuation">,</span> DIRECTION<span class="token punctuation">,</span> MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
    enabled<span class="token punctuation">:</span> ENABLED<span class="token punctuation">,</span>
    direction<span class="token punctuation">:</span> DIRECTION<span class="token punctuation">,</span>
    mode<span class="token punctuation">:</span> MODE<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Type states for MODE in GpioConfig</span>
<span class="token keyword">struct</span> Disabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Output<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Input<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledLow<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledHigh<span class="token punctuation">;</span>
<span class="token keyword">struct</span> HighZ<span class="token punctuation">;</span>
<span class="token keyword">struct</span> DontCare<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/// These functions may be used on any GPIO Pin</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_disabled</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> DontCare<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Disabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">set_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Output<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// This function may be used on an Output Pin</span>
<span class="token keyword">impl</span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> set_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>set_high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// These methods may be used on any enabled input GPIO</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_status<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledLow<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_low</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledLow<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_up</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledHigh<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在让我们看看使用它的代码会是什么样子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/*
 * Example 1: Unconfigured to High-Z input
 */</span>
<span class="token keyword">let</span> pin<span class="token punctuation">:</span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">get_gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, pin isn't enabled!</span>
<span class="token comment" spellcheck="true">// pin.into_input_pull_down();</span>

<span class="token comment" spellcheck="true">// Now turn the pin from unconfigured to a high-z input</span>
<span class="token keyword">let</span> input_pin <span class="token operator">=</span> pin<span class="token punctuation">.</span><span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Read from the pin</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, input pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// input_pin.set_bit(true);</span>

<span class="token comment" spellcheck="true">/*
 * Example 2: High-Z input to Pulled Low input
 */</span>
<span class="token keyword">let</span> pulled_low <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Example 3: Pulled Low input to Output, set high
 */</span>
<span class="token keyword">let</span> output_pin <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
output_pin<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, output pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// output_pin.into_input_pull_down();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这绝对是一种存储引脚状态的便捷方式，但为什么要这样做呢？为什么这比将状态存储在<code>enum</code>我们的<code>GpioConfig</code>结构内部更好？</p>
<h3 id="编译时功能安全"><a href="#编译时功能安全" class="headerlink" title="编译时功能安全"></a>编译时功能安全</h3><p>因为我们完全在编译时强制执行我们的设计约束，所以这不会产生运行时成本。当引脚处于输入模式时，无法设置输出模式。相反，您必须通过将其转换为输出引脚来遍历状态，然后设置输出模式。因此，在执行函数之前检查当前状态不会造成运行时损失。</p>
<p>此外，由于这些状态是由类型系统强制执行的，因此该接口的使用者不再有错误的余地。如果他们尝试执行非法的状态转换，代码将无法编译！</p>
<h2 id="Zero-Cost-Abstractions"><a href="#Zero-Cost-Abstractions" class="headerlink" title="Zero Cost Abstractions"></a>Zero Cost Abstractions</h2><p>类型状态也是零成本抽象的一个很好的例子 - 将某些行为移动到编译时执行或分析的能力。这些类型状态不包含实际数据，而是用作标记。由于它们不包含数据，因此它们在运行时在内存中没有实际表示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>mem<span class="token punctuation">:</span><span class="token punctuation">:</span>size_of<span class="token punctuation">;</span>

<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Enabled<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Input<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>PulledHigh<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="零尺寸类型"><a href="#零尺寸类型" class="headerlink" title="零尺寸类型"></a>零尺寸类型</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>像这样定义的结构称为零大小类型，因为它们不包含实际数据。尽管这些类型在编译时是“真实的”——您可以复制它们、移动它们、引用它们等等，但是优化器将完全剥离它们。</p>
<p>在这段代码中：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GpioConfig <span class="token punctuation">{</span>
        periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
        enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
        direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们返回的 GpioConfig 在运行时从不存在。调用此函数通常归结为单个汇编指令 - 将常量寄存器值存储到寄存器位置。这意味着我们开发的类型状态接口是一种零成本抽象——它不再使用 CPU、RAM 或代码空间来跟踪 的状态<code>GpioConfig</code>，并呈现为与直接寄存器访问相同的机器代码。</p>
<h3 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h3><p>一般而言，这些抽象可以根据您的需要进行嵌套。只要使用的所有组件都是零尺寸类型，整个结构在运行时就不会存在。</p>
<p>对于复杂或深度嵌套的结构，定义所有可能的状态组合可能很乏味。在这些情况下，宏可用于生成所有实现。</p>
<h1 id="Portability（可移植性）"><a href="#Portability（可移植性）" class="headerlink" title="Portability（可移植性）"></a>Portability（可移植性）</h1><p>在嵌入式环境中，可移植性是一个非常重要的话题：每个供应商甚至来自单个制造商的每个系列都提供不同的外围设备和功能，同样，与外围设备交互的方式也会有所不同。</p>
<p>平衡这种差异的常用方法是通过称为硬件抽象层或<strong>HAL 的</strong>层。</p>
<blockquote>
<p>硬件抽象是软件中的一组例程，用于模拟某些特定于平台的细节，使程序可以直接访问硬件资源。</p>
<p>它们通常允许程序员通过向硬件提供标准操作系统 (OS) 调用来编写独立于设备的高性能应用程序。</p>
<p><em>维基百科：<a href="https://en.wikipedia.org/wiki/Hardware_abstraction" target="_blank" rel="noopener">硬件抽象层</a></em></p>
</blockquote>
<p>嵌入式系统在这方面有点特殊，因为我们通常没有操作系统和用户可安装的软件，而是作为一个整体编译的固件映像以及许多其他限制。因此，虽然维基百科定义的传统方法可能有效，但它可能不是确保可移植性的最有效方法。</p>
<p>我们如何在 Rust 中做到这一点？输入<strong>嵌入式哈</strong>…</p>
<h2 id="什么是嵌入式hal？"><a href="#什么是嵌入式hal？" class="headerlink" title="什么是嵌入式hal？"></a>什么是嵌入式hal？</h2><p>简而言之，它是一组特性，定义了<strong>HAL 实现</strong>、<strong>驱动程序</strong>和<strong>应用程序（或固件）</strong>之间的实现契约。这些契约包括能力（即如果为某种类型实现了特征，<strong>HAL 实现</strong>提供了某种能力）和方法（即如果您可以构造一个实现特征的类型，则保证您拥有特征中指定的方法可用的）。</p>
<p>典型的分层可能如下所示：</p>
<p><img src="/images/loading.gif" data-original="../images/language/rust_layers.svg" alt=""></p>
<p><strong>嵌入式 hal</strong>中定义的一些特征是：</p>
<ul>
<li>GPIO（输入和输出引脚）</li>
<li>串行通讯</li>
<li>I2C</li>
<li>SPI</li>
<li>计时器/倒计时</li>
<li>模数转换</li>
</ul>
<p>实现和使用<strong>嵌入式 hal</strong>特征和板条箱的主要原因是为了控制复杂性。如果您认为应用程序可能必须在硬件以及应用程序和其他硬件组件的潜在驱动程序中实现对外围设备的使用，那么应该很容易看出可重用性非常有限。用数学表示，如果<strong>M</strong>是外围 HAL 实现的数量，<strong>N</strong>是驱动程序的数量，那么如果我们要为每个应用程序重新发明轮子，那么我们最终会得到<strong>M*N 个</strong>实现，同时使用<strong>嵌入式</strong>HAL提供的<em>API</em>特征将使实现复杂度接近<strong>M+N</strong>。当然，还有其他好处，例如由于定义明确且随时可用的 API，减少了反复试验。</p>
<h2 id="嵌入式-hal-的用户"><a href="#嵌入式-hal-的用户" class="headerlink" title="嵌入式 hal 的用户"></a>嵌入式 hal 的用户</h2><p>如上所述，HAL 有三个主要用户：</p>
<h3 id="HAL-实施"><a href="#HAL-实施" class="headerlink" title="HAL 实施"></a>HAL 实施</h3><p>HAL 实现提供了硬件和 HAL 特征的用户之间的接口。典型的实现包括三个部分：</p>
<ul>
<li>一种或多种硬件特定类型</li>
<li>创建和初始化此类类型的函数，通常提供各种配置选项（速度、操作模式、使用引脚等）</li>
<li>一个或一个以上<code>trait</code> <code>impl</code>的<strong>嵌-HAL</strong>性状该类型</li>
</ul>
<p>这样的<strong>HAL 实现</strong>可以有多种风格：</p>
<ul>
<li>通过底层硬件访问，例如通过寄存器</li>
<li>通过操作系统，例如通过<code>sysfs</code>在 Linux 下使用</li>
<li>通过适配器，例如用于单元测试的模拟类型</li>
<li>通过硬件适配器的驱动程序，例如 I2C 多路复用器或 GPIO 扩展器</li>
</ul>
<h3 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h3><p>驱动程序为内部或外部组件实现一组自定义功能，连接到实现嵌入式 hal 特征的外设。此类驱动器的典型示例包括各种传感器（温度、磁力计、加速度计、光）、显示设备（LED 阵列、LCD 显示器）和执行器（电机、发射器）。</p>
<p>驱动程序必须使用类型实例进行初始化，该类型实例实现了特定<code>trait</code>的嵌入式 hal，这是通过 trait bound 确保的，并提供其自己的类型实例和一组允许与驱动设备交互的自定义方法。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>该应用程序将各个部分绑定在一起并确保实现所需的功能。在不同系统之间移植时，这是最需要适应工作的部分，因为应用程序需要通过 HAL 实现正确初始化真实硬件，并且不同硬件的初始化不同，有时差异很大。此外，用户的选择通常也很重要，因为组件可以物理连接到不同的终端，硬件总线有时需要外部硬件来匹配配置，或者在使用内部外设（例如多个定时器）时需要进行不同的权衡具有不同的功能可用或外围设备与其他设备冲突）。</p>
<h1 id="Concurrency（并发）"><a href="#Concurrency（并发）" class="headerlink" title="Concurrency（并发）"></a>Concurrency（并发）</h1><p>当程序的不同部分可能在不同时间或无序执行时，就会发生并发。在嵌入式上下文中，这包括：</p>
<ul>
<li>中断处理程序，每当相关的中断发生时运行，</li>
<li>各种形式的多线程，您的微处理器定期在程序的各个部分之间进行交换，</li>
<li>在某些系统中，多核微处理器，其中每个核可以同时独立运行程序的不同部分。</li>
</ul>
<p>由于很多嵌入式程序需要处理中断，并发通常迟早会出现，同时也是很多微妙和困难的错误发生的地方。幸运的是，Rust 提供了许多抽象和安全保证来帮助我们编写正确的代码。</p>
<h2 id="无并发"><a href="#无并发" class="headerlink" title="无并发"></a>无并发</h2><p>嵌入式程序最简单的并发是无并发：你的软件由一个主循环组成，它一直在运行，根本没有中断。有时这非常适合手头的问题！通常，您的循环会读取一些输入、执行一些处理并写入一些输出。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> <span class="token function">setup_peripherals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> inputs <span class="token operator">=</span> <span class="token function">read_inputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> outputs <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_outputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于没有并发，因此无需担心程序各部分之间的数据共享或对外围设备的同步访问。如果您可以通过这种简单的方法逃脱，这可能是一个很好的解决方案。</p>
<h2 id="全局可变数据"><a href="#全局可变数据" class="headerlink" title="全局可变数据"></a>全局可变数据</h2><p>与非嵌入式 Rust 不同，我们通常不会创建堆分配并将对该数据的引用传递给新创建的线程。相反，我们的中断处理程序可能随时被调用，并且必须知道如何访问我们正在使用的任何共享内存。在最低级别，这意味着我们必须<em>静态分配</em>可变内存，中断处理程序和主代码都可以引用这些内存。</p>
<p>在 Rust 中，这样的<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable" target="_blank" rel="noopener"><code>static mut</code></a>变量读或写总是不安全的，因为如果不特别小心，你可能会触发竞争条件，你对变量的访问在中途被一个也访问该变量的中断中断。</p>
<p>有关此行为如何在您的代码中导致细微错误的示例，请考虑一个嵌入式程序，该程序在每个一秒周期（频率计数器）计算某些输入信号的上升沿：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DANGER - Not actually safe! Could cause data races.</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每一秒，定时器中断都会将计数器设置回 0。同时，主循环不断测量信号，并在看到从低到高的变化时递增计数器。我们不得不使用<code>unsafe</code>访问 <code>COUNTER</code>，因为它是<code>static mut</code>，这意味着我们向编译器保证我们不会导致任何未定义的行为。你能发现比赛条件吗？上的增量<code>COUNTER</code>是<em>不能</em>保证是原子-事实上，在大多数嵌入式平台，它将被分成了负载，则增量，然后商店。如果中断在加载之后但在存储之前触发，则在中断返回后将忽略重置回 0 - 我们将在该期间计算两倍的转换次数。</p>
<h2 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h2><p>那么，我们可以对数据竞争做些什么呢？一种简单的方法是使用<em>临界区</em>，即禁用中断的上下文。通过将<code>COUNTER</code>in的访问包装 <code>main</code>在临界区中，我们可以确保定时器中断在我们完成递增之前不会触发<code>COUNTER</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// New critical section ensures synchronised access to COUNTER</span>
            cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此示例中，我们使用<code>cortex_m::interrupt::free</code>，但其他平台将具有类似的机制来执行临界区中的代码。这也与禁用中断、运行一些代码，然后重新启用中断相同。</p>
<p>请注意，我们不需要在定时器中断中放置临界区，原因有两个：</p>
<ul>
<li>写入 0<code>COUNTER</code>不会受到比赛的影响，因为我们不阅读它</li>
<li><code>main</code>无论如何它永远不会被线程中断</li>
</ul>
<p>如果<code>COUNTER</code>被多个可能互相<em>抢占的</em>中断处理程序共享，那么每个中断处理程序也 可能需要一个临界区。</p>
<p>这解决了我们眼前的问题，但我们仍然要编写许多需要仔细推理的不安全代码，而且我们可能会不必要地使用临界区。由于每个临界区都会临时暂停中断处理，因此会产生一些额外代码大小以及更高的中断延迟和抖动的相关成本（处理中断可能需要更长的时间，并且处理它们之前的时间将更加可变）。这是否是一个问题取决于您的系统，但总的来说，我们希望避免它。</p>
<p>值得注意的是，虽然临界区保证不会触发任何中断，但它不提供多核系统上的排他性保证！即使没有中断，另一个内核也可以愉快地访问与您的内核相同的内存。如果您使用多核，您将需要更强的同步原语。</p>
<h2 id="原子访问"><a href="#原子访问" class="headerlink" title="原子访问"></a>原子访问</h2><p>在某些平台上，可以使用特殊的原子指令，为读取-修改-写入操作提供保证。专门针对 Cortex-M：<code>thumbv6</code> （Cortex-M0、Cortex-M0+）仅提供原子加载和存储指令，而<code>thumbv7</code>（Cortex-M3 及以上）提供完整的比较和交换（CAS）指令。这些 CAS 指令提供了对所有中断的严厉禁用的替代方案：我们可以尝试递增，它在大多数情况下都会成功，但如果被中断，它将自动重试整个递增操作。即使跨多个内核，这些原子操作也是安全的。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AtomicUsize<span class="token punctuation">,</span> Ordering<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> AtomicUsize <span class="token operator">=</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Use `fetch_add` to atomically add 1 to COUNTER</span>
            COUNTER<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use `store` to write 0 directly to COUNTER</span>
    COUNTER<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个时间<code>COUNTER</code>是一个安全<code>static</code>变量。由于可以从中断处理程序和主线程安全地修改<code>AtomicUsize</code> 类型，<code>COUNTER</code>而无需禁用中断。如果可能，这是一个更好的解决方案 - 但您的平台可能不支持它。</p>
<p>注意<a href="https://doc.rust-lang.org/core/sync/atomic/enum.Ordering.html" target="_blank" rel="noopener"><code>Ordering</code></a>：这会影响编译器和硬件对指令重新排序的方式，也会对缓存可见性产生影响。假设目标是单核平台<code>Relaxed</code>就足够了，并且在这种特殊情况下是最有效的选择。更严格的排序将导致编译器围绕原子操作发出内存屏障；根据您使用原子的内容，您可能需要也可能不需要这个！原子模型的精确细节很复杂，最好在别处进行描述。</p>
<p>有关原子和排序的更多详细信息，请参阅<a href="https://doc.rust-lang.org/nomicon/atomics.html" target="_blank" rel="noopener">nomicon</a>。</p>
<h2 id="抽象、发送和同步"><a href="#抽象、发送和同步" class="headerlink" title="抽象、发送和同步"></a>抽象、发送和同步</h2><p>上述解决方案都不是特别令人满意。它们需要<code>unsafe</code> 必须非常仔细地检查并且不符合人体工程学的积木。我们当然可以在 Rust 中做得更好！</p>
<p>我们可以将我们的计数器抽象成一个安全的接口，它可以安全地在我们代码的任何其他地方使用。对于这个例子，我们将使用临界区计数器，但你可以用原子做一些非常相似的事情。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>UnsafeCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Our counter is just a wrapper around UnsafeCell&lt;u32>, which is the heart</span>
<span class="token comment" spellcheck="true">// of interior mutability in Rust. By using interior mutability, we can have</span>
<span class="token comment" spellcheck="true">// COUNTER be `static` instead of `static mut`, but still able to mutate</span>
<span class="token comment" spellcheck="true">// its counter value.</span>
<span class="token keyword">struct</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CS_COUNTER_INIT<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> CSCounter <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// By requiring a CriticalSection be passed in, we know we must</span>
        <span class="token comment" spellcheck="true">// be operating inside a CriticalSection, and so can confidently</span>
        <span class="token comment" spellcheck="true">// use this unsafe block (required to call UnsafeCell::get).</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Required to allow static CSCounter. See explanation below.</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> CSCounter <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// COUNTER is no longer `mut` as it uses interior mutability;</span>
<span class="token comment" spellcheck="true">// therefore it also no longer requires unsafe blocks to access.</span>
<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> CS_COUNTER_INIT<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No unsafe here!</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We do need to enter a critical section here just to obtain a valid</span>
    <span class="token comment" spellcheck="true">// cs token, even though we know no other interrupt could pre-empt</span>
    <span class="token comment" spellcheck="true">// this one.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We could use unsafe code to generate a fake CriticalSection if we</span>
    <span class="token comment" spellcheck="true">// really wanted to, avoiding the overhead:</span>
    <span class="token comment" spellcheck="true">// let cs = unsafe { interrupt::CriticalSection::new() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们已经将<code>unsafe</code>代码移到精心规划的抽象内部，现在我们的应用程序代码不包含任何<code>unsafe</code>块。</p>
<p>这种设计要求应用程序传入一个<code>CriticalSection</code>令牌：这些令牌仅由 安全生成<code>interrupt::free</code>，因此通过要求传入一个令牌，我们确保我们在临界区中操作，而不必自己实际进行锁定。这种保证是由编译器静态提供的：不会有任何与<code>cs</code>. 如果我们有多个计数器，它们都可以被赋予相同的<code>cs</code>，而不需要多个嵌套的临界区。</p>
<p>这也带来了 Rust 并发的一个重要主题： <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html" target="_blank" rel="noopener"><code>Send</code>和<code>Sync</code></a>特征。总结一下 Rust 书，当它可以安全地移动到另一个线程时，类型是 Send，而当它可以在多个线程之间安全共享时，它是 Sync。在嵌入式上下文中，我们认为中断在与应用程序代码不同的线程中执行，因此被中断和主代码访问的变量必须是同步的。</p>
<p>对于 Rust 中的大多数类型，编译器会自动为您派生这两个特征。但是，因为<code>CSCounter</code>包含一个<a href="https://doc.rust-lang.org/core/cell/struct.UnsafeCell.html" target="_blank" rel="noopener"><code>UnsafeCell</code></a>，它不是同步的，因此我们不能使<code>static CSCounter</code>:<code>static</code> 变量<em>必须</em>是同步的，因为它们可以被多个线程访问。</p>
<p>为了告诉编译器我们已经注意到<code>CSCounter</code>在线程之间共享实际上是安全的，我们显式地实现了 Sync trait。与之前使用的临界区一样，这仅在单核平台上是安全的：对于多核，您需要付出更大的努力来确保安全。</p>
<h2 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h2><p>我们已经创建了一个特定于我们的计数器问题的有用抽象，但是有许多用于并发的通用抽象。</p>
<p>一个这样的<em>同步原语</em>是互斥，互斥的缩写。这些构造确保对变量的独占访问，例如我们的计数器。线程可以尝试<em>锁定</em>（或<em>获取</em>）互斥锁，并且要么立即成功，要么阻塞等待获取锁，或者返回无法锁定互斥锁的错误。当该线程持有锁时，它被授予访问受保护数据的权限。当线程完成时，它<em>解锁</em>（或 <em>释放</em>）互斥锁，允许另一个线程锁定它。在 Rust 中，我们通常会使用<a href="https://doc.rust-lang.org/core/ops/trait.Drop.html" target="_blank" rel="noopener"><code>Drop</code></a>trait 来实现解锁，以确保当互斥量超出范围时它总是被释放。</p>
<p>将互斥锁与中断处理程序一起使用可能会很棘手：中断处理程序阻塞通常是不可接受的，并且阻塞等待主线程释放锁将是特别灾难性的，因为我们会<em>死锁</em>（主线程）线程永远不会释放锁，因为执行停留在中断处理程序中）。死锁不被认为是不安全的：即使在安全的 Rust 中也是可能的。</p>
<p>为了完全避免这种行为，我们可以实现一个需要锁定临界区的互斥锁，就像我们的反例一样。只要临界区必须与锁一样长，我们就可以确保我们可以独占访问被包装的变量，甚至不需要跟踪互斥锁的锁定/解锁状态。</p>
<p>这实际上是在<code>cortex_m</code>板条箱中为我们完成的！我们可以用它写我们的计数器：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>Cell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>Mutex<span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>Cell<span class="token operator">&lt;</span>u32<span class="token operator">>></span> <span class="token operator">=</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Cell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span>
                COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We still need to enter a critical section here to satisfy the Mutex.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们现在使用<a href="https://doc.rust-lang.org/core/cell/struct.Cell.html" target="_blank" rel="noopener"><code>Cell</code></a>，它和它的兄弟一起<code>RefCell</code>被用来提供安全的内部可变性。我们已经看到<code>UnsafeCell</code>了 Rust 内部可变性的底层：它允许您获得对其值的多个可变引用，但只能使用不安全的代码。A<code>Cell</code> 类似于 an<code>UnsafeCell</code>但它提供了一个安全的接口：它只允许获取当前值的副本或替换它，而不是获取引用，并且由于它不是 Sync，因此不能在线程之间共享。这些约束意味着它可以安全使用，但我们不能直接在<code>static</code>变量中使用它， 因为<code>static</code>必须是 Sync。</p>
<p>那么为什么上面的例子有效呢？<code>Mutex&lt;T&gt;</code>为任何<code>T</code>发送的实现同步 - 例如<code>Cell</code>. 它可以安全地执行此操作，因为它仅在关键部分期间才允许访问其内容。因此，我们能够获得一个完全没有不安全代码的安全计数器！</p>
<p>这对于像<code>u32</code>我们的计数器这样的简单类型非常有用，但是对于不是 Copy 的更复杂的类型呢？嵌入式上下文中一个极其常见的示例是外设结构，它通常不是 Copy。为此，我们可以转向<code>RefCell</code>.</p>
<h2 id="共享外设"><a href="#共享外设" class="headerlink" title="共享外设"></a>共享外设</h2><p>使用<code>svd2rust</code>和类似抽象生成的设备箱通过强制一次只能存在一个外围结构实例来提供对外围设备的安全访问。这确保了安全性，但使得从主线程和中断处理程序访问外设变得困难。</p>
<p>为了安全地共享外围访问，我们可以使用<code>Mutex</code>我们之前看到的。我们还需要使用<a href="https://doc.rust-lang.org/core/cell/struct.RefCell.html" target="_blank" rel="noopener"><code>RefCell</code></a>，它使用运行时检查来确保一次只给出一个对外围设备的引用。这比普通的有更多的开销<code>Cell</code>，但由于我们提供引用而不是副本，我们必须确保一次只存在一个。</p>
<p>最后，我们还必须考虑在主代码中初始化后以某种方式将外围设备移动到共享变量中。为此，我们可以使用<code>Option</code>类型，初始化<code>None</code>并稍后设置为外围设备的实例。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Obtain the peripheral singletons and configure it.</span>
    <span class="token comment" spellcheck="true">// This example is from an svd2rust-generated crate, but</span>
    <span class="token comment" spellcheck="true">// most embedded device crates will be similar.</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> <span class="token operator">&amp;</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it sets PA0 to an input and PA1 to an output.</span>
    <span class="token function">configure_gpio</span><span class="token punctuation">(</span>gpioa<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Store the GPIOA in the mutex, moving it.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We can no longer use `gpioa` or `dp.GPIOA`, and instead have to</span>
    <span class="token comment" spellcheck="true">// access it via the mutex.</span>

    <span class="token comment" spellcheck="true">// Be careful to enable the interrupt only after setting MY_GPIO:</span>
    <span class="token comment" spellcheck="true">// otherwise the interrupt might fire while it still contains None,</span>
    <span class="token comment" spellcheck="true">// and as-written (with `unwrap()`), it would panic.</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We'll now read state as a digital input, via the mutex</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>idr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">idr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Set PA1 high if we've seen a rising edge on PA0.</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This time in the interrupt we'll just clear PA0.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We can use `unwrap()` because we know the interrupt wasn't enabled</span>
        <span class="token comment" spellcheck="true">// until after MY_GPIO was set; otherwise we should handle the potential</span>
        <span class="token comment" spellcheck="true">// for a None value.</span>
        <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要考虑的内容很多，所以让我们分解重要的几行。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们的共享变量现在是 a<code>Mutex</code>周围的 a <code>RefCell</code>，其中包含一个 <code>Option</code>。在<code>Mutex</code>确保我们只有一个临界区中访问，并因此使变量同步，即使一个普通的<code>RefCell</code>不会同步。该<code>RefCell</code>给我们参考，我们将需要使用我们内部的可变性<code>GPIOA</code>。该<code>Option</code>让我们初始化这个变量为空的东西，后来才真正移动的变量，我们不能静态地访问外设的独生子，在运行时，所以这是必需的。</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在临界区中，我们可以调用<code>borrow()</code>互斥锁，它为我们提供了对<code>RefCell</code>. 然后我们调用<code>replace()</code>将我们的新值移动到<code>RefCell</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，我们<code>MY_GPIO</code>以安全和并发的方式使用。临界区像往常一样阻止中断触发，并让我们借用互斥锁。在 <code>RefCell</code>随后给了我们一个<code>&amp;Option&lt;GPIOA&gt;</code>，并跟踪它保持多久借来的-一旦进入参考范围的那样，<code>RefCell</code>将被更新，以表明它不再是借来的。</p>
<p>由于我们无法将<code>GPIOA</code>移出<code>&amp;Option</code>，我们需要将其转换为<code>&amp;Option&lt;&amp;GPIOA&gt;</code>with <code>as_ref()</code>，我们最终<code>unwrap()</code>可以获取<code>&amp;GPIOA</code>它让我们修改外围设备。</p>
<p>如果我们需要对共享资源的可变引用<code>borrow_mut</code>，<code>deref_mut</code> 则应使用and代替。以下代码显示了使用 TIM2 定时器的示例。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>DerefMut<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">:</span><span class="token punctuation">:</span>wfi<span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> G_TIM<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>Timer<span class="token operator">&lt;</span>stm32<span class="token punctuation">:</span><span class="token punctuation">:</span>TIM2<span class="token operator">>></span><span class="token operator">>></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cp <span class="token operator">=</span> cm<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of timer configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it configures the TIM2 timer, its NVIC interrupt,</span>
    <span class="token comment" spellcheck="true">// and finally starts the timer.</span>
    <span class="token keyword">let</span> tim <span class="token operator">=</span> <span class="token function">configure_timer_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> cp<span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>tim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">wfi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> tim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>  G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tim<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>哇！这是安全的，但也有点笨拙。我们还有什么可以做的吗？</p>
<h2 id="信息中心"><a href="#信息中心" class="headerlink" title="信息中心"></a>信息中心</h2><p>一种替代方案是<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener">RTIC 框架</a>，它是实时中断驱动并发的缩写。它强制执行静态优先级并跟踪对<code>static mut</code>变量（“资源”）的访问，以静态地确保始终安全地访问共享资源，而无需总是进入临界区和使用引用计数（如 中所示<code>RefCell</code>）的开销。这有许多优点，例如保证没有死锁并提供极低的时间和内存开销。</p>
<p>该框架还包括其他功能，如消息传递，这减少了对显式共享状态的需求，以及安排任务在给定时间运行的能力，可用于实现周期性任务。查看<a href="https://rtic.rs/" target="_blank" rel="noopener">文档</a>以获取更多信息！</p>
<h2 id="实时操作系统"><a href="#实时操作系统" class="headerlink" title="实时操作系统"></a>实时操作系统</h2><p>嵌入式并发的另一个常见模型是实时操作系统 (RTOS)。虽然目前在 Rust 中的探索较少，但它们广泛用于传统的嵌入式开发。开源示例包括<a href="https://freertos.org/" target="_blank" rel="noopener">FreeRTOS</a>和 <a href="http://chibios.org/" target="_blank" rel="noopener">ChibiOS</a>。这些 RTOS 支持运行多个应用程序线程，CPU 在这些线程之间进行交换，当线程让出控制权（称为协作多任务处理）或基于常规计时器或中断（抢占式多任务处理）时。RTOS 通常提供互斥锁和其他同步原语，并且经常与硬件功能（例如 DMA 引擎）进行互操作。</p>
<p>在撰写本文时，可以指出的 Rust RTOS 示例并不多，但这是一个有趣的领域，因此请关注此空间！</p>
<h2 id="多核"><a href="#多核" class="headerlink" title="多核"></a>多核</h2><p>在嵌入式处理器中拥有两个或更多内核变得越来越普遍，这为并发性增加了一层额外的复杂性。所有使用临界区（包括<code>cortex_m::interrupt::Mutex</code>）的示例都假设唯一的其他执行线程是中断线程，但在多核系统上不再如此。相反，我们需要为多核设计的同步原语（也称为 SMP，用于对称多处理）。</p>
<p>这些通常使用我们之前看到的原子指令，因为处理系统将确保在所有内核上保持原子性。</p>
<p>详细介绍这些主题目前超出了本书的范围，但一般模式与单核情况相同。</p>
<h1 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h1><p>最终，您将希望在程序中使用动态数据结构（AKA 集合）。<code>std</code>提供了一组公共集合：<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html" target="_blank" rel="noopener"><code>Vec</code></a>、<a href="https://doc.rust-lang.org/std/string/struct.String.html" target="_blank" rel="noopener"><code>String</code></a>、 <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener"><code>HashMap</code></a>等。所有实现的集合都<code>std</code>使用全局动态内存分配器（也称为堆）。</p>
<p>按照<code>core</code>定义，这些实现在没有内存分配的情况下不可用，但可以<code>alloc</code>在编译器附带的crate 中找到。</p>
<p>如果您需要集合，堆分配实现不是您唯一的选择。您还可以使用<em>固定容量</em>集合；在<a href="https://crates.io/crates/heapless" target="_blank" rel="noopener"><code>heapless</code></a>crate 中可以找到一个这样的实现。</p>
<p>在本节中，我们将探索和比较这两种实现。</p>
<h2 id="使用-alloc"><a href="#使用-alloc" class="headerlink" title="使用 alloc"></a>使用 <code>alloc</code></h2><p>该<code>alloc</code>箱出厂时的标准锈病分布。要导入 crate，您可以直接将<code>use</code>其导入，<em>而无需</em>在<code>Cargo.toml</code>文件中将其声明为依赖项 。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc)]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> alloc<span class="token punctuation">;</span>

<span class="token keyword">use</span> alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>vec<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了能够使用任何集合，您首先需要使用该<code>global_allocator</code> 属性来声明您的程序将使用的全局分配器。您选择的分配器需要实现该<a href="https://doc.rust-lang.org/core/alloc/trait.GlobalAlloc.html" target="_blank" rel="noopener"><code>GlobalAlloc</code></a>特征。</p>
<p>为完整起见并保持本节尽可能独立，我们将实现一个简单的凹凸指针分配器并将其用作全局分配器。但是，我们<em>强烈</em>建议您在程序中使用 crates.io 中经过实战测试的分配器，而不是这个分配器。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Bump pointer allocator implementation</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalAlloc<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Bump pointer allocator for *single* core systems</span>
<span class="token keyword">struct</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token operator">&lt;</span>usize<span class="token operator">></span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> usize<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> GlobalAlloc <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">mut</span> u8 <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// `interrupt::free` is a critical section that makes our allocator safe</span>
        <span class="token comment" spellcheck="true">// to use from within interrupts</span>
        interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> head <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> size <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align_mask <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// move start up to the next alignment boundary</span>
            <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>head <span class="token operator">+</span> align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> align_mask<span class="token punctuation">;</span>

            <span class="token keyword">if</span> start <span class="token operator">+</span> size <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>end <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// a null pointer signal an Out Of Memory condition</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">null_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>head <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
                start <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">dealloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8<span class="token punctuation">,</span> _<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this allocator never deallocates memory</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Declaration of the global memory allocator</span>
<span class="token comment" spellcheck="true">// NOTE the user must ensure that the memory region `[0x2000_0100, 0x2000_0200]`</span>
<span class="token comment" spellcheck="true">// is not used by other parts of the program</span>
<span class="token attribute attr-name">#[global_allocator]</span>
<span class="token keyword">static</span> HEAP<span class="token punctuation">:</span> BumpPointerAlloc <span class="token operator">=</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x2000_0100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> <span class="token number">0x2000_0200</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了选择全局分配器之外，用户还必须定义如何使用<em>不稳定</em> <code>alloc_error_handler</code>属性处理内存不足 (OOM) 错误。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc_error_handler)]</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[alloc_error_handler]</span>
<span class="token keyword">fn</span> <span class="token function">on_oom</span><span class="token punctuation">(</span>_layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    asm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一切就绪后，用户最终可以使用<code>alloc</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您使用过<code>std</code>crate 中的集合，那么这些将很熟悉，因为它们是完全相同的实现。</p>
<h2 id="使用-heapless"><a href="#使用-heapless" class="headerlink" title="使用 heapless"></a>使用 <code>heapless</code></h2><p><code>heapless</code>不需要设置，因为它的集合不依赖于全局内存分配器。只是<code>use</code>它的集合并继续实例化它们：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> heapless<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// v0.4.x</span>

<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token punctuation">,</span> U8<span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您会注意到这些集合与<code>alloc</code>.</p>
<p>首先，您必须预先声明集合的容量。<code>heapless</code> 集合永远不会重新分配并具有固定容量；此容量是集合类型签名的一部分。在这种情况下，我们已经声明了<code>xs</code> 具有 8 个元素的容量，即向量最多可以容纳 8 个元素。这由类型签名中的<code>U8</code>（请参阅<a href="https://crates.io/crates/typenum" target="_blank" rel="noopener"><code>typenum</code></a>）指示。</p>
<p>其次，该<code>push</code>方法和许多其他方法都返回一个<code>Result</code>. 由于 <code>heapless</code>集合具有固定容量，因此所有将元素插入到集合中的操作都可能失败。API 通过返回一个<code>Result</code>指示操作是否成功来反映此问题。相比之下，<code>alloc</code>集合将在堆上重新分配自己以增加其容量。</p>
<p>从 v0.4.x 版本开始，所有<code>heapless</code>集合都内联存储其所有元素。这意味着像这样的操作<code>let x = heapless::Vec::new();</code>将在堆栈上分配集合，但也可以在<code>static</code>变量上分配集合，甚至在堆 ( <code>Box&lt;Vec&lt;_, _&gt;&gt;</code>) 上。</p>
<h2 id="权衡"><a href="#权衡" class="headerlink" title="权衡"></a>权衡</h2><p>在堆分配、可重定位集合和固定容量集合之间进行选择时，请记住这些。</p>
<h3 id="内存不足和错误处理"><a href="#内存不足和错误处理" class="headerlink" title="内存不足和错误处理"></a>内存不足和错误处理</h3><p>对于堆分配，内存不足总是可能的，并且可能发生在集合可能需要增长的任何地方：例如，所有 <code>alloc::Vec.push</code>调用都可能产生 OOM 条件。因此，某些操作可能会<em>隐式</em>失败。一些<code>alloc</code>集合公开了 一些<code>try_reserve</code>方法，可以让您在增加集合时检查潜在的 OOM 条件，但您需要主动使用它们。</p>
<p>如果您只使用<code>heapless</code>集合并且不将内存分配器用于其他任何事情，那么 OOM 条件是不可能的。相反，您必须根据具体情况处理容量不足的集合。这就是你必须处理<em>所有</em>的<code>Result</code>通过类似方法返回小号 <code>Vec.push</code>。</p>
<p>OOM 故障可能比<code>unwrap</code>对所有<code>Result</code>返回的 s说-ing更难调试，<code>heapless::Vec.push</code>因为观察到的故障位置可能 与问题原因的位置<em>不</em>匹配。例如，<code>vec.reserve(1)</code>如果分配器几乎耗尽，因为其他一些集合正在泄漏内存（在安全 Rust 中可能发生内存泄漏），甚至 可以触发 OOM。</p>
<h3 id="内存使用情况"><a href="#内存使用情况" class="headerlink" title="内存使用情况"></a>内存使用情况</h3><p>对堆分配集合的内存使用情况进行推理是很困难的，因为长寿命集合的容量可能会在运行时发生变化。某些操作可能会隐式地重新分配集合以增加其内存使用量，而某些集合公开的方法<code>shrink_to_fit</code>可能会减少集合使用的内存——最终，由分配器决定是否实际缩小内存分配。此外，分配器可能必须处理内存碎片，这会增加 <em>明显的</em>内存使用量。</p>
<p>另一方面，如果您专门使用固定容量集合，将它们中的大部分存储在<code>static</code>变量中并为调用堆栈设置最大大小，那么链接器将检测您是否尝试使用比物理可用内存更多的内存。</p>
<p>此外，堆栈上分配的固定容量集合将通过<a href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/emit-stack-sizes.html" target="_blank" rel="noopener"><code>-Z emit-stack-sizes</code></a>标志报告，这意味着分析堆栈使用情况的工具（如<a href="https://crates.io/crates/stack-sizes" target="_blank" rel="noopener"><code>stack-sizes</code></a>）将在其分析中包括它们。</p>
<p>但是，固定容量集合<em>无法</em>收缩，这会导致负载因子（集合大小与其容量之间的比率）低于可重定位集合所能达到的负载因子。</p>
<h3 id="最坏情况执行时间-WCET"><a href="#最坏情况执行时间-WCET" class="headerlink" title="最坏情况执行时间 (WCET)"></a>最坏情况执行时间 (WCET)</h3><p>如果您正在构建对时间敏感的应用程序或硬实时应用程序，那么您可能非常关心程序不同部分的最坏情况执行时间。</p>
<p>该<code>alloc</code>集合可以重新分配，这样可以增加集合还将包括它需要重新分配的集合，它本身依赖于时间的操作的WCET<em>运行时</em>收集的能力。这使得很难确定例如<code>alloc::Vec.push</code>操作的 WCET，因为它取决于正在使用的分配器及其运行时容量。</p>
<p>另一方面，固定容量集合永远不会重新分配，因此所有操作都有可预测的执行时间。例如，<code>heapless::Vec.push</code>在恒定时间内执行。</p>
<h3 id="便于使用"><a href="#便于使用" class="headerlink" title="便于使用"></a>便于使用</h3><p><code>alloc</code>需要设置全局分配器，<code>heapless</code>而不需要。但是，<code>heapless</code>需要您选择实例化的每个集合的容量。</p>
<p><code>alloc</code>几乎每个 Rust 开发人员都会熟悉该API。该 <code>heapless</code>API尝试密切模仿的<code>alloc</code>API，但它永远不会是完全一样的，因为它明确的错误处理-一些开发人员可能会觉得明确错误处理过度或太麻烦了。</p>
<h1 id="Design-Patterns"><a href="#Design-Patterns" class="headerlink" title="Design Patterns"></a>Design Patterns</h1><p>HAL Design Patterns：</p>
<p>这是一组常用和推荐的模式，用于在 Rust 中为微控制器编写硬件抽象层 (HAL)。在为微控制器编写 HAL 时，除了现有的<a href="https://rust-lang.github.io/api-guidelines/" target="_blank" rel="noopener">Rust API 指南</a>之外，还打算使用这些模式。</p>
<h2 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h2><ul>
<li><p>命名</p>
<p>（crate 与 Rust 命名约定一致）</p>
<ul>
<li>箱子被适当地命名（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/naming.html#c-crate-name" target="_blank" rel="noopener">C-CRATE-NAME</a>）</li>
</ul>
</li>
<li><p>互操作性</p>
<p>（板条箱与其他库功能很好地交互）</p>
<ul>
<li>包装器类型提供析构函数方法 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-free" target="_blank" rel="noopener">C-FREE</a> )</li>
<li>HAL 重新导出其注册访问箱 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-reexport-pac" target="_blank" rel="noopener">C-REEXPORT-PAC</a> )</li>
<li>类型实现<code>embedded-hal</code>特征（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-hal-traits" target="_blank" rel="noopener">C-HAL-TRAITS</a>）</li>
</ul>
</li>
<li><p>可预测性</p>
<p>（板条箱启用清晰的代码，使其看起来如何）</p>
<ul>
<li>使用构造函数代替扩展特征（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/predictability.html#c-ctor" target="_blank" rel="noopener">C-CTOR</a>）</li>
</ul>
</li>
<li><p>GPIO 接口</p>
<p>（GPIO 接口遵循通用模式）</p>
<ul>
<li>默认情况下，引脚类型为零大小 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-zst-pin" target="_blank" rel="noopener">C-ZST-PIN</a> )</li>
<li>引脚类型提供擦除引脚和端口的方法（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-erased-pin" target="_blank" rel="noopener">C-ERASED-PIN</a>）</li>
<li>引脚状态应编码为类型参数（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-pin-state" target="_blank" rel="noopener">C-PIN-STATE</a>）</li>
</ul>
</li>
</ul>
<h2 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h2><h3 id="箱子被适当地命名（C-CRATE-NAME）"><a href="#箱子被适当地命名（C-CRATE-NAME）" class="headerlink" title="箱子被适当地命名（C-CRATE-NAME）"></a>箱子被适当地命名（C-CRATE-NAME）</h3><p>HAL crate 应以其旨在支持的芯片或芯片系列命名。它们的名称应以 结尾，<code>-hal</code>以将它们与 register access crate 区分开来。名称不应包含下划线（改用破折号）。</p>
<h2 id="Interoperability"><a href="#Interoperability" class="headerlink" title="Interoperability"></a>Interoperability</h2><h3 id="包装类型提供析构方法（C-FREE）"><a href="#包装类型提供析构方法（C-FREE）" class="headerlink" title="包装类型提供析构方法（C-FREE）"></a>包装类型提供析构方法（C-FREE）</h3><p><code>Copy</code>HAL 提供的任何非包装器类型都应该提供一个<code>free</code>方法来使用包装器并返回创建它的原始外围设备（可能还有其他对象）。</p>
<p>如有必要，该方法应关闭并重置外设。<code>new</code> 使用 返回的原始外设调用<code>free</code>不应由于外设的意外状态而失败。</p>
<p>如果 HAL 类型需要<code>Copy</code>构造其他非对象（例如 I/O 引脚），则任何此类对象也应被释放并返回<code>free</code>。 <code>free</code>在这种情况下应该返回一个元组。</p>
<p>例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token function">Timer</span><span class="token punctuation">(</span>TIMER0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Timer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>periph<span class="token punctuation">:</span> TIMER0<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        <span class="token function">Self</span><span class="token punctuation">(</span>periph<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> TIMER0 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="HAL-重新导出其注册访问箱-C-REEXPORT-PAC"><a href="#HAL-重新导出其注册访问箱-C-REEXPORT-PAC" class="headerlink" title="HAL 重新导出其注册访问箱 (C-REEXPORT-PAC)"></a>HAL 重新导出其注册访问箱 (C-REEXPORT-PAC)</h3><p>HAL 可以写在<a href="https://github.com/rust-embedded/svd2rust" target="_blank" rel="noopener">svd2rust</a>生成的 PAC 之上，或者写在提供原始寄存器访问的其他 crate 之上。HAL 应始终在其 crate 根中重新导出它们所基于的 register access crate。</p>
<p>PAC 应该以 name 重新导出<code>pac</code>，而不管 crate 的实际名称是什么，因为 HAL 的名称应该已经清楚地表明正在访问什么 PAC。</p>
<h3 id="类型实现embedded-hal特征（C-HAL-TRAITS）"><a href="#类型实现embedded-hal特征（C-HAL-TRAITS）" class="headerlink" title="类型实现embedded-hal特征（C-HAL-TRAITS）"></a>类型实现<code>embedded-hal</code>特征（C-HAL-TRAITS）</h3><p>HAL 提供的类型应实现<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>crate提供的所有适用特征 。</p>
<p>可以为同一类型实现多个特征。</p>
<h2 id="Predictability"><a href="#Predictability" class="headerlink" title="Predictability"></a>Predictability</h2><h3 id="使用构造函数代替扩展特征（C-CTOR）"><a href="#使用构造函数代替扩展特征（C-CTOR）" class="headerlink" title="使用构造函数代替扩展特征（C-CTOR）"></a>使用构造函数代替扩展特征（C-CTOR）</h3><p>HAL 向其添加功能的所有外围设备都应包含在新类型中，即使该功能不需要其他字段。</p>
<p>应避免为原始外设实现的扩展特性。</p>
<h3 id="方法-inline-在适当的地方装饰（C-INLINE）"><a href="#方法-inline-在适当的地方装饰（C-INLINE）" class="headerlink" title="方法#[inline\]在适当的地方装饰（C-INLINE）"></a>方法<code>#[inline\]</code>在适当的地方装饰（C-INLINE）</h3><p>默认情况下，Rust 编译器不会跨 crate 边界执行完全内联。由于嵌入式应用程序对意外的代码大小增加很敏感，<code>#[inline]</code>应使用如下指导编译器：</p>
<ul>
<li>所有“小”功能都应该被标记<code>#[inline]</code>。什么是“小”是主观的，但通常所有预期编译为一位数指令序列的函数都被认为是小。</li>
<li>很可能采用常量值作为参数的函数应标记为<code>#[inline]</code>. 这使得编译器能够在编译时计算甚至复杂的初始化逻辑，前提是函数输入是已知的。</li>
</ul>
<h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><h3 id="默认情况下，引脚类型为零大小-C-ZST-PIN"><a href="#默认情况下，引脚类型为零大小-C-ZST-PIN" class="headerlink" title="默认情况下，引脚类型为零大小 (C-ZST-PIN)"></a>默认情况下，引脚类型为零大小 (C-ZST-PIN)</h3><p>HAL 公开的 GPIO 接口应为每个接口或端口上的每个引脚提供专用的零大小类型，从而在所有引脚分配都是静态已知的情况下实现零成本的 GPIO 抽象。</p>
<p>每个 GPIO 接口或端口都应该实现一个<code>split</code>方法，返回一个带有每个引脚的结构。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortA<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PortA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PortAPins <span class="token punctuation">{</span>
        PortAPins <span class="token punctuation">{</span>
            pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
            pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortAPins <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="引脚类型提供擦除引脚和端口的方法-C-ERASED-PIN"><a href="#引脚类型提供擦除引脚和端口的方法-C-ERASED-PIN" class="headerlink" title="引脚类型提供擦除引脚和端口的方法 (C-ERASED-PIN)"></a>引脚类型提供擦除引脚和端口的方法 (C-ERASED-PIN)</h3><p>Pin 应该提供类型擦除方法，将它们的属性从编译时移动到运行时，并在应用程序中提供更大的灵活性。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// Port A, pin 0.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PA0 <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_pin</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PA <span class="token punctuation">{</span>
        PA <span class="token punctuation">{</span> pin<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A pin on port A.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// The pin number.</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> PA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_port</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Pin <span class="token punctuation">{</span>
        Pin <span class="token punctuation">{</span>
            port<span class="token punctuation">:</span> Port<span class="token punctuation">:</span><span class="token punctuation">:</span>A<span class="token punctuation">,</span>
            pin<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>pin<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Pin <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> Port<span class="token punctuation">,</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// (these fields can be packed to reduce the memory footprint)</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> Port <span class="token punctuation">{</span>
    A<span class="token punctuation">,</span>
    B<span class="token punctuation">,</span>
    C<span class="token punctuation">,</span>
    D<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="引脚状态应编码为类型参数-C-PIN-STATE"><a href="#引脚状态应编码为类型参数-C-PIN-STATE" class="headerlink" title="引脚状态应编码为类型参数 (C-PIN-STATE)"></a>引脚状态应编码为类型参数 (C-PIN-STATE)</h3><p>根据芯片或系列的不同，引脚可以配置为具有不同特性的输入或输出。此状态应在类型系统中进行编码，以防止在错误状态下使用引脚。</p>
<p>附加的、特定于芯片的状态（例如驱动强度）也可以以这种方式使用附加类型参数进行编码。</p>
<p>应提供更改引脚状态的方法<code>into_input</code>和 <code>into_output</code>方法。</p>
<p>此外，<code>with_{input,output}_state</code>应该提供在不同状态下临时重新配置引脚而不移动它的方法。</p>
<p>应为每种引脚类型提供以下方法（即擦除和非擦除引脚类型应提供相同的 API）：</p>
<ul>
<li><p><code>pub fn into_input&lt;N: InputState&gt;(self, input: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><p><code>pub fn into_output&lt;N: OutputState&gt;(self, output: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_input_state<N: InputState, R>(
    &mut self,
    input: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_output_state<N: OutputState, R>(
    &mut self,
    output: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>引脚状态应受密封特征的限制。HAL 的用户应该不需要添加他们自己的状态。这些特征可以提供实现引脚状态 API 所需的特定于 HAL 的方法。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">mod</span> sealed <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">trait</span> Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> PinState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> OutputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> InputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Output<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PushPull<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> OpenDrain<span class="token punctuation">;</span>

<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Input<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Floating<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullUp<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullDown<span class="token punctuation">;</span>

<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> PA1<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_input<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Input<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_output<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Output<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_input_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_output_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Same for `PA` and `Pin`, and other pin types.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Tips-for-embedded-C-developers"><a href="#Tips-for-embedded-C-developers" class="headerlink" title="Tips for embedded C developers"></a>Tips for embedded C developers</h1><p>本章收集了各种技巧，可能对希望开始编写 Rust 的有经验的嵌入式 C 开发人员有用。它将特别强调您在 C 中可能已经习惯的东西在 Rust 中的不同之处。</p>
<h2 id="预处理器"><a href="#预处理器" class="headerlink" title="预处理器"></a>预处理器</h2><p>在嵌入式 C 中，将预处理器用于各种目的是很常见的，例如：</p>
<ul>
<li>代码块的编译时选择 <code>#ifdef</code></li>
<li>编译时数组大小和计算</li>
<li>用于简化常见模式的宏（以避免函数调用开销）</li>
</ul>
<p>在 Rust 中没有预处理器，因此许多这些用例的处理方式不同。在本节的其余部分，我们将介绍使用预处理器的各种替代方法。</p>
<h3 id="Compile-Time-Code-Selection"><a href="#Compile-Time-Code-Selection" class="headerlink" title="Compile-Time Code Selection"></a>Compile-Time Code Selection</h3><p><code>#ifdef ... #endif</code>在 Rust 中最接近的匹配是<a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-features-section" target="_blank" rel="noopener">Cargo features</a>。这些比 C 预处理器更正式一些：所有可能的功能都明确列出每个 crate，并且只能打开或关闭。当您将一个 crate 列为依赖项时，功能会被打开，并且是附加的：如果您的依赖树中的任何一个 crate 为另一个 crate 启用了一个特性，那么该特性将为该 crate 的所有用户启用。</p>
<p>例如，您可能有一个提供信号处理原语库的 crate。每个人都可能需要一些额外的时间来编译或声明一些您希望避免的大型常量表。你可以为你的每个组件声明一个 Cargo 特性<code>Cargo.toml</code>：</p>
<pre class="line-numbers language-toml"><code class="language-toml">[features]
FIR = []
IIR = []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后，在您的代码中，使用<code>#[cfg(feature="FIR")]</code>来控制所包含的内容。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// In your top-level lib.rs</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"FIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> fir<span class="token punctuation">;</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"IIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> iir<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>类似地，仅当某个功能<em>未</em>启用，或者功能的任何组合已启用或未启用时，您才可以包含代码块。</p>
<p>此外，Rust 提供了许多您可以使用的自动设置条件，例如<code>target_arch</code>根据架构选择不同的代码。有关条件编译支持的完整详细信息，请参阅Rust 参考的 <a href="https://doc.rust-lang.org/reference/conditional-compilation.html" target="_blank" rel="noopener">条件编译</a>章节。</p>
<p>条件编译仅适用于下一个语句或块。如果一个块不能在当前范围内使用，那么该<code>cfg</code>属性将需要多次使用。值得注意的是，在大多数情况下，最好简单地包含所有代码并允许编译器在优化时删除死代码：这对您和您的用户来说更简单，并且通常编译器会很好地删除未使用的代码.</p>
<h3 id="编译时大小和计算"><a href="#编译时大小和计算" class="headerlink" title="编译时大小和计算"></a>编译时大小和计算</h3><p>Rust 支持<code>const fn</code>, 保证在编译时可评估的函数，因此可以在需要常量的地方使用，例如数组的大小。这可以与上述功能一起使用，例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> usize <span class="token punctuation">{</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">1024</span> <span class="token punctuation">}</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">128</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> BUF<span class="token punctuation">:</span> <span class="token punctuation">[</span>u32<span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u32</span><span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从 1.31 开始，这些是稳定 Rust 的新内容，因此文档仍然很少。<code>const fn</code>在撰写本文时，可用的功能也非常有限；在未来的 Rust 版本中，预计会扩展<code>const fn</code>.</p>
<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><p>Rust 提供了一个极其强大的<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">宏系统</a>。虽然 C 预处理器几乎直接对源代码的文本进行操作，但 Rust 宏系统在更高的级别上运行。Rust 宏有两种变体：<em>示例*</em>宏<em>和</em>过程宏*。前者更简单也最常见；它们看起来像函数调用，可以扩展为完整的表达式、语句、项或模式。过程宏更复杂，但允许对 Rust 语言进行极其强大的添加：它们可以将任意 Rust 语法转换为新的 Rust 语法。</p>
<p>通常，在您可能使用过 C 预处理器宏的地方，您可能想查看一个宏示例是否可以完成这项工作。它们可以在您的 crate 中定义，并且可以由您自己的 crate 轻松使用或导出给其他用户。请注意，由于它们必须扩展为完整的表达式、语句、项或模式，因此 C 预处理器宏的某些用例将不起作用，例如扩展为变量名称的一部分或列表中不完整的项集的宏.</p>
<p>与 Cargo 功能一样，如果您甚至需要宏，则值得考虑。在许多情况下，常规函数更容易理解，并且会被内联到与宏相同的代码中。在<code>#[inline]</code>和<code>#[inline(always)]</code> <a href="https://doc.rust-lang.org/reference/attributes.html#inline-attribute" target="_blank" rel="noopener">属性</a> 让您对这一过程的进一步控制，但应谨慎在这里拍摄，以及-编译器会从同一包装箱自动内联函数在适当情况下，所以迫使它这样做不恰当实际上可能会导致性能下降。</p>
<p>解释整个 Rust 宏系统超出了本提示页面的范围，因此鼓励您查阅 Rust 文档以获取完整详细信息。</p>
<h2 id="构建系统"><a href="#构建系统" class="headerlink" title="构建系统"></a>构建系统</h2><p>大多数 Rust crate 是使用 Cargo 构建的（尽管不是必需的）。这解决了传统构建系统的许多难题。但是，您可能希望自定义构建过程。Cargo为此提供了<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener"><code>build.rs</code> 脚本</a>。它们是 Rust 脚本，可以根据需要与 Cargo 构建系统交互。</p>
<p>构建脚本的常见用例包括：</p>
<ul>
<li>提供构建时间信息，例如将构建日期或 Git 提交哈希静态嵌入到您的可执行文件中</li>
<li>根据所选功能或其他逻辑在构建时生成链接器脚本</li>
<li>更改 Cargo 构建配置</li>
<li>添加额外的静态库来链接</li>
</ul>
<p>目前不支持构建后脚本，您可能在传统上将其用于从构建对象自动生成二进制文件或打印构建信息等任务。</p>
<h3 id="交叉编译-1"><a href="#交叉编译-1" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>将 Cargo 用于您的构建系统还可以简化交叉编译。在大多数情况下，只需告诉 Cargo<code>--target thumbv6m-none-eabi</code>并在<code>target/thumbv6m-none-eabi/debug/myapp</code>.</p>
<p>对于 Rust 本身不支持的平台，您需要<code>libcore</code> 自己为该目标构建。在这样的平台上，<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener">Xargo</a>可以用作 Cargo 的替身，它会自动<code>libcore</code>为您构建。</p>
<h2 id="迭代器与数组访问"><a href="#迭代器与数组访问" class="headerlink" title="迭代器与数组访问"></a>迭代器与数组访问</h2><p>在 C 中，您可能习惯于通过索引直接访问数组：</p>
<pre class="line-numbers language-c"><code class="language-c">int16_t arr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Rust 中，这是一种反模式：索引访问可能会更慢（因为它需要进行边界检查）并且可能会阻止各种编译器优化。这是一个重要的区别，值得重复：Rust 将检查手动数组索引的越界访问以保证内存安全，而 C 将很乐意在数组外进行索引。</p>
<p>相反，使用迭代器：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u16</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> element <span class="token keyword">in</span> arr<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">*</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>迭代器提供了一系列强大的功能，您必须在 C 中手动实现，例如链接、压缩、枚举、查找最小值或最大值、求和等等。迭代器方法也可以链接，提供非常易读的数据处理代码。</p>
<h2 id="引用-vs-指针"><a href="#引用-vs-指针" class="headerlink" title="引用 vs 指针"></a>引用 vs 指针</h2><p>在 Rust 中，指针（称为<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener"><em>原始指针</em></a>）存在但仅在特定情况下使用，因为总是考虑取消引用它们<code>unsafe</code>——Rust 不能提供关于指针后面可能是什么的通常保证。</p>
<p>在大多数情况下，我们改用<em>引用</em>，由指定的<code>&amp;</code>符号，或 <em>可变的引用</em>，以表示<code>&amp;mut</code>。引用的行为类似于指针，因为它们可以被取消引用以访问底层值，但它们是 Rust 所有权系统的关键部分：Rust 将严格强制您可能只有一个可变引用<em>或</em>多个非可变引用到同一个在任何给定时间的价值。</p>
<p>在实践中，这意味着您必须更加小心是否需要对数据进行可变访问：在 C 中，默认值是可变的，您必须明确说明<code>const</code>，而在 Rust 中则相反。</p>
<p>您可能仍然使用原始指针的一种情况是直接与硬件交互（例如，将指向缓冲区的指针写入 DMA 外设寄存器），并且它们也在幕后用于所有外设访问包，以允许您读取和写内存映射寄存器。</p>
<h2 id="Volatile-Access"><a href="#Volatile-Access" class="headerlink" title="Volatile Access"></a>Volatile Access</h2><p>在 C 中，个别变量可能被标记为<code>volatile</code>，向编译器表明变量中的值可能会在访问之间发生变化。易失性变量通常用于内存映射寄存器的嵌入式上下文中。</p>
<p>在 Rust 中，我们没有将变量标记为<code>volatile</code>，而是使用特定的方法来执行 volatile 访问：<a href="https://doc.rust-lang.org/core/ptr/fn.read_volatile.html" target="_blank" rel="noopener"><code>core::ptr::read_volatile</code></a>和 <a href="https://doc.rust-lang.org/core/ptr/fn.write_volatile.html" target="_blank" rel="noopener"><code>core::ptr::write_volatile</code></a>。这些方法采用 a<code>*const T</code>或 a <code>*mut T</code> （<em>原始指针</em>，如上所述）并执行易失性读取或写入。</p>
<p>例如，在 C 中你可以这样写：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">volatile</span> bool signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    signalled <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>signalled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Rust 中的等价物将在每次访问时使用 volatile 方法：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    <span class="token comment" spellcheck="true">// (In real code, you should consider a higher level primitive,</span>
    <span class="token comment" spellcheck="true">//  such as an atomic type).</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">!</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SIGNALLED<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码示例中有几点值得注意：</p>
<ul>
<li>我们可以传递<code>&amp;mut SIGNALLED</code>到函数 requires <code>*mut T</code>，因为 <code>&amp;mut T</code>自动转换为 a <code>*mut T</code>（对于<code>*const T</code>）</li>
<li>我们需要/方法的<code>unsafe</code>块，因为它们是函数。确保安全使用是程序员的责任：有关更多详细信息，请参阅方法文档。<code>read_volatile``write_volatile``unsafe</code></li>
</ul>
<p>在您的代码中直接使用这些函数是很少见的，因为它们通常会由更高级别的库为您处理。对于内存映射外设，外设访问 crate 将自动实现易失性访问，而对于并发原语，有更好的抽象可用。</p>
<h2 id="压缩和对齐类型"><a href="#压缩和对齐类型" class="headerlink" title="压缩和对齐类型"></a>压缩和对齐类型</h2><p>在嵌入式 C 中，通常会告诉编译器一个变量必须有一定的对齐方式，或者一个结构必须打包而不是对齐，通常是为了满足特定的硬件或协议要求。</p>
<p>在 Rust 中，这由<code>repr</code>结构或联合上的属性控制。默认表示不提供布局保证，因此不应用于与硬件或 C 互操作的代码。编译器可能会重新排序结构成员或插入填充，并且行为可能会随着 Rust 的未来版本而改变。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffecb3511d0 0x7ffecb3511d4 0x7ffecb3511d2</span>
<span class="token comment" spellcheck="true">// Note ordering has been changed to x, z, y to improve packing.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为确保布局可与 C 互操作，请使用<code>repr(C)</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7fffd0d84c60 0x7fffd0d84c62 0x7fffd0d84c64</span>
<span class="token comment" spellcheck="true">// Ordering is preserved and the layout will not change over time.</span>
<span class="token comment" spellcheck="true">// `z` is two-byte aligned so a byte of padding exists between `y` and `z`.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要确保打包表示，请使用<code>repr(packed)</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(packed)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Unsafe is required to borrow a field of a packed struct.</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffd33598490 0x7ffd33598492 0x7ffd33598493</span>
<span class="token comment" spellcheck="true">// No padding has been inserted between `y` and `z`, so now `z` is unaligned.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意， using<code>repr(packed)</code>还将类型的对齐方式设置为<code>1</code>。</p>
<p>最后，要指定特定的对齐方式，请使用<code>repr(align(n))</code>，其中<code>n</code>是要对齐的字节数（并且必须是 2 的幂）：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[repr(align(4096))]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> u <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffec909a000 0x7ffec909a002 0x7ffec909a004</span>
<span class="token comment" spellcheck="true">// 0x7ffec909b000 0x7ffec909b002 0x7ffec909b004</span>
<span class="token comment" spellcheck="true">// The two instances `u` and `v` have been placed on 4096-byte alignments,</span>
<span class="token comment" spellcheck="true">// evidenced by the `000` at the end of their addresses.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，我们可以结合<code>repr(C)</code>使用<code>repr(align(n))</code>以获得对齐且与 C 兼容的布局。这是不允许的结合<code>repr(align(n))</code>有 <code>repr(packed)</code>，因为<code>repr(packed)</code>套对齐<code>1</code>。一个<code>repr(packed)</code>类型也不允许包含一个<code>repr(align(n))</code>类型。</p>
<h2 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h2><ul>
<li><a href="https://docs.rust-embedded.org/faq.html" target="_blank" rel="noopener">Rust 嵌入式常见问题解答</a></li>
<li><a href="http://blahg.josefsipek.net/?p=580" target="_blank" rel="noopener">C 程序员的 Rust 指针</a></li>
<li><a href="https://github.com/diwic/reffers-rs/blob/master/docs/Pointers.md" target="_blank" rel="noopener">我曾经使用指针 - 现在呢？</a></li>
</ul>
<h1 id="Interoperability（互操作性）"><a href="#Interoperability（互操作性）" class="headerlink" title="Interoperability（互操作性）"></a>Interoperability（互操作性）</h1><p>Rust 和 C 代码之间的互操作性始终依赖于两种语言之间的数据转换。为此目的，在被<code>stdlib</code>调用 <a href="https://doc.rust-lang.org/std/ffi/index.html" target="_blank" rel="noopener"><code>std::ffi</code></a>和 中 有两个专用模块<a href="https://doc.rust-lang.org/std/os/raw/index.html" target="_blank" rel="noopener"><code>std::os::raw</code></a>。</p>
<p><code>std::os::raw</code> 处理可以由编译器隐式转换的低级原始类型，因为 Rust 和 C 之间的内存布局足够相似或相同。</p>
<p><code>std::ffi</code>提供了一些实用程序用于将更加复杂的类型，如弦乐器，既映射<code>&amp;str</code>和<code>String</code> 对C-类型是更容易和更安全的处理。</p>
<p>这些模块都没有在 中可用<code>core</code>，但是您可以在crate 中找到<code>#![no_std]</code> 兼容版本，<code>std::ffi::{CStr,CString}</code>以及<a href="https://crates.io/crates/cstr_core" target="_blank" rel="noopener"><code>cstr_core</code></a>crate 中的大多数<code>std::os::raw</code>类型<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>。</p>
<table>
<thead>
<tr>
<th>锈型</th>
<th>中间的</th>
<th>C型</th>
</tr>
</thead>
<tbody><tr>
<td>细绳</td>
<td>字符串</td>
<td>*字符</td>
</tr>
<tr>
<td>&amp;str</td>
<td>CStr</td>
<td>*常量字符</td>
</tr>
<tr>
<td>()</td>
<td>c_void</td>
<td>空白</td>
</tr>
<tr>
<td>u32 或 u64</td>
<td>c_uint</td>
<td>无符号整数</td>
</tr>
<tr>
<td>等等</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>如上所述，基本类型可以由编译器隐式转换。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c_num<span class="token punctuation">:</span> c_uint <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r_num<span class="token punctuation">:</span> u32 <span class="token operator">=</span> c_num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="与其他构建系统的互操作性"><a href="#与其他构建系统的互操作性" class="headerlink" title="与其他构建系统的互操作性"></a>与其他构建系统的互操作性</h3><p>在您的嵌入式项目中包含 Rust 的一个常见要求是将 Cargo 与您现有的构建系统相结合，例如 make 或 cmake。</p>
<p>我们正在<a href="https://github.com/rust-embedded/book/issues/61" target="_blank" rel="noopener">问题 #61 中的</a>问题跟踪器上为此收集示例和用例 。</p>
<h3 id="与-RTOS-的互操作性"><a href="#与-RTOS-的互操作性" class="headerlink" title="与 RTOS 的互操作性"></a>与 RTOS 的互操作性</h3><p>将 Rust 与诸如 FreeRTOS 或 ChibiOS 之类的 RTOS 集成仍在进行中；尤其是从 Rust 调用 RTOS 函数可能会很棘手。</p>
<p>我们正在<a href="https://github.com/rust-embedded/book/issues/62" target="_blank" rel="noopener">问题 #62 中的</a>问题跟踪器上为此收集示例和用例 。</p>
<h2 id="A-little-C-with-your-Rust"><a href="#A-little-C-with-your-Rust" class="headerlink" title="A little C with your Rust"></a>A little C with your Rust</h2><p>在 Rust 项目中使用 C 或 C++ 包括两个主要部分：</p>
<ul>
<li>包装暴露的 C API 以与 Rust 一起使用</li>
<li>构建您的 C 或 C++ 代码以与 Rust 代码集成</li>
</ul>
<p>由于 C++ 没有稳定的 ABI 供 Rust 编译器作为目标，因此建议<code>C</code>在将 Rust 与 C 或 C++ 结合使用时使用ABI。</p>
<h3 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h3><p>在从 Rust 使用 C 或 C++ 代码之前，有必要定义（在 Rust 中）链接代码中存在哪些数据类型和函数签名。在 C 或 C++ 中，您将包含定义此数据的头 (<code>.h</code>或<code>.hpp</code>) 文件。在 Rust 中，需要手动将这些定义转换为 Rust，或者使用工具生成这些定义。</p>
<p>首先，我们将介绍将这些定义从 C/C++ 手动转换为 Rust。</p>
<h4 id="包装-C-函数和数据类型"><a href="#包装-C-函数和数据类型" class="headerlink" title="包装 C 函数和数据类型"></a>包装 C 函数和数据类型</h4><p>通常，用 C 或 C++ 编写的库将提供一个定义公共接口中使用的所有类型和函数的头文件。示例文件可能如下所示：</p>
<pre class="line-numbers language-C"><code class="language-C">/* File: cool.h */
typedef struct CoolStruct {
    int x;
    int y;
} CoolStruct;

void cool_function(int i, char c, CoolStruct* cs);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当转换为 Rust 时，此界面将如下所示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/* File: cool_bindings.rs */</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span>
    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们一次一个地看一下这个定义，以解释每个部分。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>默认情况下，Rust 不保证包含在<code>struct</code>. 为了保证与 C 代码的兼容性，我们包含了<code>#[repr(C)]</code>属性，它指示 Rust 编译器始终使用 C 在结构中组织数据的相同规则。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>由于 C 或 C++ 定义<code>int</code>or 的方式的灵活性，<code>char</code>建议使用 中定义的原始数据类型<code>cty</code>，它将类型从 C 映射到 Rust 中的类型。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span> <span class="token punctuation">...</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此语句定义了使用 C ABI 的函数的签名，称为<code>cool_function</code>. 通过定义签名而不定义函数体，这个函数的定义需要在别处提供，或者从静态库链接到最终库或二进制文件。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>与我们上面的数据类型类似，我们使用 C 兼容定义来定义函数参数的数据类型。为了清楚起见，我们还保留了相同的参数名称。</p>
<p>我们这里有一种新类型，<code>*mut CoolStruct</code>. 由于 C 没有 Rust 引用的概念，它看起来像这样：<code>&amp;mut CoolStruct</code>，我们有一个原始指针。由于取消引用此指针是<code>unsafe</code>，并且该指针实际上可能是一个<code>null</code>指针，因此在与 C 或 C++ 代码交互时必须注意确保 Rust 的典型保证。</p>
<h4 id="自动生成界面"><a href="#自动生成界面" class="headerlink" title="自动生成界面"></a>自动生成界面</h4><p>有一个名为<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>的工具可以自动执行这些转换，而不是手动生成这些接口，这可能很乏味且容易出错。有关<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>的使用<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">说明</a>，请参阅<a href="https://rust-lang.github.io/rust-bindgen/" target="_blank" rel="noopener">bindgen 用户手册</a>，但典型的过程包括以下内容：</p>
<ol>
<li>收集所有 C 或 C++ 头文件，定义你想与 Rust 一起使用的接口或数据类型。</li>
<li>编写一个<code>bindings.h</code>文件，它<code>#include "..."</code>是您在第一步中收集的每个文件。</li>
<li>提供此<code>bindings.h</code>文件以及用于将代码编译为<code>bindgen</code>. 提示：使用<code>Builder.ctypes_prefix("cty")</code>/ <code>--ctypes-prefix=cty</code>和<code>Builder.use_core()</code>/<code>--use-core</code>使生成的代码<code>#![no_std]</code>兼容。</li>
<li><code>bindgen</code>将生成生成的 Rust 代码到终端窗口的输出。此文件可能会通过管道传输到项目中的文件，例如<code>bindings.rs</code>. 你可以在你的 Rust 项目中使用这个文件来与编译和链接为外部库的 C/C++ 代码交互。提示：<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>如果生成的绑定中的类型带有前缀，请不要忘记使用crate <code>cty</code>。</li>
</ol>
<h3 id="构建您的-C-C-代码"><a href="#构建您的-C-C-代码" class="headerlink" title="构建您的 C/C++ 代码"></a>构建您的 C/C++ 代码</h3><p>由于 Rust 编译器不直接知道如何编译 C 或 C++ 代码（或来自任何其他语言的代码，提供 C 接口），因此有必要提前编译您的非 Rust 代码。</p>
<p>对于嵌入式项目，这通常意味着将 C/C++ 代码编译为静态存档（例如<code>cool-library.a</code>），然后可以在最后的链接步骤中将其与 Rust 代码结合。</p>
<p>如果您要使用的库已作为静态存档分发，则无需重新构建代码。只需如上所述转换提供的接口头文件，并在编译/链接时包含静态存档。</p>
<p>如果代码存在作为源项目，这将是必要编译C / C ++代码到静态库，或者通过触发现有构建系统（如<code>make</code>，<code>CMake</code>等），或通过移植必要的编译步骤，使用一种叫做<code>cc</code>板条箱的工具。对于这两个步骤，都需要使用<code>build.rs</code>脚本。</p>
<h4 id="Rustbuild-rs构建脚本"><a href="#Rustbuild-rs构建脚本" class="headerlink" title="Rustbuild.rs构建脚本"></a>Rust<code>build.rs</code>构建脚本</h4><p>一个<code>build.rs</code>脚本是写在鲁斯特语法的文件，那是你的编译机上运行后，你的项目的依赖已建成，但在此之前项目的生成。</p>
<p>完整的参考可以在<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">这里</a>找到。<code>build.rs</code>脚本对于生成代码（例如通过<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>）、调用外部构建系统（例如<code>Make</code>）或通过使用<code>cc</code>crate直接编译 C/C++ 非常有用。</p>
<h4 id="触发外部构建系统"><a href="#触发外部构建系统" class="headerlink" title="触发外部构建系统"></a>触发外部构建系统</h4><p>对于具有复杂外部项目或构建系统的项目，<a href="https://doc.rust-lang.org/std/process/struct.Command.html" target="_blank" rel="noopener"><code>std::process::Command</code></a>通过遍历相对路径、调用固定命令（例如<code>make library</code>），然后将生成的静态库复制到适当的在<code>target</code>构建目录中的位置。</p>
<p>虽然您的 crate 可能针对<code>no_std</code>嵌入式平台，但您<code>build.rs</code>只能在编译 crate 的机器上执行。这意味着您可以使用将在您的编译主机上运行的任何 Rust crate。</p>
<h4 id="使用cccrate构建-C-C-代码"><a href="#使用cccrate构建-C-C-代码" class="headerlink" title="使用cccrate构建 C/C++ 代码"></a>使用<code>cc</code>crate构建 C/C++ 代码</h4><p>对于依赖项或复杂性有限的项目，或者对于难以修改构建系统以生成静态库（而不是最终的二进制文件或可执行文件）的项目，使用<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>可能更容易，它提供了惯用的 Rust主机提供的编译器接口。</p>
<p>在将单个 C 文件编译为静态库的依赖项的最简单情况下，<code>build.rs</code>使用<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>的示例脚本如下所示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> cc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cc<span class="token punctuation">:</span><span class="token punctuation">:</span>Build<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"foo.c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"libfoo.a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="A-little-Rust-with-your-C"><a href="#A-little-Rust-with-your-C" class="headerlink" title="A little Rust with your C"></a>A little Rust with your C</h2><p>在 C 或 C++ 项目中使用 Rust 代码主要由两部分组成。</p>
<ul>
<li>在 Rust 中创建一个 C 友好的 API</li>
<li>将您的 Rust 项目嵌入到外部构建系统中</li>
</ul>
<p>除了<code>cargo</code>and之外<code>meson</code>，大多数构建系统都没有原生的 Rust 支持。因此，您很可能最好仅<code>cargo</code>用于编译您的 crate 和任何依赖项。</p>
<h3 id="设置项目"><a href="#设置项目" class="headerlink" title="设置项目"></a>设置项目</h3><p><code>cargo</code>像往常一样创建一个新项目。</p>
<p>有一些标志告诉<code>cargo</code>发出一个系统库，而不是它的常规 rust 目标。这也允许您为库设置不同的输出名称，如果您希望它与您的 crate 的其余部分不同。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[lib]
name = "your_crate"
crate-type = ["cdylib"]      # Creates dynamic lib
# crate-type = ["staticlib"] # Creates static lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="构建CAPI"><a href="#构建CAPI" class="headerlink" title="构建CAPI"></a>构建<code>C</code>API</h3><p>因为 C++ 没有稳定的 ABI 供 Rust 编译器作为目标，我们<code>C</code>用于不同语言之间的任何互操作性。在 C 和 C++ 代码中使用 Rust 时也不例外。</p>
<h4 id="no-mangle"><a href="#no-mangle" class="headerlink" title="#[no_mangle\]"></a><code>#[no_mangle\]</code></h4><p>Rust 编译器对符号名称的处理与本机代码链接器所期望的不同。因此，任何 Rust 导出以在 Rust 之外使用的函数都需要被告知不要被编译器破坏。</p>
<h4 id="extern-quot-C-quot"><a href="#extern-quot-C-quot" class="headerlink" title="extern &quot;C&quot;"></a><code>extern "C"</code></h4><p>默认情况下，您在 Rust 中编写的任何函数都将使用 Rust ABI（它也不稳定）。相反，在构建面向外部的 FFI API 时，我们需要告诉编译器使用系统 ABI。</p>
<p>根据您的平台，您可能希望针对特定的 ABI 版本，<a href="https://doc.rust-lang.org/reference/items/external-blocks.html" target="_blank" rel="noopener">此处</a>记录了这些版本。</p>
<hr>
<p>将这些部分放在一起，您会得到一个大致如下所示的函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>就像<code>C</code>在您的 Rust 项目中使用代码一样，您现在需要将数据从应用程序的其余部分可以理解的形式来回转换。</p>
<h3 id="链接和更大的项目背景"><a href="#链接和更大的项目背景" class="headerlink" title="链接和更大的项目背景"></a>链接和更大的项目背景</h3><p>那么，问题就解决了一半。你现在怎么用这个？</p>
<p><strong>这在很大程度上取决于您的项目和/或构建系统</strong></p>
<p><code>cargo</code>将创建一个<code>my_lib.so</code>/<code>my_lib.dll</code>或<code>my_lib.a</code>文件，具体取决于您的平台和设置。这个库可以简单地由你的构建系统链接。</p>
<p>但是，从 C 调用 Rust 函数需要一个头文件来声明函数签名。</p>
<p>Rust-ffi API 中的每个函数都需要有一个对应的头函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后会变成</p>
<pre class="line-numbers language-C"><code class="language-C">void rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>等等。</p>
<p>有一个工具可以自动执行此过程，称为<a href="https://github.com/eqrion/cbindgen" target="_blank" rel="noopener">cbindgen</a>，它会分析您的 Rust 代码，然后从中生成 C 和 C++ 项目的标头。</p>
<p>此时，使用 C 中的 Rust 函数就像包含标头并调用它们一样简单！</p>
<pre class="line-numbers language-C"><code class="language-C">#include "my-rust-project.h"
rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Optimizations-the-speed-size-tradeoff"><a href="#Optimizations-the-speed-size-tradeoff" class="headerlink" title="Optimizations: the speed size tradeoff"></a>Optimizations: the speed size tradeoff</h1><p>每个人都希望他们的程序超快和超小，但通常不可能同时拥有这两种特性。本节讨论提供的不同优化级别<code>rustc</code>以及它们如何影响程序的执行时间和二进制大小。</p>
<h2 id="没有优化"><a href="#没有优化" class="headerlink" title="没有优化"></a>没有优化</h2><p>这是默认设置。当您打电话时，<code>cargo build</code>您使用开发 (AKA <code>dev</code>) 配置文件。此配置文件针对调试进行了优化，因此它启用调试信息，但<em>不</em>启用任何优化，即它使用<code>-C opt-level = 0</code>.</p>
<p>至少对于裸机开发而言，debuginfo 是零成本的，因为它不会占用 Flash / ROM 中的空间，因此我们实际上建议您在发布配置文件中启用 debuginfo – 默认情况下禁用它。这将允许您在调试发布版本时使用断点。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# symbols are nice and they don't increase the size on Flash
debug = true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>没有优化对于调试来说是很好的，因为单步调试代码感觉就像你在逐条语句执行程序，而且你可以<code>print</code> 在 GDB 中堆叠变量和函数参数。代码优化后，尝试打印变量会导致<code>$0 = &lt;value optimized out&gt;</code>打印。</p>
<p><code>dev</code>配置文件的最大缺点是生成的二进制文件会很大而且很慢。大小通常更成问题，因为未优化的二进制文件可能占用数十 KiB 的闪存，而您的目标设备可能没有——结果：未优化的二进制文件不适合您的设备！</p>
<p>我们可以有更小的、调试器友好的二进制文件吗？是的，有一个技巧。</p>
<h3 id="优化依赖"><a href="#优化依赖" class="headerlink" title="优化依赖"></a>优化依赖</h3><p>有一个名为 Cargo 的功能<a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides" target="_blank" rel="noopener"><code>profile-overrides</code></a>，可让您覆盖依赖项的优化级别。您可以使用该功能来优化所有依赖项的大小，同时保持 top crate 未优化和调试器友好。</p>
<p>下面是一个例子：</p>
<pre class="line-numbers language-toml"><code class="language-toml"># Cargo.toml
[package]
name = "app"
# ..

[profile.dev.package."*"] # +
opt-level = "z" # +<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>没有覆盖：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 9060   0x8000400
.rodata               1708   0x8002780
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用覆盖：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 3490   0x8000400
.rodata               1100   0x80011c0
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这意味着 Flash 使用量减少了 6 KiB，而 top crate 的可调试性没有任何损失。如果您进入依赖项，那么您将<code>&lt;value optimized out&gt;</code>再次开始看到这些 消息，但通常情况下，您想要调试顶级板条箱而不是依赖项。如果您<em>确实</em>需要调试依赖项，那么您可以使用该<code>profile-overrides</code>功能从优化中排除特定的依赖项。请参阅下面的示例：</p>
<pre class="line-numbers language-toml"><code class="language-toml"># ..

# don't optimize the `cortex-m-rt` crate
[profile.dev.package.cortex-m-rt] # +
opt-level = 0 # +

# but do optimize all the other dependencies
[profile.dev.package."*"]
codegen-units = 1 # better optimizations
opt-level = "z"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在顶部板条箱和<code>cortex-m-rt</code>调试器友好！</p>
<h2 id="优化速度"><a href="#优化速度" class="headerlink" title="优化速度"></a>优化速度</h2><p>截至 2018 年 9 月 18 日，<code>rustc</code>支持三个“优化速度”级别：<code>opt-level = 1</code>、<code>2</code>和<code>3</code>。当您运行时，<code>cargo build --release</code>您使用的是默认为<code>opt-level = 3</code>.</p>
<p><code>opt-level = 2</code>和都<code>3</code>以牺牲二进制大小为代价来优化速度，但 level<code>3</code>比 level 执行更多的矢量化和内联<code>2</code>。特别是，您会看到 at<code>opt-level</code>等于或大于<code>2</code>LLVM 将展开循环。循环展开在 Flash / ROM 方面的成本相当高（例如，从 26 字节到 194 以实现零数组循环），但也可以在给定正确条件的情况下将执行时间减半（例如，迭代次数足够大）。</p>
<p>目前没有办法禁用循环展开<code>opt-level = 2</code>，<code>3</code>所以如果你负担不起它的成本，你应该优化你的程序的大小。</p>
<h2 id="优化尺寸"><a href="#优化尺寸" class="headerlink" title="优化尺寸"></a>优化尺寸</h2><p>截至 2018 年 9 月 18 日，<code>rustc</code>支持两个“优化大小”级别：<code>opt-level = "s"</code>和<code>"z"</code>. 这些名称是从 clang/LLVM 继承而来的，并不太具有描述性，但<code>"z"</code>旨在说明它生成的二进制文件比<code>"s"</code>.</p>
<p>如果您希望针对大小优化发布二进制文件<code>profile.release.opt-level</code>，请<code>Cargo.toml</code>按如下所示更改 设置。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# or "z"
opt-level = "s"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这两个优化级别大大降低了 LLVM 的内联阈值，这是一个用于决定是否内联函数的指标。Rust 原则之一是零成本抽象；这些抽象倾向于使用许多新类型和小函数来保存不变量（例如，借用内部值的函数，例如<code>deref</code>, <code>as_ref</code>），因此低内联阈值会使 LLVM 错过优化机会（例如消除死分支、内联调用闭包）。</p>
<p>在优化大小时，您可能想尝试增加内联阈值，看看这是否对二进制大小有任何影响。更改内联阈值的推荐方法是将<code>-C inline-threshold</code>标志附加到<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-toml"><code class="language-toml"># .cargo/config.toml
# this assumes that you are using the cortex-m-quickstart template
[target.'cfg(all(target_arch = "arm", target_os = "none"))']
rustflags = [
  # ..
  "-C", "inline-threshold=123", # +
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用什么价值？<a href="https://github.com/rust-lang/rust/blob/1.29.0/src/librustc_codegen_llvm/back/write.rs#L2105-L2122" target="_blank" rel="noopener">从 1.29.0 开始，这些是不同优化级别使用的内联阈值</a>：</p>
<ul>
<li><code>opt-level = 3</code> 使用 275</li>
<li><code>opt-level = 2</code> 使用 225</li>
<li><code>opt-level = "s"</code> 使用 75</li>
<li><code>opt-level = "z"</code> 使用 25</li>
</ul>
<p>你应该尝试<code>225</code>和<code>275</code>优化大小时。</p>
<h1 id="Appendix-A-Glossary"><a href="#Appendix-A-Glossary" class="headerlink" title="Appendix A: Glossary"></a>Appendix A: Glossary</h1><p>The embedded ecosystem is full of different protocols, hardware components and vendor-specific things that use their own terms and abbreviations. This Glossary attempts to list them with pointers for understanding them better.</p>
<h3 id="BSP"><a href="#BSP" class="headerlink" title="BSP"></a>BSP</h3><p>A Board Support Crate provides a high level interface configured for a specific board. It usually depends on a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">HAL</a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="FPU"><a href="#FPU" class="headerlink" title="FPU"></a>FPU</h3><p>Floating-point Unit. A ‘math processor’ running only operations on floating-point numbers.</p>
<h3 id="HAL"><a href="#HAL" class="headerlink" title="HAL"></a>HAL</h3><p>A Hardware Abstraction Layer crate provides a developer friendly interface to a microcontroller’s features and peripherals. It is usually implemented on top of a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#pac" target="_blank" rel="noopener">Peripheral Access Crate (PAC)</a>. It may also implement traits from the <a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><p>Sometimes referred to as <code>I²C</code> or Inter-IC. It is a protocol meant for hardware communication within a single integrated circuit. See <a href="https://en.wikipedia.org/wiki/I2c" target="_blank" rel="noopener">here</a> for more details</p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>A Peripheral Access Crate provides access to a microcontroller’s peripherals. It is one of the lower level crates and is usually generated directly from the provided <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#svd" target="_blank" rel="noopener">SVD</a>, often using <a href="https://github.com/rust-embedded/svd2rust/" target="_blank" rel="noopener">svd2rust</a>. The <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">Hardware Abstraction Layer</a> would usually depend on this crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>Serial Peripheral Interface. See <a href="https://en.wikipedia.org/wiki/Serial_peripheral_interface" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="SVD"><a href="#SVD" class="headerlink" title="SVD"></a>SVD</h3><p>System View Description is an XML file format used to describe the programmers view of a microcontroller device. You can read more about it on <a href="https://www.keil.com/pack/doc/CMSIS/SVD/html/index.html" target="_blank" rel="noopener">the ARM CMSIS documentation site</a>.</p>
<h3 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h3><p>Universal asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="USART"><a href="#USART" class="headerlink" title="USART"></a>USART</h3><p>Universal synchronous and asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_synchronous_and_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<hr>
<h1 id="😁《Discovery》"><a href="#😁《Discovery》" class="headerlink" title="😁《Discovery》"></a>😁《Discovery》</h1><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/embedded-rust.html">https://jackhcc.github.io/posts/embedded-rust.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Rust/">
                                    <span class="chip bg-color">Rust</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-09-08T21-32-49',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/posts/embedded-rust.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="Embedded Rust详解">
                        
                        <span class="card-title">Embedded Rust详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Rust嵌入式编程
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Embedded/" class="post-category">
                                    Embedded
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Rust/">
                        <span class="chip bg-color">Rust</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/awesome-bcsd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/22.jpg" class="responsive-img" alt="Awesome BCSD 2021">
                        
                        <span class="card-title">Awesome BCSD 2021</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Binary Code Similarity Detection 2021 最新研究汇总
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Awesome/" class="post-category">
                                    Awesome
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BCSD/">
                        <span class="chip bg-color">BCSD</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1343.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

